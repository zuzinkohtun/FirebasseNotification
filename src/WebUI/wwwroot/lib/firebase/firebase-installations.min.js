import{registerVersion as e,_getProvider,getApp as t,_registerComponent as n}from"https://www.gstatic.com/firebasejs/10.6.0/firebase-app.js";class FirebaseError extends Error{constructor(e,t,r){super(t),this.code=e,this.customData=r,this.name="FirebaseError",Object.setPrototypeOf(this,FirebaseError.prototype),Error.captureStackTrace&&Error.captureStackTrace(this,ErrorFactory.prototype.create)}}class ErrorFactory{constructor(e,t,r){this.service=e,this.serviceName=t,this.errors=r}create(e,...t){var n,t=t[0]||{},a=this.service+"/"+e,e=this.errors[e],e=e?(n=t,e.replace(r,(e,t)=>{var r=n[t];return null!=r?String(r):`<${t}?>`})):"Error",e=this.serviceName+`: ${e} (${a}).`;return new FirebaseError(a,e,t)}}const r=/\{\$([^}]+)}/g;class Component{constructor(e,t,r){this.name=e,this.instanceFactory=t,this.type=r,this.multipleInstances=!1,this.serviceProps={},this.instantiationMode="LAZY",this.onInstanceCreated=null}setInstantiationMode(e){return this.instantiationMode=e,this}setMultipleInstances(e){return this.multipleInstances=e,this}setServiceProps(e){return this.serviceProps=e,this}setInstanceCreatedCallback(e){return this.onInstanceCreated=e,this}}let a,o;const i=new WeakMap,s=new WeakMap,c=new WeakMap,u=new WeakMap,l=new WeakMap;let d={get(e,t,r){if(e instanceof IDBTransaction){if("done"===t)return s.get(e);if("objectStoreNames"===t)return e.objectStoreNames||c.get(e);if("store"===t)return r.objectStoreNames[1]?void 0:r.objectStore(r.objectStoreNames[0])}return wrap(e[t])},set:(e,t,r)=>(e[t]=r,!0),has:(e,t)=>e instanceof IDBTransaction&&("done"===t||"store"===t)||t in e};function wrapFunction(r){return r!==IDBDatabase.prototype.transaction||"objectStoreNames"in IDBTransaction.prototype?(o=o||[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey]).includes(r)?function(...e){return r.apply(unwrap(this),e),wrap(i.get(this))}:function(...e){return wrap(r.apply(unwrap(this),e))}:function(e,...t){t=r.call(unwrap(this),e,...t);return c.set(t,e.sort?e.sort():[e]),wrap(t)}}function transformCachableValue(e){return"function"==typeof e?wrapFunction(e):(e instanceof IDBTransaction&&(i=e,s.has(i)||(t=new Promise((e,t)=>{const r=()=>{i.removeEventListener("complete",n),i.removeEventListener("error",a),i.removeEventListener("abort",a)},n=()=>{e(),r()},a=()=>{t(i.error||new DOMException("AbortError","AbortError")),r()};i.addEventListener("complete",n),i.addEventListener("error",a),i.addEventListener("abort",a)}),s.set(i,t))),r=e,(a=a||[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction]).some(e=>r instanceof e)?new Proxy(e,d):e);var i,t,r}function wrap(e){if(e instanceof IDBRequest){var o=e;const r=new Promise((e,t)=>{const r=()=>{o.removeEventListener("success",n),o.removeEventListener("error",a)},n=()=>{e(wrap(o.result)),r()},a=()=>{t(o.error),r()};o.addEventListener("success",n),o.addEventListener("error",a)});return r.then(e=>{e instanceof IDBCursor&&i.set(e,o)}).catch(()=>{}),l.set(r,o),r}if(u.has(e))return u.get(e);var t=transformCachableValue(e);return t!==e&&(u.set(e,t),l.set(t,e)),t}const unwrap=e=>l.get(e),p=["get","getKey","getAll","getAllKeys","count"],f=["put","add","delete","clear"],g=new Map;function getMethod(e,t){if(e instanceof IDBDatabase&&!(t in e)&&"string"==typeof t){if(g.get(t))return g.get(t);const n=t.replace(/FromIndex$/,""),a=t!==n,i=f.includes(n);return n in(a?IDBIndex:IDBObjectStore).prototype&&(i||p.includes(n))?(e=async function(e,...t){e=this.transaction(e,i?"readwrite":"readonly");let r=e.store;return a&&(r=r.index(t.shift())),(await Promise.all([r[n](...t),i&&e.done]))[0]},g.set(t,e),e):void 0}}!function(e){d=e(d)}(n=>({...n,get:(e,t,r)=>getMethod(e,t)||n.get(e,t,r),has:(e,t)=>!!getMethod(e,t)||n.has(e,t)}));const h="@firebase/installations",w=new ErrorFactory("installations","Installations",{"missing-app-config-values":'Missing App configuration value: "{$valueName}"',"not-registered":"Firebase Installation is not registered.","installation-not-found":"Firebase Installation not found.","request-failed":'{$requestName} request failed with error "{$serverCode} {$serverStatus}: {$serverMessage}"',"app-offline":"Could not process request. Application offline.","delete-pending-registration":"Can't delete installation while there is a pending registration request."});function isServerError(e){return e instanceof FirebaseError&&e.code.includes("request-failed")}function getInstallationsEndpoint({projectId:e}){return`https://firebaseinstallations.googleapis.com/v1/projects/${e}/installations`}function extractAuthTokenInfoFromResponse(e){return{token:e.token,requestStatus:2,expiresIn:(e=e.expiresIn,Number(e.replace("s","000"))),creationTime:Date.now()}}async function getErrorFromResponse(e,t){t=(await t.json()).error;return w.create("request-failed",{requestName:e,serverCode:t.code,serverMessage:t.message,serverStatus:t.status})}function getHeaders({apiKey:e}){return new Headers({"Content-Type":"application/json",Accept:"application/json","x-goog-api-key":e})}function getHeadersWithAuth(e,{refreshToken:t}){const r=getHeaders(e);return r.append("Authorization","FIS_v2 "+t),r}async function retryIfServerError(e){var t=await e();return 500<=t.status&&t.status<600?e():t}function sleep(t){return new Promise(e=>{setTimeout(e,t)})}const m=/^[cdef][\w-]{21}$/;function generateFid(){try{const r=new Uint8Array(17);(self.crypto||self.msCrypto).getRandomValues(r),r[0]=112+r[0]%16;t=r;var e=btoa(String.fromCharCode(...t)).replace(/\+/g,"-").replace(/\//g,"_").substr(0,22);return m.test(e)?e:""}catch(e){return""}var t}function getKey(e){return e.appName+"!"+e.appId}const I=new Map;function fidChanged(e,t){e=getKey(e);callFidChangeCallbacks(e,t);{const r=getBroadcastChannel();return r&&r.postMessage({key:e,fid:t}),void closeBroadcastChannel()}}function callFidChangeCallbacks(e,t){var r=I.get(e);if(r)for(const e of r)e(t)}let y=null;function getBroadcastChannel(){return!y&&"BroadcastChannel"in self&&((y=new BroadcastChannel("[Firebase] FID Change")).onmessage=e=>{callFidChangeCallbacks(e.data.key,e.data.fid)}),y}function closeBroadcastChannel(){0===I.size&&y&&(y.close(),y=null)}const v="firebase-installations-store";let b=null;function getDbPromise(){return b=b||function(e,t,{blocked:r,upgrade:n,blocking:a,terminated:i}){const o=indexedDB.open(e,t),s=wrap(o);return n&&o.addEventListener("upgradeneeded",e=>{n(wrap(o.result),e.oldVersion,e.newVersion,wrap(o.transaction),e)}),r&&o.addEventListener("blocked",e=>r(e.oldVersion,e.newVersion,e)),s.then(e=>{i&&e.addEventListener("close",()=>i()),a&&e.addEventListener("versionchange",e=>a(e.oldVersion,e.newVersion,e))}).catch(()=>{}),s}("firebase-installations-database",1,{upgrade:(e,t)=>{0===t&&e.createObjectStore(v)}})}async function set(e,t){const r=getKey(e),n=(await getDbPromise()).transaction(v,"readwrite"),a=n.objectStore(v),i=await a.get(r);return await a.put(t,r),await n.done,i&&i.fid===t.fid||fidChanged(e,t.fid),t}async function remove(e){const t=getKey(e),r=(await getDbPromise()).transaction(v,"readwrite");await r.objectStore(v).delete(t),await r.done}async function update(e,t){const r=getKey(e),n=(await getDbPromise()).transaction(v,"readwrite"),a=n.objectStore(v),i=await a.get(r),o=t(i);return void 0===o?await a.delete(r):await a.put(o,r),await n.done,!o||i&&i.fid===o.fid||fidChanged(e,o.fid),o}async function getInstallationEntry(t){let r;var e=await update(t.appConfig,e=>{e=clearTimedOutRequest(e||{fid:generateFid(),registrationStatus:0}),e=function(e,t){if(0!==t.registrationStatus)return 1===t.registrationStatus?{installationEntry:t,registrationPromise:waitUntilFidRegistration(e)}:{installationEntry:t};if(!navigator.onLine)return{installationEntry:t,registrationPromise:Promise.reject(w.create("app-offline"))};t={fid:t.fid,registrationStatus:1,registrationTime:Date.now()};return{installationEntry:t,registrationPromise:async function(t,r){try{var e=await async function({appConfig:e,heartbeatServiceProvider:t},{fid:r}){const n=getInstallationsEndpoint(e),a=getHeaders(e),i=t.getImmediate({optional:!0});if(i){const e=await i.getHeartbeatsHeader();e&&a.append("x-firebase-client",e)}const o={fid:r,authVersion:"FIS_v2",appId:e.appId,sdkVersion:"w:0.6.4"},s={method:"POST",headers:a,body:JSON.stringify(o)},c=await retryIfServerError(()=>fetch(n,s));if(c.ok){const e=await c.json();return{fid:e.fid||r,registrationStatus:2,refreshToken:e.refreshToken,authToken:extractAuthTokenInfoFromResponse(e.authToken)}}throw await getErrorFromResponse("Create Installation",c)}(t,r);return set(t.appConfig,e)}catch(e){throw isServerError(e)&&409===e.customData.serverCode?await remove(t.appConfig):await set(t.appConfig,{fid:r.fid,registrationStatus:0}),e}}(e,t)}}(t,e);return r=e.registrationPromise,e.installationEntry});return""===e.fid?{installationEntry:await r}:{installationEntry:e,registrationPromise:r}}async function waitUntilFidRegistration(e){let t=await updateInstallationRequest(e.appConfig);for(;1===t.registrationStatus;)await sleep(100),t=await updateInstallationRequest(e.appConfig);if(0!==t.registrationStatus)return t;{const{installationEntry:t,registrationPromise:r}=await getInstallationEntry(e);return r||t}}function updateInstallationRequest(e){return update(e,e=>{if(e)return clearTimedOutRequest(e);throw w.create("installation-not-found")})}function clearTimedOutRequest(e){return 1===(t=e).registrationStatus&&t.registrationTime+1e4<Date.now()?{fid:e.fid,registrationStatus:0}:e;var t}async function generateAuthTokenRequest({appConfig:e,heartbeatServiceProvider:t},r){[o,s]=[e,r["fid"]];const n=getInstallationsEndpoint(o)+`/${s}/authTokens:generate`,a=getHeadersWithAuth(e,r),i=t.getImmediate({optional:!0});var o,s;if(i){const e=await i.getHeartbeatsHeader();e&&a.append("x-firebase-client",e)}const c={installation:{sdkVersion:"w:0.6.4",appId:e.appId}},u={method:"POST",headers:a,body:JSON.stringify(c)},l=await retryIfServerError(()=>fetch(n,u));if(l.ok)return extractAuthTokenInfoFromResponse(await l.json());throw await getErrorFromResponse("Generate Auth Token",l)}async function refreshAuthToken(a,i=!1){let o;var e=await update(a.appConfig,e=>{if(!isEntryRegistered(e))throw w.create("not-registered");var t,r,n=e.authToken;if(!(i||(2!==(t=n).requestStatus||(t=t,(r=Date.now())<t.creationTime||t.creationTime+t.expiresIn<r+36e5))))return e;if(1===n.requestStatus)return o=async function(e,t){let r=await updateAuthTokenRequest(e.appConfig);for(;1===r.authToken.requestStatus;)await sleep(100),r=await updateAuthTokenRequest(e.appConfig);var n=r.authToken;return 0===n.requestStatus?refreshAuthToken(e,t):n}(a,i),e;{if(!navigator.onLine)throw w.create("app-offline");t=e,r={requestStatus:1,requestTime:Date.now()};const i=Object.assign(Object.assign({},t),{authToken:r});return o=async function(t,r){try{var e=await generateAuthTokenRequest(t,r),n=Object.assign(Object.assign({},r),{authToken:e});return await set(t.appConfig,n),e}catch(e){throw!isServerError(e)||401!==e.customData.serverCode&&404!==e.customData.serverCode?(n=Object.assign(Object.assign({},r),{authToken:{requestStatus:0}}),await set(t.appConfig,n)):await remove(t.appConfig),e}}(a,i),i}});return o?await o:e.authToken}function updateAuthTokenRequest(e){return update(e,e=>{if(isEntryRegistered(e))return 1===(t=e.authToken).requestStatus&&t.requestTime+1e4<Date.now()?Object.assign(Object.assign({},e),{authToken:{requestStatus:0}}):e;throw w.create("not-registered");var t})}function isEntryRegistered(e){return void 0!==e&&2===e.registrationStatus}async function getId(e){const t=e,{installationEntry:r,registrationPromise:n}=await getInstallationEntry(t);return(n||refreshAuthToken(t)).catch(console.error),r.fid}async function getToken(e,t=!1){var r=e;return(r=(await getInstallationEntry(r)).registrationPromise)&&await r,await 0,(await refreshAuthToken(e,t)).token}async function deleteInstallationRequest(e,t){[i,o]=[e,t["fid"]];const r=getInstallationsEndpoint(i)+"/"+o,n={method:"DELETE",headers:getHeadersWithAuth(e,t)},a=await retryIfServerError(()=>fetch(r,n));var i,o;if(!a.ok)throw await getErrorFromResponse("Delete Installation",a)}async function deleteInstallations(e){var e=e["appConfig"],t=await update(e,e=>{if(!e||0!==e.registrationStatus)return e});if(t){if(1===t.registrationStatus)throw w.create("delete-pending-registration");if(2===t.registrationStatus){if(!navigator.onLine)throw w.create("app-offline");await deleteInstallationRequest(e,t),await remove(e)}}}function onIdChange(t,a){const i=t["appConfig"];{t=i;var r=a;getBroadcastChannel(),t=getKey(t);let e=I.get(t);e||(e=new Set,I.set(t,e)),e.add(r)}return()=>{{var e=i,t=a;const r=getKey(e),n=I.get(r);return void(n&&(n.delete(t),0===n.size&&I.delete(r),closeBroadcastChannel()))}}}function getInstallations(e=t()){return _getProvider(e,"installations").getImmediate()}function getMissingValueError(e){return w.create("missing-app-config-values",{valueName:e})}const publicFactory=e=>{e=e.getProvider("app").getImmediate();return{app:e,appConfig:function(e){if(!e||!e.options)throw getMissingValueError("App Configuration");if(!e.name)throw getMissingValueError("App Name");for(const t of["projectId","apiKey","appId"])if(!e.options[t])throw getMissingValueError(t);return{appName:e.name,projectId:e.options.projectId,apiKey:e.options.apiKey,appId:e.options.appId}}(e),heartbeatServiceProvider:_getProvider(e,"heartbeat"),_delete:()=>Promise.resolve()}},internalFactory=e=>{const t=e.getProvider("app").getImmediate(),r=_getProvider(t,"installations").getImmediate();return{getId:()=>getId(r),getToken:e=>getToken(r,e)}};n(new Component("installations",publicFactory,"PUBLIC")),n(new Component("installations-internal",internalFactory,"PRIVATE")),e(h,"0.6.4"),e(h,"0.6.4","esm2017");export{deleteInstallations,getId,getInstallations,getToken,onIdChange};