!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(require("@firebase/app-compat"),require("@firebase/app")):"function"==typeof define&&define.amd?define(["@firebase/app-compat","@firebase/app"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).firebase,e.firebase.INTERNAL.modularAPIs)}(this,function(mg,pg){"use strict";try{!function(){var l,n=(n=mg)&&"object"==typeof n&&"default"in n?n:{default:n};function i(n){const r=[];let s=0;for(let t=0;t<n.length;t++){let e=n.charCodeAt(t);e<128?r[s++]=e:(e<2048?r[s++]=e>>6|192:(55296==(64512&e)&&t+1<n.length&&56320==(64512&n.charCodeAt(t+1))?(e=65536+((1023&e)<<10)+(1023&n.charCodeAt(++t)),r[s++]=e>>18|240,r[s++]=e>>12&63|128):r[s++]=e>>12|224,r[s++]=e>>6&63|128),r[s++]=63&e|128)}return r}const a={byteToCharMap_:null,charToByteMap_:null,byteToCharMapWebSafe_:null,charToByteMapWebSafe_:null,ENCODED_VALS_BASE:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",get ENCODED_VALS(){return this.ENCODED_VALS_BASE+"+/="},get ENCODED_VALS_WEBSAFE(){return this.ENCODED_VALS_BASE+"-_."},HAS_NATIVE_SUPPORT:"function"==typeof atob,encodeByteArray(r,e){if(!Array.isArray(r))throw Error("encodeByteArray takes an array as a parameter");this.init_();var s=e?this.byteToCharMapWebSafe_:this.byteToCharMap_;const i=[];for(let n=0;n<r.length;n+=3){var a=r[n],o=n+1<r.length,u=o?r[n+1]:0,h=n+2<r.length,c=h?r[n+2]:0;let e=(15&u)<<2|c>>6,t=63&c;h||(t=64,o||(e=64)),i.push(s[a>>2],s[(3&a)<<4|u>>4],s[e],s[t])}return i.join("")},encodeString(e,t){return this.HAS_NATIVE_SUPPORT&&!t?btoa(e):this.encodeByteArray(i(e),t)},decodeString(n,r){if(this.HAS_NATIVE_SUPPORT&&!r)return atob(n);{var s=this.decodeStringToByteArray(n,r);const u=[];let e=0,t=0;for(;e<s.length;){var i,a,o=s[e++];o<128?u[t++]=String.fromCharCode(o):191<o&&o<224?(i=s[e++],u[t++]=String.fromCharCode((31&o)<<6|63&i)):239<o&&o<365?(a=((7&o)<<18|(63&s[e++])<<12|(63&s[e++])<<6|63&s[e++])-65536,u[t++]=String.fromCharCode(55296+(a>>10)),u[t++]=String.fromCharCode(56320+(1023&a))):(i=s[e++],a=s[e++],u[t++]=String.fromCharCode((15&o)<<12|(63&i)<<6|63&a))}return u.join("")}},decodeStringToByteArray(t,e){this.init_();var n=e?this.charToByteMapWebSafe_:this.charToByteMap_;const r=[];for(let e=0;e<t.length;){var s=n[t.charAt(e++)],i=e<t.length?n[t.charAt(e)]:0,a=++e<t.length?n[t.charAt(e)]:64,o=++e<t.length?n[t.charAt(e)]:64;if(++e,null==s||null==i||null==a||null==o)throw new u;r.push(s<<2|i>>4),64!==a&&(r.push(i<<4&240|a>>2),64!==o&&r.push(a<<6&192|o))}return r},init_(){if(!this.byteToCharMap_){this.byteToCharMap_={},this.charToByteMap_={},this.byteToCharMapWebSafe_={},this.charToByteMapWebSafe_={};for(let e=0;e<this.ENCODED_VALS.length;e++)this.byteToCharMap_[e]=this.ENCODED_VALS.charAt(e),this.charToByteMap_[this.byteToCharMap_[e]]=e,this.byteToCharMapWebSafe_[e]=this.ENCODED_VALS_WEBSAFE.charAt(e),(this.charToByteMapWebSafe_[this.byteToCharMapWebSafe_[e]]=e)>=this.ENCODED_VALS_BASE.length&&(this.charToByteMap_[this.ENCODED_VALS_WEBSAFE.charAt(e)]=e,this.charToByteMapWebSafe_[this.ENCODED_VALS.charAt(e)]=e)}}};class u extends Error{constructor(){super(...arguments),this.name="DecodeBase64StringError"}}function q(e){return e=i(e),a.encodeByteArray(e,!0).replace(/\./g,"")}const U=()=>function(){if("undefined"!=typeof self)return self;if("undefined"!=typeof window)return window;if("undefined"!=typeof global)return global;throw new Error("Unable to locate global object.")}().__FIREBASE_DEFAULTS__,z=()=>{if("undefined"!=typeof document){let e;try{e=document.cookie.match(/__FIREBASE_DEFAULTS__=([^;]+)/)}catch(e){return}var t=e&&function(e){try{return a.decodeString(e,!0)}catch(e){console.error("base64Decode failed: ",e)}return null}(e[1]);return t&&JSON.parse(t)}};function G(){return"undefined"!=typeof navigator&&"string"==typeof navigator.userAgent?navigator.userAgent:""}function j(){return!function(){var e=null==(e=(()=>{try{return U()||(()=>{var e;if("undefined"!=typeof process&&void 0!==process.env)return(e=process.env.__FIREBASE_DEFAULTS__)?JSON.parse(e):void 0})()||z()}catch(e){return void console.info("Unable to get __FIREBASE_DEFAULTS__ due to: "+e)}})())?void 0:e.forceEnvironment;if("node"===e)return 1;if("browser"!==e)try{return"[object process]"===Object.prototype.toString.call(global.process)}catch(e){return}}()&&navigator.userAgent.includes("Safari")&&!navigator.userAgent.includes("Chrome")}class K extends Error{constructor(e,t,n){super(t),this.code=e,this.customData=n,this.name="FirebaseError",Object.setPrototypeOf(this,K.prototype),Error.captureStackTrace&&Error.captureStackTrace(this,Q.prototype.create)}}class Q{constructor(e,t,n){this.service=e,this.serviceName=t,this.errors=n}create(e,...t){var r,t=t[0]||{},n=this.service+"/"+e,e=(e=this.errors[e])?(r=t,e.replace($,(e,t)=>{var n=r[t];return null!=n?String(n):`<${t}?>`})):"Error",e=this.serviceName+`: ${e} (${n}).`;return new K(n,e,t)}}const $=/\{\$([^}]+)}/g;function v(e){return e&&e._delegate?e._delegate:e}class W{constructor(e,t,n){this.name=e,this.instanceFactory=t,this.type=n,this.multipleInstances=!1,this.serviceProps={},this.instantiationMode="LAZY",this.onInstanceCreated=null}setInstantiationMode(e){return this.instantiationMode=e,this}setMultipleInstances(e){return this.multipleInstances=e,this}setServiceProps(e){return this.serviceProps=e,this}setInstanceCreatedCallback(e){return this.onInstanceCreated=e,this}}(Lr=l=l||{})[Lr.DEBUG=0]="DEBUG",Lr[Lr.VERBOSE=1]="VERBOSE",Lr[Lr.INFO=2]="INFO",Lr[Lr.WARN=3]="WARN",Lr[Lr.ERROR=4]="ERROR",Lr[Lr.SILENT=5]="SILENT";const H={debug:l.DEBUG,verbose:l.VERBOSE,info:l.INFO,warn:l.WARN,error:l.ERROR,silent:l.SILENT},Y=l.INFO,X={[l.DEBUG]:"log",[l.VERBOSE]:"log",[l.INFO]:"info",[l.WARN]:"warn",[l.ERROR]:"error"},J=(e,t,...n)=>{if(!(t<e.logLevel)){var r=(new Date).toISOString(),s=X[t];if(!s)throw new Error(`Attempted to log a message with an invalid logType (value: ${t})`);console[s](`[${r}]  ${e.name}:`,...n)}};var Z="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},x=Z||self;function ee(e){var t=typeof e;return"array"==(t="object"!=t?t:e?Array.isArray(e)?"array":t:"null")||"object"==t&&"number"==typeof e.length}function te(e){var t=typeof e;return"object"==t&&null!=e||"function"==t}Math.random();function ne(e,t,n){return e.call.apply(e.bind,arguments)}function re(t,n,e){if(t)return 2<arguments.length?(r=Array.prototype.slice.call(arguments,2),function(){var e=Array.prototype.slice.call(arguments);return Array.prototype.unshift.apply(e,r),t.apply(n,e)}):function(){return t.apply(n,arguments)};var r;throw Error()}function se(e,t,n){return(se=Function.prototype.bind&&-1!=Function.prototype.bind.toString().indexOf("native code")?ne:re).apply(null,arguments)}function ie(t){var n=Array.prototype.slice.call(arguments,1);return function(){var e=n.slice();return e.push.apply(e,arguments),t.apply(this,e)}}function e(e,i){function t(){}t.prototype=i.prototype,e.$=i.prototype,e.prototype=new t,(e.prototype.constructor=e).ac=function(e,t,n){for(var r=Array(arguments.length-2),s=2;s<arguments.length;s++)r[s-2]=arguments[s];return i.prototype[t].apply(e,r)}}function ae(){this.s=this.s,this.o=this.o}ae.prototype.s=!1,ae.prototype.sa=function(){this.s||(this.s=!0,this.N())},ae.prototype.N=function(){if(this.o)for(;this.o.length;)this.o.shift()()};const oe=Array.prototype.indexOf?function(e,t){return Array.prototype.indexOf.call(e,t,void 0)}:function(t,n){if("string"==typeof t)return"string"!=typeof n||1!=n.length?-1:t.indexOf(n,0);for(let e=0;e<t.length;e++)if(e in t&&t[e]===n)return e;return-1};function ue(t){var n=t.length;if(0<n){const r=Array(n);for(let e=0;e<n;e++)r[e]=t[e];return r}return[]}function he(t){for(let e=1;e<arguments.length;e++){var n=arguments[e];if(ee(n)){var r=t.length||0,s=n.length||0;t.length=r+s;for(let e=0;e<s;e++)t[r+e]=n[e]}else t.push(n)}}function ce(e,t){this.type=e,this.g=this.target=t,this.defaultPrevented=!1}ce.prototype.h=function(){this.defaultPrevented=!0};var le=function(){if(!x.addEventListener||!Object.defineProperty)return!1;var e=!1,t=Object.defineProperty({},"passive",{get:function(){e=!0}});try{x.addEventListener("test",()=>{},t),x.removeEventListener("test",()=>{},t)}catch(e){}return e}();function de(e){return/^[\s\xa0]*$/.test(e)}function fe(){var e=x.navigator;return(e=e&&e.userAgent)?e:""}function ge(e){return-1!=fe().indexOf(e)}function me(e){return me[" "](e),e}me[" "]=function(){};var pe=ge("Opera"),ye=ge("Trident")||ge("MSIE"),t=ge("Edge"),ve=t||ye,we=ge("Gecko")&&!(-1!=fe().toLowerCase().indexOf("webkit")&&!ge("Edge"))&&!(ge("Trident")||ge("MSIE"))&&!ge("Edge"),_e=-1!=fe().toLowerCase().indexOf("webkit")&&!ge("Edge");function be(){var e=x.document;return e?e.documentMode:void 0}var Ie="",Ee=(Ee=fe(),we?/rv:([^\);]+)(\)|;)/.exec(Ee):t?/Edge\/([\d\.]+)/.exec(Ee):ye?/\b(?:MSIE|rv)[: ]([^\);]+)(\)|;)/.exec(Ee):_e?/WebKit\/(\S+)/.exec(Ee):pe?/(?:Version)[ \/]?(\S+)/.exec(Ee):void 0),Te=((Ee&&(Ie=Ee?Ee[1]:""),ye&&null!=(Ee=be())&&Ee>parseFloat(Ie))?lg=String(Ee):lg=Ie,x.document&&ye&&(be()||parseInt(lg,10))||void 0);function Se(e,t){if(ce.call(this,e?e.type:""),this.relatedTarget=this.g=this.target=null,this.button=this.screenY=this.screenX=this.clientY=this.clientX=0,this.key="",this.metaKey=this.shiftKey=this.altKey=this.ctrlKey=!1,this.state=null,this.pointerId=0,this.pointerType="",this.i=null,e){var n=this.type=e.type,r=e.changedTouches&&e.changedTouches.length?e.changedTouches[0]:null;if(this.target=e.target||e.srcElement,this.g=t,t=e.relatedTarget){if(we){e:{try{me(t.nodeName);var s=!0;break e}catch(e){}s=!1}s||(t=null)}}else"mouseover"==n?t=e.fromElement:"mouseout"==n&&(t=e.toElement);this.relatedTarget=t,r?(this.clientX=void 0!==r.clientX?r.clientX:r.pageX,this.clientY=void 0!==r.clientY?r.clientY:r.pageY,this.screenX=r.screenX||0,this.screenY=r.screenY||0):(this.clientX=void 0!==e.clientX?e.clientX:e.pageX,this.clientY=void 0!==e.clientY?e.clientY:e.pageY,this.screenX=e.screenX||0,this.screenY=e.screenY||0),this.button=e.button,this.key=e.key||"",this.ctrlKey=e.ctrlKey,this.altKey=e.altKey,this.shiftKey=e.shiftKey,this.metaKey=e.metaKey,this.pointerId=e.pointerId||0,this.pointerType="string"==typeof e.pointerType?e.pointerType:xe[e.pointerType]||"",this.state=e.state,(this.i=e).defaultPrevented&&Se.$.h.call(this)}}e(Se,ce);var xe={2:"touch",3:"pen",4:"mouse"},De=(Se.prototype.h=function(){Se.$.h.call(this);var e=this.i;e.preventDefault?e.preventDefault():e.returnValue=!1},"closure_listenable_"+(1e6*Math.random()|0)),Ce=0;function Ae(e,t,n,r,s){this.listener=e,this.proxy=null,this.src=t,this.type=n,this.capture=!!r,this.la=s,this.key=++Ce,this.fa=this.ia=!1}function Ne(e){e.fa=!0,e.listener=null,e.proxy=null,e.src=null,e.la=null}function ke(e,t,n){for(const r in e)t.call(n,e[r],r,e)}function Re(e){const t={};for(const n in e)t[n]=e[n];return t}const Me="constructor hasOwnProperty isPrototypeOf propertyIsEnumerable toLocaleString toString valueOf".split(" ");function Le(t){let n,r;for(let e=1;e<arguments.length;e++){for(n in r=arguments[e])t[n]=r[n];for(let e=0;e<Me.length;e++)n=Me[e],Object.prototype.hasOwnProperty.call(r,n)&&(t[n]=r[n])}}function Oe(e){this.src=e,this.g={},this.h=0}function Fe(e,t){var n,r,s,i=t.type;i in e.g&&(n=e.g[i],(s=0<=(r=oe(n,t)))&&Array.prototype.splice.call(n,r,1),s&&(Ne(t),0==e.g[i].length&&(delete e.g[i],e.h--)))}function Pe(e,t,n,r){for(var s=0;s<e.length;++s){var i=e[s];if(!i.fa&&i.listener==t&&i.capture==!!n&&i.la==r)return s}return-1}Oe.prototype.add=function(e,t,n,r,s){var i=e.toString(),a=((e=this.g[i])||(e=this.g[i]=[],this.h++),Pe(e,t,r,s));return-1<a?(t=e[a],n||(t.ia=!1)):((t=new Ae(t,this.src,i,!!r,s)).ia=n,e.push(t)),t};var Ve="closure_lm_"+(1e6*Math.random()|0),Be={};function qe(e,t,n,r,s,i){if(!t)throw Error("Invalid event type");var a=te(s)?!!s.capture:!!s,o=je(e);if(o||(e[Ve]=o=new Oe(e)),(n=o.add(t,n,r,a,i)).proxy)return n;if(r=function(){const n=Ge;return function e(t){return n.call(e.src,e.listener,t)}}(),(n.proxy=r).src=e,r.listener=n,e.addEventListener)void 0===(s=le?s:a)&&(s=!1),e.addEventListener(t.toString(),r,s);else if(e.attachEvent)e.attachEvent(ze(t.toString()),r);else{if(!e.addListener||!e.removeListener)throw Error("addEventListener and attachEvent are unavailable.");e.addListener(r)}return n}function Ue(e){var t,n,r;"number"!=typeof e&&e&&!e.fa&&((t=e.src)&&t[De]?Fe(t.i,e):(n=e.type,r=e.proxy,t.removeEventListener?t.removeEventListener(n,r,e.capture):t.detachEvent?t.detachEvent(ze(n),r):t.addListener&&t.removeListener&&t.removeListener(r),(n=je(t))?(Fe(n,e),0==n.h&&(n.src=null,t[Ve]=null)):Ne(e)))}function ze(e){return e in Be?Be[e]:Be[e]="on"+e}function Ge(e,t){var n,r;return!!e.fa||(t=new Se(t,this),n=e.listener,r=e.la||e.src,e.ia&&Ue(e),n.call(r,t))}function je(e){return(e=e[Ve])instanceof Oe?e:null}var Ke="__closure_events_fn_"+(1e9*Math.random()>>>0);function Qe(t){return"function"==typeof t?t:(t[Ke]||(t[Ke]=function(e){return t.handleEvent(e)}),t[Ke])}function s(){ae.call(this),this.i=new Oe(this),(this.S=this).J=null}function $e(e,t){var n,r=e.J;if(r)for(n=[];r;r=r.J)n.push(r);if(e=e.S,r=t.type||t,"string"==typeof t?t=new ce(t,e):t instanceof ce?t.target=t.target||e:(a=t,Le(t=new ce(r,e),a)),a=!0,n)for(var s=n.length-1;0<=s;s--)var i=t.g=n[s],a=We(i,r,!0,t)&&a;if(a=We(i=t.g=e,r,!0,t)&&a,a=We(i,r,!1,t)&&a,n)for(s=0;s<n.length;s++)a=We(i=t.g=n[s],r,!1,t)&&a}function We(e,t,n,r){if(!(t=e.i.g[String(t)]))return!0;t=t.concat();for(var s=!0,i=0;i<t.length;++i){var a,o,u=t[i];u&&!u.fa&&u.capture==n&&(a=u.listener,o=u.la||u.src,u.ia&&Fe(e.i,u),s=!1!==a.call(o,r)&&s)}return s&&!r.defaultPrevented}e(s,ae),s.prototype[De]=!0,s.prototype.removeEventListener=function(e,t,n,r){!function e(t,n,r,s,i){if(Array.isArray(n))for(var a=0;a<n.length;a++)e(t,n[a],r,s,i);else s=te(s)?!!s.capture:!!s,r=Qe(r),t&&t[De]?(t=t.i,(n=String(n).toString())in t.g&&-1<(r=Pe(a=t.g[n],r,s,i))&&(Ne(a[r]),Array.prototype.splice.call(a,r,1),0==a.length&&(delete t.g[n],t.h--))):(t=t&&je(t))&&(n=t.g[n.toString()],(r=(t=-1)<(t=n?Pe(n,r,s,i):t)?n[t]:null)&&Ue(r))}(this,e,t,n,r)},s.prototype.N=function(){if(s.$.N.call(this),this.i){var e,t=this.i;for(e in t.g){for(var n=t.g[e],r=0;r<n.length;r++)Ne(n[r]);delete t.g[e],t.h--}}this.J=null},s.prototype.O=function(e,t,n,r){return this.i.add(String(e),t,!1,n,r)},s.prototype.P=function(e,t,n,r){return this.i.add(String(e),t,!0,n,r)};var He=x.JSON.stringify,Ye=new class{constructor(e,t){this.i=e,this.j=t,this.h=0,this.g=null}get(){let e;return 0<this.h?(this.h--,e=this.g,this.g=e.next,e.next=null):e=this.i(),e}}(()=>new Xe,e=>e.reset());class Xe{constructor(){this.next=this.g=this.h=null}set(e,t){this.h=e,this.g=t,this.next=null}reset(){this.next=this.g=this.h=null}}let Je,Ze=!1,et=new class{constructor(){this.h=this.g=null}add(e,t){const n=Ye.get();n.set(e,t),this.h?this.h.next=n:this.g=n,this.h=n}},tt=()=>{const e=x.Promise.resolve(void 0);Je=()=>{e.then(nt)}};var nt=()=>{for(var e;e=function(){var e=et;let t=null;return e.g&&(t=e.g,e.g=e.g.next,e.g||(e.h=null),t.next=null),t}();){try{e.h.call(e.g)}catch(e){!function(e){x.setTimeout(()=>{throw e},0)}(e)}var t=Ye;t.j(e),t.h<100&&(t.h++,e.next=t.g,t.g=e)}Ze=!1};function rt(e,t){s.call(this),this.h=e||1,this.g=t||x,this.j=se(this.qb,this),this.l=Date.now()}function st(e){e.ga=!1,e.T&&(e.g.clearTimeout(e.T),e.T=null)}function it(e,t,n){if("function"==typeof e)n&&(e=se(e,n));else{if(!e||"function"!=typeof e.handleEvent)throw Error("Invalid listener argument");e=se(e.handleEvent,e)}return 2147483647<Number(t)?-1:x.setTimeout(e,t||0)}e(rt,s),(t=rt.prototype).ga=!1,t.T=null,t.qb=function(){var e;this.ga&&(0<(e=Date.now()-this.l)&&e<.8*this.h?this.T=this.g.setTimeout(this.j,this.h-e):(this.T&&(this.g.clearTimeout(this.T),this.T=null),$e(this,"tick"),this.ga&&(st(this),this.start())))},t.start=function(){this.ga=!0,this.T||(this.T=this.g.setTimeout(this.j,this.h),this.l=Date.now())},t.N=function(){rt.$.N.call(this),st(this),delete this.g};class at extends ae{constructor(e,t){super(),this.m=e,this.j=t,this.h=null,this.i=!1,this.g=null}l(e){this.h=arguments,this.g?this.i=!0:function e(t){t.g=it(()=>{t.g=null,t.i&&(t.i=!1,e(t))},t.j);var n=t.h;t.h=null,t.m.apply(null,n)}(this)}N(){super.N(),this.g&&(x.clearTimeout(this.g),this.g=null,this.i=!1,this.h=null)}}function ot(e){ae.call(this),this.h=e,this.g={}}e(ot,ae);var ut=[];function ht(e,t,n,r){Array.isArray(n)||(n&&(ut[0]=n.toString()),n=ut);for(var s=0;s<n.length;s++){var i=function e(t,n,r,s,i){if(s&&s.once)return function e(t,n,r,s,i){if(Array.isArray(n)){for(var a=0;a<n.length;a++)e(t,n[a],r,s,i);return null}return r=Qe(r),t&&t[De]?t.P(n,r,te(s)?!!s.capture:!!s,i):qe(t,n,r,!0,s,i)}(t,n,r,s,i);if(Array.isArray(n)){for(var a=0;a<n.length;a++)e(t,n[a],r,s,i);return null}return r=Qe(r),t&&t[De]?t.O(n,r,te(s)?!!s.capture:!!s,i):qe(t,n,r,!1,s,i)}(t,n[s],r||e.handleEvent,!1,e.h||e);if(!i)break;e.g[i.key]=i}}function ct(e){ke(e.g,function(e,t){this.g.hasOwnProperty(t)&&Ue(e)},e),e.g={}}function lt(){this.g=!0}function dt(e,t,n,r){e.info(function(){return"XMLHTTP TEXT ("+t+"): "+function(e,t){if(!e.g)return t;if(!t)return null;try{var n=JSON.parse(t);if(n)for(e=0;e<n.length;e++)if(Array.isArray(n[e])){var r=n[e];if(!(r.length<2)){var s=r[1];if(Array.isArray(s)&&!(s.length<1)){var i=s[0];if("noop"!=i&&"stop"!=i&&"close"!=i)for(var a=1;a<s.length;a++)s[a]=""}}}return He(n)}catch(e){return t}}(e,n)+(r?" "+r:"")})}ot.prototype.N=function(){ot.$.N.call(this),ct(this)},ot.prototype.handleEvent=function(){throw Error("EventHandler.handleEvent not implemented")},lt.prototype.Ea=function(){this.g=!1},lt.prototype.info=function(){};var ft={},gt=null;function mt(){return gt=gt||new s}function pt(e){ce.call(this,ft.Ta,e)}function yt(){var e=mt();$e(e,new pt(e))}function vt(e,t){ce.call(this,ft.STAT_EVENT,e),this.stat=t}function wt(e){var t=mt();$e(t,new vt(t,e))}function _t(e,t){ce.call(this,ft.Ua,e),this.size=t}function bt(e,t){if("function"!=typeof e)throw Error("Fn must not be null and must be a function");return x.setTimeout(function(){e()},t)}ft.Ta="serverreachability",e(pt,ce),ft.STAT_EVENT="statevent",e(vt,ce),ft.Ua="timingevent",e(_t,ce);_e={NO_ERROR:0,rb:1,Eb:2,Db:3,yb:4,Cb:5,Fb:6,Qa:7,TIMEOUT:8,Ib:9},pe={wb:"complete",Sb:"success",Ra:"error",Qa:"abort",Kb:"ready",Lb:"readystatechange",TIMEOUT:"timeout",Gb:"incrementaldata",Jb:"progress",zb:"downloadprogress",$b:"uploadprogress"};function It(){}function Et(e){return e.h||(e.h=e.i())}function Tt(){}function St(){ce.call(this,"d")}function xt(){ce.call(this,"c")}function Dt(){}function Ct(e,t,n,r){this.l=e,this.j=t,this.m=n,this.W=r||1,this.U=new ot(this),this.P=kt,this.V=new rt(e=ve?125:void 0),this.I=null,this.i=!1,this.s=this.A=this.v=this.L=this.G=this.Y=this.B=null,this.F=[],this.g=null,this.C=0,this.o=this.u=null,this.ca=-1,this.J=!1,this.O=0,this.M=null,this.ba=this.K=this.aa=this.S=!1,this.h=new At}function At(){this.i=null,this.g="",this.h=!1}It.prototype.h=null,Z={OPEN:"a",vb:"b",Ra:"c",Hb:"d"},e(St,ce),e(xt,ce),e(Dt,It),Dt.prototype.g=function(){return new XMLHttpRequest},Dt.prototype.i=function(){return{}};var Nt=new Dt,kt=45e3,Rt={},Mt={};function Lt(e,t,n){e.L=1,e.v=Xt($t(t)),e.s=n,e.S=!0,Ot(e,null)}function Ot(e,t){e.G=Date.now(),Vt(e),e.A=$t(e.v);var a,o,u,h,c,l,n=e.A,r=e.W;Array.isArray(r)||(r=[String(r)]),ln(n.i,"t",r),e.C=0,n=e.l.J,e.h=new At,e.g=hr(e.l,n?t:null,!e.s),0<e.O&&(e.M=new at(se(e.Pa,e,e.g),e.O)),ht(e.U,e.g,"readystatechange",e.nb),t=e.I?Re(e.I):{},e.s?(e.u||(e.u="POST"),t["Content-Type"]="application/x-www-form-urlencoded",e.g.ha(e.A,e.u,e.s,t)):(e.u="GET",e.g.ha(e.A,e.u,null,t)),yt(),a=e.j,o=e.u,u=e.A,h=e.m,c=e.W,l=e.s,a.info(function(){if(a.g)if(l)for(var e="",t=l.split("&"),n=0;n<t.length;n++){var r,s,i=t[n].split("=");1<i.length&&(r=i[0],i=i[1],e=2<=(s=r.split("_")).length&&"type"==s[1]?e+(r+"=")+i+"&":e+(r+"=redacted&"))}else e=null;else e=l;return"XMLHTTP REQ ("+h+") [attempt "+c+"]: "+o+"\n"+u+"\n"+e})}function Ft(e){return e.g&&"GET"==e.u&&2!=e.L&&e.l.Ha}function Pt(e,t,n){let r=!0,s;for(;!e.J&&e.C<n.length;){if((s=(u=void 0,o=(i=e).C,-1==(u=(a=n).indexOf("\n",o))?Mt:(o=Number(a.substring(o,u)),isNaN(o)?Rt:(u+=1)+o>a.length?Mt:(a=a.slice(u,u+o),i.C=u+o,a))))==Mt){4==t&&(e.o=4,wt(14),r=!1),dt(e.j,e.m,null,"[Incomplete Response]");break}if(s==Rt){e.o=4,wt(15),dt(e.j,e.m,n,"[Invalid Chunk]"),r=!1;break}dt(e.j,e.m,s,null),Gt(e,s)}var i,a,o,u;Ft(e)&&s!=Mt&&s!=Rt&&(e.h.g="",e.C=0),4!=t||0!=n.length||e.h.h||(e.o=1,wt(16),r=!1),e.i=e.i&&r,r?0<n.length&&!e.ba&&(e.ba=!0,(t=e.l).g==e&&t.ca&&!t.M&&(t.l.info("Great, no buffering proxy detected. Bytes received: "+n.length),tr(t),t.M=!0,wt(11))):(dt(e.j,e.m,n,"[Invalid Chunked Response]"),zt(e),Ut(e))}function Vt(e){e.Y=Date.now()+e.P,Bt(e,e.P)}function Bt(e,t){if(null!=e.B)throw Error("WatchDog timer not null");e.B=bt(se(e.lb,e),t)}function qt(e){e.B&&(x.clearTimeout(e.B),e.B=null)}function Ut(e){0==e.l.H||e.J||sr(e.l,e)}function zt(e){qt(e);var t=e.M;t&&"function"==typeof t.sa&&t.sa(),e.M=null,st(e.V),ct(e.U),e.g&&(t=e.g,e.g=null,t.abort(),t.sa())}function Gt(e,t){try{var n=e.l;if(0!=n.H&&(n.g==e||yn(n.i,e)))if(!e.K&&yn(n.i,e)&&3==n.H){try{var r=n.Ja.g.parse(t)}catch(e){r=null}if(Array.isArray(r)&&3==r.length){var s=r;if(0==s[0]){e:if(!n.u){if(n.g){if(!(n.g.G+3e3<e.G))break e;rr(n),$n(n)}er(n),wt(18)}}else n.Fa=s[1],0<n.Fa-n.V&&s[2]<37500&&n.G&&0==n.A&&!n.v&&(n.v=bt(se(n.ib,n),6e3));if(pn(n.i)<=1&&n.oa){try{n.oa()}catch(e){}n.oa=void 0}}else ar(n,11)}else if(!e.K&&n.g!=e||rr(n),!de(t))for(s=n.Ja.g.parse(t),t=0;t<s.length;t++){var i=s[t];if(n.V=i[0],i=i[1],2==n.H)if("c"==i[0]){n.K=i[1],n.pa=i[2];var a=i[3],o=(null!=a&&(n.ra=a,n.l.info("VER="+n.ra)),i[4]);null!=o&&(n.Ga=o,n.l.info("SVER="+n.Ga));var u,h,c=i[5];null!=c&&"number"==typeof c&&0<c&&(r=1.5*c,n.L=r,n.l.info("backChannelRequestTimeoutMs_="+r)),r=n;const g=e.g;if(g){const m=g.g?g.g.getResponseHeader("X-Client-Wire-Protocol"):null;!m||(u=r.i).g||-1==m.indexOf("spdy")&&-1==m.indexOf("quic")&&-1==m.indexOf("h2")||(u.j=u.l,u.g=new Set,u.h&&(vn(u,u.h),u.h=null)),r.F&&(h=g.g?g.g.getResponseHeader("X-HTTP-Session-Id"):null)&&(r.Da=h,p(r.I,r.F,h))}n.H=3,n.h&&n.h.Ba(),n.ca&&(n.S=Date.now()-e.G,n.l.info("Handshake RTT: "+n.S+"ms"));var l,d,f=e;(r=n).wa=ur(r,r.J?r.pa:null,r.Y),f.K?(wn(r.i,f),l=f,(d=r.L)&&l.setTimeout(d),l.B&&(qt(l),Vt(l)),r.g=f):Zn(r),0<n.j.length&&Hn(n)}else"stop"!=i[0]&&"close"!=i[0]||ar(n,7);else 3==n.H&&("stop"==i[0]||"close"==i[0]?"stop"==i[0]?ar(n,7):Qn(n):"noop"!=i[0]&&n.h&&n.h.Aa(i),n.A=0)}yt()}catch(e){}}function jt(e,t){if(e.forEach&&"function"==typeof e.forEach)e.forEach(t,void 0);else if(ee(e)||"string"==typeof e)Array.prototype.forEach.call(e,t,void 0);else for(var n=function(e){if(e.ta&&"function"==typeof e.ta)return e.ta();if(!e.Z||"function"!=typeof e.Z){if("undefined"!=typeof Map&&e instanceof Map)return Array.from(e.keys());if(!("undefined"!=typeof Set&&e instanceof Set)){if(ee(e)||"string"==typeof e){var t=[];e=e.length;for(var n=0;n<e;n++)t.push(n);return t}t=[],n=0;for(const r in e)t[n++]=r;return t}}}(e),r=function(e){if(e.Z&&"function"==typeof e.Z)return e.Z();if("undefined"!=typeof Map&&e instanceof Map||"undefined"!=typeof Set&&e instanceof Set)return Array.from(e.values());if("string"==typeof e)return e.split("");if(ee(e)){for(var t=[],n=e.length,r=0;r<n;r++)t.push(e[r]);return t}for(r in t=[],n=0,e)t[n++]=e[r];return t}(e),s=r.length,i=0;i<s;i++)t.call(void 0,r[i],n&&n[i],e)}(t=Ct.prototype).setTimeout=function(e){this.P=e},t.nb=function(e){e=e.target;const t=this.M;t&&3==qn(e)?t.l():this.Pa(e)},t.Pa=function(e){try{if(e==this.g)e:{var t=qn(this.g),n=this.g.Ia();if(this.g.da(),!(t<3)&&(3!=t||ve||this.g&&(this.h.h||this.g.ja()||Un(this.g)))){this.J||4!=t||7==n||yt(),qt(this);var r=this.g.da();this.ca=r;t:if(Ft(this)){var s=Un(this.g),i=(e="",s.length),a=4==qn(this.g);if(!this.h.i){if("undefined"==typeof TextDecoder){zt(this),Ut(this);var o="";break t}this.h.i=new x.TextDecoder}for(n=0;n<i;n++)this.h.h=!0,e+=this.h.i.decode(s[n],{stream:a&&n==i-1});s.splice(0,i),this.h.g+=e,this.C=0,o=this.h.g}else o=this.g.ja();if(this.i=200==r,p=this.j,y=this.u,v=this.A,w=this.m,_=this.W,b=t,I=r,p.info(function(){return"XMLHTTP RESP ("+w+") [ attempt "+_+"]: "+y+"\n"+v+"\n"+b+" "+I}),this.i){if(this.aa&&!this.K){t:{if(this.g){var u,h=this.g;if((u=h.g?h.g.getResponseHeader("X-HTTP-Initial-Response"):null)&&!de(u)){var c=u;break t}}c=null}if(!(r=c)){this.i=!1,this.o=3,wt(12),zt(this),Ut(this);break e}dt(this.j,this.m,r,"Initial handshake response via X-HTTP-Initial-Response"),this.K=!0,Gt(this,r)}this.S?(Pt(this,t,o),ve&&this.i&&3==t&&(ht(this.U,this.V,"tick",this.mb),this.V.start())):(dt(this.j,this.m,o,null),Gt(this,o)),4==t&&zt(this),this.i&&!this.J&&(4==t?sr(this.l,this):(this.i=!1,Vt(this)))}else{{var l=this.g;const E={};l=(l.g&&2<=qn(l)&&l.g.getAllResponseHeaders()||"").split("\r\n");for(let e=0;e<l.length;e++)if(!de(l[e])){var d=function(e){var t=1;e=e.split(":");const n=[];for(;0<t&&e.length;)n.push(e.shift()),t--;return e.length&&n.push(e.join(":")),n}(l[e]),f=d[0];if("string"==typeof(d=d[1])){d=d.trim();const T=E[f]||[];(E[f]=T).push(d)}}function g(e){return e.join(", ")}var m=E;for(const S in m)g.call(void 0,m[S],S,m)}400==r&&0<o.indexOf("Unknown SID")?(this.o=3,wt(12)):(this.o=0,wt(13)),zt(this),Ut(this)}}}}catch(e){}var p,y,v,w,_,b,I},t.mb=function(){var e,t;this.g&&(e=qn(this.g),t=this.g.ja(),this.C<t.length&&(qt(this),Pt(this,e,t),this.i&&4!=e&&Vt(this)))},t.cancel=function(){this.J=!0,zt(this)},t.lb=function(){this.B=null;var e,t,n=Date.now();0<=n-this.Y?(e=this.j,t=this.A,e.info(function(){return"TIMEOUT: "+t}),2!=this.L&&(yt(),wt(17)),zt(this),this.o=2,Ut(this)):Bt(this,this.Y-n)};var Kt=RegExp("^(?:([^:/?#.]+):)?(?://(?:([^\\\\/?#]*)@)?([^\\\\/?#]*?)(?::([0-9]+))?(?=[\\\\/?#]|$))?([^?#]+)?(?:\\?([^#]*))?(?:#([\\s\\S]*))?$");function Qt(e){var t,n;this.g=this.s=this.j="",this.m=null,this.o=this.l="",this.h=!1,e instanceof Qt?(this.h=e.h,Wt(this,e.j),this.s=e.s,this.g=e.g,Ht(this,e.m),this.l=e.l,t=e.i,(n=new on).i=t.i,t.g&&(n.g=new Map(t.g),n.h=t.h),Yt(this,n),this.o=e.o):e&&(t=String(e).match(Kt))?(this.h=!1,Wt(this,t[1]||"",!0),this.s=Jt(t[2]||""),this.g=Jt(t[3]||"",!0),Ht(this,t[4]),this.l=Jt(t[5]||"",!0),Yt(this,t[6]||"",!0),this.o=Jt(t[7]||"")):(this.h=!1,this.i=new on(null,this.h))}function $t(e){return new Qt(e)}function Wt(e,t,n){e.j=n?Jt(t,!0):t,e.j&&(e.j=e.j.replace(/:$/,""))}function Ht(e,t){if(t){if(t=Number(t),isNaN(t)||t<0)throw Error("Bad port number "+t);e.m=t}else e.m=null}function Yt(e,t,n){var r,s;t instanceof on?(e.i=t,r=e.i,(s=e.h)&&!r.j&&(un(r),r.i=null,r.g.forEach(function(e,t){var n=t.toLowerCase();t!=n&&(hn(this,t),ln(this,n,e))},r)),r.j=s):(n||(t=Zt(t,sn)),e.i=new on(t,e.h))}function p(e,t,n){e.i.set(t,n)}function Xt(e){return p(e,"zx",Math.floor(2147483648*Math.random()).toString(36)+Math.abs(Math.floor(2147483648*Math.random())^Date.now()).toString(36)),e}function Jt(e,t){return e?t?decodeURI(e.replace(/%25/g,"%2525")):decodeURIComponent(e):""}function Zt(e,t,n){return"string"==typeof e?(e=encodeURI(e).replace(t,en),n?e.replace(/%25([0-9a-fA-F]{2})/g,"%$1"):e):null}function en(e){return"%"+((e=e.charCodeAt(0))>>4&15).toString(16)+(15&e).toString(16)}Qt.prototype.toString=function(){var e=[],t=this.j,n=(t&&e.push(Zt(t,tn,!0),":"),this.g);return!n&&"file"!=t||(e.push("//"),(t=this.s)&&e.push(Zt(t,tn,!0),"@"),e.push(encodeURIComponent(String(n)).replace(/%25([0-9a-fA-F]{2})/g,"%$1")),null!=(n=this.m)&&e.push(":",String(n))),(n=this.l)&&(this.g&&"/"!=n.charAt(0)&&e.push("/"),e.push(Zt(n,"/"==n.charAt(0)?rn:nn,!0))),(n=this.i.toString())&&e.push("?",n),(n=this.o)&&e.push("#",Zt(n,an)),e.join("")};var tn=/[#\/\?@]/g,nn=/[#\?:]/g,rn=/[#\?]/g,sn=/[#\?@]/g,an=/#/g;function on(e,t){this.h=this.g=null,this.i=e||null,this.j=!!t}function un(e){if(!e.g&&(e.g=new Map,e.h=0,e.i)){var t=e.i;if(t){t=t.split("&");for(var n=0;n<t.length;n++){var r,s=t[n].indexOf("="),i=null;0<=s?(r=t[n].substring(0,s),i=t[n].substring(s+1)):r=t[n],s=r,i=i?decodeURIComponent(i.replace(/\+/g," ")):"",e.add(decodeURIComponent(s.replace(/\+/g," ")),i)}}}}function hn(e,t){un(e),t=dn(e,t),e.g.has(t)&&(e.i=null,e.h-=e.g.get(t).length,e.g.delete(t))}function cn(e,t){return un(e),t=dn(e,t),e.g.has(t)}function ln(e,t,n){hn(e,t),0<n.length&&(e.i=null,e.g.set(dn(e,t),ue(n)),e.h+=n.length)}function dn(e,t){return t=String(t),e.j?t.toLowerCase():t}(t=on.prototype).add=function(e,t){un(this),this.i=null,e=dn(this,e);var n=this.g.get(e);return n||this.g.set(e,n=[]),n.push(t),this.h+=1,this},t.forEach=function(n,r){un(this),this.g.forEach(function(e,t){e.forEach(function(e){n.call(r,e,t,this)},this)},this)},t.ta=function(){un(this);const e=Array.from(this.g.values()),n=Array.from(this.g.keys()),r=[];for(let t=0;t<n.length;t++){var s=e[t];for(let e=0;e<s.length;e++)r.push(n[t])}return r},t.Z=function(t){un(this);let n=[];if("string"==typeof t)cn(this,t)&&(n=n.concat(this.g.get(dn(this,t))));else{t=Array.from(this.g.values());for(let e=0;e<t.length;e++)n=n.concat(t[e])}return n},t.set=function(e,t){return un(this),this.i=null,cn(this,e=dn(this,e))&&(this.h-=this.g.get(e).length),this.g.set(e,[t]),this.h+=1,this},t.get=function(e,t){return e&&0<(e=this.Z(e)).length?String(e[0]):t},t.toString=function(){if(this.i)return this.i;if(!this.g)return"";const e=[],t=Array.from(this.g.keys());for(var n=0;n<t.length;n++)for(var r=t[n],s=encodeURIComponent(String(r)),i=this.Z(r),r=0;r<i.length;r++){var a=s;""!==i[r]&&(a+="="+encodeURIComponent(String(i[r]))),e.push(a)}return this.i=e.join("&")};var fn=class{constructor(e,t){this.g=e,this.map=t}};function gn(e){this.l=e||10,e=x.PerformanceNavigationTiming?0<(e=x.performance.getEntriesByType("navigation")).length&&("hq"==e[0].nextHopProtocol||"h2"==e[0].nextHopProtocol):!!(x.g&&x.g.Ka&&x.g.Ka()&&x.g.Ka().dc),this.j=e?this.l:1,this.g=null,1<this.j&&(this.g=new Set),this.h=null,this.i=[]}function mn(e){return e.h||e.g&&e.g.size>=e.j}function pn(e){return e.h?1:e.g?e.g.size:0}function yn(e,t){return e.h?e.h==t:e.g&&e.g.has(t)}function vn(e,t){e.g?e.g.add(t):e.h=t}function wn(e,t){e.h&&e.h==t?e.h=null:e.g&&e.g.has(t)&&e.g.delete(t)}function _n(t){if(null!=t.h)return t.i.concat(t.h.F);if(null==t.g||0===t.g.size)return ue(t.i);{let e=t.i;for(const n of t.g.values())e=e.concat(n.F);return e}}gn.prototype.cancel=function(){if(this.i=_n(this),this.h)this.h.cancel(),this.h=null;else if(this.g&&0!==this.g.size){for(const e of this.g.values())e.cancel();this.g.clear()}};var bn,In=class{stringify(e){return x.JSON.stringify(e,void 0)}parse(e){return x.JSON.parse(e,void 0)}};function En(){this.g=new In}function Tn(e,t,n,r,s){try{t.onload=null,t.onerror=null,t.onabort=null,t.ontimeout=null,s(r)}catch(e){}}function Sn(e){this.l=e.ec||null,this.j=e.ob||!1}function xn(e,t){s.call(this),this.F=e,this.u=t,this.m=void 0,this.readyState=Dn,this.status=0,this.responseType=this.responseText=this.response=this.statusText="",this.onreadystatechange=null,this.v=new Headers,this.h=null,this.C="GET",this.B="",this.g=!1,this.A=this.j=this.l=null}e(Sn,It),Sn.prototype.g=function(){return new xn(this.l,this.j)},Sn.prototype.i=(bn={},function(){return bn}),e(xn,s);var Dn=0;function Cn(e){e.j.read().then(e.Xa.bind(e)).catch(e.ka.bind(e))}function An(e){e.readyState=4,e.l=null,e.j=null,e.A=null,Nn(e)}function Nn(e){e.onreadystatechange&&e.onreadystatechange.call(e)}(t=xn.prototype).open=function(e,t){if(this.readyState!=Dn)throw this.abort(),Error("Error reopening a connection");this.C=e,this.B=t,this.readyState=1,Nn(this)},t.send=function(e){if(1!=this.readyState)throw this.abort(),Error("need to call open() first. ");this.g=!0;const t={headers:this.v,method:this.C,credentials:this.m,cache:void 0};e&&(t.body=e),(this.F||x).fetch(new Request(this.B,t)).then(this.$a.bind(this),this.ka.bind(this))},t.abort=function(){this.response=this.responseText="",this.v=new Headers,this.status=0,this.j&&this.j.cancel("Request was aborted.").catch(()=>{}),1<=this.readyState&&this.g&&4!=this.readyState&&(this.g=!1,An(this)),this.readyState=Dn},t.$a=function(e){if(this.g&&(this.l=e,this.h||(this.status=this.l.status,this.statusText=this.l.statusText,this.h=e.headers,this.readyState=2,Nn(this)),this.g&&(this.readyState=3,Nn(this),this.g)))if("arraybuffer"===this.responseType)e.arrayBuffer().then(this.Ya.bind(this),this.ka.bind(this));else if(void 0!==x.ReadableStream&&"body"in e){if(this.j=e.body.getReader(),this.u){if(this.responseType)throw Error('responseType must be empty for "streamBinaryChunks" mode responses.');this.response=[]}else this.response=this.responseText="",this.A=new TextDecoder;Cn(this)}else e.text().then(this.Za.bind(this),this.ka.bind(this))},t.Xa=function(e){var t;this.g&&(this.u&&e.value?this.response.push(e.value):this.u||(t=e.value||new Uint8Array(0),(t=this.A.decode(t,{stream:!e.done}))&&(this.response=this.responseText+=t)),(e.done?An:Nn)(this),3==this.readyState&&Cn(this))},t.Za=function(e){this.g&&(this.response=this.responseText=e,An(this))},t.Ya=function(e){this.g&&(this.response=e,An(this))},t.ka=function(){this.g&&An(this)},t.setRequestHeader=function(e,t){this.v.append(e,t)},t.getResponseHeader=function(e){return this.h&&this.h.get(e.toLowerCase())||""},t.getAllResponseHeaders=function(){if(!this.h)return"";const e=[],t=this.h.entries();for(var n=t.next();!n.done;)n=n.value,e.push(n[0]+": "+n[1]),n=t.next();return e.join("\r\n")},Object.defineProperty(xn.prototype,"withCredentials",{get:function(){return"include"===this.m},set:function(e){this.m=e?"include":"same-origin"}});var kn=x.JSON.parse;function r(e){s.call(this),this.headers=new Map,this.u=e||null,this.h=!1,this.C=this.g=null,this.I="",this.m=0,this.j="",this.l=this.G=this.v=this.F=!1,this.B=0,this.A=null,this.K=Rn,this.L=this.M=!1}e(r,s);var Rn="",Mn=/^https?$/i,Ln=["POST","PUT"];function On(e,t){e.h=!1,e.g&&(e.l=!0,e.g.abort(),e.l=!1),e.j=t,e.m=5,Fn(e),Vn(e)}function Fn(e){e.F||(e.F=!0,$e(e,"complete"),$e(e,"error"))}function Pn(e){if(e.h&&(!e.C[1]||4!=qn(e)||2!=e.da()))if(e.v&&4==qn(e))it(e.La,0,e);else if($e(e,"readystatechange"),4==qn(e)){e.h=!1;try{var t,n,r,s=e.da();switch(s){case 200:case 201:case 202:case 204:case 206:case 304:case 1223:var i=!0;break;default:i=!1}if((t=i)||((n=0===s)&&(!(r=String(e.I).match(Kt)[1]||null)&&x.self&&x.self.location&&(r=x.self.location.protocol.slice(0,-1)),n=!Mn.test(r?r.toLowerCase():"")),t=n),t)$e(e,"complete"),$e(e,"success");else{e.m=6;try{var a=2<qn(e)?e.g.statusText:""}catch(e){a=""}e.j=a+" ["+e.da()+"]",Fn(e)}}finally{Vn(e)}}}function Vn(e,t){if(e.g){Bn(e);const n=e.g,r=e.C[0]?()=>{}:null;e.g=null,e.C=null,t||$e(e,"ready");try{n.onreadystatechange=r}catch(e){}}}function Bn(e){e.g&&e.L&&(e.g.ontimeout=null),e.A&&(x.clearTimeout(e.A),e.A=null)}function qn(e){return e.g?e.g.readyState:0}function Un(e){try{if(!e.g)return null;if("response"in e.g)return e.g.response;switch(e.K){case Rn:case"text":return e.g.responseText;case"arraybuffer":if("mozResponseArrayBuffer"in e.g)return e.g.mozResponseArrayBuffer}return null}catch(e){return null}}function zn(e){let n="";return ke(e,function(e,t){n=(n=n+t+":")+e+"\r\n"}),n}function Gn(e,t,n){e:{for(r in n){var r=!1;break e}r=!0}r||(n=zn(n),"string"==typeof e?null!=n&&encodeURIComponent(String(n)):p(e,t,n))}function jn(e,t,n){return n&&n.internalChannelParams&&n.internalChannelParams[e]||t}function Kn(e){this.Ga=0,this.j=[],this.l=new lt,this.pa=this.wa=this.I=this.Y=this.g=this.Da=this.F=this.na=this.o=this.U=this.s=null,this.fb=this.W=0,this.cb=jn("failFast",!1,e),this.G=this.v=this.u=this.m=this.h=null,this.aa=!0,this.Fa=this.V=-1,this.ba=this.A=this.C=0,this.ab=jn("baseRetryDelayMs",5e3,e),this.hb=jn("retryDelaySeedMs",1e4,e),this.eb=jn("forwardChannelMaxRetries",2,e),this.xa=jn("forwardChannelRequestTimeoutMs",2e4,e),this.va=e&&e.xmlHttpFactory||void 0,this.Ha=e&&e.useFetchStreams||!1,this.L=void 0,this.J=e&&e.supportsCrossDomainXhr||!1,this.K="",this.i=new gn(e&&e.concurrentRequestLimit),this.Ja=new En,this.P=e&&e.fastHandshake||!1,this.O=e&&e.encodeInitMessageHeaders||!1,this.P&&this.O&&(this.O=!1),this.bb=e&&e.bc||!1,e&&e.Ea&&this.l.Ea(),e&&e.forceLongPolling&&(this.aa=!1),this.ca=!this.P&&this.aa&&e&&e.detectBufferingProxy||!1,this.qa=void 0,e&&e.longPollingTimeout&&0<e.longPollingTimeout&&(this.qa=e.longPollingTimeout),this.oa=void 0,this.S=0,this.M=!1,this.ma=this.B=null}function Qn(e){if(Wn(e),3==e.H){var t=e.W++,n=$t(e.I);if(p(n,"SID",e.K),p(n,"RID",t),p(n,"TYPE","terminate"),Xn(e,n),(t=new Ct(e,e.l,t)).L=2,t.v=Xt($t(n)),n=!1,x.navigator&&x.navigator.sendBeacon)try{n=x.navigator.sendBeacon(t.v.toString(),"")}catch(e){}!n&&x.Image&&((new Image).src=t.v,n=!0),n||(t.g=hr(t.l,null),t.g.ha(t.v)),t.G=Date.now(),Vt(t)}or(e)}function $n(e){e.g&&(tr(e),e.g.cancel(),e.g=null)}function Wn(e){$n(e),e.u&&(x.clearTimeout(e.u),e.u=null),rr(e),e.i.cancel(),e.m&&("number"==typeof e.m&&x.clearTimeout(e.m),e.m=null)}function Hn(e){var t;mn(e.i)||e.m||(e.m=!0,t=e.Na,Je||tt(),Ze||(Je(),Ze=!0),et.add(t,e),e.C=0)}function Yn(e,t){var n=t?t.m:e.W++,r=$t(e.I);p(r,"SID",e.K),p(r,"RID",n),p(r,"AID",e.V),Xn(e,r),e.o&&e.s&&Gn(r,e.o,e.s),n=new Ct(e,e.l,n,e.C+1),null===e.o&&(n.I=e.s),t&&(e.j=t.F.concat(e.j)),t=Jn(e,n,1e3),n.setTimeout(Math.round(.5*e.xa)+Math.round(.5*e.xa*Math.random())),vn(e.i,n),Lt(n,r,t)}function Xn(e,n){e.na&&ke(e.na,function(e,t){p(n,t,e)}),e.h&&jt({},function(e,t){p(n,t,e)})}function Jn(r,e,s){s=Math.min(r.j.length,s);var i=r.h?se(r.h.Va,r.h,r):null;e:{var a=r.j;let n=-1;for(;;){const h=["count="+s];-1==n?0<s?(n=a[0].g,h.push("ofs="+n)):n=0:h.push("ofs="+n);let t=!0;for(let e=0;e<s;e++){var o=a[e].g,u=a[e].map;if((o-=n)<0)n=Math.max(0,a[e].g-100),t=!1;else try{!function(e,r){const s="req"+o+"_"||"";try{jt(e,function(e,t){let n=e;te(e)&&(n=He(e)),r.push(s+t+"="+encodeURIComponent(n))})}catch(e){throw r.push(s+"type="+encodeURIComponent("_badmap")),e}}(u,h)}catch(r){i&&i(u)}}if(t){i=h.join("&");break e}}}return r=r.j.splice(0,s),e.F=r,i}function Zn(e){var t;e.g||e.u||(e.ba=1,t=e.Ma,Je||tt(),Ze||(Je(),Ze=!0),et.add(t,e),e.A=0)}function er(e){return!(e.g||e.u||3<=e.A)&&(e.ba++,e.u=bt(se(e.Ma,e),ir(e,e.A)),e.A++,1)}function tr(e){null!=e.B&&(x.clearTimeout(e.B),e.B=null)}function nr(e){e.g=new Ct(e,e.l,"rpc",e.ba),null===e.o&&(e.g.I=e.s),e.g.O=0;var t=$t(e.wa),n=(p(t,"RID","rpc"),p(t,"SID",e.K),p(t,"AID",e.V),p(t,"CI",e.G?"0":"1"),!e.G&&e.qa&&p(t,"TO",e.qa),p(t,"TYPE","xmlhttp"),Xn(e,t),e.o&&e.s&&Gn(t,e.o,e.s),e.L&&e.g.setTimeout(e.L),e.g);e=e.pa,n.L=1,n.v=Xt($t(t)),n.s=null,n.S=!0,Ot(n,e)}function rr(e){null!=e.v&&(x.clearTimeout(e.v),e.v=null)}function sr(e,t){var n,r,s,i=null;if(e.g==t){rr(e),tr(e),e.g=null;var a=2}else{if(!yn(e.i,t))return;i=t.F,wn(e.i,t),a=1}if(0!=e.H)if(t.i)1==a?(i=t.s?t.s.length:0,t=Date.now()-t.G,n=e.C,$e(a=mt(),new _t(a,i)),Hn(e)):Zn(e);else if(3==(n=t.o)||0==n&&0<t.ca||(1!=a||(s=t,pn((r=e).i)>=r.i.j-(r.m?1:0)||(r.m?(r.j=s.F.concat(r.j),0):1==r.H||2==r.H||r.C>=(r.cb?0:r.eb)||(r.m=bt(se(r.Na,r,s),ir(r,r.C)),r.C++,0))))&&(2!=a||!er(e)))switch(i&&0<i.length&&(t=e.i,t.i=t.i.concat(i)),n){case 1:ar(e,5);break;case 4:ar(e,10);break;case 3:ar(e,6);break;default:ar(e,2)}}function ir(e,t){let n=e.ab+Math.floor(Math.random()*e.hb);return e.isActive()||(n*=2),n*t}function ar(e,t){if(e.l.info("Error code "+t),2==t){n=null,e.h&&(n=null),r=se(e.pb,e),n||(n=new Qt("//www.google.com/images/cleardot.gif"),x.location&&"http"==x.location.protocol||Wt(n,"https"),Xt(n));var n=n.toString(),r,s=new lt;if(x.Image){const i=new Image;i.onload=ie(Tn,s,i,"TestLoadImage: loaded",!0,r),i.onerror=ie(Tn,s,i,"TestLoadImage: error",!1,r),i.onabort=ie(Tn,s,i,"TestLoadImage: abort",!1,r),i.ontimeout=ie(Tn,s,i,"TestLoadImage: timeout",!1,r),x.setTimeout(function(){i.ontimeout&&i.ontimeout()},1e4),i.src=n}else r(!1)}else wt(2);e.H=0,e.h&&e.h.za(t),or(e),Wn(e)}function or(e){var t;e.H=0,e.ma=[],e.h&&(0==(t=_n(e.i)).length&&0==e.j.length||(he(e.ma,t),he(e.ma,e.j),e.i.i.length=0,ue(e.j),e.j.length=0),e.h.ya())}function ur(e,t,n){var r,s,i=n instanceof Qt?$t(n):new Qt(n);return""!=i.g?(t&&(i.g=t+"."+i.g),Ht(i,i.m)):(i=(r=x.location).protocol,t=t?t+"."+r.hostname:r.hostname,r=+r.port,s=new Qt(null),i&&Wt(s,i),t&&(s.g=t),r&&Ht(s,r),n&&(s.l=n),i=s),n=e.F,t=e.Da,n&&t&&p(i,n,t),p(i,"VER",e.ra),Xn(e,i),i}function hr(e,t,n){if(t&&!e.J)throw Error("Can't create secondary domain capable XhrIo object.");return(t=n&&e.Ha&&!e.va?new r(new Sn({ob:!0})):new r(e.va)).Oa(e.J),t}function cr(){}function lr(){if(ye&&!(10<=Number(Te)))throw Error("Environmental error: no available transport.")}function dr(e,t){s.call(this),this.g=new Kn(t),this.l=e,this.h=t&&t.messageUrlParams||null,e=t&&t.messageHeaders||null,t&&t.clientProtocolHeaderRequired&&(e?e["X-Client-Protocol"]="webchannel":e={"X-Client-Protocol":"webchannel"}),this.g.s=e,e=t&&t.initMessageHeaders||null,t&&t.messageContentType&&(e?e["X-WebChannel-Content-Type"]=t.messageContentType:e={"X-WebChannel-Content-Type":t.messageContentType}),t&&t.Ca&&(e?e["X-WebChannel-Client-Profile"]=t.Ca:e={"X-WebChannel-Client-Profile":t.Ca}),this.g.U=e,(e=t&&t.cc)&&!de(e)&&(this.g.o=e),this.A=t&&t.supportsCrossDomainXhr||!1,this.v=t&&t.sendRawJson||!1,(t=t&&t.httpSessionIdParam)&&!de(t)&&(this.g.F=t,null!==(e=this.h)&&t in e&&t in(e=this.h)&&delete e[t]),this.j=new mr(this)}function fr(e){St.call(this),e.__headers__&&(this.headers=e.__headers__,this.statusCode=e.__status__,delete e.__headers__,delete e.__status__);var t=e.__sm__;if(t){e:{for(const n in t){e=n;break e}e=void 0}(this.i=e)&&(e=this.i,t=null!==t&&e in t?t[e]:void 0),this.data=t}else this.data=e}function gr(){xt.call(this),this.status=1}function mr(e){this.g=e}function pr(){this.blockSize=-1,this.blockSize=64,this.g=Array(4),this.m=Array(this.blockSize),this.i=this.h=0,this.reset()}function yr(e,t,n){n=n||0;var r=Array(16);if("string"==typeof t)for(var s=0;s<16;++s)r[s]=t.charCodeAt(n++)|t.charCodeAt(n++)<<8|t.charCodeAt(n++)<<16|t.charCodeAt(n++)<<24;else for(s=0;s<16;++s)r[s]=t[n++]|t[n++]<<8|t[n++]<<16|t[n++]<<24;t=e.g[0],n=e.g[1];var s=e.g[2],i=e.g[3],a=(n=(s=(i=(t=(n=(s=(i=(t=(n=(s=(i=(t=(n=(s=(i=(t=(n=(s=(i=(t=(n=(s=(i=(t=(n=(s=(i=(t=(n=(s=(i=(t=(n=(s=(i=(t=(n=(s=(i=(t=(n=(s=(i=(t=(n=(s=(i=(t=(n=(s=(i=(t=(n=(s=(i=(t=(n=(s=(i=(t=n+((a=t+(i^n&(s^i))+r[0]+3614090360&4294967295)<<7&4294967295|a>>>25))+((a=i+(s^t&(n^s))+r[1]+3905402710&4294967295)<<12&4294967295|a>>>20))+((a=s+(n^i&(t^n))+r[2]+606105819&4294967295)<<17&4294967295|a>>>15))+((a=n+(t^s&(i^t))+r[3]+3250441966&4294967295)<<22&4294967295|a>>>10))+((a=t+(i^n&(s^i))+r[4]+4118548399&4294967295)<<7&4294967295|a>>>25))+((a=i+(s^t&(n^s))+r[5]+1200080426&4294967295)<<12&4294967295|a>>>20))+((a=s+(n^i&(t^n))+r[6]+2821735955&4294967295)<<17&4294967295|a>>>15))+((a=n+(t^s&(i^t))+r[7]+4249261313&4294967295)<<22&4294967295|a>>>10))+((a=t+(i^n&(s^i))+r[8]+1770035416&4294967295)<<7&4294967295|a>>>25))+((a=i+(s^t&(n^s))+r[9]+2336552879&4294967295)<<12&4294967295|a>>>20))+((a=s+(n^i&(t^n))+r[10]+4294925233&4294967295)<<17&4294967295|a>>>15))+((a=n+(t^s&(i^t))+r[11]+2304563134&4294967295)<<22&4294967295|a>>>10))+((a=t+(i^n&(s^i))+r[12]+1804603682&4294967295)<<7&4294967295|a>>>25))+((a=i+(s^t&(n^s))+r[13]+4254626195&4294967295)<<12&4294967295|a>>>20))+((a=s+(n^i&(t^n))+r[14]+2792965006&4294967295)<<17&4294967295|a>>>15))+((a=n+(t^s&(i^t))+r[15]+1236535329&4294967295)<<22&4294967295|a>>>10))+((a=t+(s^i&(n^s))+r[1]+4129170786&4294967295)<<5&4294967295|a>>>27))+((a=i+(n^s&(t^n))+r[6]+3225465664&4294967295)<<9&4294967295|a>>>23))+((a=s+(t^n&(i^t))+r[11]+643717713&4294967295)<<14&4294967295|a>>>18))+((a=n+(i^t&(s^i))+r[0]+3921069994&4294967295)<<20&4294967295|a>>>12))+((a=t+(s^i&(n^s))+r[5]+3593408605&4294967295)<<5&4294967295|a>>>27))+((a=i+(n^s&(t^n))+r[10]+38016083&4294967295)<<9&4294967295|a>>>23))+((a=s+(t^n&(i^t))+r[15]+3634488961&4294967295)<<14&4294967295|a>>>18))+((a=n+(i^t&(s^i))+r[4]+3889429448&4294967295)<<20&4294967295|a>>>12))+((a=t+(s^i&(n^s))+r[9]+568446438&4294967295)<<5&4294967295|a>>>27))+((a=i+(n^s&(t^n))+r[14]+3275163606&4294967295)<<9&4294967295|a>>>23))+((a=s+(t^n&(i^t))+r[3]+4107603335&4294967295)<<14&4294967295|a>>>18))+((a=n+(i^t&(s^i))+r[8]+1163531501&4294967295)<<20&4294967295|a>>>12))+((a=t+(s^i&(n^s))+r[13]+2850285829&4294967295)<<5&4294967295|a>>>27))+((a=i+(n^s&(t^n))+r[2]+4243563512&4294967295)<<9&4294967295|a>>>23))+((a=s+(t^n&(i^t))+r[7]+1735328473&4294967295)<<14&4294967295|a>>>18))+((a=n+(i^t&(s^i))+r[12]+2368359562&4294967295)<<20&4294967295|a>>>12))+((a=t+(n^s^i)+r[5]+4294588738&4294967295)<<4&4294967295|a>>>28))+((a=i+(t^n^s)+r[8]+2272392833&4294967295)<<11&4294967295|a>>>21))+((a=s+(i^t^n)+r[11]+1839030562&4294967295)<<16&4294967295|a>>>16))+((a=n+(s^i^t)+r[14]+4259657740&4294967295)<<23&4294967295|a>>>9))+((a=t+(n^s^i)+r[1]+2763975236&4294967295)<<4&4294967295|a>>>28))+((a=i+(t^n^s)+r[4]+1272893353&4294967295)<<11&4294967295|a>>>21))+((a=s+(i^t^n)+r[7]+4139469664&4294967295)<<16&4294967295|a>>>16))+((a=n+(s^i^t)+r[10]+3200236656&4294967295)<<23&4294967295|a>>>9))+((a=t+(n^s^i)+r[13]+681279174&4294967295)<<4&4294967295|a>>>28))+((a=i+(t^n^s)+r[0]+3936430074&4294967295)<<11&4294967295|a>>>21))+((a=s+(i^t^n)+r[3]+3572445317&4294967295)<<16&4294967295|a>>>16))+((a=n+(s^i^t)+r[6]+76029189&4294967295)<<23&4294967295|a>>>9))+((a=t+(n^s^i)+r[9]+3654602809&4294967295)<<4&4294967295|a>>>28))+((a=i+(t^n^s)+r[12]+3873151461&4294967295)<<11&4294967295|a>>>21))+((a=s+(i^t^n)+r[15]+530742520&4294967295)<<16&4294967295|a>>>16))+((a=n+(s^i^t)+r[2]+3299628645&4294967295)<<23&4294967295|a>>>9))+((a=t+(s^(n|~i))+r[0]+4096336452&4294967295)<<6&4294967295|a>>>26))+((a=i+(n^(t|~s))+r[7]+1126891415&4294967295)<<10&4294967295|a>>>22))+((a=s+(t^(i|~n))+r[14]+2878612391&4294967295)<<15&4294967295|a>>>17))+((a=n+(i^(s|~t))+r[5]+4237533241&4294967295)<<21&4294967295|a>>>11))+((a=t+(s^(n|~i))+r[12]+1700485571&4294967295)<<6&4294967295|a>>>26))+((a=i+(n^(t|~s))+r[3]+2399980690&4294967295)<<10&4294967295|a>>>22))+((a=s+(t^(i|~n))+r[10]+4293915773&4294967295)<<15&4294967295|a>>>17))+((a=n+(i^(s|~t))+r[1]+2240044497&4294967295)<<21&4294967295|a>>>11))+((a=t+(s^(n|~i))+r[8]+1873313359&4294967295)<<6&4294967295|a>>>26))+((a=i+(n^(t|~s))+r[15]+4264355552&4294967295)<<10&4294967295|a>>>22))+((a=s+(t^(i|~n))+r[6]+2734768916&4294967295)<<15&4294967295|a>>>17))+((a=n+(i^(s|~t))+r[13]+1309151649&4294967295)<<21&4294967295|a>>>11))+((i=(t=n+((a=t+(s^(n|~i))+r[4]+4149444226&4294967295)<<6&4294967295|a>>>26))+((a=i+(n^(t|~s))+r[11]+3174756917&4294967295)<<10&4294967295|a>>>22))^((s=i+((a=s+(t^(i|~n))+r[2]+718787259&4294967295)<<15&4294967295|a>>>17))|~t))+r[9]+3951481745&4294967295;e.g[0]=e.g[0]+t&4294967295,e.g[1]=e.g[1]+(s+(a<<21&4294967295|a>>>11))&4294967295,e.g[2]=e.g[2]+s&4294967295,e.g[3]=e.g[3]+i&4294967295}function h(e,t){this.h=t;for(var n=[],r=!0,s=e.length-1;0<=s;s--){var i=0|e[s];r&&i==t||(n[s]=i,r=!1)}this.g=n}(t=r.prototype).Oa=function(e){this.M=e},t.ha=function(e,t,n,r){if(this.g)throw Error("[goog.net.XhrIo] Object is active with another request="+this.I+"; newUri="+e);t=t?t.toUpperCase():"GET",this.I=e,this.j="",this.m=0,this.F=!1,this.h=!0,this.g=(this.u||Nt).g(),this.C=this.u?Et(this.u):Et(Nt),this.g.onreadystatechange=se(this.La,this);try{this.G=!0,this.g.open(t,String(e),!0),this.G=!1}catch(e){return void On(this,e)}if(e=n||"",n=new Map(this.headers),r)if(Object.getPrototypeOf(r)===Object.prototype)for(var s in r)n.set(s,r[s]);else{if("function"!=typeof r.keys||"function"!=typeof r.get)throw Error("Unknown input type for opt_headers: "+String(r));for(const u of r.keys())n.set(u,r.get(u))}r=Array.from(n.keys()).find(e=>"content-type"==e.toLowerCase()),s=x.FormData&&e instanceof x.FormData,0<=oe(Ln,t)&&!r&&!s&&n.set("Content-Type","application/x-www-form-urlencoded;charset=utf-8");for(var[i,a]of n)this.g.setRequestHeader(i,a);this.K&&(this.g.responseType=this.K),"withCredentials"in this.g&&this.g.withCredentials!==this.M&&(this.g.withCredentials=this.M);try{Bn(this),0<this.B&&((this.L=(o=this.g,ye&&"number"==typeof o.timeout&&void 0!==o.ontimeout))?(this.g.timeout=this.B,this.g.ontimeout=se(this.ua,this)):this.A=it(this.ua,this.B,this)),this.v=!0,this.g.send(e),this.v=!1}catch(e){On(this,e)}var o},t.ua=function(){this.g&&(this.j="Timed out after "+this.B+"ms, aborting",this.m=8,$e(this,"timeout"),this.abort(8))},t.abort=function(e){this.g&&this.h&&(this.h=!1,this.l=!0,this.g.abort(),this.l=!1,this.m=e||7,$e(this,"complete"),$e(this,"abort"),Vn(this))},t.N=function(){this.g&&(this.h&&(this.h=!1,this.l=!0,this.g.abort(),this.l=!1),Vn(this,!0)),r.$.N.call(this)},t.La=function(){this.s||(this.G||this.v||this.l?Pn(this):this.kb())},t.kb=function(){Pn(this)},t.isActive=function(){return!!this.g},t.da=function(){try{return 2<qn(this)?this.g.status:-1}catch(e){return-1}},t.ja=function(){try{return this.g?this.g.responseText:""}catch(e){return""}},t.Wa=function(e){var t;if(this.g)return t=this.g.responseText,e&&0==t.indexOf(e)&&(t=t.substring(e.length)),kn(t)},t.Ia=function(){return this.m},t.Sa=function(){return"string"==typeof this.j?this.j:String(this.j)},(t=Kn.prototype).ra=8,t.H=1,t.Na=function(t){if(this.m)if(this.m=null,1==this.H){if(!t){this.W=Math.floor(1e5*Math.random()),t=this.W++;const i=new Ct(this,this.l,t);let e=this.s;if(this.U&&(e?Le(e=Re(e),this.U):e=this.U),null!==this.o||this.O||(i.I=e,e=null),this.P)e:{for(var n=0,r=0;r<this.j.length;r++){var s=this.j[r];if(void 0===(s="__data__"in s.map&&"string"==typeof(s=s.map.__data__)?s.length:void 0))break;if(4096<(n+=s)){n=r;break e}if(4096===n||r===this.j.length-1){n=r+1;break e}}n=1e3}else n=1e3;n=Jn(this,i,n),p(r=$t(this.I),"RID",t),p(r,"CVER",22),this.F&&p(r,"X-HTTP-Session-Id",this.F),Xn(this,r),e&&(this.O?n="headers="+encodeURIComponent(String(zn(e)))+"&"+n:this.o&&Gn(r,this.o,e)),vn(this.i,i),this.bb&&p(r,"TYPE","init"),this.P?(p(r,"$req",n),p(r,"SID","null"),i.aa=!0,Lt(i,r,null)):Lt(i,r,n),this.H=2}}else 3==this.H&&(t?Yn(this,t):0==this.j.length||mn(this.i)||Yn(this))},t.Ma=function(){var e;this.u=null,nr(this),this.ca&&!(this.M||null==this.g||this.S<=0)&&(e=2*this.S,this.l.info("BP detection timer enabled: "+e),this.B=bt(se(this.jb,this),e))},t.jb=function(){this.B&&(this.B=null,this.l.info("BP detection timeout reached."),this.l.info("Buffering proxy detected and switch to long-polling!"),this.G=!1,this.M=!0,wt(10),$n(this),nr(this))},t.ib=function(){null!=this.v&&(this.v=null,$n(this),er(this),wt(19))},t.pb=function(e){e?(this.l.info("Successfully pinged google.com"),wt(2)):(this.l.info("Failed to ping google.com"),wt(1))},t.isActive=function(){return!!this.h&&this.h.isActive(this)},(t=cr.prototype).Ba=function(){},t.Aa=function(){},t.za=function(){},t.ya=function(){},t.isActive=function(){return!0},t.Va=function(){},lr.prototype.g=function(e,t){return new dr(e,t)},e(dr,s),dr.prototype.m=function(){this.g.h=this.j,this.A&&(this.g.J=!0);var e=this.g,t=this.l,n=this.h||void 0;wt(0),e.Y=t,e.na=n||{},e.G=e.aa,e.I=ur(e,null,e.Y),Hn(e)},dr.prototype.close=function(){Qn(this.g)},dr.prototype.u=function(e){var t,n=this.g;"string"==typeof e?((t={}).__data__=e,e=t):this.v&&((t={}).__data__=He(e),e=t),n.j.push(new fn(n.fb++,e)),3==n.H&&Hn(n)},dr.prototype.N=function(){this.g.h=null,delete this.j,Qn(this.g),delete this.g,dr.$.N.call(this)},e(fr,St),e(gr,xt),e(mr,cr),mr.prototype.Ba=function(){$e(this.g,"a")},mr.prototype.Aa=function(e){$e(this.g,new fr(e))},mr.prototype.za=function(e){$e(this.g,new gr)},mr.prototype.ya=function(){$e(this.g,"b")},e(pr,function(){this.blockSize=-1}),pr.prototype.reset=function(){this.g[0]=1732584193,this.g[1]=4023233417,this.g[2]=2562383102,this.g[3]=271733878,this.i=this.h=0},pr.prototype.j=function(e,t){for(var n=(t=void 0===t?e.length:t)-this.blockSize,r=this.m,s=this.h,i=0;i<t;){if(0==s)for(;i<=n;)yr(this,e,i),i+=this.blockSize;if("string"==typeof e){for(;i<t;)if(r[s++]=e.charCodeAt(i++),s==this.blockSize){yr(this,r),s=0;break}}else for(;i<t;)if(r[s++]=e[i++],s==this.blockSize){yr(this,r),s=0;break}}this.h=s,this.i+=t},pr.prototype.l=function(){var e=Array((this.h<56?this.blockSize:2*this.blockSize)-this.h);e[0]=128;for(var t=1;t<e.length-8;++t)e[t]=0;for(var n=8*this.i,t=e.length-8;t<e.length;++t)e[t]=255&n,n/=256;for(this.j(e),e=Array(16),t=n=0;t<4;++t)for(var r=0;r<32;r+=8)e[n++]=this.g[t]>>>r&255;return e};var vr={};function wr(e){return-128<=e&&e<128?(t=e,n=function(e){return new h([0|e],e<0?-1:0)},r=vr,Object.prototype.hasOwnProperty.call(r,t)?r[t]:r[t]=n(t)):new h([0|e],e<0?-1:0);var t,n,r}function _r(e){if(isNaN(e)||!isFinite(e))return Ir;if(e<0)return Dr(_r(-e));for(var t=[],n=1,r=0;n<=e;r++)t[r]=e/n|0,n*=br;return new h(t,0)}var br=4294967296,Ir=wr(0),Er=wr(1),Tr=wr(16777216);function Sr(e){if(0==e.h){for(var t=0;t<e.g.length;t++)if(0!=e.g[t])return;return 1}}function xr(e){return-1==e.h}function Dr(e){for(var t=e.g.length,n=[],r=0;r<t;r++)n[r]=~e.g[r];return new h(n,~e.h).add(Er)}function Cr(e,t){return e.add(Dr(t))}function Ar(e,t){for(;(65535&e[t])!=e[t];)e[t+1]+=e[t]>>>16,e[t]&=65535,t++}function Nr(e,t){this.g=e,this.h=t}function kr(e,t){if(Sr(t))throw Error("division by zero");if(Sr(e))return new Nr(Ir,Ir);if(xr(e))return t=kr(Dr(e),t),new Nr(Dr(t.g),Dr(t.h));if(xr(t))return t=kr(e,Dr(t)),new Nr(Dr(t.g),t.h);if(30<e.g.length){if(xr(e)||xr(t))throw Error("slowDivide_ only works with positive integers.");for(var n=Er,r=t;r.X(e)<=0;)n=Rr(n),r=Rr(r);for(var s=Mr(n,1),i=Mr(r,1),r=Mr(r,2),n=Mr(n,2);!Sr(r);){var a=i.add(r);a.X(e)<=0&&(s=s.add(n),i=a),r=Mr(r,1),n=Mr(n,1)}return t=Cr(e,s.R(t)),new Nr(s,t)}for(s=Ir;0<=e.X(t);){for(n=Math.max(1,Math.floor(e.ea()/t.ea())),r=(r=Math.ceil(Math.log(n)/Math.LN2))<=48?1:Math.pow(2,r-48),a=(i=_r(n)).R(t);xr(a)||0<a.X(e);)a=(i=_r(n-=r)).R(t);Sr(i)&&(i=Er),s=s.add(i),e=Cr(e,a)}return new Nr(s,e)}function Rr(e){for(var t=e.g.length+1,n=[],r=0;r<t;r++)n[r]=e.D(r)<<1|e.D(r-1)>>>31;return new h(n,e.h)}function Mr(e,t){var n=t>>5;t%=32;for(var r=e.g.length-n,s=[],i=0;i<r;i++)s[i]=0<t?e.D(i+n)>>>t|e.D(i+n+1)<<32-t:e.D(i+n);return new h(s,e.h)}(t=h.prototype).ea=function(){if(xr(this))return-Dr(this).ea();for(var e=0,t=1,n=0;n<this.g.length;n++){var r=this.D(n);e+=(0<=r?r:br+r)*t,t*=br}return e},t.toString=function(e){if((e=e||10)<2||36<e)throw Error("radix out of range: "+e);if(Sr(this))return"0";if(xr(this))return"-"+Dr(this).toString(e);for(var t=_r(Math.pow(e,6)),n=this,r="";;){var s=kr(n,t).g,i=((0<(n=Cr(n,s.R(t))).g.length?n.g[0]:n.h)>>>0).toString(e);if(Sr(n=s))return i+r;for(;i.length<6;)i="0"+i;r=i+r}},t.D=function(e){return e<0?0:e<this.g.length?this.g[e]:this.h},t.X=function(e){return xr(e=Cr(this,e))?-1:Sr(e)?0:1},t.abs=function(){return xr(this)?Dr(this):this},t.add=function(e){for(var t=Math.max(this.g.length,e.g.length),n=[],r=0,s=0;s<=t;s++){var i=r+(65535&this.D(s))+(65535&e.D(s)),a=(i>>>16)+(this.D(s)>>>16)+(e.D(s)>>>16),r=a>>>16;i&=65535,a&=65535,n[s]=a<<16|i}return new h(n,-2147483648&n[n.length-1]?-1:0)},t.R=function(e){if(Sr(this)||Sr(e))return Ir;if(xr(this))return xr(e)?Dr(this).R(Dr(e)):Dr(Dr(this).R(e));if(xr(e))return Dr(this.R(Dr(e)));if(this.X(Tr)<0&&e.X(Tr)<0)return _r(this.ea()*e.ea());for(var t=this.g.length+e.g.length,n=[],r=0;r<2*t;r++)n[r]=0;for(r=0;r<this.g.length;r++)for(var s=0;s<e.g.length;s++){var i=this.D(r)>>>16,a=65535&this.D(r),o=e.D(s)>>>16,u=65535&e.D(s);n[2*r+2*s]+=a*u,Ar(n,2*r+2*s),n[2*r+2*s+1]+=i*u,Ar(n,2*r+2*s+1),n[2*r+2*s+1]+=a*o,Ar(n,2*r+2*s+1),n[2*r+2*s+2]+=i*o,Ar(n,2*r+2*s+2)}for(r=0;r<t;r++)n[r]=n[2*r+1]<<16|n[2*r];for(r=t;r<2*t;r++)n[r]=0;return new h(n,0)},t.gb=function(e){return kr(this,e).h},t.and=function(e){for(var t=Math.max(this.g.length,e.g.length),n=[],r=0;r<t;r++)n[r]=this.D(r)&e.D(r);return new h(n,this.h&e.h)},t.or=function(e){for(var t=Math.max(this.g.length,e.g.length),n=[],r=0;r<t;r++)n[r]=this.D(r)|e.D(r);return new h(n,this.h|e.h)},t.xor=function(e){for(var t=Math.max(this.g.length,e.g.length),n=[],r=0;r<t;r++)n[r]=this.D(r)^e.D(r);return new h(n,this.h^e.h)},lr.prototype.createWebChannel=lr.prototype.g,dr.prototype.send=dr.prototype.u,dr.prototype.open=dr.prototype.m,_e.NO_ERROR=0,_e.TIMEOUT=8,_e.HTTP_ERROR=6,pe.COMPLETE="complete",(Tt.EventType=Z).OPEN="a",Z.CLOSE="b",Z.ERROR="c",Z.MESSAGE="d",s.prototype.listen=s.prototype.O,r.prototype.listenOnce=r.prototype.P,r.prototype.getLastError=r.prototype.Sa,r.prototype.getLastErrorCode=r.prototype.Ia,r.prototype.getStatus=r.prototype.da,r.prototype.getResponseJson=r.prototype.Wa,r.prototype.getResponseText=r.prototype.ja,r.prototype.send=r.prototype.ha,r.prototype.setWithCredentials=r.prototype.Oa,pr.prototype.digest=pr.prototype.l,pr.prototype.update=pr.prototype.j,h.prototype.multiply=h.prototype.R,h.prototype.modulo=h.prototype.gb,h.prototype.compare=h.prototype.X,h.prototype.toNumber=h.prototype.ea,h.prototype.getBits=h.prototype.D,h.fromNumber=_r,h.fromString=function e(t,n){if(0==t.length)throw Error("number format error: empty string");if((n=n||10)<2||36<n)throw Error("radix out of range: "+n);if("-"==t.charAt(0))return Dr(e(t.substring(1),n));if(0<=t.indexOf("-"))throw Error('number format error: interior "-" character');for(var r=_r(Math.pow(n,8)),s=Ir,i=0;i<t.length;i+=8)var a=Math.min(8,t.length-i),o=parseInt(t.substring(i,i+a),n),s=a<8?(a=_r(Math.pow(n,a)),s.R(a).add(_r(o))):(s=s.R(r)).add(_r(o));return s};var g,Lr,Or=mt,Fr=_e,Pr=pe,Vr=ft,Br=Sn,qr=Tt,Ur=r,zr=pr,Gr=h,Ee="@firebase/firestore";class o{constructor(e){this.uid=e}isAuthenticated(){return null!=this.uid}toKey(){return this.isAuthenticated()?"uid:"+this.uid:"anonymous-user"}isEqual(e){return e.uid===this.uid}}o.UNAUTHENTICATED=new o(null),o.GOOGLE_CREDENTIALS=new o("google-credentials-uid"),o.FIRST_PARTY=new o("first-party-uid"),o.MOCK_USER=new o("mock-user");let jr="10.6.0";const Kr=new class{constructor(e){this.name=e,this._logLevel=Y,this._logHandler=J,this._userLogHandler=null}get logLevel(){return this._logLevel}set logLevel(e){if(!(e in l))throw new TypeError(`Invalid value "${e}" assigned to \`logLevel\``);this._logLevel=e}setLogLevel(e){this._logLevel="string"==typeof e?H[e]:e}get logHandler(){return this._logHandler}set logHandler(e){if("function"!=typeof e)throw new TypeError("Value assigned to `logHandler` must be a function");this._logHandler=e}get userLogHandler(){return this._userLogHandler}set userLogHandler(e){this._userLogHandler=e}debug(...e){this._userLogHandler&&this._userLogHandler(this,l.DEBUG,...e),this._logHandler(this,l.DEBUG,...e)}log(...e){this._userLogHandler&&this._userLogHandler(this,l.VERBOSE,...e),this._logHandler(this,l.VERBOSE,...e)}info(...e){this._userLogHandler&&this._userLogHandler(this,l.INFO,...e),this._logHandler(this,l.INFO,...e)}warn(...e){this._userLogHandler&&this._userLogHandler(this,l.WARN,...e),this._logHandler(this,l.WARN,...e)}error(...e){this._userLogHandler&&this._userLogHandler(this,l.ERROR,...e),this._logHandler(this,l.ERROR,...e)}}("@firebase/firestore");function Qr(){return Kr.logLevel}function m(e,...t){Kr.logLevel<=l.DEBUG&&(t=t.map(Wr),Kr.debug(`Firestore (${jr}): `+e,...t))}function d(e,...t){Kr.logLevel<=l.ERROR&&(t=t.map(Wr),Kr.error(`Firestore (${jr}): `+e,...t))}function $r(e,...t){Kr.logLevel<=l.WARN&&(t=t.map(Wr),Kr.warn(`Firestore (${jr}): `+e,...t))}function Wr(t){if("string"==typeof t)return t;try{return JSON.stringify(t)}catch(e){return t}}function E(e="Unexpected state"){e=`FIRESTORE (${jr}) INTERNAL ASSERTION FAILED: `+e;throw d(e),new Error(e)}function y(e){e||E()}const w={OK:"ok",CANCELLED:"cancelled",UNKNOWN:"unknown",INVALID_ARGUMENT:"invalid-argument",DEADLINE_EXCEEDED:"deadline-exceeded",NOT_FOUND:"not-found",ALREADY_EXISTS:"already-exists",PERMISSION_DENIED:"permission-denied",UNAUTHENTICATED:"unauthenticated",RESOURCE_EXHAUSTED:"resource-exhausted",FAILED_PRECONDITION:"failed-precondition",ABORTED:"aborted",OUT_OF_RANGE:"out-of-range",UNIMPLEMENTED:"unimplemented",INTERNAL:"internal",UNAVAILABLE:"unavailable",DATA_LOSS:"data-loss"};class _ extends K{constructor(e,t){super(e,t),this.code=e,this.message=t,this.toString=()=>`${this.name}: [code=${this.code}]: `+this.message}}class Hr{constructor(){this.promise=new Promise((e,t)=>{this.resolve=e,this.reject=t})}}class Yr{constructor(e,t){this.user=t,this.type="OAuth",this.headers=new Map,this.headers.set("Authorization","Bearer "+e)}}class Xr{getToken(){return Promise.resolve(null)}invalidateToken(){}start(e,t){e.enqueueRetryable(()=>t(o.UNAUTHENTICATED))}shutdown(){}}class Jr{constructor(e){this.token=e,this.changeListener=null}getToken(){return Promise.resolve(this.token)}invalidateToken(){}start(e,t){this.changeListener=t,e.enqueueRetryable(()=>t(this.token.user))}shutdown(){this.changeListener=null}}class Zr{constructor(e){this.t=e,this.currentUser=o.UNAUTHENTICATED,this.i=0,this.forceRefresh=!1,this.auth=null}start(t,n){let r=this.i;const s=e=>this.i!==r?(r=this.i,n(e)):Promise.resolve();let i=new Hr;this.o=()=>{this.i++,this.currentUser=this.u(),i.resolve(),i=new Hr,t.enqueueRetryable(()=>s(this.currentUser))};const a=()=>{const e=i;t.enqueueRetryable(async()=>{await e.promise,await s(this.currentUser)})},o=e=>{m("FirebaseAuthCredentialsProvider","Auth detected"),this.auth=e,this.auth.addAuthTokenListener(this.o),a()};this.t.onInit(e=>o(e)),setTimeout(()=>{var e;this.auth||((e=this.t.getImmediate({optional:!0}))?o(e):(m("FirebaseAuthCredentialsProvider","Auth not yet detected"),i.resolve(),i=new Hr))},0),a()}getToken(){const t=this.i,e=this.forceRefresh;return this.forceRefresh=!1,this.auth?this.auth.getToken(e).then(e=>this.i!==t?(m("FirebaseAuthCredentialsProvider","getToken aborted due to token change."),this.getToken()):e?(y("string"==typeof e.accessToken),new Yr(e.accessToken,this.currentUser)):null):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.auth&&this.auth.removeAuthTokenListener(this.o)}u(){var e=this.auth&&this.auth.getUid();return y(null===e||"string"==typeof e),new o(e)}}class es{constructor(e,t,n){this.l=e,this.h=t,this.P=n,this.type="FirstParty",this.user=o.FIRST_PARTY,this.I=new Map}T(){return this.P?this.P():null}get headers(){this.I.set("X-Goog-AuthUser",this.l);var e=this.T();return e&&this.I.set("Authorization",e),this.h&&this.I.set("X-Goog-Iam-Authorization-Token",this.h),this.I}}class ts{constructor(e,t,n){this.l=e,this.h=t,this.P=n}getToken(){return Promise.resolve(new es(this.l,this.h,this.P))}start(e,t){e.enqueueRetryable(()=>t(o.FIRST_PARTY))}shutdown(){}invalidateToken(){}}class ns{constructor(e){this.value=e,this.type="AppCheck",this.headers=new Map,e&&0<e.length&&this.headers.set("x-firebase-appcheck",this.value)}}class rs{constructor(e){this.A=e,this.forceRefresh=!1,this.appCheck=null,this.R=null}start(t,n){const r=e=>{null!=e.error&&m("FirebaseAppCheckTokenProvider","Error getting App Check token; using placeholder token instead. Error: "+e.error.message);var t=e.token!==this.R;return this.R=e.token,m("FirebaseAppCheckTokenProvider",`Received ${t?"new":"existing"} token.`),t?n(e.token):Promise.resolve()},s=(this.o=e=>{t.enqueueRetryable(()=>r(e))},e=>{m("FirebaseAppCheckTokenProvider","AppCheck detected"),this.appCheck=e,this.appCheck.addTokenListener(this.o)});this.A.onInit(e=>s(e)),setTimeout(()=>{var e;this.appCheck||((e=this.A.getImmediate({optional:!0}))?s(e):m("FirebaseAppCheckTokenProvider","AppCheck not yet detected"))},0)}getToken(){var e=this.forceRefresh;return this.forceRefresh=!1,this.appCheck?this.appCheck.getToken(e).then(e=>e?(y("string"==typeof e.token),this.R=e.token,new ns(e.token)):null):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.appCheck&&this.appCheck.removeTokenListener(this.o)}}class ss{static newId(){var t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",n=Math.floor(256/t.length)*t.length;let r="";for(;r.length<20;){var s=function(){const e="undefined"!=typeof self&&(self.crypto||self.msCrypto),t=new Uint8Array(40);if(e&&"function"==typeof e.getRandomValues)e.getRandomValues(t);else for(let e=0;e<40;e++)t[e]=Math.floor(256*Math.random());return t}();for(let e=0;e<s.length;++e)r.length<20&&s[e]<n&&(r+=t.charAt(s[e]%t.length))}return r}}function T(e,t){return e<t?-1:t<e?1:0}function is(e,n,r){return e.length===n.length&&e.every((e,t)=>r(e,n[t]))}function as(e){return e+"\0"}class c{constructor(e,t){if(this.seconds=e,(this.nanoseconds=t)<0)throw new _(w.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+t);if(1e9<=t)throw new _(w.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+t);if(e<-62135596800)throw new _(w.INVALID_ARGUMENT,"Timestamp seconds out of range: "+e);if(253402300800<=e)throw new _(w.INVALID_ARGUMENT,"Timestamp seconds out of range: "+e)}static now(){return c.fromMillis(Date.now())}static fromDate(e){return c.fromMillis(e.getTime())}static fromMillis(e){var t=Math.floor(e/1e3),e=Math.floor(1e6*(e-1e3*t));return new c(t,e)}toDate(){return new Date(this.toMillis())}toMillis(){return 1e3*this.seconds+this.nanoseconds/1e6}_compareTo(e){return this.seconds===e.seconds?T(this.nanoseconds,e.nanoseconds):T(this.seconds,e.seconds)}isEqual(e){return e.seconds===this.seconds&&e.nanoseconds===this.nanoseconds}toString(){return"Timestamp(seconds="+this.seconds+", nanoseconds="+this.nanoseconds+")"}toJSON(){return{seconds:this.seconds,nanoseconds:this.nanoseconds}}valueOf(){var e=this.seconds- -62135596800;return String(e).padStart(12,"0")+"."+String(this.nanoseconds).padStart(9,"0")}}class b{constructor(e){this.timestamp=e}static fromTimestamp(e){return new b(e)}static min(){return new b(new c(0,0))}static max(){return new b(new c(253402300799,999999999))}compareTo(e){return this.timestamp._compareTo(e.timestamp)}isEqual(e){return this.timestamp.isEqual(e.timestamp)}toMicroseconds(){return 1e6*this.timestamp.seconds+this.timestamp.nanoseconds/1e3}toString(){return"SnapshotVersion("+this.timestamp.toString()+")"}toTimestamp(){return this.timestamp}}class os{constructor(e,t,n){void 0===t?t=0:t>e.length&&E(),void 0===n?n=e.length-t:n>e.length-t&&E(),this.segments=e,this.offset=t,this.len=n}get length(){return this.len}isEqual(e){return 0===os.comparator(this,e)}child(e){const t=this.segments.slice(this.offset,this.limit());return e instanceof os?e.forEach(e=>{t.push(e)}):t.push(e),this.construct(t)}limit(){return this.offset+this.length}popFirst(e){return this.construct(this.segments,this.offset+(e=void 0===e?1:e),this.length-e)}popLast(){return this.construct(this.segments,this.offset,this.length-1)}firstSegment(){return this.segments[this.offset]}lastSegment(){return this.get(this.length-1)}get(e){return this.segments[this.offset+e]}isEmpty(){return 0===this.length}isPrefixOf(t){if(t.length<this.length)return!1;for(let e=0;e<this.length;e++)if(this.get(e)!==t.get(e))return!1;return!0}isImmediateParentOf(t){if(this.length+1!==t.length)return!1;for(let e=0;e<this.length;e++)if(this.get(e)!==t.get(e))return!1;return!0}forEach(n){for(let e=this.offset,t=this.limit();e<t;e++)n(this.segments[e])}toArray(){return this.segments.slice(this.offset,this.limit())}static comparator(t,n){const r=Math.min(t.length,n.length);for(let e=0;e<r;e++){const r=t.get(e),s=n.get(e);if(r<s)return-1;if(r>s)return 1}return t.length<n.length?-1:t.length>n.length?1:0}}class I extends os{construct(e,t,n){return new I(e,t,n)}canonicalString(){return this.toArray().join("/")}toString(){return this.canonicalString()}static fromString(...e){const t=[];for(const n of e){if(0<=n.indexOf("//"))throw new _(w.INVALID_ARGUMENT,`Invalid segment (${n}). Paths must not contain // in them.`);t.push(...n.split("/").filter(e=>0<e.length))}return new I(t)}static emptyPath(){return new I([])}}const us=/^[_a-zA-Z][_a-zA-Z0-9]*$/;class f extends os{construct(e,t,n){return new f(e,t,n)}static isValidIdentifier(e){return us.test(e)}canonicalString(){return this.toArray().map(e=>(e=e.replace(/\\/g,"\\\\").replace(/`/g,"\\`"),e=f.isValidIdentifier(e)?e:"`"+e+"`")).join(".")}toString(){return this.canonicalString()}isKeyField(){return 1===this.length&&"__name__"===this.get(0)}static keyField(){return new f(["__name__"])}static fromServerFormat(e){const t=[];let n="",r=0;var s=()=>{if(0===n.length)throw new _(w.INVALID_ARGUMENT,`Invalid field path (${e}). Paths must not be empty, begin with '.', end with '.', or contain '..'`);t.push(n),n=""};let i=!1;for(;r<e.length;){const t=e[r];if("\\"===t){if(r+1===e.length)throw new _(w.INVALID_ARGUMENT,"Path has trailing escape character: "+e);const t=e[r+1];if("\\"!==t&&"."!==t&&"`"!==t)throw new _(w.INVALID_ARGUMENT,"Path has invalid escape sequence: "+e);n+=t,r+=2}else"`"===t?i=!i:"."!==t||i?n+=t:s(),r++}if(s(),i)throw new _(w.INVALID_ARGUMENT,"Unterminated ` in path: "+e);return new f(t)}static emptyPath(){return new f([])}}class S{constructor(e){this.path=e}static fromPath(e){return new S(I.fromString(e))}static fromName(e){return new S(I.fromString(e).popFirst(5))}static empty(){return new S(I.emptyPath())}get collectionGroup(){return this.path.popLast().lastSegment()}hasCollectionId(e){return 2<=this.path.length&&this.path.get(this.path.length-2)===e}getCollectionGroup(){return this.path.get(this.path.length-2)}getCollectionPath(){return this.path.popLast()}isEqual(e){return null!==e&&0===I.comparator(this.path,e.path)}toString(){return this.path.toString()}static comparator(e,t){return I.comparator(e.path,t.path)}static isDocumentKey(e){return e.length%2==0}static fromSegments(e){return new S(new I(e.slice()))}}class hs{constructor(e,t,n,r){this.indexId=e,this.collectionGroup=t,this.fields=n,this.indexState=r}}function cs(e){return e.fields.find(e=>2===e.kind)}function ls(e){return e.fields.filter(e=>2!==e.kind)}hs.UNKNOWN_ID=-1;class ds{constructor(e,t){this.fieldPath=e,this.kind=t}}class fs{constructor(e,t){this.sequenceNumber=e,this.offset=t}static empty(){return new fs(0,ps.min())}}function gs(e,t){var n=e.toTimestamp().seconds,e=e.toTimestamp().nanoseconds+1,e=b.fromTimestamp(1e9===e?new c(n+1,0):new c(n,e));return new ps(e,S.empty(),t)}function ms(e){return new ps(e.readTime,e.key,-1)}class ps{constructor(e,t,n){this.readTime=e,this.documentKey=t,this.largestBatchId=n}static min(){return new ps(b.min(),S.empty(),-1)}static max(){return new ps(b.max(),S.empty(),-1)}}function ys(e,t){let n=e.readTime.compareTo(t.readTime);return 0!==n?n:0!==(n=S.comparator(e.documentKey,t.documentKey))?n:T(e.largestBatchId,t.largestBatchId)}const vs="The current tab is not in the required state to perform this operation. It might be necessary to refresh the browser tab.";class ws{constructor(){this.onCommittedListeners=[]}addOnCommittedListener(e){this.onCommittedListeners.push(e)}raiseOnCommittedEvent(){this.onCommittedListeners.forEach(e=>e())}}async function _s(e){if(e.code!==w.FAILED_PRECONDITION||e.message!==vs)throw e;m("LocalStore","Unexpectedly lost primary lease")}class D{constructor(e){this.nextCallback=null,this.catchCallback=null,this.result=void 0,this.error=void 0,this.isDone=!1,this.callbackAttached=!1,e(e=>{this.isDone=!0,this.result=e,this.nextCallback&&this.nextCallback(e)},e=>{this.isDone=!0,this.error=e,this.catchCallback&&this.catchCallback(e)})}catch(e){return this.next(void 0,e)}next(r,s){return this.callbackAttached&&E(),this.callbackAttached=!0,this.isDone?this.error?this.wrapFailure(s,this.error):this.wrapSuccess(r,this.result):new D((t,n)=>{this.nextCallback=e=>{this.wrapSuccess(r,e).next(t,n)},this.catchCallback=e=>{this.wrapFailure(s,e).next(t,n)}})}toPromise(){return new Promise((e,t)=>{this.next(e,t)})}wrapUserFunction(e){try{var t=e();return t instanceof D?t:D.resolve(t)}catch(e){return D.reject(e)}}wrapSuccess(e,t){return e?this.wrapUserFunction(()=>e(t)):D.resolve(t)}wrapFailure(e,t){return e?this.wrapUserFunction(()=>e(t)):D.reject(t)}static resolve(n){return new D((e,t)=>{e(n)})}static reject(n){return new D((e,t)=>{t(n)})}static waitFor(e){return new D((t,n)=>{let r=0,s=0,i=!1;e.forEach(e=>{++r,e.next(()=>{++s,i&&s===r&&t()},e=>n(e))}),i=!0,s===r&&t()})}static or(e){let t=D.resolve(!1);for(const n of e)t=t.next(e=>e?D.resolve(e):n());return t}static forEach(e,n){const r=[];return e.forEach((e,t)=>{r.push(n.call(this,e,t))}),this.waitFor(r)}static mapArray(o,u){return new D((t,n)=>{const r=o.length,s=new Array(r);let i=0;for(let e=0;e<r;e++){const a=e;u(o[a]).next(e=>{s[a]=e,++i===r&&t(s)},e=>n(e))}})}static doWhile(r,s){return new D((e,t)=>{const n=()=>{!0===r()?s().next(()=>{n()},t):e()};n()})}}class bs{constructor(t,e){this.action=t,this.transaction=e,this.aborted=!1,this.V=new Hr,this.transaction.oncomplete=()=>{this.V.resolve()},this.transaction.onabort=()=>{e.error?this.V.reject(new Ts(t,e.error)):this.V.resolve()},this.transaction.onerror=e=>{e=As(e.target.error);this.V.reject(new Ts(t,e))}}static open(e,t,n,r){try{return new bs(t,e.transaction(r,n))}catch(e){throw new Ts(t,e)}}get m(){return this.V.promise}abort(e){e&&this.V.reject(e),this.aborted||(m("SimpleDb","Aborting transaction:",e?e.message:"Client-initiated abort"),this.aborted=!0,this.transaction.abort())}g(){const e=this.transaction;this.aborted||"function"!=typeof e.commit||e.commit()}store(e){e=this.transaction.objectStore(e);return new xs(e)}}class Is{constructor(e,t,n){this.name=e,this.version=t,this.p=n,12.2===Is.S(G())&&d("Firestore persistence suffers from a bug in iOS 12.2 Safari that may cause your app to stop working. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.")}static delete(e){return m("SimpleDb","Removing database:",e),Ds(window.indexedDB.deleteDatabase(e)).toPromise()}static D(){if(!function(){try{return"object"==typeof indexedDB}catch(e){return}}())return!1;if(Is.C())return!0;const e=G(),t=Is.S(e),n=0<t&&t<10,r=Is.v(e),s=0<r&&r<4.5;return!(0<e.indexOf("MSIE ")||0<e.indexOf("Trident/")||0<e.indexOf("Edge/")||n||s)}static C(){var e;return"undefined"!=typeof process&&"YES"===(null==(e=process.env)?void 0:e.F)}static M(e,t){return e.store(t)}static S(e){const t=e.match(/i(?:phone|pad|pod) os ([\d_]+)/i),n=t?t[1].split("_").slice(0,2).join("."):"-1";return Number(n)}static v(e){const t=e.match(/Android ([\d.]+)/i),n=t?t[1].split(".").slice(0,2).join("."):"-1";return Number(n)}async O(s){return this.db||(m("SimpleDb","Opening database:",this.name),this.db=await new Promise((t,n)=>{const r=indexedDB.open(this.name,this.version);r.onsuccess=e=>{e=e.target.result;t(e)},r.onblocked=()=>{n(new Ts(s,"Cannot upgrade IndexedDB schema while another tab is open. Close all tabs that access Firestore and reload this page to proceed."))},r.onerror=e=>{e=e.target.error;"VersionError"===e.name?n(new _(w.FAILED_PRECONDITION,"A newer version of the Firestore SDK was previously used and so the persisted data is not compatible with the version of the SDK you are now using. The SDK will operate with persistence disabled. If you need persistence, please re-upgrade to a newer version of the SDK or else clear the persisted IndexedDB data for your app to start fresh.")):"InvalidStateError"===e.name?n(new _(w.FAILED_PRECONDITION,"Unable to open an IndexedDB connection. This could be due to running in a private browsing session on a browser whose private browsing sessions do not support IndexedDB: "+e)):n(new Ts(s,e))},r.onupgradeneeded=e=>{m("SimpleDb",'Database "'+this.name+'" requires upgrade from version:',e.oldVersion);var t=e.target.result;this.p.N(t,r.transaction,e.oldVersion,this.version).next(()=>{m("SimpleDb","Database upgrade to version "+this.version+" complete")})}})),this.B&&(this.db.onversionchange=e=>this.B(e)),this.db}L(t){this.B=t,this.db&&(this.db.onversionchange=e=>t(e))}async runTransaction(e,t,n,r){var s="readonly"===t;let i=0;for(;;){++i;try{this.db=await this.O(e);const t=bs.open(this.db,e,s?"readonly":"readwrite",n),i=r(t).next(e=>(t.g(),e)).catch(e=>(t.abort(e),D.reject(e))).toPromise();return i.catch(()=>{}),await t.m,i}catch(e){const t=e,n="FirebaseError"!==t.name&&i<3;if(m("SimpleDb","Transaction failed with error:",t.message,"Retrying:",n),this.close(),!n)return Promise.reject(t)}}}close(){this.db&&this.db.close(),this.db=void 0}}class Es{constructor(e){this.k=e,this.q=!1,this.K=null}get isDone(){return this.q}get $(){return this.K}set cursor(e){this.k=e}done(){this.q=!0}U(e){this.K=e}delete(){return Ds(this.k.delete())}}class Ts extends _{constructor(e,t){super(w.UNAVAILABLE,`IndexedDB transaction '${e}' failed: `+t),this.name="IndexedDbTransactionError"}}function Ss(e){return"IndexedDbTransactionError"===e.name}class xs{constructor(e){this.store=e}put(e,t){return Ds(void 0!==t?(m("SimpleDb","PUT",this.store.name,e,t),this.store.put(t,e)):(m("SimpleDb","PUT",this.store.name,"<auto-key>",e),this.store.put(e)))}add(e){return m("SimpleDb","ADD",this.store.name,e,e),Ds(this.store.add(e))}get(t){return Ds(this.store.get(t)).next(e=>(m("SimpleDb","GET",this.store.name,t,e=void 0===e?null:e),e))}delete(e){return m("SimpleDb","DELETE",this.store.name,e),Ds(this.store.delete(e))}count(){return m("SimpleDb","COUNT",this.store.name),Ds(this.store.count())}W(e,n){var t=this.options(e,n);if(t.index||"function"!=typeof this.store.getAll){const e=this.cursor(t),n=[];return this.G(e,(e,t)=>{n.push(t)}).next(()=>n)}{const e=this.store.getAll(t.range);return new D((t,n)=>{e.onerror=e=>{n(e.target.error)},e.onsuccess=e=>{t(e.target.result)}})}}j(e,t){const r=this.store.getAll(e,null===t?void 0:t);return new D((t,n)=>{r.onerror=e=>{n(e.target.error)},r.onsuccess=e=>{t(e.target.result)}})}H(e,t){m("SimpleDb","DELETE ALL",this.store.name);const n=this.options(e,t);n.J=!1;e=this.cursor(n);return this.G(e,(e,t,n)=>n.delete())}Y(e,t){let n;t?n=e:(n={},t=e);e=this.cursor(n);return this.G(e,t)}Z(r){const e=this.cursor({});return new D((n,t)=>{e.onerror=e=>{e=As(e.target.error);t(e)},e.onsuccess=e=>{const t=e.target.result;t?r(t.primaryKey,t.value).next(e=>{e?t.continue():n()}):n()}})}G(e,i){const a=[];return new D((s,t)=>{e.onerror=e=>{t(e.target.error)},e.onsuccess=e=>{const t=e.target.result;if(t){const n=new Es(t),r=i(t.primaryKey,t.value,n);if(r instanceof D){const e=r.catch(e=>(n.done(),D.reject(e)));a.push(e)}n.isDone?s():null===n.$?t.continue():t.continue(n.$)}else s()}}).next(()=>D.waitFor(a))}options(e,t){let n;return void 0!==e&&("string"==typeof e?n=e:t=e),{index:n,range:t}}cursor(e){let t="next";if(e.reverse&&(t="prev"),e.index){const n=this.store.index(e.index);return e.J?n.openKeyCursor(e.range,t):n.openCursor(e.range,t)}return this.store.openCursor(e.range,t)}}function Ds(e){return new D((t,n)=>{e.onsuccess=e=>{e=e.target.result;t(e)},e.onerror=e=>{e=As(e.target.error);n(e)}})}let Cs=!1;function As(e){const t=Is.S(G());if(12.2<=t&&t<13){const t="An internal error was encountered in the Indexed Database server";if(0<=e.message.indexOf(t)){const e=new _("internal",`IOS_INDEXEDDB_BUG1: IndexedDb has thrown '${t}'. This is likely due to an unavoidable bug in iOS. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.`);return Cs||(Cs=!0,setTimeout(()=>{throw e},0)),e}}return e}class Ns{constructor(e,t){this.asyncQueue=e,this.X=t,this.task=null}start(){this.ee(15e3)}stop(){this.task&&(this.task.cancel(),this.task=null)}get started(){return null!==this.task}ee(e){m("IndexBackiller",`Scheduled in ${e}ms`),this.task=this.asyncQueue.enqueueAfterDelay("index_backfill",e,async()=>{this.task=null;try{m("IndexBackiller","Documents written: "+await this.X.te())}catch(e){Ss(e)?m("IndexBackiller","Ignoring IndexedDB error during index backfill: ",e):await _s(e)}await this.ee(6e4)})}}class ks{constructor(e,t){this.localStore=e,this.persistence=t}async te(t=50){return this.persistence.runTransaction("Backfill Indexes","readwrite-primary",e=>this.ne(e,t))}ne(e,t){const n=new Set;let r=t,s=!0;return D.doWhile(()=>!0===s&&0<r,()=>this.localStore.indexManager.getNextCollectionGroupToUpdate(e).next(t=>null===t||n.has(t)?void(s=!1):(m("IndexBackiller","Processing collection: "+t),this.re(e,t,r).next(e=>{r-=e,n.add(t)})))).next(()=>t-r)}re(r,s,e){return this.localStore.indexManager.getMinOffsetFromCollectionGroup(r,s).next(n=>this.localStore.localDocuments.getNextDocuments(r,s,n,e).next(e=>{const t=e.changes;return this.localStore.indexManager.updateIndexEntries(r,t).next(()=>this.ie(n,e)).next(e=>(m("IndexBackiller","Updating offset: "+e),this.localStore.indexManager.updateCollectionGroup(r,s,e))).next(()=>t.size)}))}ie(e,t){let n=e;return t.changes.forEach((e,t)=>{t=ms(t);0<ys(t,n)&&(n=t)}),new ps(n.readTime,n.documentKey,Math.max(t.batchId,e.largestBatchId))}}class Rs{constructor(e,t){this.previousValue=e,t&&(t.sequenceNumberHandler=e=>this.se(e),this.oe=e=>t.writeSequenceNumber(e))}se(e){return this.previousValue=Math.max(e,this.previousValue),this.previousValue}next(){var e=++this.previousValue;return this.oe&&this.oe(e),e}}function Ms(e){return null==e}function Ls(e){return 0===e&&1/e==-1/0}function Os(e){return"number"==typeof e&&Number.isInteger(e)&&!Ls(e)&&e<=Number.MAX_SAFE_INTEGER&&e>=Number.MIN_SAFE_INTEGER}function Fs(t){let s="";for(let e=0;e<t.length;e++)0<s.length&&(s=Ps(s)),s=function(t){let n=s;const r=t.length;for(let e=0;e<r;e++){const r=t.charAt(e);switch(r){case"\0":n+="";break;case"":n+="";break;default:n+=r}}return n}(t.get(e));return Ps(s)}function Ps(e){return e+""}function Vs(n){const r=n.length;if(y(2<=r),2===r)return y(""===n.charAt(0)&&""===n.charAt(1)),I.emptyPath();const s=r-2,i=[];let a="";for(let t=0;t<r;){const r=n.indexOf("",t);switch((r<0||r>s)&&E(),n.charAt(r+1)){case"":var o=n.substring(t,r);let e;0===a.length?e=o:(a+=o,e=a,a=""),i.push(e);break;case"":a=a+n.substring(t,r)+"\0";break;case"":a+=n.substring(t,r+1);break;default:E()}t=r+2}return new I(i)}Rs._e=-1;const Bs=["userId","batchId"];function qs(e,t){return[e,Fs(t)]}function Us(e,t,n){return[e,Fs(t),n]}const zs={},Gs=["prefixPath","collectionGroup","readTime","documentId"],js=["prefixPath","collectionGroup","documentId"],Ks=["collectionGroup","readTime","prefixPath","documentId"],Qs=["canonicalId","targetId"],$s=["targetId","path"],Ws=["path","targetId"],Hs=["collectionId","parent"],Ys=["indexId","uid"],Xs=["uid","sequenceNumber"],Js=["indexId","uid","arrayValue","directionalValue","orderedDocumentKey","documentKey"],Zs=["indexId","uid","orderedDocumentKey"],ei=["userId","collectionPath","documentId"],ti=["userId","collectionPath","largestBatchId"],ni=["userId","collectionGroup","largestBatchId"],ri=["mutationQueues","mutations","documentMutations","remoteDocuments","targets","owner","targetGlobal","targetDocuments","clientMetadata","remoteDocumentGlobal","collectionParents","bundles","namedQueries"],si=[...ri,"documentOverlays"],ii=["mutationQueues","mutations","documentMutations","remoteDocumentsV14","targets","owner","targetGlobal","targetDocuments","clientMetadata","remoteDocumentGlobal","collectionParents","bundles","namedQueries","documentOverlays"],ai=ii,oi=[...ai,"indexConfiguration","indexState","indexEntries"];class ui extends ws{constructor(e,t){super(),this.ae=e,this.currentSequenceNumber=t}}function hi(e,t){return Is.M(e.ae,t)}function ci(e){let t=0;for(const n in e)Object.prototype.hasOwnProperty.call(e,n)&&t++;return t}function li(e,t){for(const n in e)Object.prototype.hasOwnProperty.call(e,n)&&t(n,e[n])}function di(e){for(const t in e)if(Object.prototype.hasOwnProperty.call(e,t))return!1;return!0}class C{constructor(e,t){this.comparator=e,this.root=t||gi.EMPTY}insert(e,t){return new C(this.comparator,this.root.insert(e,t,this.comparator).copy(null,null,gi.BLACK,null,null))}remove(e){return new C(this.comparator,this.root.remove(e,this.comparator).copy(null,null,gi.BLACK,null,null))}get(e){let t=this.root;for(;!t.isEmpty();){var n=this.comparator(e,t.key);if(0===n)return t.value;n<0?t=t.left:0<n&&(t=t.right)}return null}indexOf(e){let t=0,n=this.root;for(;!n.isEmpty();){var r=this.comparator(e,n.key);if(0===r)return t+n.left.size;n=r<0?n.left:(t+=n.left.size+1,n.right)}return-1}isEmpty(){return this.root.isEmpty()}get size(){return this.root.size}minKey(){return this.root.minKey()}maxKey(){return this.root.maxKey()}inorderTraversal(e){return this.root.inorderTraversal(e)}forEach(n){this.inorderTraversal((e,t)=>(n(e,t),!1))}toString(){const n=[];return this.inorderTraversal((e,t)=>(n.push(e+":"+t),!1)),`{${n.join(", ")}}`}reverseTraversal(e){return this.root.reverseTraversal(e)}getIterator(){return new fi(this.root,null,this.comparator,!1)}getIteratorFrom(e){return new fi(this.root,e,this.comparator,!1)}getReverseIterator(){return new fi(this.root,null,this.comparator,!0)}getReverseIteratorFrom(e){return new fi(this.root,e,this.comparator,!0)}}class fi{constructor(e,t,n,r){this.isReverse=r,this.nodeStack=[];let s=1;for(;!e.isEmpty();)if(s=t?n(e.key,t):1,t&&r&&(s*=-1),s<0)e=this.isReverse?e.left:e.right;else{if(0===s){this.nodeStack.push(e);break}this.nodeStack.push(e),e=this.isReverse?e.right:e.left}}getNext(){let e=this.nodeStack.pop();var t={key:e.key,value:e.value};if(this.isReverse)for(e=e.left;!e.isEmpty();)this.nodeStack.push(e),e=e.right;else for(e=e.right;!e.isEmpty();)this.nodeStack.push(e),e=e.left;return t}hasNext(){return 0<this.nodeStack.length}peek(){if(0===this.nodeStack.length)return null;var e=this.nodeStack[this.nodeStack.length-1];return{key:e.key,value:e.value}}}class gi{constructor(e,t,n,r,s){this.key=e,this.value=t,this.color=null!=n?n:gi.RED,this.left=null!=r?r:gi.EMPTY,this.right=null!=s?s:gi.EMPTY,this.size=this.left.size+1+this.right.size}copy(e,t,n,r,s){return new gi(null!=e?e:this.key,null!=t?t:this.value,null!=n?n:this.color,null!=r?r:this.left,null!=s?s:this.right)}isEmpty(){return!1}inorderTraversal(e){return this.left.inorderTraversal(e)||e(this.key,this.value)||this.right.inorderTraversal(e)}reverseTraversal(e){return this.right.reverseTraversal(e)||e(this.key,this.value)||this.left.reverseTraversal(e)}min(){return this.left.isEmpty()?this:this.left.min()}minKey(){return this.min().key}maxKey(){return this.right.isEmpty()?this.key:this.right.maxKey()}insert(e,t,n){let r=this;var s=n(e,r.key);return(r=s<0?r.copy(null,null,null,r.left.insert(e,t,n),null):0===s?r.copy(null,t,null,null,null):r.copy(null,null,null,null,r.right.insert(e,t,n))).fixUp()}removeMin(){if(this.left.isEmpty())return gi.EMPTY;let e=this;return(e=(e=e.left.isRed()||e.left.left.isRed()?e:e.moveRedLeft()).copy(null,null,null,e.left.removeMin(),null)).fixUp()}remove(e,t){let n,r=this;if(t(e,r.key)<0)r=(r=r.left.isEmpty()||r.left.isRed()||r.left.left.isRed()?r:r.moveRedLeft()).copy(null,null,null,r.left.remove(e,t),null);else{if(0===t(e,(r=(r=r.left.isRed()?r.rotateRight():r).right.isEmpty()||r.right.isRed()||r.right.left.isRed()?r:r.moveRedRight()).key)){if(r.right.isEmpty())return gi.EMPTY;n=r.right.min(),r=r.copy(n.key,n.value,null,null,r.right.removeMin())}r=r.copy(null,null,null,null,r.right.remove(e,t))}return r.fixUp()}isRed(){return this.color}fixUp(){let e=this;return e=(e=(e=e.right.isRed()&&!e.left.isRed()?e.rotateLeft():e).left.isRed()&&e.left.left.isRed()?e.rotateRight():e).left.isRed()&&e.right.isRed()?e.colorFlip():e}moveRedLeft(){let e=this.colorFlip();return e=e.right.left.isRed()?(e=(e=e.copy(null,null,null,null,e.right.rotateRight())).rotateLeft()).colorFlip():e}moveRedRight(){let e=this.colorFlip();return e=e.left.left.isRed()?(e=e.rotateRight()).colorFlip():e}rotateLeft(){var e=this.copy(null,null,gi.RED,null,this.right.left);return this.right.copy(null,null,this.color,e,null)}rotateRight(){var e=this.copy(null,null,gi.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,e)}colorFlip(){var e=this.left.copy(null,null,!this.left.color,null,null),t=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,e,t)}checkMaxDepth(){var e=this.check();return Math.pow(2,e)<=this.size+1}check(){if(this.isRed()&&this.left.isRed())throw E();if(this.right.isRed())throw E();var e=this.left.check();if(e!==this.right.check())throw E();return e+(this.isRed()?0:1)}}gi.EMPTY=null,gi.RED=!0,gi.BLACK=!1,gi.EMPTY=new class{constructor(){this.size=0}get key(){throw E()}get value(){throw E()}get color(){throw E()}get left(){throw E()}get right(){throw E()}copy(e,t,n,r,s){return this}insert(e,t,n){return new gi(e,t)}remove(e,t){return this}isEmpty(){return!0}inorderTraversal(e){return!1}reverseTraversal(e){return!1}minKey(){return null}maxKey(){return null}isRed(){return!1}checkMaxDepth(){return!0}check(){return 0}};class A{constructor(e){this.comparator=e,this.data=new C(this.comparator)}has(e){return null!==this.data.get(e)}first(){return this.data.minKey()}last(){return this.data.maxKey()}get size(){return this.data.size}indexOf(e){return this.data.indexOf(e)}forEach(n){this.data.inorderTraversal((e,t)=>(n(e),!1))}forEachInRange(e,t){const n=this.data.getIteratorFrom(e[0]);for(;n.hasNext();){var r=n.getNext();if(0<=this.comparator(r.key,e[1]))return;t(r.key)}}forEachWhile(e,t){let n;for(n=void 0!==t?this.data.getIteratorFrom(t):this.data.getIterator();n.hasNext();)if(!e(n.getNext().key))return}firstAfterOrEqual(e){const t=this.data.getIteratorFrom(e);return t.hasNext()?t.getNext().key:null}getIterator(){return new mi(this.data.getIterator())}getIteratorFrom(e){return new mi(this.data.getIteratorFrom(e))}add(e){return this.copy(this.data.remove(e).insert(e,!0))}delete(e){return this.has(e)?this.copy(this.data.remove(e)):this}isEmpty(){return this.data.isEmpty()}unionWith(e){let t=this;return t.size<e.size&&(t=e,e=this),e.forEach(e=>{t=t.add(e)}),t}isEqual(e){if(!(e instanceof A))return!1;if(this.size!==e.size)return!1;const t=this.data.getIterator(),n=e.data.getIterator();for(;t.hasNext();){const e=t.getNext().key,r=n.getNext().key;if(0!==this.comparator(e,r))return!1}return!0}toArray(){const t=[];return this.forEach(e=>{t.push(e)}),t}toString(){const t=[];return this.forEach(e=>t.push(e)),"SortedSet("+t.toString()+")"}copy(e){const t=new A(this.comparator);return t.data=e,t}}class mi{constructor(e){this.iter=e}getNext(){return this.iter.getNext().key}hasNext(){return this.iter.hasNext()}}function pi(e){return e.hasNext()?e.getNext():void 0}class yi{constructor(e){(this.fields=e).sort(f.comparator)}static empty(){return new yi([])}unionWith(e){let t=new A(f.comparator);for(const e of this.fields)t=t.add(e);for(const n of e)t=t.add(n);return new yi(t.toArray())}covers(e){for(const t of this.fields)if(t.isPrefixOf(e))return!0;return!1}isEqual(e){return is(this.fields,e.fields,(e,t)=>e.isEqual(t))}}class vi extends Error{constructor(){super(...arguments),this.name="Base64DecodeError"}}class wi{constructor(e){this.binaryString=e}static fromBase64String(e){e=function(e){try{return atob(e)}catch(e){throw"undefined"!=typeof DOMException&&e instanceof DOMException?new vi("Invalid base64 string: "+e):e}}(e);return new wi(e)}static fromUint8Array(e){e=function(t){let n="";for(let e=0;e<t.length;++e)n+=String.fromCharCode(t[e]);return n}(e);return new wi(e)}[Symbol.iterator](){let e=0;return{next:()=>e<this.binaryString.length?{value:this.binaryString.charCodeAt(e++),done:!1}:{value:void 0,done:!0}}}toBase64(){return e=this.binaryString,btoa(e);var e}toUint8Array(){{var t=this.binaryString;const n=new Uint8Array(t.length);for(let e=0;e<t.length;e++)n[e]=t.charCodeAt(e);return n}}approximateByteSize(){return 2*this.binaryString.length}compareTo(e){return T(this.binaryString,e.binaryString)}isEqual(e){return this.binaryString===e.binaryString}}wi.EMPTY_BYTE_STRING=new wi("");const _i=new RegExp(/^\d{4}-\d\d-\d\dT\d\d:\d\d:\d\d(?:\.(\d+))?Z$/);function bi(t){if(y(!!t),"string"!=typeof t)return{seconds:N(t.seconds),nanos:N(t.nanos)};{let e=0;var n=_i.exec(t);y(!!n),n[1]&&(n=(n[1]+"000000000").substr(0,9),e=Number(n));const r=new Date(t);return{seconds:Math.floor(r.getTime()/1e3),nanos:e}}}function N(e){return"number"==typeof e?e:"string"==typeof e?Number(e):0}function Ii(e){return"string"==typeof e?wi.fromBase64String(e):wi.fromUint8Array(e)}function Ei(e){return"server_timestamp"===(null==(e=((null==(e=null==e?void 0:e.mapValue)?void 0:e.fields)||{}).__type__)?void 0:e.stringValue)}function Ti(e){e=e.mapValue.fields.__previous_value__;return Ei(e)?Ti(e):e}function Si(e){e=bi(e.mapValue.fields.__local_write_time__.timestampValue);return new c(e.seconds,e.nanos)}class xi{constructor(e,t,n,r,s,i,a,o,u){this.databaseId=e,this.appId=t,this.persistenceKey=n,this.host=r,this.ssl=s,this.forceLongPolling=i,this.autoDetectLongPolling=a,this.longPollingOptions=o,this.useFetchStreams=u}}class Di{constructor(e,t){this.projectId=e,this.database=t||"(default)"}static empty(){return new Di("","")}get isDefaultDatabase(){return"(default)"===this.database}isEqual(e){return e instanceof Di&&e.projectId===this.projectId&&e.database===this.database}}const Ci={mapValue:{fields:{__type__:{stringValue:"__max__"}}}},Ai={nullValue:"NULL_VALUE"};function Ni(e){return"nullValue"in e?0:"booleanValue"in e?1:"integerValue"in e||"doubleValue"in e?2:"timestampValue"in e?3:"stringValue"in e?5:"bytesValue"in e?6:"referenceValue"in e?7:"geoPointValue"in e?8:"arrayValue"in e?9:"mapValue"in e?Ei(e)?4:Gi(e)?9007199254740991:10:E()}function ki(e,t){if(e===t)return!0;var n,r=Ni(e);if(r!==Ni(t))return!1;switch(r){case 0:case 9007199254740991:return!0;case 1:return e.booleanValue===t.booleanValue;case 4:return Si(e).isEqual(Si(t));case 3:var s=t;if("string"==typeof e.timestampValue&&"string"==typeof s.timestampValue&&e.timestampValue.length===s.timestampValue.length)return e.timestampValue===s.timestampValue;var i=bi(e.timestampValue),s=bi(s.timestampValue);return i.seconds===s.seconds&&i.nanos===s.nanos;case 5:return e.stringValue===t.stringValue;case 6:return n=t,Ii(e.bytesValue).isEqual(Ii(n.bytesValue));case 7:return e.referenceValue===t.referenceValue;case 8:return i=t,N((n=e).geoPointValue.latitude)===N(i.geoPointValue.latitude)&&N(n.geoPointValue.longitude)===N(i.geoPointValue.longitude);case 2:return s=t,"integerValue"in(n=e)&&"integerValue"in s?N(n.integerValue)===N(s.integerValue):"doubleValue"in n&&"doubleValue"in s&&((n=N(n.doubleValue))===(s=N(s.doubleValue))?Ls(n)===Ls(s):isNaN(n)&&isNaN(s));case 9:return is(e.arrayValue.values||[],t.arrayValue.values||[],ki);case 10:{var a=e;const o=a.mapValue.fields||{},u=t.mapValue.fields||{};if(ci(o)!==ci(u))return!1;for(const a in o)if(o.hasOwnProperty(a)&&(void 0===u[a]||!ki(o[a],u[a])))return!1;return!0;return}default:return E()}}function Ri(e,t){return void 0!==(e.values||[]).find(e=>ki(e,t))}function Mi(e,t){if(e===t)return 0;var n,r,s=Ni(e),i=Ni(t);if(s!==i)return T(s,i);switch(s){case 0:case 9007199254740991:return 0;case 1:return T(e.booleanValue,t.booleanValue);case 2:return r=t,(a=N((n=e).integerValue||n.doubleValue))<(g=N(r.integerValue||r.doubleValue))?-1:g<a?1:a===g?0:isNaN(a)?isNaN(g)?0:-1:1;case 3:return Li(e.timestampValue,t.timestampValue);case 4:return Li(Si(e),Si(t));case 5:return T(e.stringValue,t.stringValue);case 6:{var a=e.bytesValue;var o=t.bytesValue;const y=Ii(a),v=Ii(o);return y.compareTo(v);return}case 7:var o=e.referenceValue,u=t.referenceValue,h=o.split("/"),c=u.split("/");for(let e=0;e<h.length&&e<c.length;e++){const u=T(h[e],c[e]);if(0!==u)return u}return T(h.length,c.length);case 8:return n=e.geoPointValue,r=t.geoPointValue,0!==(g=T(N(n.latitude),N(r.latitude)))?g:T(N(n.longitude),N(r.longitude));case 9:var u=e.arrayValue,l=t.arrayValue,d=u.values||[],f=l.values||[];for(let e=0;e<d.length&&e<f.length;++e){const l=Mi(d[e],f[e]);if(l)return l}return T(d.length,f.length);case 10:{var g=e.mapValue;var m=t.mapValue;if(g===Ci.mapValue&&m===Ci.mapValue)return 0;if(g===Ci.mapValue)return 1;if(m===Ci.mapValue)return-1;const w=g.fields||{},_=Object.keys(w),b=m.fields||{},I=Object.keys(b);_.sort(),I.sort();for(let e=0;e<_.length&&e<I.length;++e){const m=T(_[e],I[e]);if(0!==m)return m;var p=Mi(w[_[e]],b[I[e]]);if(0!==p)return p}return T(_.length,I.length);return}default:throw E()}}function Li(e,t){if("string"==typeof e&&"string"==typeof t&&e.length===t.length)return T(e,t);var e=bi(e),t=bi(t),n=T(e.seconds,t.seconds);return 0!==n?n:T(e.nanos,t.nanos)}function Oi(e){return function n(r){{if("nullValue"in r)return"null";if("booleanValue"in r)return""+r.booleanValue;if("integerValue"in r)return""+r.integerValue;if("doubleValue"in r)return""+r.doubleValue;if("timestampValue"in r)return`time(${(t=bi(r.timestampValue)).seconds},${t.nanos})`;if("stringValue"in r)return r.stringValue;if("bytesValue"in r)return Ii(r.bytesValue).toBase64();if("referenceValue"in r)return t=r.referenceValue,S.fromName(t).toString();if("geoPointValue"in r)return`geo(${(e=r.geoPointValue).latitude},${e.longitude})`;if("arrayValue"in r){let e="[",t=!0;for(const i of r.arrayValue.values||[])t?t=!1:e+=",",e+=n(i);return e+"]"}if("mapValue"in r){var s=r.mapValue;let e="{",t=!0;for(const a of Object.keys(s.fields||{}).sort())t?t=!1:e+=",",e+=a+":"+n(s.fields[a]);return e+"}"}return E()}var e,t}(e)}function Fi(e,t){return{referenceValue:`projects/${e.projectId}/databases/${e.database}/documents/`+t.path.canonicalString()}}function Pi(e){return e&&"integerValue"in e}function Vi(e){return!!e&&"arrayValue"in e}function Bi(e){return e&&"nullValue"in e}function qi(e){return e&&"doubleValue"in e&&isNaN(Number(e.doubleValue))}function Ui(e){return e&&"mapValue"in e}function zi(t){if(t.geoPointValue)return{geoPointValue:Object.assign({},t.geoPointValue)};if(t.timestampValue&&"object"==typeof t.timestampValue)return{timestampValue:Object.assign({},t.timestampValue)};if(t.mapValue){const n={mapValue:{fields:{}}};return li(t.mapValue.fields,(e,t)=>n.mapValue.fields[e]=zi(t)),n}if(t.arrayValue){const r={arrayValue:{values:[]}};for(let e=0;e<(t.arrayValue.values||[]).length;++e)r.arrayValue.values[e]=zi(t.arrayValue.values[e]);return r}return Object.assign({},t)}function Gi(e){return"__max__"===(((e.mapValue||{}).fields||{}).__type__||{}).stringValue}function ji(e,t){var n=Mi(e.value,t.value);return 0!==n?n:e.inclusive&&!t.inclusive?-1:!e.inclusive&&t.inclusive?1:0}function Ki(e,t){var n=Mi(e.value,t.value);return 0!==n?n:e.inclusive&&!t.inclusive?1:!e.inclusive&&t.inclusive?-1:0}class Qi{constructor(e){this.value=e}static empty(){return new Qi({mapValue:{}})}field(n){if(n.isEmpty())return this.value;{let t=this.value;for(let e=0;e<n.length-1;++e)if(!Ui(t=(t.mapValue.fields||{})[n.get(e)]))return null;return(t=(t.mapValue.fields||{})[n.lastSegment()])||null}}set(e,t){this.getFieldsMap(e.popLast())[e.lastSegment()]=zi(t)}setAll(e){let n=f.emptyPath(),r={},s=[];e.forEach((e,t)=>{if(!n.isImmediateParentOf(t)){const e=this.getFieldsMap(n);this.applyChanges(e,r,s),r={},s=[],n=t.popLast()}e?r[t.lastSegment()]=zi(e):s.push(t.lastSegment())});e=this.getFieldsMap(n);this.applyChanges(e,r,s)}delete(e){const t=this.field(e.popLast());Ui(t)&&t.mapValue.fields&&delete t.mapValue.fields[e.lastSegment()]}isEqual(e){return ki(this.value,e.value)}getFieldsMap(n){let r=this.value;r.mapValue.fields||(r.mapValue={fields:{}});for(let t=0;t<n.length;++t){let e=r.mapValue.fields[n.get(t)];Ui(e)&&e.mapValue.fields||(e={mapValue:{fields:{}}},r.mapValue.fields[n.get(t)]=e),r=e}return r.mapValue.fields}applyChanges(n,e,t){li(e,(e,t)=>n[e]=t);for(const e of t)delete n[e]}clone(){return new Qi(zi(this.value))}}class k{constructor(e,t,n,r,s,i,a){this.key=e,this.documentType=t,this.version=n,this.readTime=r,this.createTime=s,this.data=i,this.documentState=a}static newInvalidDocument(e){return new k(e,0,b.min(),b.min(),b.min(),Qi.empty(),0)}static newFoundDocument(e,t,n,r){return new k(e,1,t,b.min(),n,r,0)}static newNoDocument(e,t){return new k(e,2,t,b.min(),b.min(),Qi.empty(),0)}static newUnknownDocument(e,t){return new k(e,3,t,b.min(),b.min(),Qi.empty(),2)}convertToFoundDocument(e,t){return!this.createTime.isEqual(b.min())||2!==this.documentType&&0!==this.documentType||(this.createTime=e),this.version=e,this.documentType=1,this.data=t,this.documentState=0,this}convertToNoDocument(e){return this.version=e,this.documentType=2,this.data=Qi.empty(),this.documentState=0,this}convertToUnknownDocument(e){return this.version=e,this.documentType=3,this.data=Qi.empty(),this.documentState=2,this}setHasCommittedMutations(){return this.documentState=2,this}setHasLocalMutations(){return this.documentState=1,this.version=b.min(),this}setReadTime(e){return this.readTime=e,this}get hasLocalMutations(){return 1===this.documentState}get hasCommittedMutations(){return 2===this.documentState}get hasPendingWrites(){return this.hasLocalMutations||this.hasCommittedMutations}isValidDocument(){return 0!==this.documentType}isFoundDocument(){return 1===this.documentType}isNoDocument(){return 2===this.documentType}isUnknownDocument(){return 3===this.documentType}isEqual(e){return e instanceof k&&this.key.isEqual(e.key)&&this.version.isEqual(e.version)&&this.documentType===e.documentType&&this.documentState===e.documentState&&this.data.isEqual(e.data)}mutableCopy(){return new k(this.key,this.documentType,this.version,this.readTime,this.createTime,this.data.clone(),this.documentState)}toString(){return`Document(${this.key}, ${this.version}, ${JSON.stringify(this.data.value)}, {createTime: ${this.createTime}}), {documentType: ${this.documentType}}), {documentState: ${this.documentState}})`}}class $i{constructor(e,t){this.position=e,this.inclusive=t}}function Wi(t,n,r){let s=0;for(let e=0;e<t.position.length;e++){const i=n[e],a=t.position[e];if(s=i.field.isKeyField()?S.comparator(S.fromName(a.referenceValue),r.key):Mi(a,r.data.field(i.field)),"desc"===i.dir&&(s*=-1),0!==s)break}return s}function Hi(t,n){if(null===t)return null===n;if(null===n)return!1;if(t.inclusive!==n.inclusive||t.position.length!==n.position.length)return!1;for(let e=0;e<t.position.length;e++)if(!ki(t.position[e],n.position[e]))return!1;return!0}class Yi{constructor(e,t="asc"){this.field=e,this.dir=t}}class Xi{}class R extends Xi{constructor(e,t,n){super(),this.field=e,this.op=t,this.value=n}static create(e,t,n){return e.isKeyField()?"in"===t||"not-in"===t?this.createKeyFieldInFilter(e,t,n):new sa(e,t,n):"array-contains"===t?new ua(e,n):"in"===t?new ha(e,n):"not-in"===t?new ca(e,n):"array-contains-any"===t?new la(e,n):new R(e,t,n)}static createKeyFieldInFilter(e,t,n){return new("in"===t?ia:aa)(e,n)}matches(e){e=e.data.field(this.field);return"!="===this.op?null!==e&&this.matchesComparison(Mi(e,this.value)):null!==e&&Ni(this.value)===Ni(e)&&this.matchesComparison(Mi(e,this.value))}matchesComparison(e){switch(this.op){case"<":return e<0;case"<=":return e<=0;case"==":return 0===e;case"!=":return 0!==e;case">":return 0<e;case">=":return 0<=e;default:return E()}}isInequality(){return 0<=["<","<=",">",">=","!=","not-in"].indexOf(this.op)}getFlattenedFilters(){return[this]}getFilters(){return[this]}}class M extends Xi{constructor(e,t){super(),this.filters=e,this.op=t,this.ue=null}static create(e,t){return new M(e,t)}matches(t){return Ji(this)?void 0===this.filters.find(e=>!e.matches(t)):void 0!==this.filters.find(e=>e.matches(t))}getFlattenedFilters(){return null===this.ue&&(this.ue=this.filters.reduce((e,t)=>e.concat(t.getFlattenedFilters()),[])),this.ue}getFilters(){return Object.assign([],this.filters)}}function Ji(e){return"and"===e.op}function Zi(e){return"or"===e.op}function ea(e){return ta(e)&&Ji(e)}function ta(e){for(const t of e.filters)if(t instanceof M)return!1;return!0}function na(e,t){t=e.filters.concat(t);return M.create(t,e.op)}function ra(e){return e instanceof R?`${(t=e).field.canonicalString()} ${t.op} `+Oi(t.value):e instanceof M?e.op.toString()+" {"+e.getFilters().map(ra).join(" ,")+"}":"Filter";var t}class sa extends R{constructor(e,t,n){super(e,t,n),this.key=S.fromName(n.referenceValue)}matches(e){e=S.comparator(e.key,this.key);return this.matchesComparison(e)}}class ia extends R{constructor(e,t){super(e,"in",t),this.keys=oa(0,t)}matches(t){return this.keys.some(e=>e.isEqual(t.key))}}class aa extends R{constructor(e,t){super(e,"not-in",t),this.keys=oa(0,t)}matches(t){return!this.keys.some(e=>e.isEqual(t.key))}}function oa(e,t){return((null==(t=t.arrayValue)?void 0:t.values)||[]).map(e=>S.fromName(e.referenceValue))}class ua extends R{constructor(e,t){super(e,"array-contains",t)}matches(e){e=e.data.field(this.field);return Vi(e)&&Ri(e.arrayValue,this.value)}}class ha extends R{constructor(e,t){super(e,"in",t)}matches(e){e=e.data.field(this.field);return null!==e&&Ri(this.value.arrayValue,e)}}class ca extends R{constructor(e,t){super(e,"not-in",t)}matches(e){if(Ri(this.value.arrayValue,{nullValue:"NULL_VALUE"}))return!1;e=e.data.field(this.field);return null!==e&&!Ri(this.value.arrayValue,e)}}class la extends R{constructor(e,t){super(e,"array-contains-any",t)}matches(e){const t=e.data.field(this.field);return!(!Vi(t)||!t.arrayValue.values)&&t.arrayValue.values.some(e=>Ri(this.value.arrayValue,e))}}class da{constructor(e,t=null,n=[],r=[],s=null,i=null,a=null){this.path=e,this.collectionGroup=t,this.orderBy=n,this.filters=r,this.limit=s,this.startAt=i,this.endAt=a,this.ce=null}}function fa(e,t=null,n=[],r=[],s=null,i=null,a=null){return new da(e,t,n,r,s,i,a)}function ga(e){const t=e;if(null===t.ce){let e=t.path.canonicalString();null!==t.collectionGroup&&(e+="|cg:"+t.collectionGroup),e=(e=(e+="|f:")+t.filters.map(e=>function t(e){if(e instanceof R)return e.field.canonicalString()+e.op.toString()+Oi(e.value);if(ea(e))return e.filters.map(e=>t(e)).join(",");var n=e.filters.map(e=>t(e)).join(",");return e.op+`(${n})`}(e)).join(",")+"|ob:")+t.orderBy.map(e=>{return e.field.canonicalString()+e.dir}).join(","),Ms(t.limit)||(e=(e+="|l:")+t.limit),t.startAt&&(e=(e=(e+="|lb:")+(t.startAt.inclusive?"b:":"a:"))+t.startAt.position.map(e=>Oi(e)).join(",")),t.endAt&&(e=(e=(e+="|ub:")+(t.endAt.inclusive?"a:":"b:"))+t.endAt.position.map(e=>Oi(e)).join(",")),t.ce=e}return t.ce}function ma(t,n){if(t.limit!==n.limit)return!1;if(t.orderBy.length!==n.orderBy.length)return!1;for(let e=0;e<t.orderBy.length;e++)if(r=t.orderBy[e],s=n.orderBy[e],r.dir!==s.dir||!r.field.isEqual(s.field))return!1;var r,s;if(t.filters.length!==n.filters.length)return!1;for(let e=0;e<t.filters.length;e++)if(!function r(e,t){return e instanceof R?(n=e,(i=t)instanceof R&&n.op===i.op&&n.field.isEqual(i.field)&&ki(n.value,i.value)):e instanceof M?(s=t)instanceof M&&e.op===s.op&&e.filters.length===s.filters.length&&e.filters.reduce((e,t,n)=>e&&r(t,s.filters[n]),!0):void E();var s,n,i}(t.filters[e],n.filters[e]))return!1;return t.collectionGroup===n.collectionGroup&&!!t.path.isEqual(n.path)&&!!Hi(t.startAt,n.startAt)&&Hi(t.endAt,n.endAt)}function pa(e){return S.isDocumentKey(e.path)&&null===e.collectionGroup&&0===e.filters.length}function ya(e,t){return e.filters.filter(e=>e instanceof R&&e.field.isEqual(t))}function va(t,n,r){let s=Ai,i=!0;for(const r of ya(t,n)){let e=Ai,t=!0;switch(r.op){case"<":case"<=":e="nullValue"in(a=r.value)?Ai:"booleanValue"in a?{booleanValue:!1}:"integerValue"in a||"doubleValue"in a?{doubleValue:NaN}:"timestampValue"in a?{timestampValue:{seconds:Number.MIN_SAFE_INTEGER}}:"stringValue"in a?{stringValue:""}:"bytesValue"in a?{bytesValue:""}:"referenceValue"in a?Fi(Di.empty(),S.empty()):"geoPointValue"in a?{geoPointValue:{latitude:-90,longitude:-180}}:"arrayValue"in a?{arrayValue:{}}:"mapValue"in a?{mapValue:{}}:E();break;case"==":case"in":case">=":e=r.value;break;case">":e=r.value,t=!1;break;case"!=":case"not-in":e=Ai}ji({value:s,inclusive:i},{value:e,inclusive:t})<0&&(s=e,i=t)}var a;if(null!==r)for(let e=0;e<t.orderBy.length;++e)if(t.orderBy[e].field.isEqual(n)){const t=r.position[e];ji({value:s,inclusive:i},{value:t,inclusive:r.inclusive})<0&&(s=t,i=r.inclusive);break}return{value:s,inclusive:i}}function wa(t,n,r){let s=Ci,i=!0;for(const r of ya(t,n)){let e=Ci,t=!0;switch(r.op){case">=":case">":e="nullValue"in(a=r.value)?{booleanValue:!1}:"booleanValue"in a?{doubleValue:NaN}:"integerValue"in a||"doubleValue"in a?{timestampValue:{seconds:Number.MIN_SAFE_INTEGER}}:"timestampValue"in a?{stringValue:""}:"stringValue"in a?{bytesValue:""}:"bytesValue"in a?Fi(Di.empty(),S.empty()):"referenceValue"in a?{geoPointValue:{latitude:-90,longitude:-180}}:"geoPointValue"in a?{arrayValue:{}}:"arrayValue"in a?{mapValue:{}}:"mapValue"in a?Ci:E(),t=!1;break;case"==":case"in":case"<=":e=r.value;break;case"<":e=r.value,t=!1;break;case"!=":case"not-in":e=Ci}0<Ki({value:s,inclusive:i},{value:e,inclusive:t})&&(s=e,i=t)}var a;if(null!==r)for(let e=0;e<t.orderBy.length;++e)if(t.orderBy[e].field.isEqual(n)){const t=r.position[e];0<Ki({value:s,inclusive:i},{value:t,inclusive:r.inclusive})&&(s=t,i=r.inclusive);break}return{value:s,inclusive:i}}class _a{constructor(e,t=null,n=[],r=[],s=null,i="F",a=null,o=null){this.path=e,this.collectionGroup=t,this.explicitOrderBy=n,this.filters=r,this.limit=s,this.limitType=i,this.startAt=a,this.endAt=o,this.le=null,this.he=null,this.Pe=null,this.startAt,this.endAt}}function ba(e,t,n,r,s,i,a,o){return new _a(e,t,n,r,s,i,a,o)}function Ia(e){return new _a(e)}function Ea(e){return 0===e.filters.length&&null===e.limit&&null==e.startAt&&null==e.endAt&&(0===e.explicitOrderBy.length||1===e.explicitOrderBy.length&&e.explicitOrderBy[0].field.isKeyField())}function Ta(e){return null!==e.collectionGroup}function Sa(t){const n=t;if(null===n.le){n.le=[];const t=new Set;for(const s of n.explicitOrderBy)n.le.push(s),t.add(s.field.canonicalString());const r=0<n.explicitOrderBy.length?n.explicitOrderBy[n.explicitOrderBy.length-1].dir:"asc",e=function(e){let t=new A(f.comparator);return e.filters.forEach(e=>{e.getFlattenedFilters().forEach(e=>{e.isInequality()&&(t=t.add(e.field))})}),t}(n);e.forEach(e=>{t.has(e.canonicalString())||e.isKeyField()||n.le.push(new Yi(e,r))}),t.has(f.keyField().canonicalString())||n.le.push(new Yi(f.keyField(),r))}return n.le}function xa(e){const t=e;return t.he||(t.he=function(e,t){if("F"===e.limitType)return fa(e.path,e.collectionGroup,t,e.filters,e.limit,e.startAt,e.endAt);t=t.map(e=>{var t="desc"===e.dir?"asc":"desc";return new Yi(e.field,t)});var n=e.endAt?new $i(e.endAt.position,e.endAt.inclusive):null,r=e.startAt?new $i(e.startAt.position,e.startAt.inclusive):null;return fa(e.path,e.collectionGroup,t,e.filters,e.limit,n,r)}(t,Sa(e))),t.he}function Da(e,t){t=e.filters.concat([t]);return new _a(e.path,e.collectionGroup,e.explicitOrderBy.slice(),t,e.limit,e.limitType,e.startAt,e.endAt)}function Ca(e,t,n){return new _a(e.path,e.collectionGroup,e.explicitOrderBy.slice(),e.filters.slice(),t,n,e.startAt,e.endAt)}function Aa(e,t){return ma(xa(e),xa(t))&&e.limitType===t.limitType}function Na(e){return ga(xa(e))+"|lt:"+e.limitType}function ka(e){return`Query(target=${function(e){let t=e.path.canonicalString();return null!==e.collectionGroup&&(t+=" collectionGroup="+e.collectionGroup),0<e.filters.length&&(t+=`, filters: [${e.filters.map(e=>ra(e)).join(", ")}]`),Ms(e.limit)||(t+=", limit: "+e.limit),0<e.orderBy.length&&(t+=`, orderBy: [${e.orderBy.map(e=>{return`${e.field.canonicalString()} (${e.dir})`}).join(", ")}]`),e.startAt&&(t=(t=(t+=", startAt: ")+(e.startAt.inclusive?"b:":"a:"))+e.startAt.position.map(e=>Oi(e)).join(",")),`Target(${t=e.endAt?(t=(t+=", endAt: ")+(e.endAt.inclusive?"a:":"b:"))+e.endAt.position.map(e=>Oi(e)).join(","):t})`}(xa(e))}; limitType=${e.limitType})`}function Ra(n,e){return e.isFoundDocument()&&(s=n,a=(i=e).key.path,null!==s.collectionGroup?i.key.hasCollectionId(s.collectionGroup)&&s.path.isPrefixOf(a):S.isDocumentKey(s.path)?s.path.isEqual(a):s.path.isImmediateParentOf(a))&&function(e){for(const t of Sa(n))if(!t.field.isKeyField()&&null===e.data.field(t.field))return;return 1}(e)&&function(e){for(const t of n.filters)if(!t.matches(e))return;return 1}(e)&&(s=e,(!(e=n).startAt||(r=Wi(t=e.startAt,n=Sa(e),s),t.inclusive?r<=0:r<0))&&(!e.endAt||(r=Wi(t=e.endAt,e=Sa(e),s),t.inclusive?0<=r:0<r)));var t,r,s,i,a}function Ma(e){return e.collectionGroup||(e.path.length%2==1?e.path.lastSegment():e.path.get(e.path.length-2))}function La(s){return(e,t)=>{let n=!1;for(const r of Sa(s)){const s=function(e,t,n){var r,s=e.field.isKeyField()?S.comparator(t.key,n.key):(r=e.field,n=n,t=t.data.field(r),n=n.data.field(r),null!==t&&null!==n?Mi(t,n):E());switch(e.dir){case"asc":return s;case"desc":return-1*s;default:return E()}}(r,e,t);if(0!==s)return s;n=n||r.field.isKeyField()}return 0}}class Oa{constructor(e,t){this.mapKeyFn=e,this.equalsFn=t,this.inner={},this.innerSize=0}get(e){const t=this.mapKeyFn(e),n=this.inner[t];if(void 0!==n)for(const[t,r]of n)if(this.equalsFn(t,e))return r}has(e){return void 0!==this.get(e)}set(t,n){const e=this.mapKeyFn(t),r=this.inner[e];if(void 0===r)return this.inner[e]=[[t,n]],void this.innerSize++;for(let e=0;e<r.length;e++)if(this.equalsFn(r[e][0],t))return void(r[e]=[t,n]);r.push([t,n]),this.innerSize++}delete(t){const n=this.mapKeyFn(t),r=this.inner[n];if(void 0===r)return!1;for(let e=0;e<r.length;e++)if(this.equalsFn(r[e][0],t))return 1===r.length?delete this.inner[n]:r.splice(e,1),this.innerSize--,!0;return!1}forEach(r){li(this.inner,(e,t)=>{for(const[e,n]of t)r(e,n)})}isEmpty(){return di(this.inner)}size(){return this.innerSize}}const Fa=new C(S.comparator),Pa=new C(S.comparator);function Va(...e){let t=Pa;for(const n of e)t=t.insert(n.key,n);return t}function Ba(e){let n=Pa;return e.forEach((e,t)=>n=n.insert(e,t.overlayedDocument)),n}function qa(){return new Oa(e=>e.toString(),(e,t)=>e.isEqual(t))}const Ua=new C(S.comparator),za=new A(S.comparator);function L(...e){let t=za;for(const n of e)t=t.add(n);return t}const Ga=new A(T);function ja(e,t){if(e.useProto3Json){if(isNaN(t))return{doubleValue:"NaN"};if(t===1/0)return{doubleValue:"Infinity"};if(t===-1/0)return{doubleValue:"-Infinity"}}return{doubleValue:Ls(t)?"-0":t}}function Ka(e){return{integerValue:""+e}}function Qa(e,t){return Os(t)?Ka(t):ja(e,t)}class $a{constructor(){this._=void 0}}function Wa(e,t){return e instanceof eo?Pi(e=t)||e&&"doubleValue"in e?t:{integerValue:0}:null}class Ha extends $a{}class Ya extends $a{constructor(e){super(),this.elements=e}}function Xa(e,t){const n=no(t);for(const t of e.elements)n.some(e=>ki(e,t))||n.push(t);return{arrayValue:{values:n}}}class Ja extends $a{constructor(e){super(),this.elements=e}}function Za(e,t){let n=no(t);for(const t of e.elements)n=n.filter(e=>!ki(e,t));return{arrayValue:{values:n}}}class eo extends $a{constructor(e,t){super(),this.serializer=e,this.Ie=t}}function to(e){return N(e.integerValue||e.doubleValue)}function no(e){return Vi(e)&&e.arrayValue.values?e.arrayValue.values.slice():[]}class ro{constructor(e,t){this.field=e,this.transform=t}}class so{constructor(e,t){this.version=e,this.transformResults=t}}class O{constructor(e,t){this.updateTime=e,this.exists=t}static none(){return new O}static exists(e){return new O(void 0,e)}static updateTime(e){return new O(e)}get isNone(){return void 0===this.updateTime&&void 0===this.exists}isEqual(e){return this.exists===e.exists&&(this.updateTime?!!e.updateTime&&this.updateTime.isEqual(e.updateTime):!e.updateTime)}}function io(e,t){return void 0!==e.updateTime?t.isFoundDocument()&&t.version.isEqual(e.updateTime):void 0===e.exists||e.exists===t.isFoundDocument()}class ao{}function oo(e,n){if(!e.hasLocalMutations||n&&0===n.fields.length)return null;if(null===n)return e.isNoDocument()?new po(e.key,O.none()):new co(e.key,e.data,O.none());{const s=e.data,i=Qi.empty();let t=new A(f.comparator);for(var r of n.fields)if(!t.has(r)){let e=s.field(r);null===e&&1<r.length&&(r=r.popLast(),e=s.field(r)),null===e?i.delete(r):i.set(r,e),t=t.add(r)}return new lo(e.key,i,new yi(t.toArray()),O.none())}}function uo(e,t,n,r){if(e instanceof co){var s=e,i=t,a=n,o=r;if(!io(s.precondition,i))return a;const u=s.value.clone(),h=mo(s.fieldTransforms,o,i);return u.setAll(h),i.convertToFoundDocument(i.version,u).setHasLocalMutations(),null}if(e instanceof lo){a=e,s=t,o=n,i=r;if(!io(a.precondition,s))return o;const c=mo(a.fieldTransforms,i,s),l=s.data;return l.setAll(fo(a)),l.setAll(c),s.convertToFoundDocument(s.version,l).setHasLocalMutations(),null===o?null:o.unionWith(a.fieldMask.fields).unionWith(a.fieldTransforms.map(e=>e.field))}return io(e.precondition,t)?(t.convertToNoDocument(t.version).setHasLocalMutations(),null):n}function ho(e,t){return e.type===t.type&&!!e.key.isEqual(t.key)&&!!e.precondition.isEqual(t.precondition)&&(n=e.fieldTransforms,r=t.fieldTransforms,!!(void 0===n&&void 0===r||n&&r&&is(n,r,(e,t)=>{return e.field.isEqual(t.field)&&(e=e.transform,t=t.transform,e instanceof Ya&&t instanceof Ya||e instanceof Ja&&t instanceof Ja?is(e.elements,t.elements,ki):e instanceof eo&&t instanceof eo?ki(e.Ie,t.Ie):e instanceof Ha&&t instanceof Ha)}))&&(0===e.type?e.value.isEqual(t.value):1!==e.type||e.data.isEqual(t.data)&&e.fieldMask.isEqual(t.fieldMask)));var n,r}class co extends ao{constructor(e,t,n,r=[]){super(),this.key=e,this.value=t,this.precondition=n,this.fieldTransforms=r,this.type=0}getFieldMask(){return null}}class lo extends ao{constructor(e,t,n,r,s=[]){super(),this.key=e,this.data=t,this.fieldMask=n,this.precondition=r,this.fieldTransforms=s,this.type=1}getFieldMask(){return this.fieldMask}}function fo(n){const r=new Map;return n.fieldMask.fields.forEach(e=>{var t;e.isEmpty()||(t=n.data.field(e),r.set(e,t))}),r}function go(t,n,r){const s=new Map;y(t.length===r.length);for(let e=0;e<r.length;e++){var i=t[e],a=i.transform,o=n.data.field(i.field);s.set(i.field,(i=a,a=o,o=r[e],i instanceof Ya?Xa(i,a):i instanceof Ja?Za(i,a):o))}return s}function mo(e,t,n){const r=new Map;for(const u of e){const e=u.transform,h=n.data.field(u.field);r.set(u.field,(s=e,a=h,i=t,0,s instanceof Ha?function(e){const t={fields:{__type__:{stringValue:"server_timestamp"},__local_write_time__:{timestampValue:{seconds:i.seconds,nanos:i.nanoseconds}}}};return(e=e&&Ei(e)?Ti(e):e)&&(t.fields.__previous_value__=e),{mapValue:t}}(a):s instanceof Ya?Xa(s,a):s instanceof Ja?Za(s,a):(o=to(a=Wa(s,a))+to(s.Ie),Pi(a)&&Pi(s.Ie)?Ka(o):ja(s.serializer,o))))}var s,i,a,o;return r}class po extends ao{constructor(e,t){super(),this.key=e,this.precondition=t,this.type=2,this.fieldTransforms=[]}getFieldMask(){return null}}class yo extends ao{constructor(e,t){super(),this.key=e,this.precondition=t,this.type=3,this.fieldTransforms=[]}getFieldMask(){return null}}class vo{constructor(e,t,n,r){this.batchId=e,this.localWriteTime=t,this.baseMutations=n,this.mutations=r}applyToRemoteDocument(t,e){var n=e.mutationResults;for(let e=0;e<this.mutations.length;e++){const h=this.mutations[e];if(h.key.isEqual(t.key)){r=void 0;s=void 0;i=void 0;a=void 0;o=void 0;u=void 0;a=void 0;o=void 0;u=void 0;var r=h;var s=t;var i=n[e];if(r instanceof co){var a=r,o=s,u=i;const c=a.value.clone(),l=go(a.fieldTransforms,o,u.transformResults);c.setAll(l),o.convertToFoundDocument(u.version,c).setHasCommittedMutations()}else if(r instanceof lo){a=r,o=s,u=i;if(io(a.precondition,o)){const d=go(a.fieldTransforms,o,u.transformResults),f=o.data;f.setAll(fo(a)),f.setAll(d),o.convertToFoundDocument(u.version,f).setHasCommittedMutations()}else o.convertToUnknownDocument(u.version)}else s.convertToNoDocument(i.version).setHasCommittedMutations()}}}applyToLocalView(e,t){for(const n of this.baseMutations)n.key.isEqual(e.key)&&(t=uo(n,e,t,this.localWriteTime));for(const r of this.mutations)r.key.isEqual(e.key)&&(t=uo(r,e,t,this.localWriteTime));return t}applyToLocalDocumentSet(i,a){const o=qa();return this.mutations.forEach(e=>{const t=i.get(e.key),n=t.overlayedDocument;let r=this.applyToLocalView(n,t.mutatedFields);r=a.has(e.key)?null:r;var s=oo(n,r);null!==s&&o.set(e.key,s),n.isValidDocument()||n.convertToNoDocument(b.min())}),o}keys(){return this.mutations.reduce((e,t)=>e.add(t.key),L())}isEqual(e){return this.batchId===e.batchId&&is(this.mutations,e.mutations,(e,t)=>ho(e,t))&&is(this.baseMutations,e.baseMutations,(e,t)=>ho(e,t))}}class wo{constructor(e,t,n,r){this.batch=e,this.commitVersion=t,this.mutationResults=n,this.docVersions=r}static from(e,t,n){y(e.mutations.length===n.length);let r=Ua;var s=e.mutations;for(let e=0;e<s.length;e++)r=r.insert(s[e].key,n[e].version);return new wo(e,t,n,r)}}class _o{constructor(e,t){this.largestBatchId=e,this.mutation=t}getKey(){return this.mutation.key}isEqual(e){return null!==e&&this.mutation===e.mutation}toString(){return`Overlay{
      largestBatchId: ${this.largestBatchId},
      mutation: ${this.mutation.toString()}
    }`}}class bo{constructor(e,t){this.count=e,this.unchangedNames=t}}function Io(e){switch(e){default:return E(),0;case w.CANCELLED:case w.UNKNOWN:case w.DEADLINE_EXCEEDED:case w.RESOURCE_EXHAUSTED:case w.INTERNAL:case w.UNAVAILABLE:case w.UNAUTHENTICATED:return;case w.INVALID_ARGUMENT:case w.NOT_FOUND:case w.ALREADY_EXISTS:case w.PERMISSION_DENIED:case w.FAILED_PRECONDITION:case w.ABORTED:case w.OUT_OF_RANGE:case w.UNIMPLEMENTED:case w.DATA_LOSS:return 1}}function Eo(e){if(void 0===e)return d("GRPC error has no .code"),w.UNKNOWN;switch(e){case g.OK:return w.OK;case g.CANCELLED:return w.CANCELLED;case g.UNKNOWN:return w.UNKNOWN;case g.DEADLINE_EXCEEDED:return w.DEADLINE_EXCEEDED;case g.RESOURCE_EXHAUSTED:return w.RESOURCE_EXHAUSTED;case g.INTERNAL:return w.INTERNAL;case g.UNAVAILABLE:return w.UNAVAILABLE;case g.UNAUTHENTICATED:return w.UNAUTHENTICATED;case g.INVALID_ARGUMENT:return w.INVALID_ARGUMENT;case g.NOT_FOUND:return w.NOT_FOUND;case g.ALREADY_EXISTS:return w.ALREADY_EXISTS;case g.PERMISSION_DENIED:return w.PERMISSION_DENIED;case g.FAILED_PRECONDITION:return w.FAILED_PRECONDITION;case g.ABORTED:return w.ABORTED;case g.OUT_OF_RANGE:return w.OUT_OF_RANGE;case g.UNIMPLEMENTED:return w.UNIMPLEMENTED;case g.DATA_LOSS:return w.DATA_LOSS;default:return E()}}function To(){return new TextEncoder}pe=g={OK:0,0:"OK",CANCELLED:1,1:"CANCELLED",UNKNOWN:2,2:"UNKNOWN",INVALID_ARGUMENT:3,3:"INVALID_ARGUMENT",DEADLINE_EXCEEDED:4,4:"DEADLINE_EXCEEDED",NOT_FOUND:5,5:"NOT_FOUND",ALREADY_EXISTS:6,6:"ALREADY_EXISTS",PERMISSION_DENIED:7,7:"PERMISSION_DENIED",UNAUTHENTICATED:16,16:"UNAUTHENTICATED",RESOURCE_EXHAUSTED:8,8:"RESOURCE_EXHAUSTED",FAILED_PRECONDITION:9,9:"FAILED_PRECONDITION",ABORTED:10,10:"ABORTED",OUT_OF_RANGE:11,11:"OUT_OF_RANGE",UNIMPLEMENTED:12,12:"UNIMPLEMENTED",INTERNAL:13,13:"INTERNAL",UNAVAILABLE:14,14:"UNAVAILABLE",DATA_LOSS:15,15:"DATA_LOSS"};const So=new Gr([4294967295,4294967295],0);function xo(e){const t=To().encode(e),n=new zr;return n.update(t),new Uint8Array(n.digest())}function Do(e){const t=new DataView(e.buffer),n=t.getUint32(0,!0),r=t.getUint32(4,!0),s=t.getUint32(8,!0),i=t.getUint32(12,!0);return[new Gr([n,r],0),new Gr([s,i],0)]}class Co{constructor(e,t,n){if(this.bitmap=e,this.padding=t,this.hashCount=n,t<0||8<=t)throw new Ao("Invalid padding: "+t);if(n<0)throw new Ao("Invalid hash count: "+n);if(0<e.length&&0===this.hashCount)throw new Ao("Invalid hash count: "+n);if(0===e.length&&0!==t)throw new Ao("Invalid padding when bitmap length is 0: "+t);this.Te=8*e.length-t,this.Ee=Gr.fromNumber(this.Te)}de(e,t,n){let r=e.add(t.multiply(Gr.fromNumber(n)));return(r=1===r.compare(So)?new Gr([r.getBits(0),r.getBits(1)],0):r).modulo(this.Ee).toNumber()}Ae(e){return 0!=(this.bitmap[Math.floor(e/8)]&1<<e%8)}mightContain(e){if(0===this.Te)return!1;const t=xo(e),[n,r]=Do(t);for(let e=0;e<this.hashCount;e++){const t=this.de(n,r,e);if(!this.Ae(t))return!1}return!0}static create(e,t,n){const r=e%8==0?0:8-e%8,s=new Uint8Array(Math.ceil(e/8)),i=new Co(s,r,t);return n.forEach(e=>i.insert(e)),i}insert(e){if(0!==this.Te){var[t,n]=Do(xo(e));for(let e=0;e<this.hashCount;e++){var r=this.de(t,n,e);this.Re(r)}}}Re(e){var t=Math.floor(e/8);this.bitmap[t]|=1<<e%8}}class Ao extends Error{constructor(){super(...arguments),this.name="BloomFilterError"}}class No{constructor(e,t,n,r,s){this.snapshotVersion=e,this.targetChanges=t,this.targetMismatches=n,this.documentUpdates=r,this.resolvedLimboDocuments=s}static createSynthesizedRemoteEventForCurrentChange(e,t,n){const r=new Map;return r.set(e,ko.createSynthesizedTargetChangeForCurrentChange(e,t,n)),new No(b.min(),r,new C(T),Fa,L())}}class ko{constructor(e,t,n,r,s){this.resumeToken=e,this.current=t,this.addedDocuments=n,this.modifiedDocuments=r,this.removedDocuments=s}static createSynthesizedTargetChangeForCurrentChange(e,t,n){return new ko(n,t,L(),L(),L())}}class Ro{constructor(e,t,n,r){this.Ve=e,this.removedTargetIds=t,this.key=n,this.me=r}}class Mo{constructor(e,t){this.targetId=e,this.fe=t}}class Lo{constructor(e,t,n=wi.EMPTY_BYTE_STRING,r=null){this.state=e,this.targetIds=t,this.resumeToken=n,this.cause=r}}class Oo{constructor(){this.ge=0,this.pe=Vo(),this.ye=wi.EMPTY_BYTE_STRING,this.we=!1,this.Se=!0}get current(){return this.we}get resumeToken(){return this.ye}get be(){return 0!==this.ge}get De(){return this.Se}Ce(e){0<e.approximateByteSize()&&(this.Se=!0,this.ye=e)}ve(){let n=L(),r=L(),s=L();return this.pe.forEach((e,t)=>{switch(t){case 0:n=n.add(e);break;case 2:r=r.add(e);break;case 1:s=s.add(e);break;default:E()}}),new ko(this.ye,this.we,n,r,s)}Fe(){this.Se=!1,this.pe=Vo()}Me(e,t){this.Se=!0,this.pe=this.pe.insert(e,t)}xe(e){this.Se=!0,this.pe=this.pe.remove(e)}Oe(){this.ge+=1}Ne(){--this.ge}Be(){this.Se=!0,this.we=!0}}class Fo{constructor(e){this.Le=e,this.ke=new Map,this.qe=Fa,this.Qe=Po(),this.Ke=new C(T)}$e(e){for(const t of e.Ve)e.me&&e.me.isFoundDocument()?this.Ue(t,e.me):this.We(t,e.key,e.me);for(const n of e.removedTargetIds)this.We(n,e.key,e.me)}Ge(n){this.forEachTarget(n,e=>{const t=this.ze(e);switch(n.state){case 0:this.je(e)&&t.Ce(n.resumeToken);break;case 1:t.Ne(),t.be||t.Fe(),t.Ce(n.resumeToken);break;case 2:t.Ne(),t.be||this.removeTarget(e);break;case 3:this.je(e)&&(t.Be(),t.Ce(n.resumeToken));break;case 4:this.je(e)&&(this.He(e),t.Ce(n.resumeToken));break;default:E()}})}forEachTarget(e,n){0<e.targetIds.length?e.targetIds.forEach(n):this.ke.forEach((e,t)=>{this.je(t)&&n(t)})}Je(e){const t=e.targetId,n=e.fe.count,r=this.Ye(t);if(r){var s=r.target;if(pa(s))if(0===n){const e=new S(s.path);this.We(t,e,k.newNoDocument(e,b.min()))}else y(1===n);else{const r=this.Ze(t);if(r!==n){const n=this.Xe(e),i=n?this.et(n,e,r):1;if(0!==i){this.He(t);const e=2===i?"TargetPurposeExistenceFilterMismatchBloom":"TargetPurposeExistenceFilterMismatch";this.Ke=this.Ke.insert(t,e)}}}}}Xe(e){if(!(r=e.fe.unchangedNames)||!r.bits)return null;var{bits:{bitmap:t="",padding:n=0},hashCount:r=0}=r;let s,i;try{s=Ii(t).toUint8Array()}catch(e){if(e instanceof vi)return $r("Decoding the base64 bloom filter in existence filter failed ("+e.message+"); ignoring the bloom filter and falling back to full re-query."),null;throw e}try{i=new Co(s,n,r)}catch(e){return $r(e instanceof Ao?"BloomFilter error: ":"Applying bloom filter failed: ",e),null}return 0===i.Te?null:i}et(e,t,n){return t.fe.count===n-this.rt(e,t.targetId)?0:2}rt(n,r){const e=this.Le.getRemoteKeysForTarget(r);let s=0;return e.forEach(e=>{var t=`projects/${(t=this.Le.nt()).projectId}/databases/${t.database}/documents/`+e.path.canonicalString();n.mightContain(t)||(this.We(r,e,null),s++)}),s}it(r){const s=new Map;this.ke.forEach((e,t)=>{var n=this.Ye(t);if(n){if(e.current&&pa(n.target)){const s=new S(n.target.path);null!==this.qe.get(s)||this.st(t,s)||this.We(t,s,k.newNoDocument(s,r))}e.De&&(s.set(t,e.ve()),e.Fe())}});let i=L();this.Qe.forEach((e,t)=>{let n=!0;t.forEachWhile(e=>{e=this.Ye(e);return!e||"TargetPurposeLimboResolution"===e.purpose||(n=!1)}),n&&(i=i.add(e))}),this.qe.forEach((e,t)=>t.setReadTime(r));var e=new No(r,s,this.Ke,this.qe,i);return this.qe=Fa,this.Qe=Po(),this.Ke=new C(T),e}Ue(e,t){var n;this.je(e)&&(n=this.st(e,t.key)?2:0,this.ze(e).Me(t.key,n),this.qe=this.qe.insert(t.key,t),this.Qe=this.Qe.insert(t.key,this.ot(t.key).add(e)))}We(e,t,n){if(this.je(e)){const r=this.ze(e);this.st(e,t)?r.Me(t,1):r.xe(t),this.Qe=this.Qe.insert(t,this.ot(t).delete(e)),n&&(this.qe=this.qe.insert(t,n))}}removeTarget(e){this.ke.delete(e)}Ze(e){var t=this.ze(e).ve();return this.Le.getRemoteKeysForTarget(e).size+t.addedDocuments.size-t.removedDocuments.size}Oe(e){this.ze(e).Oe()}ze(e){let t=this.ke.get(e);return t||(t=new Oo,this.ke.set(e,t)),t}ot(e){let t=this.Qe.get(e);return t||(t=new A(T),this.Qe=this.Qe.insert(e,t)),t}je(e){var t=null!==this.Ye(e);return t||m("WatchChangeAggregator","Detected inactive target",e),t}Ye(e){var t=this.ke.get(e);return t&&t.be?null:this.Le._t(e)}He(t){this.ke.set(t,new Oo),this.Le.getRemoteKeysForTarget(t).forEach(e=>{this.We(t,e,null)})}st(e,t){return this.Le.getRemoteKeysForTarget(e).has(t)}}function Po(){return new C(S.comparator)}function Vo(){return new C(S.comparator)}const Bo={asc:"ASCENDING",desc:"DESCENDING"},qo={"<":"LESS_THAN","<=":"LESS_THAN_OR_EQUAL",">":"GREATER_THAN",">=":"GREATER_THAN_OR_EQUAL","==":"EQUAL","!=":"NOT_EQUAL","array-contains":"ARRAY_CONTAINS",in:"IN","not-in":"NOT_IN","array-contains-any":"ARRAY_CONTAINS_ANY"},Uo={and:"AND",or:"OR"};class zo{constructor(e,t){this.databaseId=e,this.useProto3Json=t}}function Go(e,t){return e.useProto3Json||Ms(t)?t:{value:t}}function jo(e,t){return e.useProto3Json?`${new Date(1e3*t.seconds).toISOString().replace(/\.\d*/,"").replace("Z","")}.${("000000000"+t.nanoseconds).slice(-9)}Z`:{seconds:""+t.seconds,nanos:t.nanoseconds}}function Ko(e,t){return e.useProto3Json?t.toBase64():t.toUint8Array()}function F(e){return y(!!e),b.fromTimestamp((e=bi(e),new c(e.seconds,e.nanos)))}function Qo(e,t){return new I(["projects",e.projectId,"databases",e.database]).child("documents").child(t).canonicalString()}function $o(e){e=I.fromString(e);return y(hu(e)),e}function Wo(e,t){return Qo(e.databaseId,t.path)}function Ho(e,t){const n=$o(t);if(n.get(1)!==e.databaseId.projectId)throw new _(w.INVALID_ARGUMENT,"Tried to deserialize key from different project: "+n.get(1)+" vs "+e.databaseId.projectId);if(n.get(3)!==e.databaseId.database)throw new _(w.INVALID_ARGUMENT,"Tried to deserialize key from different database: "+n.get(3)+" vs "+e.databaseId.database);return new S(Zo(n))}function Yo(e,t){return Qo(e.databaseId,t)}function Xo(e){e=$o(e);return 4===e.length?I.emptyPath():Zo(e)}function Jo(e){return new I(["projects",e.databaseId.projectId,"databases",e.databaseId.database]).canonicalString()}function Zo(e){return y(4<e.length&&"documents"===e.get(4)),e.popFirst(5)}function eu(e,t,n){return{name:Wo(e,t),fields:n.value.mapValue.fields}}function tu(e,t,n){const r=Ho(e,t.name),s=F(t.updateTime),i=t.createTime?F(t.createTime):b.min(),a=new Qi({mapValue:{fields:t.fields}}),o=k.newFoundDocument(r,s,i,a);return n&&o.setHasCommittedMutations(),n?o.setHasCommittedMutations():o}function nu(e,t){let n;if(t instanceof co)n={update:eu(e,t.key,t.value)};else if(t instanceof po)n={delete:Wo(e,t.key)};else if(t instanceof lo)n={update:eu(e,t.key,t.data),updateMask:function(e){const t=[];return e.fields.forEach(e=>t.push(e.canonicalString())),{fieldPaths:t}}(t.fieldMask)};else{if(!(t instanceof yo))return E();n={verify:Wo(e,t.key)}}return 0<t.fieldTransforms.length&&(n.updateTransforms=t.fieldTransforms.map(e=>{var t=e.transform;if(t instanceof Ha)return{fieldPath:e.field.canonicalString(),setToServerValue:"REQUEST_TIME"};if(t instanceof Ya)return{fieldPath:e.field.canonicalString(),appendMissingElements:{values:t.elements}};if(t instanceof Ja)return{fieldPath:e.field.canonicalString(),removeAllFromArray:{values:t.elements}};if(t instanceof eo)return{fieldPath:e.field.canonicalString(),increment:t.Ie};throw E()})),t.precondition.isNone||(n.currentDocument=(r=e,void 0!==(e=t.precondition).updateTime?{updateTime:jo(r,(t=e.updateTime).toTimestamp())}:void 0!==e.exists?{exists:e.exists}:E())),n;var r}function ru(r,t){const e=t.currentDocument?void 0!==(s=t.currentDocument).updateTime?O.updateTime(F(s.updateTime)):void 0!==s.exists?O.exists(s.exists):O.none():O.none(),n=t.updateTransforms?t.updateTransforms.map(t=>{{var n=r;let e=null;if("setToServerValue"in t)y("REQUEST_TIME"===t.setToServerValue),e=new Ha;else if("appendMissingElements"in t){const n=t.appendMissingElements.values||[];e=new Ya(n)}else if("removeAllFromArray"in t){const n=t.removeAllFromArray.values||[];e=new Ja(n)}else"increment"in t?e=new eo(n,t.increment):E();return n=f.fromServerFormat(t.fieldPath),new ro(n,e)}}):[];if(t.update){t.update.name;var s=Ho(r,t.update.name),i=new Qi({mapValue:{fields:t.update.fields}});if(t.updateMask){const r=function(){const e=t.updateMask.fieldPaths||[];return new yi(e.map(e=>f.fromServerFormat(e)))}();return new lo(s,i,r,e,n)}return new co(s,i,e,n)}if(t.delete){const n=Ho(r,t.delete);return new po(n,e)}if(t.verify){const n=Ho(r,t.verify);return new yo(n,e)}return E()}function su(e,t){return{documents:[Yo(e,t.path)]}}function iu(e,t){const n={structuredQuery:{}},r=t.path;null!==t.collectionGroup?(n.parent=Yo(e,r),n.structuredQuery.from=[{collectionId:t.collectionGroup,allDescendants:!0}]):(n.parent=Yo(e,r.popLast()),n.structuredQuery.from=[{collectionId:r.lastSegment()}]);var s=function(e){if(0!==e.length)return function t(e){if(e instanceof R){var n=e;if("=="===n.op){if(qi(n.value))return{unaryFilter:{field:ou(n.field),op:"IS_NAN"}};if(Bi(n.value))return{unaryFilter:{field:ou(n.field),op:"IS_NULL"}}}else if("!="===n.op){if(qi(n.value))return{unaryFilter:{field:ou(n.field),op:"IS_NOT_NAN"}};if(Bi(n.value))return{unaryFilter:{field:ou(n.field),op:"IS_NOT_NULL"}}}return{fieldFilter:{field:ou(n.field),op:(r=n.op,qo[r]),value:n.value}}}return e instanceof M?1===(n=(r=e).getFilters().map(e=>t(e))).length?n[0]:{compositeFilter:{op:(r=r.op,Uo[r]),filters:n}}:E();var r}(M.create(e,"and"))}(t.filters);return s&&(n.structuredQuery.where=s),(s=function(e){if(0!==e.length)return e.map(e=>{return{field:ou(e.field),direction:(e=e.dir,Bo[e])}})}(t.orderBy))&&(n.structuredQuery.orderBy=s),null!==(s=Go(e,t.limit))&&(n.structuredQuery.limit=s),t.startAt&&(n.structuredQuery.startAt={before:(e=t.startAt).inclusive,values:e.position}),t.endAt&&(n.structuredQuery.endAt={before:!(t=t.endAt).inclusive,values:t.position}),n}function au(e){let t=Xo(e.parent);var n,r,s,i=e.structuredQuery,a=i.from?i.from.length:0;let o=null,u=(0<a&&(y(1===a),(a=i.from[0]).allDescendants?o=a.collectionId:t=t.child(a.collectionId)),[]),h=(i.where&&(u=function(){const e=function t(e){if(void 0!==e.unaryFilter){var n=e;switch(n.unaryFilter.op){case"IS_NAN":var r=uu(n.unaryFilter.field);return R.create(r,"==",{doubleValue:NaN});case"IS_NULL":r=uu(n.unaryFilter.field);return R.create(r,"==",{nullValue:"NULL_VALUE"});case"IS_NOT_NAN":r=uu(n.unaryFilter.field);return R.create(r,"!=",{doubleValue:NaN});case"IS_NOT_NULL":r=uu(n.unaryFilter.field);return R.create(r,"!=",{nullValue:"NULL_VALUE"});default:return E()}}else{return void 0!==e.fieldFilter?(i=e,R.create(uu(i.fieldFilter.field),function(){switch(i.fieldFilter.op){case"EQUAL":return"==";case"NOT_EQUAL":return"!=";case"GREATER_THAN":return">";case"GREATER_THAN_OR_EQUAL":return">=";case"LESS_THAN":return"<";case"LESS_THAN_OR_EQUAL":return"<=";case"ARRAY_CONTAINS":return"array-contains";case"IN":return"in";case"NOT_IN":return"not-in";case"ARRAY_CONTAINS_ANY":return"array-contains-any";default:return E()}}(),i.fieldFilter.value)):void 0!==e.compositeFilter?(s=e,M.create(s.compositeFilter.filters.map(e=>t(e)),function(){switch(s.compositeFilter.op){case"AND":return"and";case"OR":return"or";default:return E()}}())):E();var s,i}}(i.where);return e instanceof M&&ea(e)?e.getFilters():[e]}()),[]),c=(i.orderBy&&(h=i.orderBy.map(e=>{var t=e;return new Yi(uu(t.field),function(){switch(t.direction){case"ASCENDING":return"asc";case"DESCENDING":return"desc";default:return}}())})),null),l=(i.limit&&(c=Ms(n="object"==typeof(e=i.limit)?e.value:e)?null:n),null),d=(i.startAt&&(l=(s=!!(r=i.startAt).before,n=r.values||[],new $i(n,s))),null);return i.endAt&&(d=(s=!(r=i.endAt).before,i=r.values||[],new $i(i,s))),ba(t,o,h,u,c,"F",l,d)}function ou(e){return{fieldPath:e.canonicalString()}}function uu(e){return f.fromServerFormat(e.fieldPath)}function hu(e){return 4<=e.length&&"projects"===e.get(0)&&"databases"===e.get(2)}class cu{constructor(e,t,n,r,s=b.min(),i=b.min(),a=wi.EMPTY_BYTE_STRING,o=null){this.target=e,this.targetId=t,this.purpose=n,this.sequenceNumber=r,this.snapshotVersion=s,this.lastLimboFreeSnapshotVersion=i,this.resumeToken=a,this.expectedCount=o}withSequenceNumber(e){return new cu(this.target,this.targetId,this.purpose,e,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken,this.expectedCount)}withResumeToken(e,t){return new cu(this.target,this.targetId,this.purpose,this.sequenceNumber,t,this.lastLimboFreeSnapshotVersion,e,null)}withExpectedCount(e){return new cu(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken,e)}withLastLimboFreeSnapshotVersion(e){return new cu(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,e,this.resumeToken,this.expectedCount)}}class lu{constructor(e){this.ut=e}}function du(e,t){const n=t.key,r={prefixPath:n.getCollectionPath().popLast().toArray(),collectionGroup:n.collectionGroup,documentId:n.path.lastSegment(),readTime:fu(t.readTime),hasCommittedMutations:t.hasCommittedMutations};if(t.isFoundDocument())r.document={name:Wo(s=e.ut,(e=t).key),fields:e.data.value.mapValue.fields,updateTime:jo(s,e.version.toTimestamp()),createTime:jo(s,e.createTime.toTimestamp())};else if(t.isNoDocument())r.noDocument={path:n.path.toArray(),readTime:gu(t.version)};else{if(!t.isUnknownDocument())return E();r.unknownDocument={path:n.path.toArray(),version:gu(t.version)}}var s;return r}function fu(e){e=e.toTimestamp();return[e.seconds,e.nanoseconds]}function gu(e){e=e.toTimestamp();return{seconds:e.seconds,nanoseconds:e.nanoseconds}}function mu(e){e=new c(e.seconds,e.nanoseconds);return b.fromTimestamp(e)}function pu(t,n){const r=(n.baseMutations||[]).map(e=>ru(t.ut,e));for(let e=0;e<n.mutations.length-1;++e){const r=n.mutations[e];if(e+1<n.mutations.length&&void 0!==n.mutations[e+1].transform){const s=n.mutations[e+1];r.updateTransforms=s.transform.fieldTransforms,n.mutations.splice(e+1,1),++e}}const s=n.mutations.map(e=>ru(t.ut,e)),e=c.fromMillis(n.localWriteTimeMs);return new vo(n.batchId,e,r,s)}function yu(e){var t=mu(e.readTime),n=void 0!==e.lastLimboFreeSnapshotVersion?mu(e.lastLimboFreeSnapshotVersion):b.min(),r=void 0!==e.query.documents?(y(1===(r=e.query).documents.length),xa(Ia(Xo(r.documents[0])))):xa(au(e.query));return new cu(r,e.targetId,"TargetPurposeListen",e.lastListenSequenceNumber,t,n,wi.fromBase64String(e.resumeToken))}function vu(e,t){var n=gu(t.snapshotVersion),r=gu(t.lastLimboFreeSnapshotVersion),e=(pa(t.target)?su:iu)(e.ut,t.target),s=t.resumeToken.toBase64();return{targetId:t.targetId,canonicalId:ga(t.target),readTime:n,resumeToken:s,lastListenSequenceNumber:t.sequenceNumber,lastLimboFreeSnapshotVersion:r,query:e}}function wu(e){var t=au({parent:e.parent,structuredQuery:e.structuredQuery});return"LAST"===e.limitType?Ca(t,t.limit,"L"):t}function _u(e,t){return new _o(t.largestBatchId,ru(e.ut,t.overlayMutation))}function bu(e,t){var n=t.path.lastSegment();return[e,Fs(t.path.popLast()),n]}function Iu(e,t,n,r){return{indexId:e,uid:t.uid||"",sequenceNumber:n,readTime:gu(r.readTime),documentKey:Fs(r.documentKey.path),largestBatchId:r.largestBatchId}}class Eu{getBundleMetadata(e,t){return Tu(e).get(t).next(e=>{if(e)return{id:e.bundleId,createTime:mu(e.createTime),version:e.version}})}saveBundleMetadata(e,t){return Tu(e).put({bundleId:t.id,createTime:gu(F(t.createTime)),version:t.version})}getNamedQuery(e,t){return Su(e).get(t).next(e=>{if(e)return{name:e.name,query:wu(e.bundledQuery),readTime:mu(e.readTime)}})}saveNamedQuery(e,t){return Su(e).put({name:t.name,readTime:gu(F(t.readTime)),bundledQuery:t.bundledQuery})}}function Tu(e){return hi(e,"bundles")}function Su(e){return hi(e,"namedQueries")}class xu{constructor(e,t){this.serializer=e,this.userId=t}static ct(e,t){t=t.uid||"";return new xu(e,t)}getOverlay(e,t){return Du(e).get(bu(this.userId,t)).next(e=>e?_u(this.serializer,e):null)}getOverlays(e,t){const n=qa();return D.forEach(t,t=>this.getOverlay(e,t).next(e=>{null!==e&&n.set(t,e)})).next(()=>n)}saveOverlays(n,r,e){const s=[];return e.forEach((e,t)=>{t=new _o(r,t);s.push(this.lt(n,t))}),D.waitFor(s)}removeOverlaysForBatchId(t,e,n){const r=new Set,s=(e.forEach(e=>r.add(Fs(e.getCollectionPath()))),[]);return r.forEach(e=>{e=IDBKeyRange.bound([this.userId,e,n],[this.userId,e,n+1],!1,!0);s.push(Du(t).H("collectionPathOverlayIndex",e))}),D.waitFor(s)}getOverlaysForCollection(e,t,n){const r=qa(),s=Fs(t),i=IDBKeyRange.bound([this.userId,s,n],[this.userId,s,Number.POSITIVE_INFINITY],!0);return Du(e).W("collectionPathOverlayIndex",i).next(e=>{for(const t of e){const e=_u(this.serializer,t);r.set(e.getKey(),e)}return r})}getOverlaysForCollectionGroup(e,t,n,s){const i=qa();let a;n=IDBKeyRange.bound([this.userId,t,n],[this.userId,t,Number.POSITIVE_INFINITY],!0);return Du(e).Y({index:"collectionGroupOverlayIndex",range:n},(e,t,n)=>{const r=_u(this.serializer,t);i.size()<s||r.largestBatchId===a?(i.set(r.getKey(),r),a=r.largestBatchId):n.done()}).next(()=>i)}lt(e,t){return Du(e).put(function(e,t,n){var[,r,s]=bu(t,n.mutation.key);return{userId:t,collectionPath:r,documentId:s,collectionGroup:n.mutation.key.getCollectionGroup(),largestBatchId:n.largestBatchId,overlayMutation:nu(e.ut,n.mutation)}}(this.serializer,this.userId,t))}}function Du(e){return hi(e,"documentOverlays")}class Cu{constructor(){}ht(e,t){this.Pt(e,t),t.It()}Pt(e,t){var n,r;"nullValue"in e?this.Tt(t,5):"booleanValue"in e?(this.Tt(t,10),t.Et(e.booleanValue?1:0)):"integerValue"in e?(this.Tt(t,15),t.Et(N(e.integerValue))):"doubleValue"in e?(n=N(e.doubleValue),isNaN(n)?this.Tt(t,13):(this.Tt(t,15),Ls(n)?t.Et(0):t.Et(n))):"timestampValue"in e?(r=e.timestampValue,this.Tt(t,20),"string"==typeof r?t.dt(r):(t.dt(""+(r.seconds||"")),t.Et(r.nanos||0))):"stringValue"in e?(this.At(e.stringValue,t),this.Rt(t)):"bytesValue"in e?(this.Tt(t,30),t.Vt(Ii(e.bytesValue)),this.Rt(t)):"referenceValue"in e?this.ft(e.referenceValue,t):"geoPointValue"in e?(r=e.geoPointValue,this.Tt(t,45),t.Et(r.latitude||0),t.Et(r.longitude||0)):"mapValue"in e?Gi(e)?this.Tt(t,Number.MAX_SAFE_INTEGER):(this.gt(e.mapValue,t),this.Rt(t)):"arrayValue"in e?(this.yt(e.arrayValue,t),this.Rt(t)):E()}At(e,t){this.Tt(t,25),this.wt(e,t)}wt(e,t){t.dt(e)}gt(e,t){var n=e.fields||{};this.Tt(t,55);for(const e of Object.keys(n))this.At(e,t),this.Pt(n[e],t)}yt(e,t){var n=e.values||[];this.Tt(t,50);for(const e of n)this.Pt(e,t)}ft(e,t){this.Tt(t,37),S.fromName(e).path.forEach(e=>{this.Tt(t,60),this.wt(e,t)})}Tt(e,t){e.Et(t)}Rt(e){e.Et(2)}}function Au(e){e=64-function(t){let n=0;for(let e=0;e<8;++e){var r=function(e){if(0===e)return 8;let t=0;return e>>4==0&&(t+=4,e<<=4),e>>6==0&&(t+=2,e<<=2),e>>7==0&&(t+=1),t}(255&t[e]);if(n+=r,8!==r)break}return n}(e);return Math.ceil(e/8)}Cu.St=new Cu;class Nu{constructor(){this.buffer=new Uint8Array(1024),this.position=0}bt(e){const t=e[Symbol.iterator]();let n=t.next();for(;!n.done;)this.Dt(n.value),n=t.next();this.Ct()}vt(e){const t=e[Symbol.iterator]();let n=t.next();for(;!n.done;)this.Ft(n.value),n=t.next();this.Mt()}xt(e){for(const t of e){const e=t.charCodeAt(0);if(e<128)this.Dt(e);else if(e<2048)this.Dt(960|e>>>6),this.Dt(128|63&e);else if(t<"\ud800"||"\udbff"<t)this.Dt(480|e>>>12),this.Dt(128|63&e>>>6),this.Dt(128|63&e);else{const e=t.codePointAt(0);this.Dt(240|e>>>18),this.Dt(128|63&e>>>12),this.Dt(128|63&e>>>6),this.Dt(128|63&e)}}this.Ct()}Ot(e){for(const t of e){const e=t.charCodeAt(0);if(e<128)this.Ft(e);else if(e<2048)this.Ft(960|e>>>6),this.Ft(128|63&e);else if(t<"\ud800"||"\udbff"<t)this.Ft(480|e>>>12),this.Ft(128|63&e>>>6),this.Ft(128|63&e);else{const e=t.codePointAt(0);this.Ft(240|e>>>18),this.Ft(128|63&e>>>12),this.Ft(128|63&e>>>6),this.Ft(128|63&e)}}this.Mt()}Nt(t){var n=this.Bt(t),t=Au(n);this.Lt(1+t),this.buffer[this.position++]=255&t;for(let e=n.length-t;e<n.length;++e)this.buffer[this.position++]=255&n[e]}kt(t){var n=this.Bt(t),t=Au(n);this.Lt(1+t),this.buffer[this.position++]=~(255&t);for(let e=n.length-t;e<n.length;++e)this.buffer[this.position++]=~(255&n[e])}qt(){this.Qt(255),this.Qt(255)}Kt(){this.$t(255),this.$t(255)}reset(){this.position=0}seed(e){this.Lt(e.length),this.buffer.set(e,this.position),this.position+=e.length}Ut(){return this.buffer.slice(0,this.position)}Bt(e){const t=function(e){const t=new DataView(new ArrayBuffer(8));return t.setFloat64(0,e,!1),new Uint8Array(t.buffer)}(e),n=0!=(128&t[0]);t[0]^=n?255:128;for(let e=1;e<t.length;++e)t[e]^=n?255:0;return t}Dt(e){e&=255;0==e?(this.Qt(0),this.Qt(255)):255==e?(this.Qt(255),this.Qt(0)):this.Qt(e)}Ft(e){var t=255&e;0==t?(this.$t(0),this.$t(255)):255==t?(this.$t(255),this.$t(0)):this.$t(e)}Ct(){this.Qt(0),this.Qt(1)}Mt(){this.$t(0),this.$t(1)}Qt(e){this.Lt(1),this.buffer[this.position++]=e}$t(e){this.Lt(1),this.buffer[this.position++]=~e}Lt(t){t+=this.position;if(!(t<=this.buffer.length)){let e=2*this.buffer.length;e<t&&(e=t);const n=new Uint8Array(e);n.set(this.buffer),this.buffer=n}}}class ku{constructor(e){this.Wt=e}Vt(e){this.Wt.bt(e)}dt(e){this.Wt.xt(e)}Et(e){this.Wt.Nt(e)}It(){this.Wt.qt()}}class Ru{constructor(e){this.Wt=e}Vt(e){this.Wt.vt(e)}dt(e){this.Wt.Ot(e)}Et(e){this.Wt.kt(e)}It(){this.Wt.Kt()}}class Mu{constructor(){this.Wt=new Nu,this.Gt=new ku(this.Wt),this.zt=new Ru(this.Wt)}seed(e){this.Wt.seed(e)}jt(e){return 0===e?this.Gt:this.zt}Ut(){return this.Wt.Ut()}reset(){this.Wt.reset()}}class Lu{constructor(e,t,n,r){this.indexId=e,this.documentKey=t,this.arrayValue=n,this.directionalValue=r}Ht(){const e=this.directionalValue.length,t=0===e||255===this.directionalValue[e-1]?e+1:e,n=new Uint8Array(t);return n.set(this.directionalValue,0),t!==e?n.set([0],this.directionalValue.length):++n[n.length-1],new Lu(this.indexId,this.documentKey,this.arrayValue,n)}}function Ou(e,t){let n=e.indexId-t.indexId;return 0!==n?n:0!==(n=Fu(e.arrayValue,t.arrayValue))?n:0!==(n=Fu(e.directionalValue,t.directionalValue))?n:S.comparator(e.documentKey,t.documentKey)}function Fu(t,n){for(let e=0;e<t.length&&e<n.length;++e){var r=t[e]-n[e];if(0!=r)return r}return t.length-n.length}class Pu{constructor(e){this.Jt=new A((e,t)=>f.comparator(e.field,t.field)),this.collectionId=null!=e.collectionGroup?e.collectionGroup:e.path.lastSegment(),this.Yt=e.orderBy,this.Zt=[];for(const t of e.filters){const e=t;e.isInequality()?this.Jt=this.Jt.add(e):this.Zt.push(e)}}get Xt(){return 1<this.Jt.size}en(e){if(y(e.collectionGroup===this.collectionId),this.Xt)return!1;const t=cs(e);if(void 0!==t&&!this.tn(t))return!1;const n=ls(e);let r=new Set,s=0,i=0;for(;s<n.length&&this.tn(n[s]);++s)r=r.add(n[s].fieldPath.canonicalString());if(s===n.length)return!0;if(0<this.Jt.size){const e=this.Jt.getIterator().getNext();if(!r.has(e.field.canonicalString())){const t=n[s];if(!this.nn(e,t)||!this.rn(this.Yt[i++],t))return!1}++s}for(;s<n.length;++s){const e=n[s];if(i>=this.Yt.length||!this.rn(this.Yt[i++],e))return!1}return!0}sn(){if(this.Xt)return null;let e=new A(f.comparator);const t=[];for(const n of this.Zt)n.field.isKeyField()||("array-contains"===n.op||"array-contains-any"===n.op?t.push(new ds(n.field,2)):e.has(n.field)||(e=e.add(n.field),t.push(new ds(n.field,0))));for(const r of this.Yt)r.field.isKeyField()||e.has(r.field)||(e=e.add(r.field),t.push(new ds(r.field,"asc"===r.dir?0:1)));return new hs(hs.UNKNOWN_ID,this.collectionId,t,fs.empty())}tn(e){for(const t of this.Zt)if(this.nn(t,e))return!0;return!1}nn(e,t){if(void 0===e||!e.field.isEqual(t.fieldPath))return!1;e="array-contains"===e.op||"array-contains-any"===e.op;return 2===t.kind==e}rn(e,t){return!!e.field.isEqual(t.fieldPath)&&(0===t.kind&&"asc"===e.dir||1===t.kind&&"desc"===e.dir)}}function Vu(e){return e instanceof R}function Bu(e){return e instanceof M&&ea(e)}function qu(e){return Vu(e)||Bu(e)||function(e){if(e instanceof M&&Zi(e)){for(const t of e.getFilters())if(!Vu(t)&&!Bu(t))return!1;return!0}return!1}(e)}function Uu(e,t){var n,r;return y(e instanceof R||e instanceof M),y(t instanceof R||t instanceof M),Gu(e instanceof R?t instanceof R?(n=e,r=t,M.create([n,r],"and")):zu(e,t):t instanceof R?zu(t,e):function(e,t){if(y(0<e.filters.length&&0<t.filters.length),Ji(e)&&Ji(t))return na(e,t.getFilters());const n=Zi(e)?e:t,r=Zi(e)?t:e,s=n.filters.map(e=>Uu(e,r));return M.create(s,"or")}(e,t))}function zu(t,e){if(Ji(e))return na(e,t.getFilters());e=e.filters.map(e=>Uu(t,e));return M.create(e,"or")}function Gu(t){if(y(t instanceof R||t instanceof M),t instanceof R)return t;const e=t.getFilters();if(1===e.length)return Gu(e[0]);if(ta(t))return t;const n=e.map(e=>Gu(e)),r=[];return n.forEach(e=>{e instanceof R?r.push(e):e instanceof M&&(e.op===t.op?r.push(...e.filters):r.push(e))}),1===r.length?r[0]:M.create(r,t.op)}class ju{constructor(){this.on=new Ku}addToCollectionParentIndex(e,t){return this.on.add(t),D.resolve()}getCollectionParents(e,t){return D.resolve(this.on.getEntries(t))}addFieldIndex(e,t){return D.resolve()}deleteFieldIndex(e,t){return D.resolve()}deleteAllFieldIndexes(e){return D.resolve()}createTargetIndexes(e,t){return D.resolve()}getDocumentsMatchingTarget(e,t){return D.resolve(null)}getIndexType(e,t){return D.resolve(0)}getFieldIndexes(e,t){return D.resolve([])}getNextCollectionGroupToUpdate(e){return D.resolve(null)}getMinOffset(e,t){return D.resolve(ps.min())}getMinOffsetFromCollectionGroup(e,t){return D.resolve(ps.min())}updateCollectionGroup(e,t,n){return D.resolve()}updateIndexEntries(e,t){return D.resolve()}}class Ku{constructor(){this.index={}}add(e){const t=e.lastSegment(),n=e.popLast(),r=this.index[t]||new A(I.comparator),s=!r.has(n);return this.index[t]=r.add(n),s}has(e){const t=e.lastSegment(),n=e.popLast(),r=this.index[t];return r&&r.has(n)}getEntries(e){return(this.index[e]||new A(I.comparator)).toArray()}}const Qu=new Uint8Array(0);class $u{constructor(e,t){this.user=e,this.databaseId=t,this._n=new Ku,this.an=new Oa(e=>ga(e),(e,t)=>ma(e,t)),this.uid=e.uid||""}addToCollectionParentIndex(e,t){if(this._n.has(t))return D.resolve();var n=t.lastSegment(),r=t.popLast();return e.addOnCommittedListener(()=>{this._n.add(t)}),r={collectionId:n,parent:Fs(r)},Wu(e).put(r)}getCollectionParents(e,n){const r=[],t=IDBKeyRange.bound([n,""],[as(n),""],!1,!0);return Wu(e).W(t).next(e=>{for(const t of e){if(t.collectionId!==n)break;r.push(Vs(t.parent))}return r})}addFieldIndex(e,t){const n=Yu(e),r={indexId:t.indexId,collectionGroup:t.collectionGroup,fields:t.fields.map(e=>[e.fieldPath.canonicalString(),e.kind])},s=(delete r.indexId,n.add(r));if(t.indexState){const n=Xu(e);return s.next(e=>{n.put(Iu(e,this.user,t.indexState.sequenceNumber,t.indexState.offset))})}return s.next()}deleteFieldIndex(e,t){const n=Yu(e),r=Xu(e),s=Hu(e);return n.delete(t.indexId).next(()=>r.delete(IDBKeyRange.bound([t.indexId],[t.indexId+1],!1,!0))).next(()=>s.delete(IDBKeyRange.bound([t.indexId],[t.indexId+1],!1,!0)))}deleteAllFieldIndexes(e){const t=Yu(e),n=Hu(e),r=Xu(e);return t.H().next(()=>n.H()).next(()=>r.H())}createTargetIndexes(n,e){return D.forEach(this.un(e),t=>this.getIndexType(n,t).next(e=>{if(0===e||1===e){const e=new Pu(t).sn();if(null!=e)return this.addFieldIndex(n,e)}}))}getDocumentsMatchingTarget(e,h){const c=Hu(e);let l=!0;const n=new Map;return D.forEach(this.un(h),t=>this.cn(e,t).next(e=>{l=l&&!!e,n.set(t,e)})).next(()=>{if(l){let u=L();const l=[];return D.forEach(n,(e,t)=>{m("IndexedDbIndexManager",`Using index ${n=e,`id=${n.indexId}|cg=${n.collectionGroup}|f=`+n.fields.map(e=>e.fieldPath+":"+e.kind).join(",")} to execute `+ga(h));var n=function(e,t){var n=cs(t);if(void 0===n)return null;for(const t of ya(e,n.fieldPath))switch(t.op){case"array-contains-any":return t.value.arrayValue.values||[];case"array-contains":return[t.value]}return null}(t,e),r=function(e,t){const n=new Map;for(const r of ls(t))for(const t of ya(e,r.fieldPath))switch(t.op){case"==":case"in":n.set(r.fieldPath.canonicalString(),t.value);break;case"not-in":case"!=":return n.set(r.fieldPath.canonicalString(),t.value),Array.from(n.values())}return null}(t,e),s=function(e,t){const n=[];let r=!0;for(const s of ls(t)){const t=(0===s.kind?va:wa)(e,s.fieldPath,e.startAt);n.push(t.value),r=r&&t.inclusive}return new $i(n,r)}(t,e),i=function(e,t){const n=[];let r=!0;for(const s of ls(t)){const t=(0===s.kind?wa:va)(e,s.fieldPath,e.endAt);n.push(t.value),r=r&&t.inclusive}return new $i(n,r)}(t,e),a=this.ln(e,t,s),o=this.ln(e,t,i),r=this.hn(e,t,r),r=this.Pn(e.indexId,n,a,s.inclusive,o,i.inclusive,r);return D.forEach(r,e=>c.j(e,h.limit).next(e=>{e.forEach(e=>{e=S.fromSegments(e.documentKey);u.has(e)||(u=u.add(e),l.push(e))})}))}).next(()=>l)}return D.resolve(null)})}un(t){var e;return this.an.get(t)||(e=0===t.filters.length?[t]:function(e){if(0===e.getFilters().length)return[];const t=function t(e){if(y(e instanceof R||e instanceof M),e instanceof R)return e;if(1===e.filters.length)return t(e.filters[0]);var n=e.filters.map(e=>t(e));let r=M.create(n,e.op);return qu(r=Gu(r))?r:(y(r instanceof M),y(Ji(r)),y(1<r.filters.length),r.filters.reduce((e,t)=>Uu(e,t)))}(function t(n){var e;if(y(n instanceof R||n instanceof M),n instanceof R){if(n instanceof ha){const r=(null==(e=null==(e=n.value.arrayValue)?void 0:e.values)?void 0:e.map(e=>R.create(n.field,"==",e)))||[];return M.create(r,"or")}return n}const r=n.filters.map(e=>t(e));return M.create(r,n.op)}(e));return y(qu(t)),Vu(t)||Bu(t)?[t]:t.getFilters()}(M.create(t.filters,"and")).map(e=>fa(t.path,t.collectionGroup,t.orderBy,e.getFilters(),t.limit,t.startAt,t.endAt)),this.an.set(t,e),e)}Pn(t,n,r,s,i,a,o){const u=(null!=n?n.length:1)*Math.max(r.length,i.length),h=u/(null!=n?n.length:1),c=[];for(let e=0;e<u;++e){const u=n?this.In(n[e/h]):Qu,l=this.Tn(t,u,r[e%h],s),d=this.En(t,u,i[e%h],a),f=o.map(e=>this.Tn(t,u,e,!0));c.push(...this.createRange(l,d,f))}return c}Tn(e,t,n,r){const s=new Lu(e,S.empty(),t,n);return r?s:s.Ht()}En(e,t,n,r){const s=new Lu(e,S.empty(),t,n);return r?s.Ht():s}cn(e,t){const r=new Pu(t),n=null!=t.collectionGroup?t.collectionGroup:t.path.lastSegment();return this.getFieldIndexes(e,n).next(e=>{let t=null;for(const n of e)r.en(n)&&(!t||n.fields.length>t.fields.length)&&(t=n);return t})}getIndexType(e,t){let n=2;const r=this.un(t);return D.forEach(r,t=>this.cn(e,t).next(e=>{e?0!==n&&e.fields.length<function(e){let t=new A(f.comparator),n=!1;for(const r of e.filters)for(const e of r.getFlattenedFilters())e.field.isKeyField()||("array-contains"===e.op||"array-contains-any"===e.op?n=!0:t=t.add(e.field));for(const n of e.orderBy)n.field.isKeyField()||(t=t.add(n.field));return t.size+(n?1:0)}(t)&&(n=1):n=0})).next(()=>null!==t.limit&&1<r.length&&2===n?1:n)}dn(e,t){const n=new Mu;for(const s of ls(e)){const e=t.data.field(s.fieldPath);if(null==e)return null;var r=n.jt(s.kind);Cu.St.ht(e,r)}return n.Ut()}In(e){const t=new Mu;return Cu.St.ht(e,t.jt(0)),t.Ut()}An(e,t){const n=new Mu;return Cu.St.ht(Fi(this.databaseId,t),n.jt(0===(t=ls(e)).length?0:t[t.length-1].kind)),n.Ut()}hn(e,t,n){if(null===n)return[];let r=[],s=(r.push(new Mu),0);for(const i of ls(e)){const e=n[s++];for(const n of r)if(this.Rn(t,i.fieldPath)&&Vi(e))r=this.Vn(r,i,e);else{const t=n.jt(i.kind);Cu.St.ht(e,t)}}return this.mn(r)}ln(e,t,n){return this.hn(e,t,n.position)}mn(t){const n=[];for(let e=0;e<t.length;++e)n[e]=t[e].Ut();return n}Vn(e,t,n){const r=[...e],s=[];for(const e of n.arrayValue.values||[])for(const n of r){const r=new Mu;r.seed(n.Ut()),Cu.St.ht(e,r.jt(t.kind)),s.push(r)}return s}Rn(e,t){return!!e.filters.find(e=>e instanceof R&&e.field.isEqual(t)&&("in"===e.op||"not-in"===e.op))}getFieldIndexes(e,t){const n=Yu(e),i=Xu(e);return(t?n.W("collectionGroupIndex",IDBKeyRange.bound(t,t)):n.W()).next(e=>{const s=[];return D.forEach(e,r=>i.get([r.indexId,this.uid]).next(e=>{var t,n;s.push((t=r,e=e?new fs(e.sequenceNumber,new ps(mu(e.readTime),new S(Vs(e.documentKey)),e.largestBatchId)):fs.empty(),n=t.fields.map(([e,t])=>new ds(f.fromServerFormat(e),t)),new hs(t.indexId,t.collectionGroup,n,e)))})).next(()=>s)})}getNextCollectionGroupToUpdate(e){return this.getFieldIndexes(e).next(e=>0===e.length?null:(e.sort((e,t)=>{var n=e.indexState.sequenceNumber-t.indexState.sequenceNumber;return 0!=n?n:T(e.collectionGroup,t.collectionGroup)}),e[0].collectionGroup))}updateCollectionGroup(e,n,r){const s=Yu(e),i=Xu(e);return this.fn(e).next(t=>s.W("collectionGroupIndex",IDBKeyRange.bound(n,n)).next(e=>D.forEach(e,e=>i.put(Iu(e.indexId,this.user,t,r)))))}updateIndexEntries(s,e){const n=new Map;return D.forEach(e,(t,r)=>{var e=n.get(t.collectionGroup);return(e?D.resolve(e):this.getFieldIndexes(s,t.collectionGroup)).next(e=>(n.set(t.collectionGroup,e),D.forEach(e,n=>this.gn(s,t,n).next(e=>{var t=this.pn(r,n);return e.isEqual(t)?D.resolve():this.yn(s,r,n,e,t)}))))})}wn(e,t,n,r){return Hu(e).put({indexId:r.indexId,uid:this.uid,arrayValue:r.arrayValue,directionalValue:r.directionalValue,orderedDocumentKey:this.An(n,t.key),documentKey:t.key.path.toArray()})}Sn(e,t,n,r){return Hu(e).delete([r.indexId,this.uid,r.arrayValue,r.directionalValue,this.An(n,t.key),t.key.path.toArray()])}gn(e,n,r){const t=Hu(e);let s=new A(Ou);return t.Y({index:"documentKeyIndex",range:IDBKeyRange.only([r.indexId,this.uid,this.An(r,n)])},(e,t)=>{s=s.add(new Lu(r.indexId,n,t.arrayValue,t.directionalValue))}).next(()=>s)}pn(e,t){let n=new A(Ou);var r=this.dn(t,e);if(null==r)return n;const s=cs(t);if(null!=s){var i=e.data.field(s.fieldPath);if(Vi(i))for(const s of i.arrayValue.values||[])n=n.add(new Lu(t.indexId,e.key,this.In(s),r))}else n=n.add(new Lu(t.indexId,e.key,Qu,r));return n}yn(t,s,i,e,a){m("IndexedDbIndexManager","Updating index entries for document '%s'",s.key);const o=[];{var u=Ou,h=e=>{o.push(this.wn(t,s,i,e))},c=e=>{o.push(this.Sn(t,s,i,e))},l=e.getIterator(),d=a.getIterator();let n=pi(l),r=pi(d);for(;n||r;){let e=!1,t=!1;if(n&&r){const h=u(n,r);h<0?t=!0:0<h&&(e=!0)}else null!=n?t=!0:e=!0;e?(h(r),r=pi(d)):t?(c(n),n=pi(l)):(n=pi(l),r=pi(d))}}return D.waitFor(o)}fn(e){let r=1;return Xu(e).Y({index:"sequenceNumberIndex",reverse:!0,range:IDBKeyRange.upperBound([this.uid,Number.MAX_SAFE_INTEGER])},(e,t,n)=>{n.done(),r=t.sequenceNumber+1}).next(()=>r)}createRange(e,t,n){n=n.sort((e,t)=>Ou(e,t)).filter((e,t,n)=>!t||0!==Ou(e,n[t-1]));const r=[];r.push(e);for(const s of n){const n=Ou(s,e),i=Ou(s,t);if(0===n)r[0]=e.Ht();else if(0<n&&i<0)r.push(s),r.push(s.Ht());else if(0<i)break}r.push(t);const s=[];for(let e=0;e<r.length;e+=2){if(this.bn(r[e],r[e+1]))return[];const t=[r[e].indexId,this.uid,r[e].arrayValue,r[e].directionalValue,Qu,[]],n=[r[e+1].indexId,this.uid,r[e+1].arrayValue,r[e+1].directionalValue,Qu,[]];s.push(IDBKeyRange.bound(t,n))}return s}bn(e,t){return 0<Ou(e,t)}getMinOffsetFromCollectionGroup(e,t){return this.getFieldIndexes(e,t).next(Ju)}getMinOffset(t,e){return D.mapArray(this.un(e),e=>this.cn(t,e).next(e=>e||E())).next(Ju)}}function Wu(e){return hi(e,"collectionParents")}function Hu(e){return hi(e,"indexEntries")}function Yu(e){return hi(e,"indexConfiguration")}function Xu(e){return hi(e,"indexState")}function Ju(t){y(0!==t.length);let n=t[0].indexState.offset,r=n.largestBatchId;for(let e=1;e<t.length;e++){var s=t[e].indexState.offset;ys(s,n)<0&&(n=s),r<s.largestBatchId&&(r=s.largestBatchId)}return new ps(n.readTime,n.documentKey,r)}const Zu={didRun:!1,sequenceNumbersCollected:0,targetsRemoved:0,documentsRemoved:0};class eh{constructor(e,t,n){this.cacheSizeCollectionThreshold=e,this.percentileToCollect=t,this.maximumSequenceNumbersToCollect=n}static withCacheSize(e){return new eh(e,eh.DEFAULT_COLLECTION_PERCENTILE,eh.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT)}}function th(e,t,n){const r=e.store("mutations"),s=e.store("documentMutations"),i=[],a=IDBKeyRange.only(n.batchId);let o=0;const u=r.Y({range:a},(e,t,n)=>(o++,n.delete())),h=(i.push(u.next(()=>{y(1===o)})),[]);for(const e of n.mutations){const r=Us(t,e.key.path,n.batchId);i.push(s.delete(r)),h.push(e.key)}return D.waitFor(i).next(()=>h)}function nh(e){if(!e)return 0;let t;if(e.document)t=e.document;else if(e.unknownDocument)t=e.unknownDocument;else{if(!e.noDocument)throw E();t=e.noDocument}return JSON.stringify(t).length}eh.DEFAULT_COLLECTION_PERCENTILE=10,eh.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT=1e3,eh.DEFAULT=new eh(41943040,eh.DEFAULT_COLLECTION_PERCENTILE,eh.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT),eh.DISABLED=new eh(-1,0,0);class rh{constructor(e,t,n,r){this.userId=e,this.serializer=t,this.indexManager=n,this.referenceDelegate=r,this.Dn={}}static ct(e,t,n,r){y(""!==e.uid);e=e.isAuthenticated()?e.uid:"";return new rh(e,t,n,r)}checkEmpty(e){let r=!0;var t=IDBKeyRange.bound([this.userId,Number.NEGATIVE_INFINITY],[this.userId,Number.POSITIVE_INFINITY]);return ih(e).Y({index:"userMutationsIndex",range:t},(e,t,n)=>{r=!1,n.done()}).next(()=>r)}addMutationBatch(c,l,d,f){const g=ah(c),m=ih(c);return m.add({}).next(e=>{y("number"==typeof e);const t=new vo(e,l,d,f),n=(s=this.serializer,i=this.userId,o=(a=t).baseMutations.map(e=>nu(s.ut,e)),u=a.mutations.map(e=>nu(s.ut,e)),{userId:i,batchId:a.batchId,localWriteTimeMs:a.localWriteTime.toMillis(),baseMutations:o,mutations:u}),r=[];var s,i,a,o,u;let h=new A((e,t)=>T(e.canonicalString(),t.canonicalString()));for(const c of f){const l=Us(this.userId,c.key.path,e);h=h.add(c.key.path.popLast()),r.push(m.put(n)),r.push(g.put(l,zs))}return h.forEach(e=>{r.push(this.indexManager.addToCollectionParentIndex(c,e))}),c.addOnCommittedListener(()=>{this.Dn[e]=t.keys()}),D.waitFor(r).next(()=>t)})}lookupMutationBatch(e,t){return ih(e).get(t).next(e=>e?(y(e.userId===this.userId),pu(this.serializer,e)):null)}Cn(e,t){return this.Dn[t]?D.resolve(this.Dn[t]):this.lookupMutationBatch(e,t).next(e=>{return e?(e=e.keys(),this.Dn[t]=e):null})}getNextMutationBatchAfterBatchId(e,t){const r=t+1,n=IDBKeyRange.lowerBound([this.userId,r]);let s=null;return ih(e).Y({index:"userMutationsIndex",range:n},(e,t,n)=>{t.userId===this.userId&&(y(t.batchId>=r),s=pu(this.serializer,t)),n.done()}).next(()=>s)}getHighestUnacknowledgedBatchId(e){var t=IDBKeyRange.upperBound([this.userId,Number.POSITIVE_INFINITY]);let r=-1;return ih(e).Y({index:"userMutationsIndex",range:t,reverse:!0},(e,t,n)=>{r=t.batchId,n.done()}).next(()=>r)}getAllMutationBatches(e){var t=IDBKeyRange.bound([this.userId,-1],[this.userId,Number.POSITIVE_INFINITY]);return ih(e).W("userMutationsIndex",t).next(e=>e.map(e=>pu(this.serializer,e)))}getAllMutationBatchesAffectingDocumentKey(i,a){const e=qs(this.userId,a.path),t=IDBKeyRange.lowerBound(e),o=[];return ah(i).Y({range:t},(e,t,n)=>{var[e,r,s]=e,r=Vs(r);if(e===this.userId&&a.path.isEqual(r))return ih(i).get(s).next(e=>{if(!e)throw E();y(e.userId===this.userId),o.push(pu(this.serializer,e))});n.done()}).next(()=>o)}getAllMutationBatchesAffectingDocumentKeys(t,e){let a=new A(T);const n=[];return e.forEach(i=>{var e=qs(this.userId,i.path),e=IDBKeyRange.lowerBound(e),e=ah(t).Y({range:e},(e,t,n)=>{var[e,r,s]=e,r=Vs(r);e===this.userId&&i.path.isEqual(r)?a=a.add(s):n.done()});n.push(e)}),D.waitFor(n).next(()=>this.vn(t,a))}getAllMutationBatchesAffectingQuery(e,t){const i=t.path,a=i.length+1,n=qs(this.userId,i),r=IDBKeyRange.lowerBound(n);let o=new A(T);return ah(e).Y({range:r},(e,t,n)=>{var[e,r,s]=e,r=Vs(r);e===this.userId&&i.isPrefixOf(r)?r.length===a&&(o=o.add(s)):n.done()}).next(()=>this.vn(e,o))}vn(t,e){const n=[],r=[];return e.forEach(e=>{r.push(ih(t).get(e).next(e=>{if(null===e)throw E();y(e.userId===this.userId),n.push(pu(this.serializer,e))}))}),D.waitFor(r).next(()=>n)}removeMutationBatch(t,n){return th(t.ae,this.userId,n).next(e=>(t.addOnCommittedListener(()=>{this.Fn(n.batchId)}),D.forEach(e,e=>this.referenceDelegate.markPotentiallyOrphaned(t,e))))}Fn(e){delete this.Dn[e]}performConsistencyCheck(n){return this.checkEmpty(n).next(e=>{if(!e)return D.resolve();const t=IDBKeyRange.lowerBound([this.userId]),r=[];return ah(n).Y({range:t},(e,t,n)=>{if(e[0]===this.userId){const t=Vs(e[1]);r.push(t)}else n.done()}).next(()=>{y(0===r.length)})})}containsKey(e,t){return sh(e,this.userId,t)}Mn(e){return oh(e).get(this.userId).next(e=>e||{userId:this.userId,lastAcknowledgedBatchId:-1,lastStreamToken:""})}}function sh(e,s,t){const n=qs(s,t.path),i=n[1],r=IDBKeyRange.lowerBound(n);let a=!1;return ah(e).Y({range:r,J:!0},(e,t,n)=>{var[e,r]=e;e===s&&r===i&&(a=!0),n.done()}).next(()=>a)}function ih(e){return hi(e,"mutations")}function ah(e){return hi(e,"documentMutations")}function oh(e){return hi(e,"mutationQueues")}class uh{constructor(e){this.xn=e}next(){return this.xn+=2,this.xn}static On(){return new uh(0)}static Nn(){return new uh(-1)}}class hh{constructor(e,t){this.referenceDelegate=e,this.serializer=t}allocateTargetId(n){return this.Bn(n).next(e=>{const t=new uh(e.highestTargetId);return e.highestTargetId=t.next(),this.Ln(n,e).next(()=>e.highestTargetId)})}getLastRemoteSnapshotVersion(e){return this.Bn(e).next(e=>b.fromTimestamp(new c(e.lastRemoteSnapshotVersion.seconds,e.lastRemoteSnapshotVersion.nanoseconds)))}getHighestSequenceNumber(e){return this.Bn(e).next(e=>e.highestListenSequenceNumber)}setTargetsMetadata(t,n,r){return this.Bn(t).next(e=>(e.highestListenSequenceNumber=n,r&&(e.lastRemoteSnapshotVersion=r.toTimestamp()),n>e.highestListenSequenceNumber&&(e.highestListenSequenceNumber=n),this.Ln(t,e)))}addTargetData(t,n){return this.kn(t,n).next(()=>this.Bn(t).next(e=>(e.targetCount+=1,this.qn(n,e),this.Ln(t,e))))}updateTargetData(e,t){return this.kn(e,t)}removeTargetData(t,e){return this.removeMatchingKeysForTargetId(t,e.targetId).next(()=>ch(t).delete(e.targetId)).next(()=>this.Bn(t)).next(e=>(y(0<e.targetCount),--e.targetCount,this.Ln(t,e)))}removeTargets(n,r,s){let i=0;const a=[];return ch(n).Y((e,t)=>{t=yu(t);t.sequenceNumber<=r&&null===s.get(t.targetId)&&(i++,a.push(this.removeTargetData(n,t)))}).next(()=>D.waitFor(a)).next(()=>i)}forEachTarget(e,n){return ch(e).Y((e,t)=>{t=yu(t);n(t)})}Bn(e){return lh(e).get("targetGlobalKey").next(e=>(y(null!==e),e))}Ln(e,t){return lh(e).put("targetGlobalKey",t)}kn(e,t){return ch(e).put(vu(this.serializer,t))}qn(e,t){let n=!1;return e.targetId>t.highestTargetId&&(t.highestTargetId=e.targetId,n=!0),e.sequenceNumber>t.highestListenSequenceNumber&&(t.highestListenSequenceNumber=e.sequenceNumber,n=!0),n}getTargetCount(e){return this.Bn(e).next(e=>e.targetCount)}getTargetData(e,r){var t=ga(r),t=IDBKeyRange.bound([t,Number.NEGATIVE_INFINITY],[t,Number.POSITIVE_INFINITY]);let s=null;return ch(e).Y({range:t,index:"queryTargetsIndex"},(e,t,n)=>{t=yu(t);ma(r,t.target)&&(s=t,n.done())}).next(()=>s)}addMatchingKeys(n,e,r){const s=[],i=dh(n);return e.forEach(e=>{var t=Fs(e.path);s.push(i.put({targetId:r,path:t})),s.push(this.referenceDelegate.addReference(n,r,e))}),D.waitFor(s)}removeMatchingKeys(n,e,r){const s=dh(n);return D.forEach(e,e=>{var t=Fs(e.path);return D.waitFor([s.delete([r,t]),this.referenceDelegate.removeReference(n,r,e)])})}removeMatchingKeysForTargetId(e,t){const n=dh(e),r=IDBKeyRange.bound([t],[t+1],!1,!0);return n.delete(r)}getMatchingKeysForTargetId(e,t){const n=IDBKeyRange.bound([t],[t+1],!1,!0),r=dh(e);let s=L();return r.Y({range:n,J:!0},(e,t,n)=>{e=Vs(e[1]),e=new S(e);s=s.add(e)}).next(()=>s)}containsKey(e,t){t=Fs(t.path),t=IDBKeyRange.bound([t],[as(t)],!1,!0);let r=0;return dh(e).Y({index:"documentTargetsIndex",J:!0,range:t},([e],t,n)=>{0!==e&&(r++,n.done())}).next(()=>0<r)}_t(e,t){return ch(e).get(t).next(e=>e?yu(e):null)}}function ch(e){return hi(e,"targets")}function lh(e){return hi(e,"targetGlobal")}function dh(e){return hi(e,"targetDocuments")}function fh([e,t],[n,r]){e=T(e,n);return 0===e?T(t,r):e}class gh{constructor(e){this.Qn=e,this.buffer=new A(fh),this.Kn=0}$n(){return++this.Kn}Un(e){var t=[e,this.$n()];if(this.buffer.size<this.Qn)this.buffer=this.buffer.add(t);else{const e=this.buffer.last();fh(t,e)<0&&(this.buffer=this.buffer.delete(e).add(t))}}get maxValue(){return this.buffer.last()[0]}}class mh{constructor(e,t,n){this.garbageCollector=e,this.asyncQueue=t,this.localStore=n,this.Wn=null}start(){-1!==this.garbageCollector.params.cacheSizeCollectionThreshold&&this.Gn(6e4)}stop(){this.Wn&&(this.Wn.cancel(),this.Wn=null)}get started(){return null!==this.Wn}Gn(e){m("LruGarbageCollector",`Garbage collection scheduled in ${e}ms`),this.Wn=this.asyncQueue.enqueueAfterDelay("lru_garbage_collection",e,async()=>{this.Wn=null;try{await this.localStore.collectGarbage(this.garbageCollector)}catch(e){Ss(e)?m("LruGarbageCollector","Ignoring IndexedDB error during garbage collection: ",e):await _s(e)}await this.Gn(3e5)})}}class ph{constructor(e,t){this.zn=e,this.params=t}calculateTargetCount(e,t){return this.zn.jn(e).next(e=>Math.floor(t/100*e))}nthSequenceNumber(e,t){if(0===t)return D.resolve(Rs._e);const n=new gh(t);return this.zn.forEachTarget(e,e=>n.Un(e.sequenceNumber)).next(()=>this.zn.Hn(e,e=>n.Un(e))).next(()=>n.maxValue)}removeTargets(e,t,n){return this.zn.removeTargets(e,t,n)}removeOrphanedDocuments(e,t){return this.zn.removeOrphanedDocuments(e,t)}collect(t,n){return-1===this.params.cacheSizeCollectionThreshold?(m("LruGarbageCollector","Garbage collection skipped; disabled"),D.resolve(Zu)):this.getCacheSize(t).next(e=>e<this.params.cacheSizeCollectionThreshold?(m("LruGarbageCollector",`Garbage collection skipped; Cache size ${e} is lower than threshold `+this.params.cacheSizeCollectionThreshold),Zu):this.Jn(t,n))}getCacheSize(e){return this.zn.getCacheSize(e)}Jn(t,n){let r,s,i,a,o,u,h;const c=Date.now();return this.calculateTargetCount(t,this.params.percentileToCollect).next(e=>(s=e>this.params.maximumSequenceNumbersToCollect?(m("LruGarbageCollector",`Capping sequence numbers to collect down to the maximum of ${this.params.maximumSequenceNumbersToCollect} from `+e),this.params.maximumSequenceNumbersToCollect):e,a=Date.now(),this.nthSequenceNumber(t,s))).next(e=>(r=e,o=Date.now(),this.removeTargets(t,r,n))).next(e=>(i=e,u=Date.now(),this.removeOrphanedDocuments(t,r))).next(e=>(h=Date.now(),Qr()<=l.DEBUG&&m("LruGarbageCollector",`LRU Garbage Collection
	Counted targets in ${a-c}ms
	Determined least recently used ${s} in `+(o-a)+"ms\n"+`	Removed ${i} targets in `+(u-o)+"ms\n"+`	Removed ${e} documents in `+(h-u)+"ms\n"+`Total Duration: ${h-c}ms`),D.resolve({didRun:!0,sequenceNumbersCollected:s,targetsRemoved:i,documentsRemoved:e})))}}class yh{constructor(e,t){this.db=e,this.garbageCollector=(e=this,new ph(e,t))}jn(e){const n=this.Yn(e);return this.db.getTargetCache().getTargetCount(e).next(t=>n.next(e=>t+e))}Yn(e){let t=0;return this.Hn(e,e=>{t++}).next(()=>t)}forEachTarget(e,t){return this.db.getTargetCache().forEachTarget(e,t)}Hn(e,n){return this.Zn(e,(e,t)=>n(t))}addReference(e,t,n){return vh(e,n)}removeReference(e,t,n){return vh(e,n)}removeTargets(e,t,n){return this.db.getTargetCache().removeTargets(e,t,n)}markPotentiallyOrphaned(e,t){return vh(e,t)}Xn(t,n){let r=!1;return oh(t).Z(e=>sh(t,e,n).next(e=>(e&&(r=!0),D.resolve(!e)))).next(()=>r)}removeOrphanedDocuments(n,r){const s=this.db.getRemoteDocumentCache().newChangeBuffer(),i=[];let a=0;return this.Zn(n,(t,e)=>{if(e<=r){const r=this.Xn(n,t).next(e=>{if(!e)return a++,s.getEntry(n,t).next(()=>(s.removeEntry(t,b.min()),dh(n).delete([0,Fs(t.path)])))});i.push(r)}}).next(()=>D.waitFor(i)).next(()=>s.apply(n)).next(()=>a)}removeTarget(e,t){t=t.withSequenceNumber(e.currentSequenceNumber);return this.db.getTargetCache().updateTargetData(e,t)}updateLimboDocument(e,t){return vh(e,t)}Zn(e,r){const t=dh(e);let s,i=Rs._e;return t.Y({index:"documentTargetsIndex"},([e],{path:t,sequenceNumber:n})=>{0===e?(i!==Rs._e&&r(new S(Vs(s)),i),i=n,s=t):i=Rs._e}).next(()=>{i!==Rs._e&&r(new S(Vs(s)),i)})}getCacheSize(e){return this.db.getRemoteDocumentCache().getSize(e)}}function vh(e,t){return dh(e).put((e=e.currentSequenceNumber,{targetId:0,path:Fs(t.path),sequenceNumber:e}))}class wh{constructor(){this.changes=new Oa(e=>e.toString(),(e,t)=>e.isEqual(t)),this.changesApplied=!1}addEntry(e){this.assertNotApplied(),this.changes.set(e.key,e)}removeEntry(e,t){this.assertNotApplied(),this.changes.set(e,k.newInvalidDocument(e).setReadTime(t))}getEntry(e,t){this.assertNotApplied();var n=this.changes.get(t);return void 0!==n?D.resolve(n):this.getFromCache(e,t)}getEntries(e,t){return this.getAllFromCache(e,t)}apply(e){return this.assertNotApplied(),this.changesApplied=!0,this.applyChanges(e)}assertNotApplied(){}}class _h{constructor(e){this.serializer=e}setIndexManager(e){this.indexManager=e}addEntry(e,t,n){return Th(e).put(n)}removeEntry(e,n,t){return Th(e).delete(function(e){const t=n.path.toArray();return[t.slice(0,t.length-2),t[t.length-2],fu(e),t[t.length-1]]}(t))}updateMetadata(t,n){return this.getMetadata(t).next(e=>(e.byteSize+=n,this.er(t,e)))}getEntry(e,n){let r=k.newInvalidDocument(n);return Th(e).Y({index:"documentKeyIndex",range:IDBKeyRange.only(Sh(n))},(e,t)=>{r=this.tr(n,t)}).next(()=>r)}nr(e,n){let r={size:0,document:k.newInvalidDocument(n)};return Th(e).Y({index:"documentKeyIndex",range:IDBKeyRange.only(Sh(n))},(e,t)=>{r={document:this.tr(n,t),size:nh(t)}}).next(()=>r)}getEntries(e,t){let n=Fa;return this.rr(e,t,(e,t)=>{t=this.tr(e,t);n=n.insert(e,t)}).next(()=>n)}ir(e,t){let r=Fa,s=new C(S.comparator);return this.rr(e,t,(e,t)=>{var n=this.tr(e,t);r=r.insert(e,n),s=s.insert(e,nh(t))}).next(()=>({documents:r,sr:s}))}rr(e,t,s){if(t.isEmpty())return D.resolve();let n=new A(Dh);t.forEach(e=>n=n.add(e));const r=IDBKeyRange.bound(Sh(n.first()),Sh(n.last())),i=n.getIterator();let a=i.getNext();return Th(e).Y({index:"documentKeyIndex",range:r},(e,t,n)=>{for(var r=S.fromSegments([...t.prefixPath,t.collectionGroup,t.documentId]);a&&Dh(a,r)<0;)s(a,null),a=i.getNext();a&&a.isEqual(r)&&(s(a,t),a=i.hasNext()?i.getNext():null),a?n.U(Sh(a)):n.done()}).next(()=>{for(;a;)s(a,null),a=i.hasNext()?i.getNext():null})}getDocumentsMatchingQuery(e,n,t,r,s){const i=n.path,a=[i.popLast().toArray(),i.lastSegment(),fu(t.readTime),t.documentKey.path.isEmpty()?"":t.documentKey.path.lastSegment()],o=[i.popLast().toArray(),i.lastSegment(),[Number.MAX_SAFE_INTEGER,Number.MAX_SAFE_INTEGER],""];return Th(e).W(IDBKeyRange.bound(a,o,!0)).next(e=>{null!=s&&s.incrementDocumentReadCount(e.length);let t=Fa;for(const s of e){const e=this.tr(S.fromSegments(s.prefixPath.concat(s.collectionGroup,s.documentId)),s);e.isFoundDocument()&&(Ra(n,e)||r.has(e.key))&&(t=t.insert(e.key,e))}return t})}getAllFromCollectionGroup(e,t,n,r){let s=Fa;n=xh(t,n),t=xh(t,ps.max());return Th(e).Y({index:"collectionGroupIndex",range:IDBKeyRange.bound(n,t,!0)},(e,t,n)=>{t=this.tr(S.fromSegments(t.prefixPath.concat(t.collectionGroup,t.documentId)),t);(s=s.insert(t.key,t)).size===r&&n.done()}).next(()=>s)}newChangeBuffer(e){return new Ih(this,!!e&&e.trackRemovals)}getSize(e){return this.getMetadata(e).next(e=>e.byteSize)}getMetadata(e){return Eh(e).get("remoteDocumentGlobalKey").next(e=>(y(!!e),e))}er(e,t){return Eh(e).put("remoteDocumentGlobalKey",t)}tr(e,t){if(t){const e=function(e,t){let n;if(t.document)n=tu(e.ut,t.document,!!t.hasCommittedMutations);else if(t.noDocument){const e=S.fromSegments(t.noDocument.path),r=mu(t.noDocument.readTime);n=k.newNoDocument(e,r),t.hasCommittedMutations&&n.setHasCommittedMutations()}else{if(!t.unknownDocument)return E();{const e=S.fromSegments(t.unknownDocument.path),s=mu(t.unknownDocument.version);n=k.newUnknownDocument(e,s)}}return t.readTime&&n.setReadTime((t=t.readTime,e=new c(t[0],t[1]),b.fromTimestamp(e))),n}(this.serializer,t);if(!e.isNoDocument()||!e.version.isEqual(b.min()))return e}return k.newInvalidDocument(e)}}function bh(e){return new _h(e)}class Ih extends wh{constructor(e,t){super(),this._r=e,this.trackRemovals=t,this.ar=new Oa(e=>e.toString(),(e,t)=>e.isEqual(t))}applyChanges(i){const a=[];let o=0,u=new A((e,t)=>T(e.canonicalString(),t.canonicalString()));return this.changes.forEach((e,t)=>{var n=this.ar.get(e);if(a.push(this._r.removeEntry(i,e,n.readTime)),t.isValidDocument()){var r=du(this._r.serializer,t),s=(u=u.add(e.path.popLast()),nh(r));o+=s-n.size,a.push(this._r.addEntry(i,e,r))}else if(o-=n.size,this.trackRemovals){const o=du(this._r.serializer,t.convertToNoDocument(b.min()));a.push(this._r.addEntry(i,e,o))}}),u.forEach(e=>{a.push(this._r.indexManager.addToCollectionParentIndex(i,e))}),a.push(this._r.updateMetadata(i,o)),D.waitFor(a)}getFromCache(e,t){return this._r.nr(e,t).next(e=>(this.ar.set(t,{size:e.size,readTime:e.document.readTime}),e.document))}getAllFromCache(e,t){return this._r.ir(e,t).next(({documents:n,sr:e})=>(e.forEach((e,t)=>{this.ar.set(e,{size:t,readTime:n.get(e).readTime})}),n))}}function Eh(e){return hi(e,"remoteDocumentGlobal")}function Th(e){return hi(e,"remoteDocumentsV14")}function Sh(e){const t=e.path.toArray();return[t.slice(0,t.length-2),t[t.length-2],t[t.length-1]]}function xh(e,t){const n=t.documentKey.path.toArray();return[e,fu(t.readTime),n.slice(0,n.length-2),0<n.length?n[n.length-1]:""]}function Dh(e,t){var n=e.path.toArray(),r=t.path.toArray();let s=0;for(let e=0;e<n.length-2&&e<r.length-2;++e)if(s=T(n[e],r[e]))return s;return(s=T(n.length,r.length))||((s=T(n[n.length-2],r[r.length-2]))||T(n[n.length-1],r[r.length-1]))}class Ch{constructor(e,t){this.overlayedDocument=e,this.mutatedFields=t}}class Ah{constructor(e,t,n,r){this.remoteDocumentCache=e,this.mutationQueue=t,this.documentOverlayCache=n,this.indexManager=r}getDocument(t,n){let r=null;return this.documentOverlayCache.getOverlay(t,n).next(e=>(r=e,this.remoteDocumentCache.getEntry(t,n))).next(e=>(null!==r&&uo(r.mutation,e,yi.empty(),c.now()),e))}getDocuments(t,e){return this.remoteDocumentCache.getEntries(t,e).next(e=>this.getLocalViewOfDocuments(t,e,L()).next(()=>e))}getLocalViewOfDocuments(e,t,n=L()){const r=qa();return this.populateOverlays(e,r,t).next(()=>this.computeViews(e,t,r,n).next(e=>{let n=Va();return e.forEach((e,t)=>{n=n.insert(e,t.overlayedDocument)}),n}))}getOverlayedDocuments(e,t){const n=qa();return this.populateOverlays(e,n,t).next(()=>this.computeViews(e,t,n,L()))}populateOverlays(e,n,t){const r=[];return t.forEach(e=>{n.has(e)||r.push(e)}),this.documentOverlayCache.getOverlays(e,r).next(e=>{e.forEach((e,t)=>{n.set(e,t)})})}computeViews(e,t,r,s){let i=Fa;const a=qa(),n=qa();return t.forEach((e,t)=>{const n=r.get(t.key);s.has(t.key)&&(void 0===n||n.mutation instanceof lo)?i=i.insert(t.key,t):void 0!==n?(a.set(t.key,n.mutation.getFieldMask()),uo(n.mutation,t,n.mutation.getFieldMask(),c.now())):a.set(t.key,yi.empty())}),this.recalculateAndSaveOverlays(e,i).next(e=>(e.forEach((e,t)=>a.set(e,t)),t.forEach((e,t)=>{return n.set(e,new Ch(t,null!=(t=a.get(e))?t:null))}),n))}recalculateAndSaveOverlays(i,a){const o=qa();let u=new C((e,t)=>e-t),h=L();return this.mutationQueue.getAllMutationBatchesAffectingDocumentKeys(i,a).next(e=>{for(const r of e)r.keys().forEach(e=>{var t,n=a.get(e);null!==n&&(t=o.get(e)||yi.empty(),t=r.applyToLocalView(n,t),o.set(e,t),t=(u.get(r.batchId)||L()).add(e),u=u.insert(r.batchId,t))})}).next(()=>{const e=[],t=u.getReverseIterator();for(;t.hasNext();){const u=t.getNext(),n=u.key,r=u.value,s=qa();r.forEach(e=>{var t;h.has(e)||(null!==(t=oo(a.get(e),o.get(e)))&&s.set(e,t),h=h.add(e))}),e.push(this.documentOverlayCache.saveOverlays(i,n,s))}return D.waitFor(e)}).next(()=>o)}recalculateAndSaveOverlaysForDocumentKeys(t,e){return this.remoteDocumentCache.getEntries(t,e).next(e=>this.recalculateAndSaveOverlays(t,e))}getDocumentsMatchingQuery(e,t,n,r){return s=t,S.isDocumentKey(s.path)&&null===s.collectionGroup&&0===s.filters.length?this.getDocumentsMatchingDocumentQuery(e,t.path):Ta(t)?this.getDocumentsMatchingCollectionGroupQuery(e,t,n,r):this.getDocumentsMatchingCollectionQuery(e,t,n,r);var s}getNextDocuments(i,t,a,o){return this.remoteDocumentCache.getAllFromCollectionGroup(i,t,a,o).next(n=>{const e=0<o-n.size?this.documentOverlayCache.getOverlaysForCollectionGroup(i,t,a.largestBatchId,o-n.size):D.resolve(qa());let r=-1,s=n;return e.next(e=>D.forEach(e,(t,e)=>(r<e.largestBatchId&&(r=e.largestBatchId),n.get(t)?D.resolve():this.remoteDocumentCache.getEntry(i,t).next(e=>{s=s.insert(t,e)}))).next(()=>this.populateOverlays(i,e,n)).next(()=>this.computeViews(i,s,e,L())).next(e=>({batchId:r,changes:Ba(e)})))})}getDocumentsMatchingDocumentQuery(e,t){return this.getDocument(e,new S(t)).next(e=>{let t=Va();return t=e.isFoundDocument()?t.insert(e.key,e):t})}getDocumentsMatchingCollectionGroupQuery(n,r,s,i){const a=r.collectionGroup;let o=Va();return this.indexManager.getCollectionParents(n,a).next(e=>D.forEach(e,e=>{t=r,e=e.child(a);var t,e=new _a(e,null,t.explicitOrderBy.slice(),t.filters.slice(),t.limit,t.limitType,t.startAt,t.endAt);return this.getDocumentsMatchingCollectionQuery(n,e,s,i).next(e=>{e.forEach((e,t)=>{o=o.insert(e,t)})})}).next(()=>o))}getDocumentsMatchingCollectionQuery(t,s,n,r){let i;return this.documentOverlayCache.getOverlaysForCollection(t,s.path,n.largestBatchId).next(e=>(i=e,this.remoteDocumentCache.getDocumentsMatchingQuery(t,s,n,i,r))).next(n=>{i.forEach((e,t)=>{t=t.getKey();null===n.get(t)&&(n=n.insert(t,k.newInvalidDocument(t)))});let r=Va();return n.forEach((e,t)=>{var n=i.get(e);void 0!==n&&uo(n.mutation,t,yi.empty(),c.now()),Ra(s,t)&&(r=r.insert(e,t))}),r})}}class Nh{constructor(e){this.serializer=e,this.ur=new Map,this.cr=new Map}getBundleMetadata(e,t){return D.resolve(this.ur.get(t))}saveBundleMetadata(e,t){return this.ur.set(t.id,{id:t.id,version:t.version,createTime:F(t.createTime)}),D.resolve()}getNamedQuery(e,t){return D.resolve(this.cr.get(t))}saveNamedQuery(e,t){return this.cr.set(t.name,{name:t.name,query:wu(t.bundledQuery),readTime:F(t.readTime)}),D.resolve()}}class kh{constructor(){this.overlays=new C(S.comparator),this.lr=new Map}getOverlay(e,t){return D.resolve(this.overlays.get(t))}getOverlays(e,t){const n=qa();return D.forEach(t,t=>this.getOverlay(e,t).next(e=>{null!==e&&n.set(t,e)})).next(()=>n)}saveOverlays(n,r,e){return e.forEach((e,t)=>{this.lt(n,r,t)}),D.resolve()}removeOverlaysForBatchId(e,t,n){const r=this.lr.get(n);return void 0!==r&&(r.forEach(e=>this.overlays=this.overlays.remove(e)),this.lr.delete(n)),D.resolve()}getOverlaysForCollection(e,t,n){const r=qa(),s=t.length+1,i=new S(t.child("")),a=this.overlays.getIteratorFrom(i);for(;a.hasNext();){const e=a.getNext().value,i=e.getKey();if(!t.isPrefixOf(i.path))break;i.path.length===s&&e.largestBatchId>n&&r.set(e.getKey(),e)}return D.resolve(r)}getOverlaysForCollectionGroup(t,e,n,r){let s=new C((e,t)=>e-t);const i=this.overlays.getIterator();for(;i.hasNext();){const t=i.getNext().value;if(t.getKey().getCollectionGroup()===e&&t.largestBatchId>n){let e=s.get(t.largestBatchId);null===e&&(e=qa(),s=s.insert(t.largestBatchId,e)),e.set(t.getKey(),t)}}const a=qa(),o=s.getIterator();for(;o.hasNext()&&(o.getNext().value.forEach((e,t)=>a.set(e,t)),!(a.size()>=r)););return D.resolve(a)}lt(e,t,n){var r=this.overlays.get(n.key);if(null!==r){const e=this.lr.get(r.largestBatchId).delete(n.key);this.lr.set(r.largestBatchId,e)}this.overlays=this.overlays.insert(n.key,new _o(t,n));let s=this.lr.get(t);void 0===s&&(s=L(),this.lr.set(t,s)),this.lr.set(t,s.add(n.key))}}class Rh{constructor(){this.hr=new A(Mh.Pr),this.Ir=new A(Mh.Tr)}isEmpty(){return this.hr.isEmpty()}addReference(e,t){e=new Mh(e,t);this.hr=this.hr.add(e),this.Ir=this.Ir.add(e)}Er(e,t){e.forEach(e=>this.addReference(e,t))}removeReference(e,t){this.dr(new Mh(e,t))}Ar(e,t){e.forEach(e=>this.removeReference(e,t))}Rr(e){const t=new S(new I([])),n=new Mh(t,e),r=new Mh(t,e+1),s=[];return this.Ir.forEachInRange([n,r],e=>{this.dr(e),s.push(e.key)}),s}Vr(){this.hr.forEach(e=>this.dr(e))}dr(e){this.hr=this.hr.delete(e),this.Ir=this.Ir.delete(e)}mr(e){var t=new S(new I([])),n=new Mh(t,e),t=new Mh(t,e+1);let r=L();return this.Ir.forEachInRange([n,t],e=>{r=r.add(e.key)}),r}containsKey(e){var t=new Mh(e,0);return null!==(t=this.hr.firstAfterOrEqual(t))&&e.isEqual(t.key)}}class Mh{constructor(e,t){this.key=e,this.gr=t}static Pr(e,t){return S.comparator(e.key,t.key)||T(e.gr,t.gr)}static Tr(e,t){return T(e.gr,t.gr)||S.comparator(e.key,t.key)}}class Lh{constructor(e,t){this.indexManager=e,this.referenceDelegate=t,this.mutationQueue=[],this.pr=1,this.yr=new A(Mh.Pr)}checkEmpty(e){return D.resolve(0===this.mutationQueue.length)}addMutationBatch(e,t,n,r){var s=this.pr,t=(this.pr++,0<this.mutationQueue.length&&this.mutationQueue[this.mutationQueue.length-1],new vo(s,t,n,r));this.mutationQueue.push(t);for(const t of r)this.yr=this.yr.add(new Mh(t.key,s)),this.indexManager.addToCollectionParentIndex(e,t.key.path.popLast());return D.resolve(t)}lookupMutationBatch(e,t){return D.resolve(this.wr(t))}getNextMutationBatchAfterBatchId(e,t){t=(t=this.Sr(t+1))<0?0:t;return D.resolve(this.mutationQueue.length>t?this.mutationQueue[t]:null)}getHighestUnacknowledgedBatchId(){return D.resolve(0===this.mutationQueue.length?-1:this.pr-1)}getAllMutationBatches(e){return D.resolve(this.mutationQueue.slice())}getAllMutationBatchesAffectingDocumentKey(e,t){const n=new Mh(t,0),r=new Mh(t,Number.POSITIVE_INFINITY),s=[];return this.yr.forEachInRange([n,r],e=>{e=this.wr(e.gr);s.push(e)}),D.resolve(s)}getAllMutationBatchesAffectingDocumentKeys(e,t){let n=new A(T);return t.forEach(e=>{var t=new Mh(e,0),e=new Mh(e,Number.POSITIVE_INFINITY);this.yr.forEachInRange([t,e],e=>{n=n.add(e.gr)})}),D.resolve(this.br(n))}getAllMutationBatchesAffectingQuery(e,t){const n=t.path,r=n.length+1;let s=n;S.isDocumentKey(s)||(s=s.child(""));t=new Mh(new S(s),0);let i=new A(T);return this.yr.forEachWhile(e=>{var t=e.key.path;return!!n.isPrefixOf(t)&&(t.length===r&&(i=i.add(e.gr)),!0)},t),D.resolve(this.br(i))}br(e){const t=[];return e.forEach(e=>{e=this.wr(e);null!==e&&t.push(e)}),t}removeMutationBatch(n,r){y(0===this.Dr(r.batchId,"removed")),this.mutationQueue.shift();let s=this.yr;return D.forEach(r.mutations,e=>{var t=new Mh(e.key,r.batchId);return s=s.delete(t),this.referenceDelegate.markPotentiallyOrphaned(n,e.key)}).next(()=>{this.yr=s})}Fn(e){}containsKey(e,t){var n=new Mh(t,0),n=this.yr.firstAfterOrEqual(n);return D.resolve(t.isEqual(n&&n.key))}performConsistencyCheck(e){return this.mutationQueue.length,D.resolve()}Dr(e,t){return this.Sr(e)}Sr(e){return 0===this.mutationQueue.length?0:e-this.mutationQueue[0].batchId}wr(e){e=this.Sr(e);return e<0||e>=this.mutationQueue.length?null:this.mutationQueue[e]}}class Oh{constructor(e){this.Cr=e,this.docs=new C(S.comparator),this.size=0}setIndexManager(e){this.indexManager=e}addEntry(e,t){const n=t.key,r=this.docs.get(n),s=r?r.size:0,i=this.Cr(t);return this.docs=this.docs.insert(n,{document:t.mutableCopy(),size:i}),this.size+=i-s,this.indexManager.addToCollectionParentIndex(e,n.path.popLast())}removeEntry(e){var t=this.docs.get(e);t&&(this.docs=this.docs.remove(e),this.size-=t.size)}getEntry(e,t){const n=this.docs.get(t);return D.resolve(n?n.document.mutableCopy():k.newInvalidDocument(t))}getEntries(e,t){let n=Fa;return t.forEach(e=>{const t=this.docs.get(e);n=n.insert(e,t?t.document.mutableCopy():k.newInvalidDocument(e))}),D.resolve(n)}getDocumentsMatchingQuery(e,t,n,r){let s=Fa;const i=t.path,a=new S(i.child("")),o=this.docs.getIteratorFrom(a);for(;o.hasNext();){const{key:e,value:{document:a}}=o.getNext();if(!i.isPrefixOf(e.path))break;e.path.length>i.length+1||ys(ms(a),n)<=0||(r.has(a.key)||Ra(t,a))&&(s=s.insert(a.key,a.mutableCopy()))}return D.resolve(s)}getAllFromCollectionGroup(e,t,n,r){E()}vr(e,t){return D.forEach(this.docs,e=>t(e))}newChangeBuffer(e){return new Fh(this)}getSize(e){return D.resolve(this.size)}}class Fh extends wh{constructor(e){super(),this._r=e}applyChanges(n){const r=[];return this.changes.forEach((e,t)=>{t.isValidDocument()?r.push(this._r.addEntry(n,t)):this._r.removeEntry(e)}),D.waitFor(r)}getFromCache(e,t){return this._r.getEntry(e,t)}getAllFromCache(e,t){return this._r.getEntries(e,t)}}class Ph{constructor(e){this.persistence=e,this.Fr=new Oa(e=>ga(e),ma),this.lastRemoteSnapshotVersion=b.min(),this.highestTargetId=0,this.Mr=0,this.Or=new Rh,this.targetCount=0,this.Nr=uh.On()}forEachTarget(e,n){return this.Fr.forEach((e,t)=>n(t)),D.resolve()}getLastRemoteSnapshotVersion(e){return D.resolve(this.lastRemoteSnapshotVersion)}getHighestSequenceNumber(e){return D.resolve(this.Mr)}allocateTargetId(e){return this.highestTargetId=this.Nr.next(),D.resolve(this.highestTargetId)}setTargetsMetadata(e,t,n){return n&&(this.lastRemoteSnapshotVersion=n),t>this.Mr&&(this.Mr=t),D.resolve()}kn(e){this.Fr.set(e.target,e);var t=e.targetId;t>this.highestTargetId&&(this.Nr=new uh(t),this.highestTargetId=t),e.sequenceNumber>this.Mr&&(this.Mr=e.sequenceNumber)}addTargetData(e,t){return this.kn(t),this.targetCount+=1,D.resolve()}updateTargetData(e,t){return this.kn(t),D.resolve()}removeTargetData(e,t){return this.Fr.delete(t.target),this.Or.Rr(t.targetId),--this.targetCount,D.resolve()}removeTargets(n,r,s){let i=0;const a=[];return this.Fr.forEach((e,t)=>{t.sequenceNumber<=r&&null===s.get(t.targetId)&&(this.Fr.delete(e),a.push(this.removeMatchingKeysForTargetId(n,t.targetId)),i++)}),D.waitFor(a).next(()=>i)}getTargetCount(e){return D.resolve(this.targetCount)}getTargetData(e,t){t=this.Fr.get(t)||null;return D.resolve(t)}addMatchingKeys(e,t,n){return this.Or.Er(t,n),D.resolve()}removeMatchingKeys(t,e,n){this.Or.Ar(e,n);const r=this.persistence.referenceDelegate,s=[];return r&&e.forEach(e=>{s.push(r.markPotentiallyOrphaned(t,e))}),D.waitFor(s)}removeMatchingKeysForTargetId(e,t){return this.Or.Rr(t),D.resolve()}getMatchingKeysForTargetId(e,t){t=this.Or.mr(t);return D.resolve(t)}containsKey(e,t){return D.resolve(this.Or.containsKey(t))}}class Vh{constructor(e,t){this.Br={},this.overlays={},this.Lr=new Rs(0),this.kr=!1,this.kr=!0,this.referenceDelegate=e(this),this.qr=new Ph(this),this.indexManager=new ju,this.remoteDocumentCache=(e=e=>this.referenceDelegate.Qr(e),new Oh(e)),this.serializer=new lu(t),this.Kr=new Nh(this.serializer)}start(){return Promise.resolve()}shutdown(){return this.kr=!1,Promise.resolve()}get started(){return this.kr}setDatabaseDeletedListener(){}setNetworkEnabled(){}getIndexManager(e){return this.indexManager}getDocumentOverlayCache(e){let t=this.overlays[e.toKey()];return t||(t=new kh,this.overlays[e.toKey()]=t),t}getMutationQueue(e,t){let n=this.Br[e.toKey()];return n||(n=new Lh(t,this.referenceDelegate),this.Br[e.toKey()]=n),n}getTargetCache(){return this.qr}getRemoteDocumentCache(){return this.remoteDocumentCache}getBundleCache(){return this.Kr}runTransaction(e,t,n){m("MemoryPersistence","Starting transaction:",e);const r=new Bh(this.Lr.next());return this.referenceDelegate.$r(),n(r).next(e=>this.referenceDelegate.Ur(r).next(()=>e)).toPromise().then(e=>(r.raiseOnCommittedEvent(),e))}Wr(t,n){return D.or(Object.values(this.Br).map(e=>()=>e.containsKey(t,n)))}}class Bh extends ws{constructor(e){super(),this.currentSequenceNumber=e}}class qh{constructor(e){this.persistence=e,this.Gr=new Rh,this.zr=null}static jr(e){return new qh(e)}get Hr(){if(this.zr)return this.zr;throw E()}addReference(e,t,n){return this.Gr.addReference(n,t),this.Hr.delete(n.toString()),D.resolve()}removeReference(e,t,n){return this.Gr.removeReference(n,t),this.Hr.add(n.toString()),D.resolve()}markPotentiallyOrphaned(e,t){return this.Hr.add(t.toString()),D.resolve()}removeTarget(e,t){this.Gr.Rr(t.targetId).forEach(e=>this.Hr.add(e.toString()));const n=this.persistence.getTargetCache();return n.getMatchingKeysForTargetId(e,t.targetId).next(e=>{e.forEach(e=>this.Hr.add(e.toString()))}).next(()=>n.removeTargetData(e,t))}$r(){this.zr=new Set}Ur(n){const r=this.persistence.getRemoteDocumentCache().newChangeBuffer();return D.forEach(this.Hr,e=>{const t=S.fromPath(e);return this.Jr(n,t).next(e=>{e||r.removeEntry(t,b.min())})}).next(()=>(this.zr=null,r.apply(n)))}updateLimboDocument(e,t){return this.Jr(e,t).next(e=>{e?this.Hr.delete(t.toString()):this.Hr.add(t.toString())})}Qr(e){return 0}Jr(e,t){return D.or([()=>D.resolve(this.Gr.containsKey(t)),()=>this.persistence.getTargetCache().containsKey(e,t),()=>this.persistence.Wr(e,t)])}}class Uh{constructor(e){this.serializer=e}N(t,e,n,r){const i=new bs("createOrUpgrade",e);var s;n<1&&1<=r&&(t.createObjectStore("owner"),(s=t).createObjectStore("mutationQueues",{keyPath:"userId"}),s.createObjectStore("mutations",{keyPath:"batchId",autoIncrement:!0}).createIndex("userMutationsIndex",Bs,{unique:!0}),s.createObjectStore("documentMutations"),zh(t),t.createObjectStore("remoteDocuments"));let a=D.resolve();return n<3&&3<=r&&(0!==n&&((s=t).deleteObjectStore("targetDocuments"),s.deleteObjectStore("targets"),s.deleteObjectStore("targetGlobal"),zh(t)),a=a.next(()=>{{const e=i.store("targetGlobal"),t={highestTargetId:0,highestListenSequenceNumber:0,lastRemoteSnapshotVersion:b.min().toTimestamp(),targetCount:0};return e.put("targetGlobalKey",t)}})),n<4&&4<=r&&(a=(a=0!==n?a.next(()=>{var r=t,s=i;return s.store("mutations").W().next(e=>{r.deleteObjectStore("mutations"),r.createObjectStore("mutations",{keyPath:"batchId",autoIncrement:!0}).createIndex("userMutationsIndex",Bs,{unique:!0});const t=s.store("mutations"),n=e.map(e=>t.put(e));return D.waitFor(n)})}):a).next(()=>{t.createObjectStore("clientMetadata",{keyPath:"clientId"})})),n<5&&5<=r&&(a=a.next(()=>this.Zr(i))),n<6&&6<=r&&(a=a.next(()=>(t.createObjectStore("remoteDocumentGlobal"),this.Xr(i)))),n<7&&7<=r&&(a=a.next(()=>this.ei(i))),n<8&&8<=r&&(a=a.next(()=>this.ti(t,i))),n<9&&9<=r&&(a=a.next(()=>{var e;(e=t).objectStoreNames.contains("remoteDocumentChanges")&&e.deleteObjectStore("remoteDocumentChanges")})),n<10&&10<=r&&(a=a.next(()=>this.ni(i))),n<11&&11<=r&&(a=a.next(()=>{t.createObjectStore("bundles",{keyPath:"bundleId"}),t.createObjectStore("namedQueries",{keyPath:"name"})})),n<12&&12<=r&&(a=a.next(()=>{{const e=t.createObjectStore("documentOverlays",{keyPath:ei});return e.createIndex("collectionPathOverlayIndex",ti,{unique:!1}),void e.createIndex("collectionGroupOverlayIndex",ni,{unique:!1})}})),n<13&&13<=r&&(a=a.next(()=>{{const e=t.createObjectStore("remoteDocumentsV14",{keyPath:Gs});return e.createIndex("documentKeyIndex",js),void e.createIndex("collectionGroupIndex",Ks)}}).next(()=>this.ri(t,i)).next(()=>t.deleteObjectStore("remoteDocuments"))),n<14&&14<=r&&(a=a.next(()=>this.ii(t,i))),a=n<15&&15<=r?a.next(()=>{var e=t;e.createObjectStore("indexConfiguration",{keyPath:"indexId",autoIncrement:!0}).createIndex("collectionGroupIndex","collectionGroup",{unique:!1}),e.createObjectStore("indexState",{keyPath:Ys}).createIndex("sequenceNumberIndex",Xs,{unique:!1}),e.createObjectStore("indexEntries",{keyPath:Js}).createIndex("documentKeyIndex",Zs,{unique:!1})}):a}Xr(t){let n=0;return t.store("remoteDocuments").Y((e,t)=>{n+=nh(t)}).next(()=>{var e={byteSize:n};return t.store("remoteDocumentGlobal").put("remoteDocumentGlobalKey",e)})}Zr(n){const e=n.store("mutationQueues"),r=n.store("mutations");return e.W().next(e=>D.forEach(e,t=>{var e=IDBKeyRange.bound([t.userId,-1],[t.userId,t.lastAcknowledgedBatchId]);return r.W("userMutationsIndex",e).next(e=>D.forEach(e,e=>{y(e.userId===t.userId);e=pu(this.serializer,e);return th(n,t.userId,e).next(()=>{})}))}))}ei(e){const a=e.store("targetDocuments"),t=e.store("remoteDocuments");return e.store("targetGlobal").get("targetGlobalKey").next(s=>{const i=[];return t.Y((e,t)=>{const n=new I(e),r=[0,Fs(n)];i.push(a.get(r).next(e=>e?D.resolve():(e=>a.put({targetId:0,path:Fs(e),sequenceNumber:s.highestListenSequenceNumber}))(n)))}).next(()=>D.waitFor(i))})}ti(e,t){e.createObjectStore("collectionParents",{keyPath:Hs});const n=t.store("collectionParents"),r=new Ku,s=e=>{if(r.add(e)){const t=e.lastSegment(),r=e.popLast();return n.put({collectionId:t,parent:Fs(r)})}};return t.store("remoteDocuments").Y({J:!0},(e,t)=>{const n=new I(e);return s(n.popLast())}).next(()=>t.store("documentMutations").Y({J:!0},([,e],t)=>{const n=Vs(e);return s(n.popLast())}))}ni(e){const n=e.store("targets");return n.Y((e,t)=>{t=yu(t),t=vu(this.serializer,t);return n.put(t)})}ri(e,a){const t=a.store("remoteDocuments"),o=[];return t.Y((e,t)=>{const n=a.store("remoteDocumentsV14"),r=((i=t).document?new S(I.fromString(i.document.name).popFirst(5)):i.noDocument?S.fromSegments(i.noDocument.path):i.unknownDocument?S.fromSegments(i.unknownDocument.path):E()).path.toArray(),s={prefixPath:r.slice(0,r.length-2),collectionGroup:r[r.length-2],documentId:r[r.length-1],readTime:t.readTime||[0,0],unknownDocument:t.unknownDocument,noDocument:t.noDocument,document:t.document,hasCommittedMutations:!!t.hasCommittedMutations};var i;o.push(n.put(s))}).next(()=>D.waitFor(o))}ii(e,s){const t=s.store("mutations"),i=bh(this.serializer),a=new Vh(qh.jr,this.serializer.ut);return t.W().next(e=>{const r=new Map;return e.forEach(e=>{var t;let n=null!=(t=r.get(e.userId))?t:L();pu(this.serializer,e).keys().forEach(e=>n=n.add(e)),r.set(e.userId,n)}),D.forEach(r,(e,t)=>{var t=new o(t),n=xu.ct(this.serializer,t),r=a.getIndexManager(t),t=rh.ct(t,this.serializer,r,a.referenceDelegate);return new Ah(i,t,n,r).recalculateAndSaveOverlaysForDocumentKeys(new ui(s,Rs._e),e).next()})})}}function zh(e){e.createObjectStore("targetDocuments",{keyPath:$s}).createIndex("documentTargetsIndex",Ws,{unique:!0}),e.createObjectStore("targets",{keyPath:"targetId"}).createIndex("queryTargetsIndex",Qs,{unique:!0}),e.createObjectStore("targetGlobal")}const Gh="Failed to obtain exclusive access to the persistence layer. To allow shared access, multi-tab synchronization has to be enabled in all tabs. If you are using `experimentalForceOwningTab:true`, make sure that only one tab has persistence enabled at any given time.";class jh{constructor(e,t,n,r,s,i,a,o,u,h,c=15){if(this.allowTabSynchronization=e,this.persistenceKey=t,this.clientId=n,this.si=s,this.window=i,this.document=a,this.oi=u,this._i=h,this.ai=c,this.Lr=null,this.kr=!1,this.isPrimary=!1,this.networkEnabled=!0,this.ui=null,this.inForeground=!1,this.ci=null,this.li=null,this.hi=Number.NEGATIVE_INFINITY,this.Pi=e=>Promise.resolve(),!jh.D())throw new _(w.UNIMPLEMENTED,"This platform is either missing IndexedDB or is known to have an incomplete implementation. Offline persistence has been disabled.");this.referenceDelegate=new yh(this,r),this.Ii=t+"main",this.serializer=new lu(o),this.Ti=new Is(this.Ii,this.ai,new Uh(this.serializer)),this.qr=new hh(this.referenceDelegate,this.serializer),this.remoteDocumentCache=bh(this.serializer),this.Kr=new Eu,this.window&&this.window.localStorage?this.Ei=this.window.localStorage:(this.Ei=null,!1===h&&d("IndexedDbPersistence","LocalStorage is unavailable. As a result, persistence may not work reliably. In particular enablePersistence() could fail immediately after refreshing the page."))}start(){return this.di().then(()=>{if(this.isPrimary||this.allowTabSynchronization)return this.Ai(),this.Ri(),this.Vi(),this.runTransaction("getHighestListenSequenceNumber","readonly",e=>this.qr.getHighestSequenceNumber(e));throw new _(w.FAILED_PRECONDITION,Gh)}).then(e=>{this.Lr=new Rs(e,this.oi)}).then(()=>{this.kr=!0}).catch(e=>(this.Ti&&this.Ti.close(),Promise.reject(e)))}mi(t){return this.Pi=async e=>{if(this.started)return t(e)},t(this.isPrimary)}setDatabaseDeletedListener(t){this.Ti.L(async e=>{null===e.newVersion&&await t()})}setNetworkEnabled(e){this.networkEnabled!==e&&(this.networkEnabled=e,this.si.enqueueAndForget(async()=>{this.started&&await this.di()}))}di(){return this.runTransaction("updateClientMetadataAndTryBecomePrimary","readwrite",t=>Qh(t).put({clientId:this.clientId,updateTimeMs:Date.now(),networkEnabled:this.networkEnabled,inForeground:this.inForeground}).next(()=>{if(this.isPrimary)return this.fi(t).next(e=>{e||(this.isPrimary=!1,this.si.enqueueRetryable(()=>this.Pi(!1)))})}).next(()=>this.gi(t)).next(e=>this.isPrimary&&!e?this.pi(t).next(()=>!1):!!e&&this.yi(t).next(()=>!0))).catch(e=>{if(Ss(e))return m("IndexedDbPersistence","Failed to extend owner lease: ",e),this.isPrimary;if(this.allowTabSynchronization)return m("IndexedDbPersistence","Releasing owner lease after error during lease refresh",e),!1;throw e}).then(e=>{this.isPrimary!==e&&this.si.enqueueRetryable(()=>this.Pi(e)),this.isPrimary=e})}fi(e){return Kh(e).get("owner").next(e=>D.resolve(this.wi(e)))}Si(e){return Qh(e).delete(this.clientId)}async bi(){if(this.isPrimary&&!this.Di(this.hi,18e5)){this.hi=Date.now();var e=await this.runTransaction("maybeGarbageCollectMultiClientState","readwrite-primary",e=>{const r=hi(e,"clientMetadata");return r.W().next(e=>{const t=this.Ci(e,18e5),n=e.filter(e=>-1===t.indexOf(e));return D.forEach(n,e=>r.delete(e.clientId)).next(()=>n)})}).catch(()=>[]);if(this.Ei)for(const t of e)this.Ei.removeItem(this.vi(t.clientId))}}Vi(){this.li=this.si.enqueueAfterDelay("client_metadata_refresh",4e3,()=>this.di().then(()=>this.bi()).then(()=>this.Vi()))}wi(e){return!!e&&e.ownerId===this.clientId}gi(t){return this._i?D.resolve(!0):Kh(t).get("owner").next(e=>{if(null!==e&&this.Di(e.leaseTimestampMs,5e3)&&!this.Fi(e.ownerId)){if(this.wi(e)&&this.networkEnabled)return!0;if(!this.wi(e)){if(e.allowTabSynchronization)return!1;throw new _(w.FAILED_PRECONDITION,Gh)}}return!(!this.networkEnabled||!this.inForeground)||Qh(t).W().next(e=>void 0===this.Ci(e,5e3).find(e=>{if(this.clientId!==e.clientId){var t=!this.networkEnabled&&e.networkEnabled,n=!this.inForeground&&e.inForeground,e=this.networkEnabled===e.networkEnabled;if(t||n&&e)return!0}return!1}))}).next(e=>(this.isPrimary!==e&&m("IndexedDbPersistence",`Client ${e?"is":"is not"} eligible for a primary lease.`),e))}async shutdown(){this.kr=!1,this.Mi(),this.li&&(this.li.cancel(),this.li=null),this.xi(),this.Oi(),await this.Ti.runTransaction("shutdown","readwrite",["owner","clientMetadata"],e=>{const t=new ui(e,Rs._e);return this.pi(t).next(()=>this.Si(t))}),this.Ti.close(),this.Ni()}Ci(e,t){return e.filter(e=>this.Di(e.updateTimeMs,t)&&!this.Fi(e.clientId))}Bi(){return this.runTransaction("getActiveClients","readonly",e=>Qh(e).W().next(e=>this.Ci(e,18e5).map(e=>e.clientId)))}get started(){return this.kr}getMutationQueue(e,t){return rh.ct(e,this.serializer,t,this.referenceDelegate)}getTargetCache(){return this.qr}getRemoteDocumentCache(){return this.remoteDocumentCache}getIndexManager(e){return new $u(e,this.serializer.ut.databaseId)}getDocumentOverlayCache(e){return xu.ct(this.serializer,e)}getBundleCache(){return this.Kr}runTransaction(t,n,r){m("IndexedDbPersistence","Starting transaction:",t);var e="readonly"===n?"readonly":"readwrite",s=15===(s=this.ai)?oi:14===s?ai:13===s?ii:12===s?si:11===s?ri:void E();let i;return this.Ti.runTransaction(t,e,s,e=>(i=new ui(e,this.Lr?this.Lr.next():Rs._e),"readwrite-primary"===n?this.fi(i).next(e=>!!e||this.gi(i)).next(e=>{if(e)return r(i);throw d(`Failed to obtain primary lease for action '${t}'.`),this.isPrimary=!1,this.si.enqueueRetryable(()=>this.Pi(!1)),new _(w.FAILED_PRECONDITION,vs)}).next(e=>this.yi(i).next(()=>e)):this.Li(i).next(()=>r(i)))).then(e=>(i.raiseOnCommittedEvent(),e))}Li(e){return Kh(e).get("owner").next(e=>{if(null!==e&&this.Di(e.leaseTimestampMs,5e3)&&!this.Fi(e.ownerId)&&!this.wi(e)&&!(this._i||this.allowTabSynchronization&&e.allowTabSynchronization))throw new _(w.FAILED_PRECONDITION,Gh)})}yi(e){var t={ownerId:this.clientId,allowTabSynchronization:this.allowTabSynchronization,leaseTimestampMs:Date.now()};return Kh(e).put("owner",t)}static D(){return Is.D()}pi(e){const t=Kh(e);return t.get("owner").next(e=>this.wi(e)?(m("IndexedDbPersistence","Releasing primary lease."),t.delete("owner")):D.resolve())}Di(e,t){var n=Date.now();return!(e<n-t||n<e&&(d(`Detected an update time that is in the future: ${e} > `+n),1))}Ai(){null!==this.document&&"function"==typeof this.document.addEventListener&&(this.ci=()=>{this.si.enqueueAndForget(()=>(this.inForeground="visible"===this.document.visibilityState,this.di()))},this.document.addEventListener("visibilitychange",this.ci),this.inForeground="visible"===this.document.visibilityState)}xi(){this.ci&&(this.document.removeEventListener("visibilitychange",this.ci),this.ci=null)}Ri(){var e;"function"==typeof(null==(e=this.window)?void 0:e.addEventListener)&&(this.ui=()=>{this.Mi();var e=/(?:Version|Mobile)\/1[456]/;j()&&(navigator.appVersion.match(e)||navigator.userAgent.match(e))&&this.si.enterRestrictedMode(!0),this.si.enqueueAndForget(()=>this.shutdown())},this.window.addEventListener("pagehide",this.ui))}Oi(){this.ui&&(this.window.removeEventListener("pagehide",this.ui),this.ui=null)}Fi(e){var t;try{var n=null!==(null==(t=this.Ei)?void 0:t.getItem(this.vi(e)));return m("IndexedDbPersistence",`Client '${e}' ${n?"is":"is not"} zombied in LocalStorage`),n}catch(e){return d("IndexedDbPersistence","Failed to get zombied client id.",e),!1}}Mi(){if(this.Ei)try{this.Ei.setItem(this.vi(this.clientId),String(Date.now()))}catch(e){d("Failed to set zombie client id.",e)}}Ni(){if(this.Ei)try{this.Ei.removeItem(this.vi(this.clientId))}catch(e){}}vi(e){return`firestore_zombie_${this.persistenceKey}_`+e}}function Kh(e){return hi(e,"owner")}function Qh(e){return hi(e,"clientMetadata")}function $h(e,t){let n=e.projectId;return e.isDefaultDatabase||(n+="."+e.database),"firestore/"+t+"/"+n+"/"}class Wh{constructor(e,t,n,r){this.targetId=e,this.fromCache=t,this.ki=n,this.qi=r}static Qi(e,t){let n=L(),r=L();for(const e of t.docChanges)switch(e.type){case 0:n=n.add(e.doc.key);break;case 1:r=r.add(e.doc.key)}return new Wh(e,t.fromCache,n,r)}}class Hh{constructor(){this._documentReadCount=0}get documentReadCount(){return this._documentReadCount}incrementDocumentReadCount(e){this._documentReadCount+=e}}class Yh{constructor(){this.Ki=!1,this.$i=!1,this.Ui=100,this.Wi=8}initialize(e,t){this.Gi=e,this.indexManager=t,this.Ki=!0}getDocumentsMatchingQuery(n,r,e,t){const s={result:null};return this.zi(n,r).next(e=>{s.result=e}).next(()=>{if(!s.result)return this.ji(n,r,t,e).next(e=>{s.result=e})}).next(()=>{if(!s.result){const t=new Hh;return this.Hi(n,r,t).next(e=>{if(s.result=e,this.$i)return this.Ji(n,r,t,e.size)})}}).next(()=>s.result)}Ji(e,t,n,r){return n.documentReadCount<this.Ui?(Qr()<=l.DEBUG&&m("QueryEngine","SDK will not create cache indexes for query:",ka(t),"since it only creates cache indexes for collection contains","more than or equal to",this.Ui,"documents"),D.resolve()):(Qr()<=l.DEBUG&&m("QueryEngine","Query:",ka(t),"scans",n.documentReadCount,"local documents and returns",r,"documents as results."),n.documentReadCount>this.Wi*r?(Qr()<=l.DEBUG&&m("QueryEngine","The SDK decides to create cache indexes for query:",ka(t),"as using cache indexes may help improve performance."),this.indexManager.createTargetIndexes(e,xa(t))):D.resolve())}zi(s,i){if(Ea(i))return D.resolve(null);let t=xa(i);return this.indexManager.getIndexType(s,t).next(e=>0===e?null:(null!==i.limit&&1===e&&(i=Ca(i,null,"F"),t=xa(i)),this.indexManager.getDocumentsMatchingTarget(s,t).next(e=>{const r=L(...e);return this.Gi.getDocuments(s,r).next(n=>this.indexManager.getMinOffset(s,t).next(e=>{var t=this.Yi(i,n);return this.Zi(i,t,r,e.readTime)?this.zi(s,Ca(i,null,"F")):this.Xi(s,t,i,e)}))})))}ji(t,n,r,s){return Ea(n)||s.isEqual(b.min())?D.resolve(null):this.Gi.getDocuments(t,r).next(e=>{e=this.Yi(n,e);return this.Zi(n,e,r,s)?D.resolve(null):(Qr()<=l.DEBUG&&m("QueryEngine","Re-using previous result from %s to execute query: %s",s.toString(),ka(n)),this.Xi(t,e,n,gs(s,-1)).next(e=>e))})}Yi(n,e){let r=new A(La(n));return e.forEach((e,t)=>{Ra(n,t)&&(r=r.add(t))}),r}Zi(e,t,n,r){if(null===e.limit)return!1;if(n.size!==t.size)return!0;const s="F"===e.limitType?t.last():t.first();return!!s&&(s.hasPendingWrites||0<s.version.compareTo(r))}Hi(e,t,n){return Qr()<=l.DEBUG&&m("QueryEngine","Using full collection scan to execute query:",ka(t)),this.Gi.getDocumentsMatchingQuery(e,t,ps.min(),n)}Xi(e,n,t,r){return this.Gi.getDocumentsMatchingQuery(e,t,r).next(t=>(n.forEach(e=>{t=t.insert(e.key,e)}),t))}}class Xh{constructor(e,t,n,r){this.persistence=e,this.es=t,this.serializer=r,this.ts=new C(T),this.ns=new Oa(e=>ga(e),ma),this.rs=new Map,this.ss=e.getRemoteDocumentCache(),this.qr=e.getTargetCache(),this.Kr=e.getBundleCache(),this.os(n)}os(e){this.documentOverlayCache=this.persistence.getDocumentOverlayCache(e),this.indexManager=this.persistence.getIndexManager(e),this.mutationQueue=this.persistence.getMutationQueue(e,this.indexManager),this.localDocuments=new Ah(this.ss,this.mutationQueue,this.documentOverlayCache,this.indexManager),this.ss.setIndexManager(this.indexManager),this.es.initialize(this.localDocuments,this.indexManager)}collectGarbage(t){return this.persistence.runTransaction("Collect garbage","readwrite-primary",e=>t.collect(e,this.ts))}}function Jh(e,t,n,r){return new Xh(e,t,n,r)}async function Zh(e,t){const a=e;return a.persistence.runTransaction("Handle user change","readonly",s=>{let i;return a.mutationQueue.getAllMutationBatches(s).next(e=>(i=e,a.os(t),a.mutationQueue.getAllMutationBatches(s))).next(e=>{const t=[],n=[];let r=L();for(const s of i){t.push(s.batchId);for(const e of s.mutations)r=r.add(e.key)}for(const s of e){n.push(s.batchId);for(const e of s.mutations)r=r.add(e.key)}return a.localDocuments.getDocuments(s,r).next(e=>({_s:e,removedBatchIds:t,addedBatchIds:n}))})})}function ec(e){const t=e;return t.persistence.runTransaction("Get last remote snapshot version","readonly",e=>t.qr.getLastRemoteSnapshotVersion(e))}function tc(e,i,t){let n=L(),a=L();return t.forEach(e=>n=n.add(e)),i.getEntries(e,n).next(r=>{let s=Fa;return t.forEach((e,t)=>{const n=r.get(e);t.isFoundDocument()!==n.isFoundDocument()&&(a=a.add(e)),t.isNoDocument()&&t.version.isEqual(b.min())?(i.removeEntry(e,t.readTime),s=s.insert(e,t)):!n.isValidDocument()||0<t.version.compareTo(n.version)||0===t.version.compareTo(n.version)&&n.hasPendingWrites?(i.addEntry(t),s=s.insert(e,t)):m("LocalStore","Ignoring outdated watch update for ",e,". Current version:",n.version," Watch version:",t.version)}),{us:s,cs:a}})}function nc(e,r){const s=e;return s.persistence.runTransaction("Allocate target","readwrite",t=>{let n;return s.qr.getTargetData(t,r).next(e=>e?(n=e,D.resolve(n)):s.qr.allocateTargetId(t).next(e=>(n=new cu(r,e,"TargetPurposeListen",t.currentSequenceNumber),s.qr.addTargetData(t,n).next(()=>n))))}).then(e=>{var t=s.ts.get(e.targetId);return(null===t||0<e.snapshotVersion.compareTo(t.snapshotVersion))&&(s.ts=s.ts.insert(e.targetId,e),s.ns.set(r,e.targetId)),e})}async function rc(e,t,n){const r=e,s=r.ts.get(t),i=n?"readwrite":"readwrite-primary";try{n||await r.persistence.runTransaction("Release target",i,e=>r.persistence.referenceDelegate.removeTarget(e,s))}catch(e){if(!Ss(e))throw e;m("LocalStore",`Failed to update sequence numbers for target ${t}: `+e)}r.ts=r.ts.remove(t),r.ns.delete(s.target)}function sc(e,n,r){const s=e;let i=b.min(),a=L();return s.persistence.runTransaction("Execute query","readwrite",t=>function(e,t,n){const r=e,s=r.ns.get(n);return void 0!==s?D.resolve(r.ts.get(s)):r.qr.getTargetData(t,n)}(s,t,xa(n)).next(e=>{if(e)return i=e.lastLimboFreeSnapshotVersion,s.qr.getMatchingKeysForTargetId(t,e.targetId).next(e=>{a=e})}).next(()=>s.es.getDocumentsMatchingQuery(t,n,r?i:b.min(),r?a:L())).next(e=>(oc(s,Ma(n),e),{documents:e,ls:a})))}function ic(e,t){const n=e,r=n.qr,s=n.ts.get(t);return s?Promise.resolve(s.target):n.persistence.runTransaction("Get target data","readonly",e=>r._t(e,t).next(e=>e?e.target:null))}function ac(e,t){const n=e,r=n.rs.get(t)||b.min();return n.persistence.runTransaction("Get new document changes","readonly",e=>n.ss.getAllFromCollectionGroup(e,t,gs(r,-1),Number.MAX_SAFE_INTEGER)).then(e=>(oc(n,t,e),e))}function oc(e,t,n){let r=e.rs.get(t)||b.min();n.forEach((e,t)=>{0<t.readTime.compareTo(r)&&(r=t.readTime)}),e.rs.set(t,r)}function uc(e,t){return`firestore_clients_${e}_`+t}function hc(e,t,n){let r=`firestore_mutations_${e}_`+n;return t.isAuthenticated()&&(r+="_"+t.uid),r}function cc(e,t){return`firestore_targets_${e}_`+t}class lc{constructor(e,t,n,r){this.user=e,this.batchId=t,this.state=n,this.error=r}static Ts(e,t,n){var r=JSON.parse(n);let s,i="object"==typeof r&&-1!==["pending","acknowledged","rejected"].indexOf(r.state)&&(void 0===r.error||"object"==typeof r.error);return i&&r.error&&((i="string"==typeof r.error.message&&"string"==typeof r.error.code)&&(s=new _(r.error.code,r.error.message))),i?new lc(e,t,r.state,s):(d("SharedClientState",`Failed to parse mutation state for ID '${t}': `+n),null)}Es(){const e={state:this.state,updateTimeMs:Date.now()};return this.error&&(e.error={code:this.error.code,message:this.error.message}),JSON.stringify(e)}}class dc{constructor(e,t,n){this.targetId=e,this.state=t,this.error=n}static Ts(e,t){var n=JSON.parse(t);let r,s="object"==typeof n&&-1!==["not-current","current","rejected"].indexOf(n.state)&&(void 0===n.error||"object"==typeof n.error);return s&&n.error&&((s="string"==typeof n.error.message&&"string"==typeof n.error.code)&&(r=new _(n.error.code,n.error.message))),s?new dc(e,n.state,r):(d("SharedClientState",`Failed to parse target state for ID '${e}': `+t),null)}Es(){const e={state:this.state,updateTimeMs:Date.now()};return this.error&&(e.error={code:this.error.code,message:this.error.message}),JSON.stringify(e)}}class fc{constructor(e,t){this.clientId=e,this.activeTargetIds=t}static Ts(e,t){var n=JSON.parse(t);let r="object"==typeof n&&n.activeTargetIds instanceof Array,s=Ga;for(let e=0;r&&e<n.activeTargetIds.length;++e)r=Os(n.activeTargetIds[e]),s=s.add(n.activeTargetIds[e]);return r?new fc(e,s):(d("SharedClientState",`Failed to parse client data for instance '${e}': `+t),null)}}class gc{constructor(e,t){this.clientId=e,this.onlineState=t}static Ts(e){var t=JSON.parse(e);return"object"==typeof t&&-1!==["Unknown","Online","Offline"].indexOf(t.onlineState)&&"string"==typeof t.clientId?new gc(t.clientId,t.onlineState):(d("SharedClientState","Failed to parse online state: "+e),null)}}class mc{constructor(){this.activeTargetIds=Ga}ds(e){this.activeTargetIds=this.activeTargetIds.add(e)}As(e){this.activeTargetIds=this.activeTargetIds.delete(e)}Es(){var e={activeTargetIds:this.activeTargetIds.toArray(),updateTimeMs:Date.now()};return JSON.stringify(e)}}class pc{constructor(e,t,n,r,s){this.window=e,this.si=t,this.persistenceKey=n,this.Rs=r,this.syncEngine=null,this.onlineStateHandler=null,this.sequenceNumberHandler=null,this.Vs=this.fs.bind(this),this.gs=new C(T),this.started=!1,this.ps=[];e=n.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");this.storage=this.window.localStorage,this.currentUser=s,this.ys=uc(this.persistenceKey,this.Rs),this.ws="firestore_sequence_number_"+this.persistenceKey,this.gs=this.gs.insert(this.Rs,new mc),this.Ss=new RegExp(`^firestore_clients_${e}_([^_]*)$`),this.bs=new RegExp(`^firestore_mutations_${e}_(\\d+)(?:_(.*))?$`),this.Ds=new RegExp(`^firestore_targets_${e}_(\\d+)$`),this.Cs="firestore_online_state_"+this.persistenceKey,this.vs="firestore_bundle_loaded_v2_"+this.persistenceKey,this.window.addEventListener("storage",this.Vs)}static D(e){return!(!e||!e.localStorage)}async start(){const e=await this.syncEngine.Bi();for(const n of e)if(n!==this.Rs){const e=this.getItem(uc(this.persistenceKey,n));var t;e&&(t=fc.Ts(n,e))&&(this.gs=this.gs.insert(t.clientId,t))}this.Fs();const n=this.storage.getItem(this.Cs);if(n){const e=this.Ms(n);e&&this.xs(e)}for(const e of this.ps)this.fs(e);this.ps=[],this.window.addEventListener("pagehide",()=>this.shutdown()),this.started=!0}writeSequenceNumber(e){this.setItem(this.ws,JSON.stringify(e))}getAllActiveQueryTargets(){return this.Os(this.gs)}isActiveQueryTarget(n){let r=!1;return this.gs.forEach((e,t)=>{t.activeTargetIds.has(n)&&(r=!0)}),r}addPendingMutation(e){this.Ns(e,"pending")}updateMutationState(e,t,n){this.Ns(e,t,n),this.Bs(e)}addLocalQueryTarget(e){let t="not-current";var n;return!this.isActiveQueryTarget(e)||(n=this.storage.getItem(cc(this.persistenceKey,e)))&&(n=dc.Ts(e,n))&&(t=n.state),this.Ls.ds(e),this.Fs(),t}removeLocalQueryTarget(e){this.Ls.As(e),this.Fs()}isLocalQueryTarget(e){return this.Ls.activeTargetIds.has(e)}clearQueryState(e){this.removeItem(cc(this.persistenceKey,e))}updateQueryState(e,t,n){this.ks(e,t,n)}handleUserChange(e,t,n){t.forEach(e=>{this.Bs(e)}),this.currentUser=e,n.forEach(e=>{this.addPendingMutation(e)})}setOnlineState(e){this.qs(e)}notifyBundleLoaded(e){this.Qs(e)}shutdown(){this.started&&(this.window.removeEventListener("storage",this.Vs),this.removeItem(this.ys),this.started=!1)}getItem(e){var t=this.storage.getItem(e);return m("SharedClientState","READ",e,t),t}setItem(e,t){m("SharedClientState","SET",e,t),this.storage.setItem(e,t)}removeItem(e){m("SharedClientState","REMOVE",e),this.storage.removeItem(e)}fs(e){const s=e;s.storageArea===this.storage&&(m("SharedClientState","EVENT",s.key,s.newValue),s.key!==this.ys?this.si.enqueueRetryable(async()=>{var e;if(this.started){if(null!==s.key){if(this.Ss.test(s.key))return null==s.newValue?(e=this.Ks(s.key),this.$s(e,null)):(e=this.Us(s.key,s.newValue))?this.$s(e.clientId,e):void 0;if(this.bs.test(s.key)){if(null!==s.newValue){var t=this.Ws(s.key,s.newValue);if(t)return this.Gs(t)}}else if(this.Ds.test(s.key)){if(null!==s.newValue&&(t=this.zs(s.key,s.newValue)))return this.js(t)}else if(s.key===this.Cs){if(null!==s.newValue){var n=this.Ms(s.newValue);if(n)return this.xs(n)}}else if(s.key===this.ws)(n=function(e){let t=Rs._e;if(null!=e)try{var n=JSON.parse(e);y("number"==typeof n),t=n}catch(e){d("SharedClientState","Failed to read sequence number from WebStorage",e)}return t}(s.newValue))!==Rs._e&&this.sequenceNumberHandler(n);else if(s.key===this.vs){const r=this.Hs(s.newValue);await Promise.all(r.map(e=>this.syncEngine.Js(e)))}}}else this.ps.push(s)}):d("Received WebStorage notification for local change. Another client might have garbage-collected our state"))}get Ls(){return this.gs.get(this.Rs)}Fs(){this.setItem(this.ys,this.Ls.Es())}Ns(e,t,n){const r=new lc(this.currentUser,e,t,n),s=hc(this.persistenceKey,this.currentUser,e);this.setItem(s,r.Es())}Bs(e){e=hc(this.persistenceKey,this.currentUser,e);this.removeItem(e)}qs(e){e={clientId:this.Rs,onlineState:e};this.storage.setItem(this.Cs,JSON.stringify(e))}ks(e,t,n){const r=cc(this.persistenceKey,e),s=new dc(e,t,n);this.setItem(r,s.Es())}Qs(e){e=JSON.stringify(Array.from(e));this.setItem(this.vs,e)}Ks(e){e=this.Ss.exec(e);return e?e[1]:null}Us(e,t){e=this.Ks(e);return fc.Ts(e,t)}Ws(e,t){var e=this.bs.exec(e),n=Number(e[1]),e=void 0!==e[2]?e[2]:null;return lc.Ts(new o(e),n,t)}zs(e,t){e=this.Ds.exec(e),e=Number(e[1]);return dc.Ts(e,t)}Ms(e){return gc.Ts(e)}Hs(e){return JSON.parse(e)}async Gs(e){if(e.user.uid===this.currentUser.uid)return this.syncEngine.Ys(e.batchId,e.state,e.error);m("SharedClientState","Ignoring mutation for non-active user "+e.user.uid)}js(e){return this.syncEngine.Zs(e.targetId,e.state,e.error)}$s(e,t){const n=t?this.gs.insert(e,t):this.gs.remove(e),r=this.Os(this.gs),s=this.Os(n),i=[],a=[];return s.forEach(e=>{r.has(e)||i.push(e)}),r.forEach(e=>{s.has(e)||a.push(e)}),this.syncEngine.Xs(i,a).then(()=>{this.gs=n})}xs(e){this.gs.get(e.clientId)&&this.onlineStateHandler(e.onlineState)}Os(e){let n=Ga;return e.forEach((e,t)=>{n=n.unionWith(t.activeTargetIds)}),n}}class yc{constructor(){this.eo=new mc,this.no={},this.onlineStateHandler=null,this.sequenceNumberHandler=null}addPendingMutation(e){}updateMutationState(e,t,n){}addLocalQueryTarget(e){return this.eo.ds(e),this.no[e]||"not-current"}updateQueryState(e,t,n){this.no[e]=t}removeLocalQueryTarget(e){this.eo.As(e)}isLocalQueryTarget(e){return this.eo.activeTargetIds.has(e)}clearQueryState(e){delete this.no[e]}getAllActiveQueryTargets(){return this.eo.activeTargetIds}isActiveQueryTarget(e){return this.eo.activeTargetIds.has(e)}start(){return this.eo=new mc,Promise.resolve()}handleUserChange(e,t,n){}setOnlineState(e){}shutdown(){}writeSequenceNumber(e){}notifyBundleLoaded(e){}}class vc{ro(e){}shutdown(){}}class wc{constructor(){this.io=()=>this.so(),this.oo=()=>this._o(),this.ao=[],this.uo()}ro(e){this.ao.push(e)}shutdown(){window.removeEventListener("online",this.io),window.removeEventListener("offline",this.oo)}uo(){window.addEventListener("online",this.io),window.addEventListener("offline",this.oo)}so(){m("ConnectivityMonitor","Network connectivity changed: AVAILABLE");for(const e of this.ao)e(0)}_o(){m("ConnectivityMonitor","Network connectivity changed: UNAVAILABLE");for(const e of this.ao)e(1)}static D(){return"undefined"!=typeof window&&void 0!==window.addEventListener&&void 0!==window.removeEventListener}}let _c=null;function bc(){return null===_c?_c=268435456+Math.round(2147483648*Math.random()):_c++,"0x"+_c.toString(16)}const Ic={BatchGetDocuments:"batchGet",Commit:"commit",RunQuery:"runQuery",RunAggregationQuery:"runAggregationQuery"};class Ec{constructor(e){this.co=e.co,this.lo=e.lo}ho(e){this.Po=e}Io(e){this.To=e}onMessage(e){this.Eo=e}close(){this.lo()}send(e){this.co(e)}Ao(){this.Po()}Ro(e){this.To(e)}Vo(e){this.Eo(e)}}const Tc="WebChannelConnection";class Sc extends class{constructor(e){this.databaseInfo=e,this.databaseId=e.databaseId;var t=e.ssl?"https":"http",n=encodeURIComponent(this.databaseId.projectId),r=encodeURIComponent(this.databaseId.database);this.mo=t+"://"+e.host,this.fo=`projects/${n}/databases/`+r,this.po="(default)"===this.databaseId.database?"project_id="+n:`project_id=${n}&database_id=`+r}get yo(){return!1}wo(t,e,n,r,s){const i=bc(),a=this.So(t,e);m("RestConnection",`Sending RPC '${t}' ${i}:`,a,n);e={"google-cloud-resource-prefix":this.fo,"x-goog-request-params":this.po};return this.bo(e,r,s),this.Do(t,a,e,n).then(e=>(m("RestConnection",`Received RPC '${t}' ${i}: `,e),e),e=>{throw $r("RestConnection",`RPC '${t}' ${i} failed with error: `,e,"url: ",a,"request:",n),e})}Co(e,t,n,r,s,i){return this.wo(e,t,n,r,s)}bo(n,e,t){n["X-Goog-Api-Client"]="gl-js/ fire/"+jr,n["Content-Type"]="text/plain",this.databaseInfo.appId&&(n["X-Firebase-GMPID"]=this.databaseInfo.appId),e&&e.headers.forEach((e,t)=>n[t]=e),t&&t.headers.forEach((e,t)=>n[t]=e)}So(e,t){e=Ic[e];return this.mo+`/v1/${t}:`+e}}{constructor(e){super(e),this.forceLongPolling=e.forceLongPolling,this.autoDetectLongPolling=e.autoDetectLongPolling,this.useFetchStreams=e.useFetchStreams,this.longPollingOptions=e.longPollingOptions}Do(o,t,n,r){const u=bc();return new Promise((s,i)=>{const a=new Ur;a.setWithCredentials(!0),a.listenOnce(Pr.COMPLETE,()=>{try{switch(a.getLastErrorCode()){case Fr.NO_ERROR:var e=a.getResponseJson();m(Tc,`XHR for RPC '${o}' ${u} received:`,JSON.stringify(e)),s(e);break;case Fr.TIMEOUT:m(Tc,`RPC '${o}' ${u} timed out`),i(new _(w.DEADLINE_EXCEEDED,"Request time out"));break;case Fr.HTTP_ERROR:var t=a.getStatus();if(m(Tc,`RPC '${o}' ${u} failed with status:`,t,"response text:",a.getResponseText()),0<t){let e=a.getResponseJson();var n=null==(e=Array.isArray(e)?e[0]:e)?void 0:e.error;if(n&&n.status&&n.message){r=n.status.toLowerCase().replace(/_/g,"-");const o=0<=Object.values(w).indexOf(r)?r:w.UNKNOWN;i(new _(o,n.message))}else i(new _(w.UNKNOWN,"Server responded with status "+a.getStatus()))}else i(new _(w.UNAVAILABLE,"Connection failed."));break;default:E()}}finally{m(Tc,`RPC '${o}' ${u} completed.`)}var r});var e=JSON.stringify(r);m(Tc,`RPC '${o}' ${u} sending request:`,r),a.send(t,"POST",e,n,15)})}vo(s,e,t){const i=bc(),n=[this.mo,"/","google.firestore.v1.Firestore","/",s,"/channel"],r=new lr,a=Or(),o={httpSessionIdParam:"gsessionid",initMessageHeaders:{},messageUrlParams:{database:`projects/${this.databaseId.projectId}/databases/`+this.databaseId.database},sendRawJson:!0,supportsCrossDomainXhr:!0,internalChannelParams:{forwardChannelRequestTimeoutMs:6e5},forceLongPolling:this.forceLongPolling,detectBufferingProxy:this.autoDetectLongPolling},u=this.longPollingOptions.timeoutSeconds;void 0!==u&&(o.longPollingTimeout=Math.round(1e3*u)),this.useFetchStreams&&(o.xmlHttpFactory=new Br({})),this.bo(o.initMessageHeaders,e,t),o.encodeInitMessageHeaders=!0;e=n.join("");m(Tc,`Creating RPC '${s}' stream ${i}: `+e,o);const h=r.createWebChannel(e,o);let c=!1,l=!1;const d=new Ec({co:e=>{l?m(Tc,`Not sending because RPC '${s}' stream ${i} is closed:`,e):(c||(m(Tc,`Opening RPC '${s}' stream ${i} transport.`),h.open(),c=!0),m(Tc,`RPC '${s}' stream ${i} sending:`,e),h.send(e))},lo:()=>h.close()}),f=(e,t,n)=>{e.listen(t,e=>{try{n(e)}catch(e){setTimeout(()=>{throw e},0)}})};return f(h,qr.EventType.OPEN,()=>{l||m(Tc,`RPC '${s}' stream ${i} transport opened.`)}),f(h,qr.EventType.CLOSE,()=>{l||(l=!0,m(Tc,`RPC '${s}' stream ${i} transport closed`),d.Ro())}),f(h,qr.EventType.ERROR,e=>{l||(l=!0,$r(Tc,`RPC '${s}' stream ${i} transport errored:`,e),d.Ro(new _(w.UNAVAILABLE,"The operation could not be completed")))}),f(h,qr.EventType.MESSAGE,n=>{if(!l){var n=n.data[0],r=(y(!!n),n.error||(null==(r=n[0])?void 0:r.error));if(r){m(Tc,`RPC '${s}' stream ${i} received error:`,r);const n=r.status;let e=function(e){e=g[e];if(void 0!==e)return Eo(e)}(n),t=r.message;void 0===e&&(e=w.INTERNAL,t="Unknown error status: "+n+" with message "+r.message),l=!0,d.Ro(new _(e,t)),h.close()}else m(Tc,`RPC '${s}' stream ${i} received:`,n),d.Vo(n)}}),f(a,Vr.STAT_EVENT,e=>{10===e.stat?m(Tc,`RPC '${s}' stream ${i} detected buffering proxy`):11===e.stat&&m(Tc,`RPC '${s}' stream ${i} detected no buffering proxy`)}),setTimeout(()=>{d.Ao()},0),d}}function xc(){return"undefined"!=typeof window?window:null}function Dc(){return"undefined"!=typeof document?document:null}function Cc(e){return new zo(e,!0)}class Ac{constructor(e,t,n=1e3,r=1.5,s=6e4){this.si=e,this.timerId=t,this.Fo=n,this.Mo=r,this.xo=s,this.Oo=0,this.No=null,this.Bo=Date.now(),this.reset()}reset(){this.Oo=0}Lo(){this.Oo=this.xo}ko(e){this.cancel();var t=Math.floor(this.Oo+this.qo()),n=Math.max(0,Date.now()-this.Bo),r=Math.max(0,t-n);0<r&&m("ExponentialBackoff",`Backing off for ${r} ms (base delay: ${this.Oo} ms, delay with jitter: ${t} ms, last attempt: ${n} ms ago)`),this.No=this.si.enqueueAfterDelay(this.timerId,r,()=>(this.Bo=Date.now(),e())),this.Oo*=this.Mo,this.Oo<this.Fo&&(this.Oo=this.Fo),this.Oo>this.xo&&(this.Oo=this.xo)}Qo(){null!==this.No&&(this.No.skipDelay(),this.No=null)}cancel(){null!==this.No&&(this.No.cancel(),this.No=null)}qo(){return(Math.random()-.5)*this.Oo}}class Nc{constructor(e,t,n,r,s,i,a,o){this.si=e,this.Ko=n,this.$o=r,this.connection=s,this.authCredentialsProvider=i,this.appCheckCredentialsProvider=a,this.listener=o,this.state=0,this.Uo=0,this.Wo=null,this.Go=null,this.stream=null,this.zo=new Ac(e,t)}jo(){return 1===this.state||5===this.state||this.Ho()}Ho(){return 2===this.state||3===this.state}start(){4!==this.state?this.auth():this.Jo()}async stop(){this.jo()&&await this.close(0)}Yo(){this.state=0,this.zo.reset()}Zo(){this.Ho()&&null===this.Wo&&(this.Wo=this.si.enqueueAfterDelay(this.Ko,6e4,()=>this.Xo()))}e_(e){this.t_(),this.stream.send(e)}async Xo(){if(this.Ho())return this.close(0)}t_(){this.Wo&&(this.Wo.cancel(),this.Wo=null)}n_(){this.Go&&(this.Go.cancel(),this.Go=null)}async close(e,t){this.t_(),this.n_(),this.zo.cancel(),this.Uo++,4!==e?this.zo.reset():t&&t.code===w.RESOURCE_EXHAUSTED?(d(t.toString()),d("Using maximum backoff delay to prevent overloading the backend."),this.zo.Lo()):t&&t.code===w.UNAUTHENTICATED&&3!==this.state&&(this.authCredentialsProvider.invalidateToken(),this.appCheckCredentialsProvider.invalidateToken()),null!==this.stream&&(this.r_(),this.stream.close(),this.stream=null),this.state=e,await this.listener.Io(t)}r_(){}auth(){this.state=1;const e=this.i_(this.Uo),n=this.Uo;Promise.all([this.authCredentialsProvider.getToken(),this.appCheckCredentialsProvider.getToken()]).then(([e,t])=>{this.Uo===n&&this.s_(e,t)},t=>{e(()=>{var e=new _(w.UNKNOWN,"Fetching auth token failed: "+t.message);return this.o_(e)})})}s_(e,t){const n=this.i_(this.Uo);this.stream=this.__(e,t),this.stream.ho(()=>{n(()=>(this.state=2,this.Go=this.si.enqueueAfterDelay(this.$o,1e4,()=>(this.Ho()&&(this.state=3),Promise.resolve())),this.listener.ho()))}),this.stream.Io(e=>{n(()=>this.o_(e))}),this.stream.onMessage(e=>{n(()=>this.onMessage(e))})}Jo(){this.state=5,this.zo.ko(async()=>{this.state=0,this.start()})}o_(e){return m("PersistentStream","close with error: "+e),this.stream=null,this.close(4,e)}i_(t){return e=>{this.si.enqueueAndForget(()=>this.Uo===t?e():(m("PersistentStream","stream callback skipped by getCloseGuardedDispatcher."),Promise.resolve()))}}}class kc extends Nc{constructor(e,t,n,r,s,i){super(e,"listen_stream_connection_backoff","listen_stream_idle","health_check_timeout",t,n,r,i),this.serializer=s}__(e,t){return this.connection.vo("Listen",e,t)}onMessage(e){this.zo.reset();var t=function(e,t){let n;if("targetChange"in t){t.targetChange;var r="NO_CHANGE"===(f=t.targetChange.targetChangeType||"NO_CHANGE")?0:"ADD"===f?1:"REMOVE"===f?2:"CURRENT"===f?3:"RESET"===f?4:E(),s=t.targetChange.targetIds||[],i=(f=t.targetChange.resumeToken,e.useProto3Json?(y(void 0===f||"string"==typeof f),wi.fromBase64String(f||"")):(y(void 0===f||f instanceof Uint8Array),wi.fromUint8Array(f||new Uint8Array))),a=t.targetChange.cause,o=a&&(o=void 0===(f=a).code?w.UNKNOWN:Eo(f.code),new _(o,f.message||""));n=new Lo(r,s,i,o||null)}else if("documentChange"in t){t.documentChange;(c=t.documentChange).document,c.document.name,c.document.updateTime;var i=Ho(e,c.document.name),o=F(c.document.updateTime),u=c.document.createTime?F(c.document.createTime):b.min(),h=new Qi({mapValue:{fields:c.document.fields}}),u=k.newFoundDocument(i,o,u,h),h=c.targetIds||[],c=c.removedTargetIds||[];n=new Ro(h,c,u.key,u)}else if("documentDelete"in t)t.documentDelete,(h=t.documentDelete).document,c=Ho(e,h.document),u=h.readTime?F(h.readTime):b.min(),u=k.newNoDocument(c,u),h=h.removedTargetIds||[],n=new Ro([],h,u.key,u);else if("documentRemove"in t){t.documentRemove;(d=t.documentRemove).document;var l=Ho(e,d.document),d=d.removedTargetIds||[];n=new Ro([],d,l,null)}else{if(!("filter"in t))return E();{t.filter;const e=t.filter;e.targetId;var{count:d=0,unchangedNames:l}=e,d=new bo(d,l),l=e.targetId;n=new Mo(l,d)}}var f;return n}(this.serializer,e),e=function(e){if(!("targetChange"in e))return b.min();e=e.targetChange;return e.targetIds&&e.targetIds.length||!e.readTime?b.min():F(e.readTime)}(e);return this.listener.a_(t,e)}u_(e){const t={};t.database=Jo(this.serializer),t.addTarget=function(e,t){let n;const r=t.target;if((n=pa(r)?{documents:su(e,r)}:{query:iu(e,r)}).targetId=t.targetId,0<t.resumeToken.approximateByteSize()){n.resumeToken=Ko(e,t.resumeToken);const r=Go(e,t.expectedCount);null!==r&&(n.expectedCount=r)}else if(0<t.snapshotVersion.compareTo(b.min())){n.readTime=jo(e,t.snapshotVersion.toTimestamp());const r=Go(e,t.expectedCount);null!==r&&(n.expectedCount=r)}return n}(this.serializer,e);this.serializer;var n=null==(n=function(){switch(e.purpose){case"TargetPurposeListen":return null;case"TargetPurposeExistenceFilterMismatch":return"existence-filter-mismatch";case"TargetPurposeExistenceFilterMismatchBloom":return"existence-filter-mismatch-bloom";case"TargetPurposeLimboResolution":return"limbo-document";default:return E()}}())?null:{"goog-listen-tags":n};n&&(t.labels=n),this.e_(t)}c_(e){const t={};t.database=Jo(this.serializer),t.removeTarget=e,this.e_(t)}}class Rc extends Nc{constructor(e,t,n,r,s,i){super(e,"write_stream_connection_backoff","write_stream_idle","health_check_timeout",t,n,r,i),this.serializer=s,this.l_=!1}get h_(){return this.l_}start(){this.l_=!1,this.lastStreamToken=void 0,super.start()}r_(){this.l_&&this.P_([])}__(e,t){return this.connection.vo("Write",e,t)}onMessage(e){var t,n,r;return y(!!e.streamToken),this.lastStreamToken=e.streamToken,this.l_?(this.zo.reset(),n=e.writeResults,r=e.commitTime,n=n&&0<n.length?(y(void 0!==r),n.map(t=>{{var n=r;let e=t.updateTime?F(t.updateTime):F(n);return e.isEqual(b.min())&&(e=F(n)),new so(e,t.transformResults||[])}})):[],t=F(e.commitTime),this.listener.I_(t,n)):(y(!e.writeResults||0===e.writeResults.length),this.l_=!0,this.listener.T_())}E_(){const e={};e.database=Jo(this.serializer),this.e_(e)}P_(e){e={streamToken:this.lastStreamToken,writes:e.map(e=>nu(this.serializer,e))};this.e_(e)}}class Mc extends class{}{constructor(e,t,n,r){super(),this.authCredentials=e,this.appCheckCredentials=t,this.connection=n,this.serializer=r,this.d_=!1}A_(){if(this.d_)throw new _(w.FAILED_PRECONDITION,"The client has already been terminated.")}wo(n,r,s){return this.A_(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then(([e,t])=>this.connection.wo(n,r,s,e,t)).catch(e=>{throw"FirebaseError"===e.name?(e.code===w.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),e):new _(w.UNKNOWN,e.toString())})}Co(n,r,s,i){return this.A_(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then(([e,t])=>this.connection.Co(n,r,s,e,t,i)).catch(e=>{throw"FirebaseError"===e.name?(e.code===w.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),e):new _(w.UNKNOWN,e.toString())})}terminate(){this.d_=!0}}class Lc{constructor(e,t){this.asyncQueue=e,this.onlineStateHandler=t,this.state="Unknown",this.V_=0,this.m_=null,this.f_=!0}g_(){0===this.V_&&(this.p_("Unknown"),this.m_=this.asyncQueue.enqueueAfterDelay("online_state_timeout",1e4,()=>(this.m_=null,this.y_("Backend didn't respond within 10 seconds."),this.p_("Offline"),Promise.resolve())))}w_(e){"Online"===this.state?this.p_("Unknown"):(this.V_++,1<=this.V_&&(this.S_(),this.y_("Connection failed 1 times. Most recent error: "+e.toString()),this.p_("Offline")))}set(e){this.S_(),this.V_=0,"Online"===e&&(this.f_=!1),this.p_(e)}p_(e){e!==this.state&&(this.state=e,this.onlineStateHandler(e))}y_(e){e=`Could not reach Cloud Firestore backend. ${e}
This typically indicates that your device does not have a healthy Internet connection at the moment. The client will operate in offline mode until it is able to successfully connect to the backend.`;this.f_?(d(e),this.f_=!1):m("OnlineStateTracker",e)}S_(){null!==this.m_&&(this.m_.cancel(),this.m_=null)}}class Oc{constructor(e,t,n,r,s){this.localStore=e,this.datastore=t,this.asyncQueue=n,this.remoteSyncer={},this.b_=[],this.D_=new Map,this.C_=new Set,this.v_=[],this.F_=s,this.F_.ro(e=>{n.enqueueAndForget(async()=>{if(jc(this)){m("RemoteStore","Restarting streams for network reachability change.");{var e;const t=this;t.C_.add(4),await Pc(t),t.M_.set("Unknown"),t.C_.delete(4),await Fc(t)}}})}),this.M_=new Lc(n,r)}}async function Fc(e){if(jc(e))for(const t of e.v_)await t(!0)}async function Pc(e){for(const t of e.v_)await t(!1)}function Vc(e,t){const n=e;n.D_.has(t.targetId)||(n.D_.set(t.targetId,t),Gc(n)?zc(n):Zc(n).Ho()&&qc(n,t))}function Bc(e,t){const n=e,r=Zc(n);n.D_.delete(t),r.Ho()&&Uc(n,t),0===n.D_.size&&(r.Ho()?r.Zo():jc(n)&&n.M_.set("Unknown"))}function qc(e,t){var n;e.x_.Oe(t.targetId),(0<t.resumeToken.approximateByteSize()||0<t.snapshotVersion.compareTo(b.min()))&&(n=e.remoteSyncer.getRemoteKeysForTarget(t.targetId).size,t=t.withExpectedCount(n)),Zc(e).u_(t)}function Uc(e,t){e.x_.Oe(t),Zc(e).c_(t)}function zc(t){t.x_=new Fo({getRemoteKeysForTarget:e=>t.remoteSyncer.getRemoteKeysForTarget(e),_t:e=>t.D_.get(e)||null,nt:()=>t.datastore.serializer.databaseId}),Zc(t).start(),t.M_.g_()}function Gc(e){return jc(e)&&!Zc(e).jo()&&0<e.D_.size}function jc(e){return 0===e.C_.size}function Kc(e){e.x_=void 0}async function Qc(e,t,n){if(!Ss(t))throw t;e.C_.add(1),await Pc(e),e.M_.set("Offline"),n=n||(()=>ec(e.localStore)),e.asyncQueue.enqueueRetryable(async()=>{m("RemoteStore","Retrying IndexedDB access"),await n(),e.C_.delete(1),await Fc(e)})}function $c(t,n){return n().catch(e=>Qc(t,e,n))}async function Wc(e){const t=e,n=el(t);let r=0<t.b_.length?t.b_[t.b_.length-1].batchId:-1;for(;jc(a=t)&&a.b_.length<10;)try{const e=await function(e,t){const n=e;return n.persistence.runTransaction("Get next mutation batch","readonly",e=>(void 0===t&&(t=-1),n.mutationQueue.getNextMutationBatchAfterBatchId(e,t)))}(t.localStore,r);if(null===e){0===t.b_.length&&n.Zo();break}r=e.batchId;{var s=t;var i=e;s.b_.push(i);const o=el(s);o.Ho()&&o.h_&&o.P_(i.mutations)}}catch(e){await Qc(t,e)}var a;Hc(t)&&Yc(t)}function Hc(e){return jc(e)&&!el(e).jo()&&0<e.b_.length}function Yc(e){el(e).start()}async function Xc(e,t){const n=e;n.asyncQueue.verifyOperationInProgress(),m("RemoteStore","RemoteStore received new credentials");e=jc(n);n.C_.add(3),await Pc(n),e&&n.M_.set("Unknown"),await n.remoteSyncer.handleCredentialChange(t),n.C_.delete(3),await Fc(n)}async function Jc(e,t){const n=e;t?(n.C_.delete(2),await Fc(n)):(n.C_.add(2),await Pc(n),n.M_.set("Unknown"))}function Zc(t){return t.O_||(t.O_=function(e,t,n){const r=e;return r.A_(),new kc(t,r.connection,r.authCredentials,r.appCheckCredentials,r.serializer,n)}(t.datastore,t.asyncQueue,{ho:async function(n){n.D_.forEach((e,t)=>{qc(n,e)})}.bind(null,t),Io:async function(e,t){Kc(e),Gc(e)?(e.M_.w_(t),zc(e)):e.M_.set("Unknown")}.bind(null,t),a_:async function(e,t,n){if(e.M_.set("Online"),t instanceof Lo&&2===t.state&&t.cause)try{var r=e,s=t.cause;for(const o of t.targetIds)r.D_.has(o)&&(await r.remoteSyncer.rejectListen(o,s),r.D_.delete(o),r.x_.removeTarget(o))}catch(n){m("RemoteStore","Failed to remove targets %s: %s ",t.targetIds.join(","),n),await Qc(e,n)}else if(t instanceof Ro?e.x_.$e(t):t instanceof Mo?e.x_.Je(t):e.x_.Ge(t),!n.isEqual(b.min()))try{const t=await ec(e.localStore);if(0<=n.compareTo(t)){var i=e,a=n;const u=i.x_.it(a);void await(u.targetChanges.forEach((e,t)=>{if(0<e.resumeToken.approximateByteSize()){const n=i.D_.get(t);n&&i.D_.set(t,n.withResumeToken(e.resumeToken,a))}}),u.targetMismatches.forEach((e,t)=>{const n=i.D_.get(e);n&&(i.D_.set(e,n.withResumeToken(wi.EMPTY_BYTE_STRING,n.snapshotVersion)),Uc(i,e),e=new cu(n.target,e,t,n.sequenceNumber),qc(i,e))}),i.remoteSyncer.applyRemoteEvent(u))}}catch(t){m("RemoteStore","Failed to raise snapshot:",t),await Qc(e,t)}}.bind(null,t)}),t.v_.push(async e=>{e?(t.O_.Yo(),Gc(t)?zc(t):t.M_.set("Unknown")):(await t.O_.stop(),Kc(t))})),t.O_}function el(t){return t.N_||(t.N_=function(e,t,n){const r=e;return r.A_(),new Rc(t,r.connection,r.authCredentials,r.appCheckCredentials,r.serializer,n)}(t.datastore,t.asyncQueue,{ho:async function(e){el(e).E_()}.bind(null,t),Io:async function(e,t){if(t&&el(e).h_){var n=e,r=t;if(Io(t=r.code)&&t!==w.ABORTED){const s=n.b_.shift();el(n).Yo(),await $c(n,()=>n.remoteSyncer.rejectFailedWrite(s.batchId,r)),await Wc(n)}await 0}Hc(e)&&Yc(e)}.bind(null,t),T_:async function(e){const t=el(e);for(const n of e.b_)t.P_(n.mutations)}.bind(null,t),I_:async function(e,t,n){const r=e.b_.shift(),s=wo.from(r,t,n);await $c(e,()=>e.remoteSyncer.applySuccessfulWrite(s)),await Wc(e)}.bind(null,t)}),t.v_.push(async e=>{e?(t.N_.Yo(),await Wc(t)):(await t.N_.stop(),0<t.b_.length&&(m("RemoteStore",`Stopping write stream with ${t.b_.length} pending writes`),t.b_=[]))})),t.N_}class tl{constructor(e,t,n,r,s){this.asyncQueue=e,this.timerId=t,this.targetTimeMs=n,this.op=r,this.removalCallback=s,this.deferred=new Hr,this.then=this.deferred.promise.then.bind(this.deferred.promise),this.deferred.promise.catch(e=>{})}get promise(){return this.deferred.promise}static createAndSchedule(e,t,n,r,s){const i=Date.now()+n,a=new tl(e,t,i,r,s);return a.start(n),a}start(e){this.timerHandle=setTimeout(()=>this.handleDelayElapsed(),e)}skipDelay(){return this.handleDelayElapsed()}cancel(e){null!==this.timerHandle&&(this.clearTimeout(),this.deferred.reject(new _(w.CANCELLED,"Operation cancelled"+(e?": "+e:""))))}handleDelayElapsed(){this.asyncQueue.enqueueAndForget(()=>null!==this.timerHandle?(this.clearTimeout(),this.op().then(e=>this.deferred.resolve(e))):Promise.resolve())}clearTimeout(){null!==this.timerHandle&&(this.removalCallback(this),clearTimeout(this.timerHandle),this.timerHandle=null)}}function nl(e,t){if(d("AsyncQueue",t+": "+e),Ss(e))return new _(w.UNAVAILABLE,t+": "+e);throw e}class rl{constructor(n){this.comparator=n?(e,t)=>n(e,t)||S.comparator(e.key,t.key):(e,t)=>S.comparator(e.key,t.key),this.keyedMap=Va(),this.sortedSet=new C(this.comparator)}static emptySet(e){return new rl(e.comparator)}has(e){return null!=this.keyedMap.get(e)}get(e){return this.keyedMap.get(e)}first(){return this.sortedSet.minKey()}last(){return this.sortedSet.maxKey()}isEmpty(){return this.sortedSet.isEmpty()}indexOf(e){e=this.keyedMap.get(e);return e?this.sortedSet.indexOf(e):-1}get size(){return this.sortedSet.size}forEach(n){this.sortedSet.inorderTraversal((e,t)=>(n(e),!1))}add(e){const t=this.delete(e.key);return t.copy(t.keyedMap.insert(e.key,e),t.sortedSet.insert(e,null))}delete(e){var t=this.get(e);return t?this.copy(this.keyedMap.remove(e),this.sortedSet.remove(t)):this}isEqual(e){if(!(e instanceof rl))return!1;if(this.size!==e.size)return!1;const t=this.sortedSet.getIterator(),n=e.sortedSet.getIterator();for(;t.hasNext();){const e=t.getNext().key,r=n.getNext().key;if(!e.isEqual(r))return!1}return!0}toString(){const t=[];return this.forEach(e=>{t.push(e.toString())}),0===t.length?"DocumentSet ()":"DocumentSet (\n  "+t.join("  \n")+"\n)"}copy(e,t){const n=new rl;return n.comparator=this.comparator,n.keyedMap=e,n.sortedSet=t,n}}class sl{constructor(){this.B_=new C(S.comparator)}track(e){var t=e.doc.key,n=this.B_.get(t);!n||0!==e.type&&3===n.type?this.B_=this.B_.insert(t,e):3===e.type&&1!==n.type?this.B_=this.B_.insert(t,{type:n.type,doc:e.doc}):2===e.type&&2===n.type?this.B_=this.B_.insert(t,{type:2,doc:e.doc}):2===e.type&&0===n.type?this.B_=this.B_.insert(t,{type:0,doc:e.doc}):1===e.type&&0===n.type?this.B_=this.B_.remove(t):1===e.type&&2===n.type?this.B_=this.B_.insert(t,{type:1,doc:n.doc}):0===e.type&&1===n.type?this.B_=this.B_.insert(t,{type:2,doc:e.doc}):E()}L_(){const n=[];return this.B_.inorderTraversal((e,t)=>{n.push(t)}),n}}class il{constructor(e,t,n,r,s,i,a,o,u){this.query=e,this.docs=t,this.oldDocs=n,this.docChanges=r,this.mutatedKeys=s,this.fromCache=i,this.syncStateChanged=a,this.excludesMetadataChanges=o,this.hasCachedResults=u}static fromInitialDocuments(e,t,n,r,s){const i=[];return t.forEach(e=>{i.push({type:0,doc:e})}),new il(e,t,rl.emptySet(t),i,n,r,!0,!1,s)}get hasPendingWrites(){return!this.mutatedKeys.isEmpty()}isEqual(e){if(!(this.fromCache===e.fromCache&&this.hasCachedResults===e.hasCachedResults&&this.syncStateChanged===e.syncStateChanged&&this.mutatedKeys.isEqual(e.mutatedKeys)&&Aa(this.query,e.query)&&this.docs.isEqual(e.docs)&&this.oldDocs.isEqual(e.oldDocs)))return!1;const t=this.docChanges,n=e.docChanges;if(t.length!==n.length)return!1;for(let e=0;e<t.length;e++)if(t[e].type!==n[e].type||!t[e].doc.isEqual(n[e].doc))return!1;return!0}}class al{constructor(){this.k_=void 0,this.listeners=[]}}class ol{constructor(){this.queries=new Oa(e=>Na(e),Aa),this.onlineState="Unknown",this.q_=new Set}}async function ul(e,t){const n=e,r=t.query;let s=!1,i=n.queries.get(r);if(i||(s=!0,i=new al),s)try{i.k_=await n.onListen(r)}catch(e){const n=nl(e,`Initialization of query '${ka(t.query)}' failed`);return void t.onError(n)}n.queries.set(r,i),i.listeners.push(t),t.Q_(n.onlineState),i.k_&&t.K_(i.k_)&&cl(n)}async function hl(e,t){const n=e,r=t.query;let s=!1;const i=n.queries.get(r);if(i){const e=i.listeners.indexOf(t);0<=e&&(i.listeners.splice(e,1),s=0===i.listeners.length)}if(s)return n.queries.delete(r),n.onUnlisten(r)}function cl(e){e.q_.forEach(e=>{e.next()})}class ll{constructor(e,t,n){this.query=e,this.U_=t,this.W_=!1,this.G_=null,this.onlineState="Unknown",this.options=n||{}}K_(e){if(!this.options.includeMetadataChanges){const t=[];for(const n of e.docChanges)3!==n.type&&t.push(n);e=new il(e.query,e.docs,e.oldDocs,t,e.mutatedKeys,e.fromCache,e.syncStateChanged,!0,e.hasCachedResults)}let t=!1;return this.W_?this.z_(e)&&(this.U_.next(e),t=!0):this.j_(e,this.onlineState)&&(this.H_(e),t=!0),this.G_=e,t}onError(e){this.U_.error(e)}Q_(e){this.onlineState=e;let t=!1;return this.G_&&!this.W_&&this.j_(this.G_,e)&&(this.H_(this.G_),t=!0),t}j_(e,t){return!e.fromCache||(!this.options.J_||!("Offline"!==t))&&(!e.docs.isEmpty()||e.hasCachedResults||"Offline"===t)}z_(e){if(0<e.docChanges.length)return!0;var t=this.G_&&this.G_.hasPendingWrites!==e.hasPendingWrites;return!(!e.syncStateChanged&&!t)&&!0===this.options.includeMetadataChanges}H_(e){e=il.fromInitialDocuments(e.query,e.docs,e.mutatedKeys,e.fromCache,e.hasCachedResults),this.W_=!0,this.U_.next(e)}}class dl{constructor(e,t){this.Y_=e,this.byteLength=t}Z_(){return"metadata"in this.Y_}}class fl{constructor(e){this.serializer=e}hs(e){return Ho(this.serializer,e)}Ps(e){return e.metadata.exists?tu(this.serializer,e.document,!1):k.newNoDocument(this.hs(e.metadata.name),this.Is(e.metadata.readTime))}Is(e){return F(e)}}class gl{constructor(e,t,n){this.X_=e,this.localStore=t,this.serializer=n,this.queries=[],this.documents=[],this.collectionGroups=new Set,this.progress=ml(e)}ea(e){this.progress.bytesLoaded+=e.byteLength;let t=this.progress.documentsLoaded;if(e.Y_.namedQuery)this.queries.push(e.Y_.namedQuery);else if(e.Y_.documentMetadata){this.documents.push({metadata:e.Y_.documentMetadata}),e.Y_.documentMetadata.exists||++t;const n=I.fromString(e.Y_.documentMetadata.name);this.collectionGroups.add(n.get(n.length-2))}else e.Y_.document&&(this.documents[this.documents.length-1].document=e.Y_.document,++t);return t!==this.progress.documentsLoaded?(this.progress.documentsLoaded=t,Object.assign({},this.progress)):null}ta(e){const t=new Map,n=new fl(this.serializer);for(const s of e)if(s.metadata.queries){const e=n.hs(s.metadata.name);for(const n of s.metadata.queries){var r=(t.get(n)||L()).add(e);t.set(n,r)}}return t}async complete(){const e=await async function(e,t,n,r){const s=e;let i=L(),a=Fa;for(const e of n){const n=t.hs(e.metadata.name),h=(e.document&&(i=i.add(n)),t.Ps(e));h.setReadTime(t.Is(e.metadata.readTime)),a=a.insert(n,h)}const o=s.ss.newChangeBuffer({trackRemovals:!0}),u=await nc(s,xa(Ia(I.fromString("__bundle__/docs/"+r))));return s.persistence.runTransaction("Apply bundle documents","readwrite",t=>tc(t,o,a).next(e=>(o.apply(t),e)).next(e=>s.qr.removeMatchingKeysForTargetId(t,u.targetId).next(()=>s.qr.addMatchingKeys(t,i,u.targetId)).next(()=>s.localDocuments.getLocalViewOfDocuments(t,e.us,e.cs)).next(()=>e.us)))}(this.localStore,new fl(this.serializer),this.documents,this.X_.id),t=this.ta(this.documents);for(const e of this.queries)await async function(e,n,r=L()){const s=await nc(e,xa(wu(n.bundledQuery))),i=e;return i.persistence.runTransaction("Save named query","readwrite",e=>{var t=F(n.readTime);return 0<=s.snapshotVersion.compareTo(t)?i.Kr.saveNamedQuery(e,n):(t=s.withResumeToken(wi.EMPTY_BYTE_STRING,t),i.ts=i.ts.insert(t.targetId,t),i.qr.updateTargetData(e,t).next(()=>i.qr.removeMatchingKeysForTargetId(e,s.targetId)).next(()=>i.qr.addMatchingKeys(e,r,s.targetId)).next(()=>i.Kr.saveNamedQuery(e,n)))})}(this.localStore,e,t.get(e.name));return this.progress.taskState="Success",{progress:this.progress,na:this.collectionGroups,ra:e}}}function ml(e){return{taskState:"Running",documentsLoaded:0,bytesLoaded:0,totalDocuments:e.totalDocuments,totalBytes:e.totalBytes}}class pl{constructor(e){this.key=e}}class yl{constructor(e){this.key=e}}class vl{constructor(e,t){this.query=e,this.ia=t,this.sa=null,this.hasCachedResults=!1,this.current=!1,this.oa=L(),this.mutatedKeys=L(),this._a=La(e),this.aa=new rl(this._a)}get ua(){return this.ia}ca(e,t){const o=t?t.la:new sl,u=(t||this).aa;let h=(t||this).mutatedKeys,c=u,l=!1;const d="F"===this.query.limitType&&u.size===this.query.limit?u.last():null,f="L"===this.query.limitType&&u.size===this.query.limit?u.first():null;if(e.inorderTraversal((e,t)=>{const n=u.get(e),r=Ra(this.query,t)?t:null,s=!!n&&this.mutatedKeys.has(n.key),i=!!r&&(r.hasLocalMutations||this.mutatedKeys.has(r.key)&&r.hasCommittedMutations);let a=!1;n&&r?n.data.isEqual(r.data)?s!==i&&(o.track({type:3,doc:r}),a=!0):this.ha(n,r)||(o.track({type:2,doc:r}),a=!0,(d&&0<this._a(r,d)||f&&this._a(r,f)<0)&&(l=!0)):!n&&r?(o.track({type:0,doc:r}),a=!0):n&&!r&&(o.track({type:1,doc:n}),a=!0,(d||f)&&(l=!0)),a&&(h=r?(c=c.add(r),i?h.add(e):h.delete(e)):(c=c.delete(e),h.delete(e)))}),null!==this.query.limit)for(;c.size>this.query.limit;){const e="F"===this.query.limitType?c.last():c.first();c=c.delete(e.key),h=h.delete(e.key),o.track({type:1,doc:e})}return{aa:c,la:o,Zi:l,mutatedKeys:h}}ha(e,t){return e.hasLocalMutations&&t.hasCommittedMutations&&!t.hasLocalMutations}applyChanges(e,t,n){var r=this.aa;this.aa=e.aa,this.mutatedKeys=e.mutatedKeys;const s=e.la.L_();s.sort((e,t)=>function(e,t){var n=e=>{switch(e){case 0:return 1;case 2:case 3:return 2;case 1:return 0;default:return E()}};return n(e)-n(t)}(e.type,t.type)||this._a(e.doc,t.doc)),this.Pa(n);var t=t?this.Ia():[],i=0===this.oa.size&&this.current?1:0,a=i!==this.sa;return this.sa=i,0!==s.length||a?{snapshot:new il(this.query,e.aa,r,s,e.mutatedKeys,0==i,a,!1,!!n&&0<n.resumeToken.approximateByteSize()),Ta:t}:{Ta:t}}Q_(e){return this.current&&"Offline"===e?(this.current=!1,this.applyChanges({aa:this.aa,la:new sl,mutatedKeys:this.mutatedKeys,Zi:!1},!1)):{Ta:[]}}Ea(e){return!this.ia.has(e)&&!!this.aa.has(e)&&!this.aa.get(e).hasLocalMutations}Pa(e){e&&(e.addedDocuments.forEach(e=>this.ia=this.ia.add(e)),e.modifiedDocuments.forEach(e=>{}),e.removedDocuments.forEach(e=>this.ia=this.ia.delete(e)),this.current=e.current)}Ia(){if(!this.current)return[];const t=this.oa,n=(this.oa=L(),this.aa.forEach(e=>{this.Ea(e.key)&&(this.oa=this.oa.add(e.key))}),[]);return t.forEach(e=>{this.oa.has(e)||n.push(new yl(e))}),this.oa.forEach(e=>{t.has(e)||n.push(new pl(e))}),n}da(e){this.ia=e.ls,this.oa=L();e=this.ca(e.documents);return this.applyChanges(e,!0)}Aa(){return il.fromInitialDocuments(this.query,this.aa,this.mutatedKeys,0===this.sa,this.hasCachedResults)}}class wl{constructor(e,t,n){this.query=e,this.targetId=t,this.view=n}}class _l{constructor(e){this.key=e,this.Ra=!1}}class bl{constructor(e,t,n,r,s,i){this.localStore=e,this.remoteStore=t,this.eventManager=n,this.sharedClientState=r,this.currentUser=s,this.maxConcurrentLimboResolutions=i,this.Va={},this.ma=new Oa(e=>Na(e),Aa),this.fa=new Map,this.ga=new Set,this.pa=new C(S.comparator),this.ya=new Map,this.wa=new Rh,this.Sa={},this.ba=new Map,this.Da=uh.Nn(),this.onlineState="Unknown",this.Ca=void 0}get isPrimaryClient(){return!0===this.Ca}}async function Il(n,e,t,r,s){n.va=(e,s,t)=>async function(e,t,n){let r=t.view.ca(s);r.Zi&&(r=await sc(e.localStore,t.query,!1).then(({documents:e})=>t.view.ca(e,r)));n=n&&n.targetChanges.get(t.targetId),n=t.view.applyChanges(r,e.isPrimaryClient,n);return Al(e,t.targetId,n.Ta),n.snapshot}(n,e,t);const i=await sc(n.localStore,e,!0),a=new vl(e,i.ls),o=a.ca(i.documents),u=ko.createSynthesizedTargetChangeForCurrentChange(t,r&&"Offline"!==n.onlineState,s),h=a.applyChanges(o,n.isPrimaryClient,u);Al(n,t,h.Ta);r=new wl(e,t,a);return n.ma.set(e,r),n.fa.has(t)?n.fa.get(t).push(e):n.fa.set(t,[e]),h.snapshot}async function El(e,t){const r=e;try{const e=await function(e,h){const c=e,l=h.snapshotVersion;let d=c.ts;return c.persistence.runTransaction("Apply remote event","readwrite-primary",o=>{const e=c.ss.newChangeBuffer({trackRemovals:!0}),u=(d=c.ts,[]);h.targetChanges.forEach((t,n)=>{const r=d.get(n);if(r){u.push(c.qr.removeMatchingKeys(o,t.removedDocuments,n).next(()=>c.qr.addMatchingKeys(o,t.addedDocuments,n)));let e=r.withSequenceNumber(o.currentSequenceNumber);var s,i,a;null!==h.targetMismatches.get(n)?e=e.withResumeToken(wi.EMPTY_BYTE_STRING,b.min()).withLastLimboFreeSnapshotVersion(b.min()):0<t.resumeToken.approximateByteSize()&&(e=e.withResumeToken(t.resumeToken,l)),d=d.insert(n,e),s=r,i=e,a=t,0!==s.resumeToken.approximateByteSize()&&!(3e8<=i.snapshotVersion.toMicroseconds()-s.snapshotVersion.toMicroseconds()||0<a.addedDocuments.size+a.modifiedDocuments.size+a.removedDocuments.size)||u.push(c.qr.updateTargetData(o,e))}});let t=Fa,n=L();if(h.documentUpdates.forEach(e=>{h.resolvedLimboDocuments.has(e)&&u.push(c.persistence.referenceDelegate.updateLimboDocument(o,e))}),u.push(tc(o,e,h.documentUpdates).next(e=>{t=e.us,n=e.cs})),!l.isEqual(b.min())){const h=c.qr.getLastRemoteSnapshotVersion(o).next(e=>c.qr.setTargetsMetadata(o,o.currentSequenceNumber,l));u.push(h)}return D.waitFor(u).next(()=>e.apply(o)).next(()=>c.localDocuments.getLocalViewOfDocuments(o,t,n)).next(()=>t)}).then(e=>(c.ts=d,e))}(r.localStore,t);t.targetChanges.forEach((e,t)=>{const n=r.ya.get(t);n&&(y(e.addedDocuments.size+e.modifiedDocuments.size+e.removedDocuments.size<=1),0<e.addedDocuments.size?n.Ra=!0:0<e.modifiedDocuments.size?y(n.Ra):0<e.removedDocuments.size&&(y(n.Ra),n.Ra=!1))}),await kl(r,e,t)}catch(e){await _s(e)}}function Tl(n,r,e){const t=n;if(t.isPrimaryClient&&0===e||!t.isPrimaryClient&&1===e){const n=[];t.ma.forEach((e,t)=>{t=t.view.Q_(r);t.snapshot&&n.push(t.snapshot)});{e=t.eventManager;var s=r;const i=e;i.onlineState=s;let n=!1;i.queries.forEach((e,t)=>{for(const e of t.listeners)e.Q_(s)&&(n=!0)}),n&&cl(i)}n.length&&t.Va.a_(n),t.onlineState=r,t.isPrimaryClient&&t.sharedClientState.setOnlineState(r)}}function Sl(e,t){(e.ba.get(t)||[]).forEach(e=>{e.resolve()}),e.ba.delete(t)}function xl(e,t,n){const r=e;let s=r.Sa[r.currentUser.toKey()];if(s){const e=s.get(t);e&&(n?e.reject(n):e.resolve(),s=s.remove(t)),r.Sa[r.currentUser.toKey()]=s}}function Dl(t,e,n=null){t.sharedClientState.removeLocalQueryTarget(e);for(const r of t.fa.get(e))t.ma.delete(r),n&&t.Va.Fa(r,n);t.fa.delete(e),t.isPrimaryClient&&t.wa.Rr(e).forEach(e=>{t.wa.containsKey(e)||Cl(t,e)})}function Cl(e,t){e.ga.delete(t.path.canonicalString());var n=e.pa.get(t);null!==n&&(Bc(e.remoteStore,n),e.pa=e.pa.remove(t),e.ya.delete(n),Nl(e))}function Al(e,t,n){for(const s of n)if(s instanceof pl){e.wa.addReference(s.key,t);{var r=e;const i=s.key,a=i.path.canonicalString();r.pa.get(i)||r.ga.has(a)||(m("SyncEngine","New document in limbo: "+i),r.ga.add(a),Nl(r))}}else s instanceof yl?(m("SyncEngine","Document no longer in limbo: "+s.key),e.wa.removeReference(s.key,t),e.wa.containsKey(s.key)||Cl(e,s.key)):E()}function Nl(e){for(;0<e.ga.size&&e.pa.size<e.maxConcurrentLimboResolutions;){var t=e.ga.values().next().value,n=(e.ga.delete(t),new S(I.fromString(t))),t=e.Da.next();e.ya.set(t,new _l(n)),e.pa=e.pa.insert(n,t),Vc(e.remoteStore,new cu(xa(Ia(n.path)),t,"TargetPurposeLimboResolution",Rs._e))}}async function kl(e,n,r){const s=e,i=[],a=[],o=[];if(!s.ma.isEmpty()){s.ma.forEach((e,t)=>{o.push(s.va(t,n,r).then(e=>{(e||r)&&s.isPrimaryClient&&s.sharedClientState.updateQueryState(t.targetId,null!=e&&e.fromCache?"not-current":"current"),e&&(i.push(e),e=Wh.Qi(t.targetId,e),a.push(e))}))}),await Promise.all(o),s.Va.a_(i);{var t=s.localStore,u=a;const h=t;try{await h.persistence.runTransaction("notifyLocalViewChanges","readwrite",n=>D.forEach(u,t=>D.forEach(t.ki,e=>h.persistence.referenceDelegate.addReference(n,t.targetId,e)).next(()=>D.forEach(t.qi,e=>h.persistence.referenceDelegate.removeReference(n,t.targetId,e)))))}catch(t){if(!Ss(t))throw t;m("LocalStore","Failed to update sequence numbers: "+t)}for(const t of u){const u=t.targetId;if(!t.fromCache){const t=h.ts.get(u),c=t.snapshotVersion,l=t.withLastLimboFreeSnapshotVersion(c);h.ts=h.ts.insert(u,l)}}}}}async function Rl(t,n){const r=t,s=[],i=[];for(const t of n){let e;var a=r.fa.get(t);if(a&&0!==a.length){e=await nc(r.localStore,xa(a[0]));for(const t of a){const n=r.ma.get(t),c=(o=n,0,h=await sc((u=r).localStore,o.query,!0),h=o.view.da(h),u.isPrimaryClient&&Al(u,o.targetId,h.Ta),await h);c.snapshot&&i.push(c.snapshot)}}else{a=await ic(r.localStore,t);e=await nc(r.localStore,a),await Il(r,Ml(a),t,!1,e.resumeToken)}s.push(e)}var o,u,h;return r.Va.a_(i),s}function Ml(e){return ba(e.path,e.collectionGroup,e.orderBy,e.filters,e.limit,"F",e.startAt,e.endAt)}function Ll(e){const t=e;return t.remoteStore.remoteSyncer.applyRemoteEvent=El.bind(null,t),t.remoteStore.remoteSyncer.getRemoteKeysForTarget=function(e,t){const n=e,r=n.ya.get(t);if(r&&r.Ra)return L().add(r.key);{let e=L();const r=n.fa.get(t);if(!r)return e;for(const t of r){const r=n.ma.get(t);e=e.unionWith(r.view.ua)}return e}}.bind(null,t),t.remoteStore.remoteSyncer.rejectListen=async function(e,t,n){const r=e,s=(r.sharedClientState.updateQueryState(t,"rejected",n),r.ya.get(t)),i=s&&s.key;if(i){let e=new C(S.comparator);e=e.insert(i,k.newNoDocument(i,b.min()));const n=L().add(i),s=new No(b.min(),new Map,new C(T),e,n);await El(r,s),r.pa=r.pa.remove(i),r.ya.delete(t),Nl(r)}else await rc(r.localStore,t,!1).then(()=>Dl(r,t,n)).catch(_s)}.bind(null,t),t.Va.a_=function(e,t){const n=e;let r=!1;for(const e of t){const t=e.query,s=n.queries.get(t);if(s){for(const t of s.listeners)t.K_(e)&&(r=!0);s.k_=e}}r&&cl(n)}.bind(null,t.eventManager),t.Va.Fa=function(e,t,n){const r=e,s=r.queries.get(t);if(s)for(const e of s.listeners)e.onError(n);r.queries.delete(t)}.bind(null,t.eventManager),t}function Ol(e){const t=e;return t.remoteStore.remoteSyncer.applySuccessfulWrite=async function(e,t){const n=e,r=t.batch.batchId;try{const e=await function(e,r){const s=e;return s.persistence.runTransaction("Acknowledge batch","readwrite-primary",e=>{const t=r.batch.keys(),n=s.ss.newChangeBuffer({trackRemovals:!0});return function(e,t,r,s){const i=r.batch,n=i.keys();let a=D.resolve();return n.forEach(n=>{a=a.next(()=>s.getEntry(t,n)).next(e=>{var t=r.docVersions.get(n);y(null!==t),e.version.compareTo(t)<0&&(i.applyToRemoteDocument(e,r),e.isValidDocument()&&(e.setReadTime(r.commitVersion),s.addEntry(e)))})}),a.next(()=>e.mutationQueue.removeMutationBatch(t,i))}(s,e,r,n).next(()=>n.apply(e)).next(()=>s.mutationQueue.performConsistencyCheck(e)).next(()=>s.documentOverlayCache.removeOverlaysForBatchId(e,t,r.batch.batchId)).next(()=>s.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(e,function(t){let n=L();for(let e=0;e<t.mutationResults.length;++e)0<t.mutationResults[e].transformResults.length&&(n=n.add(t.batch.mutations[e].key));return n}(r))).next(()=>s.localDocuments.getDocuments(e,t))})}(n.localStore,t);xl(n,r,null),Sl(n,r),n.sharedClientState.updateMutationState(r,"acknowledged"),await kl(n,e)}catch(e){await _s(e)}}.bind(null,t),t.remoteStore.remoteSyncer.rejectFailedWrite=async function(e,t,n){const r=e;try{const e=await function(e,r){const s=e;return s.persistence.runTransaction("Reject batch","readwrite-primary",t=>{let n;return s.mutationQueue.lookupMutationBatch(t,r).next(e=>(y(null!==e),n=e.keys(),s.mutationQueue.removeMutationBatch(t,e))).next(()=>s.mutationQueue.performConsistencyCheck(t)).next(()=>s.documentOverlayCache.removeOverlaysForBatchId(t,n,r)).next(()=>s.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(t,n)).next(()=>s.localDocuments.getDocuments(t,n))})}(r.localStore,t);xl(r,t,n),Sl(r,t),r.sharedClientState.updateMutationState(t,"rejected",n),await kl(r,e)}catch(n){await _s(n)}}.bind(null,t),t}class Fl{constructor(){this.synchronizeTabs=!1}async initialize(e){this.serializer=Cc(e.databaseInfo.databaseId),this.sharedClientState=this.createSharedClientState(e),this.persistence=this.createPersistence(e),await this.persistence.start(),this.localStore=this.createLocalStore(e),this.gcScheduler=this.createGarbageCollectionScheduler(e,this.localStore),this.indexBackfillerScheduler=this.createIndexBackfillerScheduler(e,this.localStore)}createGarbageCollectionScheduler(e,t){return null}createIndexBackfillerScheduler(e,t){return null}createLocalStore(e){return Jh(this.persistence,new Yh,e.initialUser,this.serializer)}createPersistence(e){return new Vh(qh.jr,this.serializer)}createSharedClientState(e){return new yc}async terminate(){this.gcScheduler&&this.gcScheduler.stop(),await this.sharedClientState.shutdown(),await this.persistence.shutdown()}}class Pl extends Fl{constructor(e,t,n){super(),this.xa=e,this.cacheSizeBytes=t,this.forceOwnership=n,this.synchronizeTabs=!1}async initialize(e){await super.initialize(e),await this.xa.initialize(this,e),await Ol(this.xa.syncEngine),await Wc(this.xa.remoteStore),await this.persistence.mi(()=>(this.gcScheduler&&!this.gcScheduler.started&&this.gcScheduler.start(),this.indexBackfillerScheduler&&!this.indexBackfillerScheduler.started&&this.indexBackfillerScheduler.start(),Promise.resolve()))}createLocalStore(e){return Jh(this.persistence,new Yh,e.initialUser,this.serializer)}createGarbageCollectionScheduler(e,t){var n=this.persistence.referenceDelegate.garbageCollector;return new mh(n,e.asyncQueue,t)}createIndexBackfillerScheduler(e,t){t=new ks(t,this.persistence);return new Ns(e.asyncQueue,t)}createPersistence(e){var t=$h(e.databaseInfo.databaseId,e.databaseInfo.persistenceKey),n=void 0!==this.cacheSizeBytes?eh.withCacheSize(this.cacheSizeBytes):eh.DEFAULT;return new jh(this.synchronizeTabs,t,e.clientId,n,e.asyncQueue,xc(),Dc(),this.serializer,this.sharedClientState,!!this.forceOwnership)}createSharedClientState(e){return new yc}}class Vl extends Pl{constructor(e,t){super(e,t,!1),this.xa=e,this.cacheSizeBytes=t,this.synchronizeTabs=!0}async initialize(e){await super.initialize(e);e=this.xa.syncEngine;this.sharedClientState instanceof pc&&(this.sharedClientState.syncEngine={Ys:async function(e,t,n,r){var s=await function(e,n){const r=e,s=r.mutationQueue;return r.persistence.runTransaction("Lookup mutation documents","readonly",t=>s.Cn(t,n).next(e=>e?r.localDocuments.getDocuments(t,e):D.resolve(null)))}(e.localStore,t);null!==s?("pending"===n?await Wc(e.remoteStore):"acknowledged"===n||"rejected"===n?(xl(e,t,r||null),Sl(e,t),e.localStore.mutationQueue.Fn(t)):E(),await kl(e,s)):m("SyncEngine","Cannot apply mutation batch with id: "+t)}.bind(null,e),Zs:async function(e,t,n,r){const s=e;if(s.Ca)m("SyncEngine","Ignoring unexpected query state notification.");else{var i=s.fa.get(t);if(i&&0<i.length)switch(n){case"current":case"not-current":{const e=await ac(s.localStore,Ma(i[0])),r=No.createSynthesizedRemoteEventForCurrentChange(t,"current"===n,wi.EMPTY_BYTE_STRING);await kl(s,e,r);break}case"rejected":await rc(s.localStore,t,!0),Dl(s,t,r);break;default:E()}}}.bind(null,e),Xs:async function(e,t,n){const r=Ll(e);if(r.Ca){for(const e of t)if(r.fa.has(e))m("SyncEngine","Adding an already active target "+e);else{const t=await ic(r.localStore,e),n=await nc(r.localStore,t);await Il(r,Ml(t),n.targetId,!1,n.resumeToken),Vc(r.remoteStore,n)}for(const e of n)r.fa.has(e)&&await rc(r.localStore,e,!1).then(()=>{Bc(r.remoteStore,e),Dl(r,e)}).catch(_s)}}.bind(null,e),Bi:function(e){return e.localStore.persistence.Bi()}.bind(null,e),Js:async function(e,t){const n=e;return ac(n.localStore,t).then(e=>kl(n,e))}.bind(null,e)},await this.sharedClientState.start()),await this.persistence.mi(async e=>{{var r=this.xa.syncEngine,t=e;const s=r;if(Ll(s),Ol(s),!0===t&&!0!==s.Ca){const r=s.sharedClientState.getAllActiveQueryTargets(),t=await Rl(s,r.toArray());s.Ca=!0,await Jc(s.remoteStore,!0);for(const r of t)Vc(s.remoteStore,r)}else if(!1===t&&!1!==s.Ca){const r=[];let n=Promise.resolve();s.fa.forEach((e,t)=>{s.sharedClientState.isLocalQueryTarget(t)?r.push(t):n=n.then(()=>(Dl(s,t),rc(s.localStore,t,!0))),Bc(s.remoteStore,t)}),await n,await Rl(s,r);{const i=s;i.ya.forEach((e,t)=>{Bc(i.remoteStore,t)}),i.wa.Vr(),i.ya=new Map,i.pa=new C(S.comparator)}s.Ca=!1,await Jc(s.remoteStore,!1)}}await 0,this.gcScheduler&&(e&&!this.gcScheduler.started?this.gcScheduler.start():e||this.gcScheduler.stop()),this.indexBackfillerScheduler&&(e&&!this.indexBackfillerScheduler.started?this.indexBackfillerScheduler.start():e||this.indexBackfillerScheduler.stop())})}createSharedClientState(e){var t=xc();if(!pc.D(t))throw new _(w.UNIMPLEMENTED,"IndexedDB persistence is only available on platforms that support LocalStorage.");var n=$h(e.databaseInfo.databaseId,e.databaseInfo.persistenceKey);return new pc(t,e.asyncQueue,n,e.clientId,e.initialUser)}}class Bl{async initialize(e,t){this.localStore||(this.localStore=e.localStore,this.sharedClientState=e.sharedClientState,this.datastore=this.createDatastore(t),this.remoteStore=this.createRemoteStore(t),this.eventManager=this.createEventManager(t),this.syncEngine=this.createSyncEngine(t,!e.synchronizeTabs),this.sharedClientState.onlineStateHandler=e=>Tl(this.syncEngine,e,1),this.remoteStore.remoteSyncer.handleCredentialChange=async function(e,t){const n=e;var r;n.currentUser.isEqual(t)||(m("SyncEngine","User change. New user:",t.toKey()),r=await Zh(n.localStore,t),n.currentUser=t,e=n,e.ba.forEach(e=>{e.forEach(e=>{e.reject(new _(w.CANCELLED,"'waitForPendingWrites' promise is rejected due to a user change."))})}),e.ba.clear(),n.sharedClientState.handleUserChange(t,r.removedBatchIds,r.addedBatchIds),await kl(n,r._s))}.bind(null,this.syncEngine),await Jc(this.remoteStore,this.syncEngine.isPrimaryClient))}createEventManager(e){return new ol}createDatastore(e){var t=Cc(e.databaseInfo.databaseId),n=(i=e.databaseInfo,new Sc(i)),r=e.authCredentials,s=e.appCheckCredentials,i=n;return e=t,new Mc(r,s,i,e)}createRemoteStore(e){return t=this.localStore,n=this.datastore,r=e.asyncQueue,s=e=>Tl(this.syncEngine,e,0),e=new(wc.D()?wc:vc),new Oc(t,n,r,s,e);var t,n,r,s}createSyncEngine(e,t){{var n=this.localStore,r=this.remoteStore,s=this.eventManager,i=this.sharedClientState,a=e.initialUser;e=e.maxConcurrentLimboResolutions;const o=new bl(n,r,s,i,a,e);return t&&(o.Ca=!0),o}}terminate(){return async function(e){const t=e;m("RemoteStore","RemoteStore shutting down."),t.C_.add(5),await Pc(t),t.F_.shutdown(),t.M_.set("Unknown")}(this.remoteStore)}}function ql(t,n=10240){let r=0;return{async read(){var e;return r<t.byteLength?(e={value:t.slice(r,r+n),done:!1},r+=n,e):{done:!0}},async cancel(){},releaseLock(){},closed:Promise.resolve()}}class Ul{constructor(e){this.observer=e,this.muted=!1}next(e){this.observer.next&&this.Oa(this.observer.next,e)}error(e){this.observer.error?this.Oa(this.observer.error,e):d("Uncaught Error in snapshot listener:",e.toString())}Na(){this.muted=!0}Oa(e,t){this.muted||setTimeout(()=>{this.muted||e(t)},0)}}class zl{constructor(e,t){this.Ba=e,this.serializer=t,this.metadata=new Hr,this.buffer=new Uint8Array,this.La=new TextDecoder("utf-8"),this.ka().then(e=>{e&&e.Z_()?this.metadata.resolve(e.Y_.metadata):this.metadata.reject(new Error(`The first element of the bundle is not a metadata, it is
             `+JSON.stringify(null==e?void 0:e.Y_)))},e=>this.metadata.reject(e))}close(){return this.Ba.cancel()}async getMetadata(){return this.metadata.promise}async Ma(){return await this.getMetadata(),this.ka()}async ka(){var e=await this.qa();if(null===e)return null;var t=this.La.decode(e),n=Number(t);return isNaN(n)&&this.Qa(`length string (${t}) is not valid number`),t=await this.Ka(n),new dl(JSON.parse(t),e.length+n)}$a(){return this.buffer.findIndex(e=>e==="{".charCodeAt(0))}async qa(){for(;this.$a()<0&&!await this.Ua(););if(0===this.buffer.length)return null;var e=this.$a(),t=(e<0&&this.Qa("Reached the end of bundle when a length string is expected."),this.buffer.slice(0,e));return this.buffer=this.buffer.slice(e),t}async Ka(e){for(;this.buffer.length<e;)await this.Ua()&&this.Qa("Reached the end of bundle when more is expected.");var t=this.La.decode(this.buffer.slice(0,e));return this.buffer=this.buffer.slice(e),t}Qa(e){throw this.Ba.cancel(),new Error("Invalid bundle format: "+e)}async Ua(){var e=await this.Ba.read();if(!e.done){const t=new Uint8Array(this.buffer.length+e.value.length);t.set(this.buffer),t.set(e.value,this.buffer.length),this.buffer=t}return e.done}}class Gl{constructor(e){this.datastore=e,this.readVersions=new Map,this.mutations=[],this.committed=!1,this.lastWriteError=null,this.writtenDocs=new Set}async lookup(e){if(this.ensureCommitNotCalled(),0<this.mutations.length)throw new _(w.INVALID_ARGUMENT,"Firestore transactions require all reads to be executed before all writes.");const t=await async function(e,t){const o=e,n=Jo(o.serializer)+"/documents",r={documents:t.map(e=>Wo(o.serializer,e))},s=await o.Co("BatchGetDocuments",n,r,t.length),u=new Map,i=(s.forEach(e=>{a=o.serializer;const t="found"in e?(n=a,y(!!(r=e).found),r.found.name,r.found.updateTime,n=Ho(n,r.found.name),s=F(r.found.updateTime),i=r.found.createTime?F(r.found.createTime):b.min(),r=new Qi({mapValue:{fields:r.found.fields}}),k.newFoundDocument(n,s,i,r)):"missing"in e?function(e,t){y(!!t.missing),y(!!t.readTime);e=Ho(e,t.missing),t=F(t.readTime);return k.newNoDocument(e,t)}(a,e):E();var n,r,s,i,a;u.set(t.key.toString(),t)}),[]);return t.forEach(e=>{e=u.get(e.toString());y(!!e),i.push(e)}),i}(this.datastore,e);return t.forEach(e=>this.recordVersion(e)),t}set(e,t){this.write(t.toMutation(e,this.precondition(e))),this.writtenDocs.add(e.toString())}update(e,t){try{this.write(t.toMutation(e,this.preconditionForUpdate(e)))}catch(e){this.lastWriteError=e}this.writtenDocs.add(e.toString())}delete(e){this.write(new po(e,this.precondition(e))),this.writtenDocs.add(e.toString())}async commit(){if(this.ensureCommitNotCalled(),this.lastWriteError)throw this.lastWriteError;const t=this.readVersions;this.mutations.forEach(e=>{t.delete(e.key.toString())}),t.forEach((e,t)=>{t=S.fromPath(t);this.mutations.push(new yo(t,this.precondition(t)))});{var e=this.datastore,n=this.mutations;const r=e,s=Jo(r.serializer)+"/documents",i={writes:n.map(e=>nu(r.serializer,e))};await r.wo("Commit",s,i)}await 0,this.committed=!0}recordVersion(e){let t;if(e.isFoundDocument())t=e.version;else{if(!e.isNoDocument())throw E();t=b.min()}var n=this.readVersions.get(e.key.toString());if(n){if(!t.isEqual(n))throw new _(w.ABORTED,"Document version changed between two reads.")}else this.readVersions.set(e.key.toString(),t)}precondition(e){const t=this.readVersions.get(e.toString());return!this.writtenDocs.has(e.toString())&&t?t.isEqual(b.min())?O.exists(!1):O.updateTime(t):O.none()}preconditionForUpdate(e){const t=this.readVersions.get(e.toString());if(this.writtenDocs.has(e.toString())||!t)return O.exists(!0);if(t.isEqual(b.min()))throw new _(w.INVALID_ARGUMENT,"Can't update a document that doesn't exist.");return O.updateTime(t)}write(e){this.ensureCommitNotCalled(),this.mutations.push(e)}ensureCommitNotCalled(){}}class jl{constructor(e,t,n,r,s){this.asyncQueue=e,this.datastore=t,this.options=n,this.updateFunction=r,this.deferred=s,this.Wa=n.maxAttempts,this.zo=new Ac(this.asyncQueue,"transaction_retry")}run(){--this.Wa,this.Ga()}Ga(){this.zo.ko(async()=>{const t=new Gl(this.datastore),e=this.za(t);e&&e.then(e=>{this.asyncQueue.enqueueAndForget(()=>t.commit().then(()=>{this.deferred.resolve(e)}).catch(e=>{this.ja(e)}))}).catch(e=>{this.ja(e)})})}za(e){try{var t=this.updateFunction(e);return!Ms(t)&&t.catch&&t.then?t:(this.deferred.reject(Error("Transaction callback must return a Promise")),null)}catch(e){return this.deferred.reject(e),null}}ja(e){0<this.Wa&&this.Ha(e)?(--this.Wa,this.asyncQueue.enqueueAndForget(()=>(this.Ga(),Promise.resolve()))):this.deferred.reject(e)}Ha(e){if("FirebaseError"!==e.name)return!1;e=e.code;return"aborted"===e||"failed-precondition"===e||"already-exists"===e||!Io(e)}}class Kl{constructor(e,t,n,r){this.authCredentials=e,this.appCheckCredentials=t,this.asyncQueue=n,this.databaseInfo=r,this.user=o.UNAUTHENTICATED,this.clientId=ss.newId(),this.authCredentialListener=()=>Promise.resolve(),this.appCheckCredentialListener=()=>Promise.resolve(),this.authCredentials.start(n,async e=>{m("FirestoreClient","Received user=",e.uid),await this.authCredentialListener(e),this.user=e}),this.appCheckCredentials.start(n,e=>(m("FirestoreClient","Received new app check token=",e),this.appCheckCredentialListener(e,this.user)))}async getConfiguration(){return{asyncQueue:this.asyncQueue,databaseInfo:this.databaseInfo,clientId:this.clientId,authCredentials:this.authCredentials,appCheckCredentials:this.appCheckCredentials,initialUser:this.user,maxConcurrentLimboResolutions:100}}setCredentialChangeListener(e){this.authCredentialListener=e}setAppCheckTokenChangeListener(e){this.appCheckCredentialListener=e}verifyNotTerminated(){if(this.asyncQueue.isShuttingDown)throw new _(w.FAILED_PRECONDITION,"The client has already been terminated.")}terminate(){this.asyncQueue.enterRestrictedMode();const n=new Hr;return this.asyncQueue.enqueueAndForgetEvenWhileRestricted(async()=>{try{this._onlineComponents&&await this._onlineComponents.terminate(),this._offlineComponents&&await this._offlineComponents.terminate(),this.authCredentials.shutdown(),this.appCheckCredentials.shutdown(),n.resolve()}catch(e){var t=nl(e,"Failed to shutdown persistence");n.reject(t)}}),n.promise}}async function Ql(e,t){e.asyncQueue.verifyOperationInProgress(),m("FirestoreClient","Initializing OfflineComponentProvider");var n=await e.getConfiguration();await t.initialize(n);let r=n.initialUser;e.setCredentialChangeListener(async e=>{r.isEqual(e)||(await Zh(t.localStore,e),r=e)}),t.persistence.setDatabaseDeletedListener(()=>e.terminate()),e._offlineComponents=t}async function $l(e,n){e.asyncQueue.verifyOperationInProgress();var t=await Hl(e),r=(m("FirestoreClient","Initializing OnlineComponentProvider"),await e.getConfiguration());await n.initialize(t,r),e.setCredentialChangeListener(e=>Xc(n.remoteStore,e)),e.setAppCheckTokenChangeListener((e,t)=>Xc(n.remoteStore,t)),e._onlineComponents=n}function Wl(e){return"FirebaseError"===e.name?e.code===w.FAILED_PRECONDITION||e.code===w.UNIMPLEMENTED:!("undefined"!=typeof DOMException&&e instanceof DOMException)||22===e.code||20===e.code||11===e.code}async function Hl(t){if(!t._offlineComponents)if(t._uninitializedComponentsProvider){m("FirestoreClient","Using user provided OfflineComponentProvider");try{await Ql(t,t._uninitializedComponentsProvider._offline)}catch(e){var n=e;if(!Wl(n))throw n;$r("Error using user provided cache. Falling back to memory cache: "+n),await Ql(t,new Fl)}}else m("FirestoreClient","Using default OfflineComponentProvider"),await Ql(t,new Fl);return t._offlineComponents}async function Yl(e){return e._onlineComponents||(e._uninitializedComponentsProvider?(m("FirestoreClient","Using user provided OnlineComponentProvider"),await $l(e,e._uninitializedComponentsProvider._online)):(m("FirestoreClient","Using default OnlineComponentProvider"),await $l(e,new Bl))),e._onlineComponents}function Xl(e){return Hl(e).then(e=>e.persistence)}function Jl(e){return Hl(e).then(e=>e.localStore)}function Zl(e){return Yl(e).then(e=>e.remoteStore)}function ed(e){return Yl(e).then(e=>e.syncEngine)}async function td(e){const t=await Yl(e),n=t.eventManager;return n.onListen=async function(e,t){const n=Ll(e);let r,s;const i=n.ma.get(t);if(i)r=i.targetId,n.sharedClientState.addLocalQueryTarget(r),s=i.view.Aa();else{const e=await nc(n.localStore,xa(t)),i=n.sharedClientState.addLocalQueryTarget(e.targetId);r=e.targetId,s=await Il(n,t,r,"current"===i,e.resumeToken),n.isPrimaryClient&&Vc(n.remoteStore,e)}return s}.bind(null,t.syncEngine),n.onUnlisten=async function(e,t){const n=e,r=n.ma.get(t),s=n.fa.get(r.targetId);if(1<s.length)return n.fa.set(r.targetId,s.filter(e=>!Aa(e,t))),void n.ma.delete(t);n.isPrimaryClient?(n.sharedClientState.removeLocalQueryTarget(r.targetId),n.sharedClientState.isActiveQueryTarget(r.targetId)||await rc(n.localStore,r.targetId,!1).then(()=>{n.sharedClientState.clearQueryState(r.targetId),Bc(n.remoteStore,r.targetId),Dl(n,r.targetId)}).catch(_s)):(Dl(n,r.targetId),await rc(n.localStore,r.targetId,!0))}.bind(null,t.syncEngine),n}function nd(t,u,h={}){const c=new Hr;return t.asyncQueue.enqueueAndForget(async()=>{{var n=await td(t),r=t.asyncQueue,s=u,i=h,a=c;const e=new Ul({next:e=>{r.enqueueAndForget(()=>hl(n,o));var t=e.docs.has(s);!t&&e.fromCache?a.reject(new _(w.UNAVAILABLE,"Failed to get document because the client is offline.")):t&&e.fromCache&&i&&"server"===i.source?a.reject(new _(w.UNAVAILABLE,'Failed to get document from server. (However, this document does exist in the local cache. Run again without setting source to "server" to retrieve the cached document.)')):a.resolve(e)},error:e=>a.reject(e)}),o=new ll(Ia(s.path),e,{includeMetadataChanges:!0,J_:!0});return ul(n,o)}}),c.promise}function rd(o,u,h={}){const c=new Hr;return o.asyncQueue.enqueueAndForget(async()=>{{var t=await td(o),n=o.asyncQueue,e=u,r=h,s=c;const i=new Ul({next:e=>{n.enqueueAndForget(()=>hl(t,a)),e.fromCache&&"server"===r.source?s.reject(new _(w.UNAVAILABLE,'Failed to get documents from server. (However, these documents may exist in the local cache. Run again without setting source to "server" to retrieve the cached documents.)')):s.resolve(e)},error:e=>s.reject(e)}),a=new ll(e,i,{includeMetadataChanges:!0,J_:!0});return ul(t,a)}}),c.promise}function sd(r,e,t,s){e=Cc(e),t=function(e){if(e instanceof Uint8Array)return ql(e,void 0);if(e instanceof ArrayBuffer)return ql(new Uint8Array(e),void 0);if(e instanceof ReadableStream)return e.getReader();throw new Error("Source of `toByteStreamReader` has to be a ArrayBuffer or ReadableStream")}("string"==typeof t?To().encode(t):t);const i=new zl(t,e);r.asyncQueue.enqueueAndForget(async()=>{{var e=await ed(r),t=i;const n=e;return void async function(t,n,r){try{var s=await n.getMetadata();if(await function(e,t){const n=e,r=F(t.createTime);return n.persistence.runTransaction("hasNewerBundle","readonly",e=>n.Kr.getBundleMetadata(e,t.id)).then(e=>!!e&&0<=e.createTime.compareTo(r))}(t.localStore,s))return await n.close(),r._completeWith({taskState:"Success",documentsLoaded:s.totalDocuments,bytesLoaded:s.totalBytes,totalDocuments:s.totalDocuments,totalBytes:s.totalBytes}),Promise.resolve(new Set);r._updateProgress(ml(s));const a=new gl(s,t.localStore,n.serializer);let e=await n.Ma();for(;e;){const t=await a.ea(e);t&&r._updateProgress(t),e=await n.Ma()}var i=await a.complete();return await kl(t,i.ra,void 0),await function(e,t){const n=e;return n.persistence.runTransaction("Save bundle","readwrite",e=>n.Kr.saveBundleMetadata(e,t))}(t.localStore,s),r._completeWith(i.progress),Promise.resolve(i.na)}catch(t){return $r("SyncEngine","Loading bundle failed with "+t),r._failWith(t),Promise.resolve(new Set)}}(n,t,s).then(e=>{n.sharedClientState.notifyBundleLoaded(e)})}})}function id(e){const t={};return void 0!==e.timeoutSeconds&&(t.timeoutSeconds=e.timeoutSeconds),t}const ad=new Map;function od(e,t,n){if(!n)throw new _(w.INVALID_ARGUMENT,`Function ${e}() cannot be called with an empty ${t}.`)}function ud(e,t,n,r){if(!0===t&&!0===r)throw new _(w.INVALID_ARGUMENT,e+` and ${n} cannot be used together.`)}function hd(e){if(!S.isDocumentKey(e))throw new _(w.INVALID_ARGUMENT,`Invalid document reference. Document references must have an even number of segments, but ${e} has ${e.length}.`)}function cd(e){if(S.isDocumentKey(e))throw new _(w.INVALID_ARGUMENT,`Invalid collection reference. Collection references must have an odd number of segments, but ${e} has ${e.length}.`)}function ld(e){if(void 0===e)return"undefined";if(null===e)return"null";if("string"==typeof e)return 20<e.length&&(e=e.substring(0,20)+"..."),JSON.stringify(e);if("number"==typeof e||"boolean"==typeof e)return""+e;if("object"!=typeof e)return"function"==typeof e?"a function":E();if(e instanceof Array)return"an array";e=e.constructor?e.constructor.name:null;return e?`a custom ${e} object`:"an object"}function P(e,t){if((e="_delegate"in e?e._delegate:e)instanceof t)return e;if(t.name===e.constructor.name)throw new _(w.INVALID_ARGUMENT,"Type does not match the expected instance. Did you pass a reference from a different Firestore SDK?");e=ld(e);throw new _(w.INVALID_ARGUMENT,`Expected type '${t.name}', but it was: `+e)}function dd(e,t){if(t<=0)throw new _(w.INVALID_ARGUMENT,`Function ${e}() requires a positive number, but it was: ${t}.`)}class fd{constructor(e){if(void 0===e.host){if(void 0!==e.ssl)throw new _(w.INVALID_ARGUMENT,"Can't provide ssl option if host option is not set");this.host="firestore.googleapis.com",this.ssl=!0}else this.host=e.host,this.ssl=null==(t=e.ssl)||t;if(this.credentials=e.credentials,this.ignoreUndefinedProperties=!!e.ignoreUndefinedProperties,this.localCache=e.localCache,void 0===e.cacheSizeBytes)this.cacheSizeBytes=41943040;else{if(-1!==e.cacheSizeBytes&&e.cacheSizeBytes<1048576)throw new _(w.INVALID_ARGUMENT,"cacheSizeBytes must be at least 1048576");this.cacheSizeBytes=e.cacheSizeBytes}ud("experimentalForceLongPolling",e.experimentalForceLongPolling,"experimentalAutoDetectLongPolling",e.experimentalAutoDetectLongPolling),this.experimentalForceLongPolling=!!e.experimentalForceLongPolling,this.experimentalForceLongPolling?this.experimentalAutoDetectLongPolling=!1:void 0===e.experimentalAutoDetectLongPolling?this.experimentalAutoDetectLongPolling=!0:this.experimentalAutoDetectLongPolling=!!e.experimentalAutoDetectLongPolling,this.experimentalLongPollingOptions=id(null!=(t=e.experimentalLongPollingOptions)?t:{});var t=this.experimentalLongPollingOptions;if(void 0!==t.timeoutSeconds){if(isNaN(t.timeoutSeconds))throw new _(w.INVALID_ARGUMENT,`invalid long polling timeout: ${t.timeoutSeconds} (must not be NaN)`);if(t.timeoutSeconds<5)throw new _(w.INVALID_ARGUMENT,`invalid long polling timeout: ${t.timeoutSeconds} (minimum allowed value is 5)`);if(30<t.timeoutSeconds)throw new _(w.INVALID_ARGUMENT,`invalid long polling timeout: ${t.timeoutSeconds} (maximum allowed value is 30)`)}this.useFetchStreams=!!e.useFetchStreams}isEqual(e){return this.host===e.host&&this.ssl===e.ssl&&this.credentials===e.credentials&&this.cacheSizeBytes===e.cacheSizeBytes&&this.experimentalForceLongPolling===e.experimentalForceLongPolling&&this.experimentalAutoDetectLongPolling===e.experimentalAutoDetectLongPolling&&(t=this.experimentalLongPollingOptions,n=e.experimentalLongPollingOptions,t.timeoutSeconds===n.timeoutSeconds)&&this.ignoreUndefinedProperties===e.ignoreUndefinedProperties&&this.useFetchStreams===e.useFetchStreams;var t,n}}class gd{constructor(e,t,n,r){this._authCredentials=e,this._appCheckCredentials=t,this._databaseId=n,this._app=r,this.type="firestore-lite",this._persistenceKey="(lite)",this._settings=new fd({}),this._settingsFrozen=!1}get app(){if(this._app)return this._app;throw new _(w.FAILED_PRECONDITION,"Firestore was not initialized using the Firebase SDK. 'app' is not available")}get _initialized(){return this._settingsFrozen}get _terminated(){return void 0!==this._terminateTask}_setSettings(e){if(this._settingsFrozen)throw new _(w.FAILED_PRECONDITION,"Firestore has already been started and its settings can no longer be changed. You can only modify settings before calling any other methods on a Firestore object.");this._settings=new fd(e),void 0!==e.credentials&&(this._authCredentials=function(e){if(!e)return new Xr;switch(e.type){case"firstParty":return new ts(e.sessionIndex||"0",e.iamToken||null,e.authTokenFactory||null);case"provider":return e.client;default:throw new _(w.INVALID_ARGUMENT,"makeAuthCredentialsProvider failed due to invalid credential type")}}(e.credentials))}_getSettings(){return this._settings}_freezeSettings(){return this._settingsFrozen=!0,this._settings}_delete(){return this._terminateTask||(this._terminateTask=this._terminate()),this._terminateTask}toJSON(){return{app:this._app,databaseId:this._databaseId,settings:this._settings}}_terminate(){{var e=this;const t=ad.get(e);t&&(m("ComponentProvider","Removing Datastore"),ad.delete(e),t.terminate())}return Promise.resolve()}}class md{constructor(e,t,n){this.converter=t,this._query=n,this.type="query",this.firestore=e}withConverter(e){return new md(this.firestore,e,this._query)}}class V{constructor(e,t,n){this.converter=t,this._key=n,this.type="document",this.firestore=e}get _path(){return this._key.path}get id(){return this._key.path.lastSegment()}get path(){return this._key.path.canonicalString()}get parent(){return new pd(this.firestore,this.converter,this._key.path.popLast())}withConverter(e){return new V(this.firestore,e,this._key)}}class pd extends md{constructor(e,t,n){super(e,t,Ia(n)),this._path=n,this.type="collection"}get id(){return this._query.path.lastSegment()}get path(){return this._query.path.canonicalString()}get parent(){const e=this._path.popLast();return e.isEmpty()?null:new V(this.firestore,null,new S(e))}withConverter(e){return new pd(this.firestore,e,this._path)}}function yd(e,t,...n){var r;if(e=v(e),od("collection","path",t),e instanceof gd)return cd(r=I.fromString(t,...n)),new pd(e,null,r);if(e instanceof V||e instanceof pd)return cd(r=e._path.child(I.fromString(t,...n))),new pd(e.firestore,null,r);throw new _(w.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore")}function vd(e,t,...n){var r;if(e=v(e),od("doc","path",t=1===arguments.length?ss.newId():t),e instanceof gd)return hd(r=I.fromString(t,...n)),new V(e,null,new S(r));if(e instanceof V||e instanceof pd)return hd(r=e._path.child(I.fromString(t,...n))),new V(e.firestore,e instanceof pd?e.converter:null,new S(r));throw new _(w.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore")}function wd(e,t){return e=v(e),t=v(t),(e instanceof V||e instanceof pd)&&(t instanceof V||t instanceof pd)&&e.firestore===t.firestore&&e.path===t.path&&e.converter===t.converter}function _d(e,t){return e=v(e),t=v(t),e instanceof md&&t instanceof md&&e.firestore===t.firestore&&Aa(e._query,t._query)&&e.converter===t.converter}class bd{constructor(){this.Ja=Promise.resolve(),this.Ya=[],this.Za=!1,this.Xa=[],this.eu=null,this.tu=!1,this.nu=!1,this.ru=[],this.zo=new Ac(this,"async_queue_retry"),this.iu=()=>{var e=Dc();e&&m("AsyncQueue","Visibility state changed to "+e.visibilityState),this.zo.Qo()};const e=Dc();e&&"function"==typeof e.addEventListener&&e.addEventListener("visibilitychange",this.iu)}get isShuttingDown(){return this.Za}enqueueAndForget(e){this.enqueue(e)}enqueueAndForgetEvenWhileRestricted(e){this.su(),this.ou(e)}enterRestrictedMode(e){if(!this.Za){this.Za=!0,this.nu=e||!1;const t=Dc();t&&"function"==typeof t.removeEventListener&&t.removeEventListener("visibilitychange",this.iu)}}enqueue(e){if(this.su(),this.Za)return new Promise(()=>{});const t=new Hr;return this.ou(()=>this.Za&&this.nu?Promise.resolve():(e().then(t.resolve,t.reject),t.promise)).then(()=>t.promise)}enqueueRetryable(e){this.enqueueAndForget(()=>(this.Ya.push(e),this._u()))}async _u(){if(0!==this.Ya.length){try{await this.Ya[0](),this.Ya.shift(),this.zo.reset()}catch(e){if(!Ss(e))throw e;m("AsyncQueue","Operation failed with retryable error: "+e)}0<this.Ya.length&&this.zo.ko(()=>this._u())}}ou(e){var t=this.Ja.then(()=>(this.tu=!0,e().catch(e=>{throw this.eu=e,this.tu=!1,d("INTERNAL UNHANDLED ERROR: ",function(e){let t=e.message||"";return t=e.stack?e.stack.includes(e.message)?e.stack:e.message+"\n"+e.stack:t}(e)),e}).then(e=>(this.tu=!1,e))));return this.Ja=t}enqueueAfterDelay(e,t,n){this.su(),-1<this.ru.indexOf(e)&&(t=0);e=tl.createAndSchedule(this,e,t,n,e=>this.au(e));return this.Xa.push(e),e}su(){this.eu&&E()}verifyOperationInProgress(){}async uu(){for(var e;await(e=this.Ja),e!==this.Ja;);}cu(e){for(const t of this.Xa)if(t.timerId===e)return!0;return!1}lu(t){return this.uu().then(()=>{this.Xa.sort((e,t)=>e.targetTimeMs-t.targetTimeMs);for(const e of this.Xa)if(e.skipDelay(),"all"!==t&&e.timerId===t)break;return this.uu()})}hu(e){this.ru.push(e)}au(e){e=this.Xa.indexOf(e);this.Xa.splice(e,1)}}function Id(e){var t=e;if("object"==typeof t&&null!==t){var n=t;for(const t of["next","error","complete"])if(t in n&&"function"==typeof n[t])return 1}}class Ed{constructor(){this._progressObserver={},this._taskCompletionResolver=new Hr,this._lastProgress={taskState:"Running",totalBytes:0,totalDocuments:0,bytesLoaded:0,documentsLoaded:0}}onProgress(e,t,n){this._progressObserver={next:e,error:t,complete:n}}catch(e){return this._taskCompletionResolver.promise.catch(e)}then(e,t){return this._taskCompletionResolver.promise.then(e,t)}_completeWith(e){this._updateProgress(e),this._progressObserver.complete&&this._progressObserver.complete(),this._taskCompletionResolver.resolve(e)}_failWith(e){this._lastProgress.taskState="Error",this._progressObserver.next&&this._progressObserver.next(this._lastProgress),this._progressObserver.error&&this._progressObserver.error(e),this._taskCompletionResolver.reject(e)}_updateProgress(e){this._lastProgress=e,this._progressObserver.next&&this._progressObserver.next(e)}}class B extends gd{constructor(e,t,n,r){super(e,t,n,r),this.type="firestore",this._queue=new bd,this._persistenceKey=(null==r?void 0:r.name)||"[DEFAULT]"}_terminate(){return this._firestoreClient||Sd(this),this._firestoreClient.terminate()}}function Td(e){return e._firestoreClient||Sd(e),e._firestoreClient.verifyNotTerminated(),e._firestoreClient}function Sd(e){var t,n,r,s,i=e._freezeSettings(),a=(t=e._databaseId,n=(null==(a=e._app)?void 0:a.options.appId)||"",r=e._persistenceKey,s=i,new xi(t,n,r,s.host,s.ssl,s.experimentalForceLongPolling,s.experimentalAutoDetectLongPolling,id(s.experimentalLongPollingOptions),s.useFetchStreams));e._firestoreClient=new Kl(e._authCredentials,e._appCheckCredentials,e._queue,a),null!=(a=i.localCache)&&a._offlineComponentProvider&&null!=(t=i.localCache)&&t._onlineComponentProvider&&(e._firestoreClient._uninitializedComponentsProvider={_offlineKind:i.localCache.kind,_offline:i.localCache._offlineComponentProvider,_online:i.localCache._onlineComponentProvider})}function xd(e,t,n){const r=new Hr;return e.asyncQueue.enqueue(async()=>{try{await Ql(e,n),await $l(e,t),r.resolve()}catch(e){const t=e;if(!Wl(t))throw t;$r("Error enabling indexeddb cache. Falling back to memory cache: "+t),r.reject(t)}}).then(()=>r.promise)}function Dd(e){return(r=Td(e=P(e,B))).asyncQueue.enqueue(async()=>{const e=await Xl(r),t=await Zl(r);e.setNetworkEnabled(!0);{const n=t;return n.C_.delete(0),Fc(n)}});var r}function Cd(t,e){return r=Td(t=P(t,B)),s=e,r.asyncQueue.enqueue(async()=>{{var e=await Jl(r),t=s;const n=e;return n.persistence.runTransaction("Get named query","readonly",e=>n.Kr.getNamedQuery(e,t))}}).then(e=>e?new md(t,null,e.query):null);var r,s}function Ad(e){if(e._initialized||e._terminated)throw new _(w.FAILED_PRECONDITION,"Firestore has already been started and persistence can no longer be enabled. You can only enable persistence before calling any other methods on a Firestore object.")}class Nd{constructor(e){this._byteString=e}static fromBase64String(e){try{return new Nd(wi.fromBase64String(e))}catch(e){throw new _(w.INVALID_ARGUMENT,"Failed to construct data from Base64 string: "+e)}}static fromUint8Array(e){return new Nd(wi.fromUint8Array(e))}toBase64(){return this._byteString.toBase64()}toUint8Array(){return this._byteString.toUint8Array()}toString(){return"Bytes(base64: "+this.toBase64()+")"}isEqual(e){return this._byteString.isEqual(e._byteString)}}class kd{constructor(...t){for(let e=0;e<t.length;++e)if(0===t[e].length)throw new _(w.INVALID_ARGUMENT,"Invalid field name at argument $(i + 1). Field names must not be empty.");this._internalPath=new f(t)}isEqual(e){return this._internalPath.isEqual(e._internalPath)}}class Rd{constructor(e){this._methodName=e}}class Md{constructor(e,t){if(!isFinite(e)||e<-90||90<e)throw new _(w.INVALID_ARGUMENT,"Latitude must be a number between -90 and 90, but was: "+e);if(!isFinite(t)||t<-180||180<t)throw new _(w.INVALID_ARGUMENT,"Longitude must be a number between -180 and 180, but was: "+t);this._lat=e,this._long=t}get latitude(){return this._lat}get longitude(){return this._long}isEqual(e){return this._lat===e._lat&&this._long===e._long}toJSON(){return{latitude:this._lat,longitude:this._long}}_compareTo(e){return T(this._lat,e._lat)||T(this._long,e._long)}}const Ld=/^__.*__$/;class Od{constructor(e,t,n){this.data=e,this.fieldMask=t,this.fieldTransforms=n}toMutation(e,t){return null!==this.fieldMask?new lo(e,this.data,this.fieldMask,t,this.fieldTransforms):new co(e,this.data,t,this.fieldTransforms)}}class Fd{constructor(e,t,n){this.data=e,this.fieldMask=t,this.fieldTransforms=n}toMutation(e,t){return new lo(e,this.data,this.fieldMask,t,this.fieldTransforms)}}function Pd(e){switch(e){case 0:case 2:case 1:return 1;case 3:case 4:return;default:throw E()}}class Vd{constructor(e,t,n,r,s,i){this.settings=e,this.databaseId=t,this.serializer=n,this.ignoreUndefinedProperties=r,void 0===s&&this.Pu(),this.fieldTransforms=s||[],this.fieldMask=i||[]}get path(){return this.settings.path}get Iu(){return this.settings.Iu}Tu(e){return new Vd(Object.assign(Object.assign({},this.settings),e),this.databaseId,this.serializer,this.ignoreUndefinedProperties,this.fieldTransforms,this.fieldMask)}Eu(e){var t;const n=null==(t=this.path)?void 0:t.child(e),r=this.Tu({path:n,du:!1});return r.Au(e),r}Ru(e){var t;const n=null==(t=this.path)?void 0:t.child(e),r=this.Tu({path:n,du:!1});return r.Pu(),r}Vu(e){return this.Tu({path:void 0,du:!0})}mu(e){return sf(e,this.settings.methodName,this.settings.fu||!1,this.path,this.settings.gu)}contains(t){return void 0!==this.fieldMask.find(e=>t.isPrefixOf(e))||void 0!==this.fieldTransforms.find(e=>t.isPrefixOf(e.field))}Pu(){if(this.path)for(let e=0;e<this.path.length;e++)this.Au(this.path.get(e))}Au(e){if(0===e.length)throw this.mu("Document fields must not be empty");if(Pd(this.Iu)&&Ld.test(e))throw this.mu('Document fields cannot begin and end with "__"')}}class Bd{constructor(e,t,n){this.databaseId=e,this.ignoreUndefinedProperties=t,this.serializer=n||Cc(e)}pu(e,t,n,r=!1){return new Vd({Iu:e,methodName:t,gu:n,path:f.emptyPath(),du:!1,fu:r},this.databaseId,this.serializer,this.ignoreUndefinedProperties)}}function qd(e){var t=e._freezeSettings(),n=Cc(e._databaseId);return new Bd(e._databaseId,!!t.ignoreUndefinedProperties,n)}function Ud(e,t,n,r,s,i={}){const a=e.pu(i.merge||i.mergeFields?2:0,t,n,s);ef("Data must be an object, but it was:",a,r);e=Jd(r,a);let o,u;if(i.merge)o=new yi(a.fieldMask),u=a.fieldTransforms;else if(i.mergeFields){const e=[];for(const r of i.mergeFields){const s=tf(t,r,n);if(!a.contains(s))throw new _(w.INVALID_ARGUMENT,`Field '${s}' is specified in your field mask but missing from your input data.`);af(e,s)||e.push(s)}o=new yi(e),u=a.fieldTransforms.filter(e=>o.covers(e.field))}else o=null,u=a.fieldTransforms;return new Od(new Qi(e),o,u)}class zd extends Rd{_toFieldTransform(e){if(2!==e.Iu)throw 1===e.Iu?e.mu(this._methodName+"() can only appear at the top level of your update data"):e.mu(this._methodName+"() cannot be used with set() unless you pass {merge:true}");return e.fieldMask.push(e.path),null}isEqual(e){return e instanceof zd}}function Gd(e,t,n){return new Vd({Iu:3,gu:t.settings.gu,methodName:e._methodName,du:n},t.databaseId,t.serializer,t.ignoreUndefinedProperties)}class jd extends Rd{_toFieldTransform(e){return new ro(e.path,new Ha)}isEqual(e){return e instanceof jd}}class Kd extends Rd{constructor(e,t){super(e),this.yu=t}_toFieldTransform(e){const t=Gd(this,e,!0),n=this.yu.map(e=>Xd(e,t)),r=new Ya(n);return new ro(e.path,r)}isEqual(e){return this===e}}class Qd extends Rd{constructor(e,t){super(e),this.yu=t}_toFieldTransform(e){const t=Gd(this,e,!0),n=this.yu.map(e=>Xd(e,t)),r=new Ja(n);return new ro(e.path,r)}isEqual(e){return this===e}}class $d extends Rd{constructor(e,t){super(e),this.wu=t}_toFieldTransform(e){var t=new eo(e.serializer,Qa(e.serializer,this.wu));return new ro(e.path,t)}isEqual(e){return this===e}}function Wd(e,s,i,t){const a=e.pu(1,s,i),o=(ef("Data must be an object, but it was:",a,t),[]),u=Qi.empty();li(t,(e,t)=>{var n=rf(s,e,i),r=(t=v(t),a.Ru(n));if(t instanceof zd)o.push(n);else{const e=Xd(t,r);null!=e&&(o.push(n),u.set(n,e))}});e=new yi(o);return new Fd(u,e,a.fieldTransforms)}function Hd(t,n,e,r,s,i){const a=t.pu(1,n,e),o=[tf(n,r,e)],u=[s];if(i.length%2!=0)throw new _(w.INVALID_ARGUMENT,`Function ${n}() needs to be called with an even number of arguments that alternate between field names and values.`);for(let e=0;e<i.length;e+=2)o.push(tf(n,i[e])),u.push(i[e+1]);const h=[],c=Qi.empty();for(let e=o.length-1;0<=e;--e)if(!af(h,o[e])){const n=o[e];var l=v(u[e]);const r=a.Ru(n);if(l instanceof zd)h.push(n);else{const t=Xd(l,r);null!=t&&(h.push(n),c.set(n,t))}}t=new yi(h);return new Fd(c,t,a.fieldTransforms)}function Yd(e,t,n,r=!1){return Xd(n,e.pu(r?4:3,t))}function Xd(e,n){if(Zd(e=v(e)))return ef("Unsupported field value:",n,e),Jd(e,n);if(e instanceof Rd){{var t=e;var r=n;if(!Pd(r.Iu))throw r.mu(t._methodName+"() can only be used with update() and set()");if(!r.path)throw r.mu(t._methodName+"() is not currently supported inside arrays");t=t._toFieldTransform(r);t&&r.fieldTransforms.push(t)}return null}if(void 0===e&&n.ignoreUndefinedProperties)return null;if(n.path&&n.fieldMask.push(n.path),e instanceof Array){if(n.settings.du&&4!==n.Iu)throw n.mu("Nested arrays are not supported");{var s=n;const a=[];let t=0;for(const o of e){let e=Xd(o,s.Vu(t));null==e&&(e={nullValue:"NULL_VALUE"}),a.push(e),t++}return{arrayValue:{values:a}}}}var i,r=0,t=n;if(null===(r=v(e)))return{nullValue:"NULL_VALUE"};if("number"==typeof r)return Qa(t.serializer,r);if("boolean"==typeof r)return{booleanValue:r};if("string"==typeof r)return{stringValue:r};if(r instanceof Date)return i=c.fromDate(r),{timestampValue:jo(t.serializer,i)};if(r instanceof c)return i=new c(r.seconds,1e3*Math.floor(r.nanoseconds/1e3)),{timestampValue:jo(t.serializer,i)};if(r instanceof Md)return{geoPointValue:{latitude:r.latitude,longitude:r.longitude}};if(r instanceof Nd)return{bytesValue:Ko(t.serializer,r._byteString)};if(r instanceof V){const u=t.databaseId,h=r.firestore._databaseId;if(h.isEqual(u))return{referenceValue:Qo(r.firestore._databaseId||t.databaseId,r._key.path)};throw t.mu(`Document reference is for database ${h.projectId}/${h.database} but should be for database ${u.projectId}/`+u.database)}throw t.mu("Unsupported field value: "+ld(r))}function Jd(e,n){const r={};return di(e)?n.path&&0<n.path.length&&n.fieldMask.push(n.path):li(e,(e,t)=>{t=Xd(t,n.Eu(e));null!=t&&(r[e]=t)}),{mapValue:{fields:r}}}function Zd(e){return!("object"!=typeof e||null===e||e instanceof Array||e instanceof Date||e instanceof c||e instanceof Md||e instanceof Nd||e instanceof V||e instanceof Rd)}function ef(e,t,n){var r;if(!Zd(n)||"object"!=typeof(r=n)||null===r||Object.getPrototypeOf(r)!==Object.prototype&&null!==Object.getPrototypeOf(r))throw"an object"===(r=ld(n))?t.mu(e+" a custom object"):t.mu(e+" "+r)}function tf(e,t,n){if((t=v(t))instanceof kd)return t._internalPath;if("string"==typeof t)return rf(e,t);throw sf("Field path arguments must be of type string or ",e,!1,void 0,n)}const nf=new RegExp("[~\\*/\\[\\]]");function rf(t,n,r){if(0<=n.search(nf))throw sf(`Invalid field path (${n}). Paths must not contain '~', '*', '/', '[', or ']'`,t,!1,void 0,r);try{return new kd(...n.split("."))._internalPath}catch(e){throw sf(`Invalid field path (${n}). Paths must not be empty, begin with '.', end with '.', or contain '..'`,t,!1,void 0,r)}}function sf(e,t,n,r,s){var i=r&&!r.isEmpty(),a=void 0!==s;let o=`Function ${t}() called with invalid data`,u=(n&&(o+=" (via `toFirestore()`)"),o+=". ","");return(i||a)&&(u+=" (found",i&&(u+=" in field "+r),a&&(u+=" in document "+s),u+=")"),new _(w.INVALID_ARGUMENT,o+e+u)}function af(e,t){return e.some(e=>e.isEqual(t))}class of{constructor(e,t,n,r,s){this._firestore=e,this._userDataWriter=t,this._key=n,this._document=r,this._converter=s}get id(){return this._key.path.lastSegment()}get ref(){return new V(this._firestore,this._converter,this._key)}exists(){return null!==this._document}data(){var e;if(this._document)return this._converter?(e=new uf(this._firestore,this._userDataWriter,this._key,this._document,null),this._converter.fromFirestore(e)):this._userDataWriter.convertValue(this._document.data.value)}get(e){if(this._document){e=this._document.data.field(hf("DocumentSnapshot.get",e));if(null!==e)return this._userDataWriter.convertValue(e)}}}class uf extends of{data(){return super.data()}}function hf(e,t){return"string"==typeof t?rf(e,t):(t instanceof kd?t:t._delegate)._internalPath}function cf(e){if("L"===e.limitType&&0===e.explicitOrderBy.length)throw new _(w.UNIMPLEMENTED,"limitToLast() queries require specifying at least one orderBy() clause")}class lf{}class df extends lf{}function ff(e,t,...n){let r=[];t instanceof lf&&r.push(t),r=r.concat(n);n=(t=r).filter(e=>e instanceof mf).length,t=t.filter(e=>e instanceof gf).length;if(1<n||0<n&&0<t)throw new _(w.INVALID_ARGUMENT,"InvalidQuery. When using composite filters, you cannot use more than one filter at the top level. Consider nesting the multiple filters within an `and(...)` statement. For example: change `query(query, where(...), or(...))` to `query(query, and(where(...), or(...)))`.");for(const t of r)e=t._apply(e);return e}class gf extends df{constructor(e,t,n){super(),this._field=e,this._op=t,this._value=n,this.type="where"}static _create(e,t,n){return new gf(e,t,n)}_apply(e){var t=this._parse(e);return Ef(e._query,t),new md(e.firestore,e.converter,Da(e._query,t))}_parse(t){var n=qd(t.firestore);{var r=t._query,s="where",i=n,a=t.firestore._databaseId,o=(n=this._field,t=this._op,this._value);let e;if(n.isKeyField()){if("array-contains"===t||"array-contains-any"===t)throw new _(w.INVALID_ARGUMENT,`Invalid Query. You can't perform '${t}' queries on documentId().`);if("in"===t||"not-in"===t){If(o,t);const s=[];for(const i of o)s.push(bf(a,r,i));e={arrayValue:{values:s}}}else e=bf(a,r,o)}else"in"!==t&&"not-in"!==t&&"array-contains-any"!==t||If(o,t),e=Yd(i,s,o,"in"===t||"not-in"===t);return R.create(n,t,e)}}}class mf extends lf{constructor(e,t){super(),this.type=e,this._queryConstraints=t}static _create(e,t){return new mf(e,t)}_parse(t){var e=this._queryConstraints.map(e=>e._parse(t)).filter(e=>0<e.getFilters().length);return 1===e.length?e[0]:M.create(e,this._getOperator())}_apply(t){const n=this._parse(t);{if(0===n.getFilters().length)return t;{var r=t._query;let e=r;for(const r of n.getFlattenedFilters())Ef(e,r),e=Da(e,r)}return new md(t.firestore,t.converter,Da(t._query,n))}}_getQueryConstraints(){return this._queryConstraints}_getOperator(){return"and"===this.type?"and":"or"}}class pf extends df{constructor(e,t){super(),this._field=e,this._direction=t,this.type="orderBy"}static _create(e,t){return new pf(e,t)}_apply(e){var t=function(e,t,n){if(null!==e.startAt)throw new _(w.INVALID_ARGUMENT,"Invalid query. You must not call startAt() or startAfter() before calling orderBy().");if(null!==e.endAt)throw new _(w.INVALID_ARGUMENT,"Invalid query. You must not call endAt() or endBefore() before calling orderBy().");return new Yi(t,n)}(e._query,this._field,this._direction);return new md(e.firestore,e.converter,(t=(e=e._query).explicitOrderBy.concat([t]),new _a(e.path,e.collectionGroup,t,e.filters.slice(),e.limit,e.limitType,e.startAt,e.endAt)))}}class yf extends df{constructor(e,t,n){super(),this.type=e,this._limit=t,this._limitType=n}static _create(e,t,n){return new yf(e,t,n)}_apply(e){return new md(e.firestore,e.converter,Ca(e._query,this._limit,this._limitType))}}class vf extends df{constructor(e,t,n){super(),this.type=e,this._docOrFields=t,this._inclusive=n}static _create(e,t,n){return new vf(e,t,n)}_apply(e){var t,n=_f(e,this.type,this._docOrFields,this._inclusive);return new md(e.firestore,e.converter,(t=e._query,e=n,new _a(t.path,t.collectionGroup,t.explicitOrderBy.slice(),t.filters.slice(),t.limit,t.limitType,e,t.endAt)))}}class wf extends df{constructor(e,t,n){super(),this.type=e,this._docOrFields=t,this._inclusive=n}static _create(e,t,n){return new wf(e,t,n)}_apply(e){var t,n=_f(e,this.type,this._docOrFields,this._inclusive);return new md(e.firestore,e.converter,(t=e._query,e=n,new _a(t.path,t.collectionGroup,t.explicitOrderBy.slice(),t.filters.slice(),t.limit,t.limitType,t.startAt,e)))}}function _f(e,t,n,r){if(n[0]=v(n[0]),n[0]instanceof of){var s=e._query,i=e.firestore._databaseId,a=t,o=n[0]._document,u=r;if(!o)throw new _(w.NOT_FOUND,`Can't use a DocumentSnapshot that doesn't exist for ${a}().`);const g=[];for(const a of Sa(s))if(a.field.isKeyField())g.push(Fi(i,o.key));else{const s=o.data.field(a.field);if(Ei(s))throw new _(w.INVALID_ARGUMENT,'Invalid query. You are trying to start or end a query using a document for which the field "'+a.field+'" is an uncommitted server timestamp. (Since the value of this field is unknown, you cannot start/end a query with it.)');if(null===s){const s=a.field.canonicalString();throw new _(w.INVALID_ARGUMENT,`Invalid query. You are trying to start or end a query using a document for which the field '${s}' (used as the orderBy) does not exist.`)}g.push(s)}return new $i(g,u)}a=qd(e.firestore);{var h=e._query,c=e.firestore._databaseId,l=a,d=t,f=n,s=r;const m=h.explicitOrderBy;if(f.length>m.length)throw new _(w.INVALID_ARGUMENT,`Too many arguments provided to ${d}(). The number of arguments must be less than or equal to the number of orderBy() clauses`);const p=[];for(let e=0;e<f.length;e++){const y=f[e];if(m[e].field.isKeyField()){if("string"!=typeof y)throw new _(w.INVALID_ARGUMENT,`Invalid query. Expected a string for document ID in ${d}(), but got a `+typeof y);if(!Ta(h)&&-1!==y.indexOf("/"))throw new _(w.INVALID_ARGUMENT,`Invalid query. When querying a collection and ordering by documentId(), the value passed to ${d}() must be a plain document ID, but '${y}' contains a slash.`);const l=h.path.child(I.fromString(y));if(!S.isDocumentKey(l))throw new _(w.INVALID_ARGUMENT,`Invalid query. When querying a collection group and ordering by documentId(), the value passed to ${d}() must result in a valid document path, but '${l}' is not because it contains an odd number of segments.`);const f=new S(l);p.push(Fi(c,f))}else{const h=Yd(l,d,y);p.push(h)}}return new $i(p,s)}}function bf(e,t,n){if("string"==typeof(n=v(n))){if(""===n)throw new _(w.INVALID_ARGUMENT,"Invalid query. When querying with documentId(), you must provide a valid document ID, but it was an empty string.");if(!Ta(t)&&-1!==n.indexOf("/"))throw new _(w.INVALID_ARGUMENT,`Invalid query. When querying a collection by documentId(), you must provide a plain document ID, but '${n}' contains a '/' character.`);t=t.path.child(I.fromString(n));if(S.isDocumentKey(t))return Fi(e,new S(t));throw new _(w.INVALID_ARGUMENT,`Invalid query. When querying a collection group by documentId(), the value provided must result in a valid document path, but '${t}' is not because it has an odd number of segments (${t.length}).`)}if(n instanceof V)return Fi(e,n._key);throw new _(w.INVALID_ARGUMENT,`Invalid query. When querying with documentId(), you must provide a valid string or a DocumentReference, but it was: ${ld(n)}.`)}function If(e,t){if(!Array.isArray(e)||0===e.length)throw new _(w.INVALID_ARGUMENT,`Invalid Query. A non-empty array is required for '${t.toString()}' filters.`)}function Ef(e,t){const n=function(e,t){for(const n of e)for(const e of n.getFlattenedFilters())if(0<=t.indexOf(e.op))return e.op;return null}(e.filters,function(){switch(t.op){case"!=":return["!=","not-in"];case"array-contains-any":case"in":return["not-in"];case"not-in":return["array-contains-any","in","not-in","!="];default:return[]}}());if(null!==n)throw n===t.op?new _(w.INVALID_ARGUMENT,`Invalid query. You cannot use more than one '${t.op.toString()}' filter.`):new _(w.INVALID_ARGUMENT,`Invalid query. You cannot use '${t.op.toString()}' filters with '${n.toString()}' filters.`)}class Tf{convertValue(e,t="none"){switch(Ni(e)){case 0:return null;case 1:return e.booleanValue;case 2:return N(e.integerValue||e.doubleValue);case 3:return this.convertTimestamp(e.timestampValue);case 4:return this.convertServerTimestamp(e,t);case 5:return e.stringValue;case 6:return this.convertBytes(Ii(e.bytesValue));case 7:return this.convertReference(e.referenceValue);case 8:return this.convertGeoPoint(e.geoPointValue);case 9:return this.convertArray(e.arrayValue,t);case 10:return this.convertObject(e.mapValue,t);default:throw E()}}convertObject(e,t){return this.convertObjectMap(e.fields,t)}convertObjectMap(e,n="none"){const r={};return li(e,(e,t)=>{r[e]=this.convertValue(t,n)}),r}convertGeoPoint(e){return new Md(N(e.latitude),N(e.longitude))}convertArray(e,t){return(e.values||[]).map(e=>this.convertValue(e,t))}convertServerTimestamp(e,t){switch(t){case"previous":var n=Ti(e);return null==n?null:this.convertValue(n,t);case"estimate":return this.convertTimestamp(Si(e));default:return null}}convertTimestamp(e){e=bi(e);return new c(e.seconds,e.nanos)}convertDocumentKey(e,t){const n=I.fromString(e),r=(y(hu(n)),new Di(n.get(1),n.get(3))),s=new S(n.popFirst(5));return r.isEqual(t)||d(`Document ${s} contains a document reference within a different database (${r.projectId}/${r.database}) which is not supported. It will be treated as a reference in the current database (${t.projectId}/${t.database}) instead.`),s}}function Sf(e,t,n){return e?n&&(n.merge||n.mergeFields)?e.toFirestore(t,n):e.toFirestore(t):t}class xf extends Tf{constructor(e){super(),this.firestore=e}convertBytes(e){return new Nd(e)}convertReference(e){e=this.convertDocumentKey(e,this.firestore._databaseId);return new V(this.firestore,null,e)}}class Df{constructor(e,t){this.hasPendingWrites=e,this.fromCache=t}isEqual(e){return this.hasPendingWrites===e.hasPendingWrites&&this.fromCache===e.fromCache}}class Cf extends of{constructor(e,t,n,r,s,i){super(e,t,n,r,i),this._firestore=e,this._firestoreImpl=e,this.metadata=s}exists(){return super.exists()}data(e={}){var t;if(this._document)return this._converter?(t=new Af(this._firestore,this._userDataWriter,this._key,this._document,this.metadata,null),this._converter.fromFirestore(t,e)):this._userDataWriter.convertValue(this._document.data.value,e.serverTimestamps)}get(e,t={}){if(this._document){e=this._document.data.field(hf("DocumentSnapshot.get",e));if(null!==e)return this._userDataWriter.convertValue(e,t.serverTimestamps)}}}class Af extends Cf{data(e={}){return super.data(e)}}class Nf{constructor(e,t,n,r){this._firestore=e,this._userDataWriter=t,this._snapshot=r,this.metadata=new Df(r.hasPendingWrites,r.fromCache),this.query=n}get docs(){const t=[];return this.forEach(e=>t.push(e)),t}get size(){return this._snapshot.docs.size}get empty(){return 0===this.size}forEach(t,n){this._snapshot.docs.forEach(e=>{t.call(n,new Af(this._firestore,this._userDataWriter,e.key,e,new Df(this._snapshot.mutatedKeys.has(e.key),this._snapshot.fromCache),this.query.converter))})}docChanges(e={}){e=!!e.includeMetadataChanges;if(e&&this._snapshot.excludesMetadataChanges)throw new _(w.INVALID_ARGUMENT,"To include metadata changes with your document changes, you must also pass { includeMetadataChanges:true } to onSnapshot().");return this._cachedChanges&&this._cachedChangesIncludeMetadataChanges===e||(this._cachedChanges=function(i,t){if(i._snapshot.oldDocs.isEmpty()){let n=0;return i._snapshot.docChanges.map(e=>{var t=new Af(i._firestore,i._userDataWriter,e.doc.key,e.doc,new Df(i._snapshot.mutatedKeys.has(e.doc.key),i._snapshot.fromCache),i.query.converter);return e.doc,{type:"added",doc:t,oldIndex:-1,newIndex:n++}})}{let s=i._snapshot.oldDocs;return i._snapshot.docChanges.filter(e=>t||3!==e.type).map(e=>{var t=new Af(i._firestore,i._userDataWriter,e.doc.key,e.doc,new Df(i._snapshot.mutatedKeys.has(e.doc.key),i._snapshot.fromCache),i.query.converter);let n=-1,r=-1;return 0!==e.type&&(n=s.indexOf(e.doc.key),s=s.delete(e.doc.key)),1!==e.type&&(s=s.add(e.doc),r=s.indexOf(e.doc.key)),{type:function(){switch(e.type){case 0:return"added";case 2:case 3:return"modified";case 1:return"removed";default:return E()}}(),doc:t,oldIndex:n,newIndex:r}})}}(this,e),this._cachedChangesIncludeMetadataChanges=e),this._cachedChanges}}function kf(e,t){return e instanceof Cf&&t instanceof Cf?e._firestore===t._firestore&&e._key.isEqual(t._key)&&(null===e._document?null===t._document:e._document.isEqual(t._document))&&e._converter===t._converter:e instanceof Nf&&t instanceof Nf&&e._firestore===t._firestore&&_d(e.query,t.query)&&e.metadata.isEqual(t.metadata)&&e._snapshot.isEqual(t._snapshot)}class Rf extends Tf{constructor(e){super(),this.firestore=e}convertBytes(e){return new Nd(e)}convertReference(e){e=this.convertDocumentKey(e,this.firestore._databaseId);return new V(this.firestore,null,e)}}function Mf(e,t,n){e=P(e,V);var r=P(e.firestore,B),t=Sf(e.converter,t,n);return Pf(r,[Ud(qd(r),"setDoc",e._key,t,null!==e.converter,n).toMutation(e._key,O.none())])}function Lf(e,t,n,...r){e=P(e,V);var s=P(e.firestore,B),i=qd(s);let a;return Pf(s,[(a="string"==typeof(t=v(t))||t instanceof kd?Hd(i,"updateDoc",e._key,t,n,r):Wd(i,"updateDoc",e._key,t)).toMutation(e._key,O.exists(!0))])}function Of(t,...n){t=v(t);let e={includeMetadataChanges:!1},r=0;"object"!=typeof n[r]||Id(n[r])||(e=n[r],r++);var s={includeMetadataChanges:e.includeMetadataChanges};if(Id(n[r])){const t=n[r];n[r]=null==(h=t.next)?void 0:h.bind(t),n[r+1]=null==(h=t.error)?void 0:h.bind(t),n[r+2]=null==(h=t.complete)?void 0:h.bind(t)}let i,a,o;if(t instanceof V)a=P(t.firestore,B),o=Ia(t._key.path),i={next:e=>{n[r]&&n[r](Vf(a,t,e))},error:n[r+1],complete:n[r+2]};else{const l=P(t,md),d=(a=P(l.firestore,B),o=l._query,new Rf(a));i={next:e=>{n[r]&&n[r](new Nf(a,d,l,e))},error:n[r+1],complete:n[r+2]},cf(t._query)}{var u=Td(a),h=o,c=i;const f=new Ul(c),g=new ll(h,f,s);return u.asyncQueue.enqueueAndForget(async()=>ul(await td(u),g)),()=>{f.Na(),u.asyncQueue.enqueueAndForget(async()=>hl(await td(u),g))}}}function Ff(e,t){{var n=Td(e=P(e,B));e=Id(t)?t:{next:t};const r=new Ul(e);return n.asyncQueue.enqueueAndForget(async()=>{var e=await td(n),t=r;e.q_.add(t),t.next()}),()=>{r.Na(),n.asyncQueue.enqueueAndForget(async()=>{var e=await td(n),t=r;e.q_.delete(t)})}}}function Pf(e,t){{var n=Td(e),r=t;const s=new Hr;return n.asyncQueue.enqueueAndForget(async()=>async function(t,e,n){const r=Ol(t);try{const t=await function(e,s){const i=e,a=c.now(),o=s.reduce((e,t)=>e.add(t.key),L());let u,h;return i.persistence.runTransaction("Locally write mutations","readwrite",n=>{let t=Fa,r=L();return i.ss.getEntries(n,o).next(e=>{(t=e).forEach((e,t)=>{t.isValidDocument()||(r=r.add(e))})}).next(()=>i.localDocuments.getOverlayedDocuments(n,t)).next(e=>{u=e;const t=[];for(const n of s){const s=function(e,t){let n=null;for(const r of e.fieldTransforms){const e=t.data.field(r.field),s=Wa(r.transform,e||null);null!=s&&(n=null===n?Qi.empty():n).set(r.field,s)}return n||null}(n,u.get(n.key).overlayedDocument);null!=s&&t.push(new lo(n.key,s,function r(e){const s=[];return li(e.fields,(e,t)=>{const n=new f([e]);if(Ui(t)){const e=r(t.mapValue).fields;if(0===e.length)s.push(n);else for(const t of e)s.push(n.child(t))}else s.push(n)}),new yi(s)}(s.value.mapValue),O.exists(!0)))}return i.mutationQueue.addMutationBatch(n,a,t,s)}).next(e=>{var t=(h=e).applyToLocalDocumentSet(u,r);return i.documentOverlayCache.saveOverlays(n,e.batchId,t)})}).then(()=>({batchId:h.batchId,changes:Ba(u)}))}(r.localStore,e);r.sharedClientState.addPendingMutation(t.batchId);{var s=r;var i=t.batchId;var a=n;let e=s.Sa[s.currentUser.toKey()];e=(e=e||new C(T)).insert(i,a),s.Sa[s.currentUser.toKey()]=e}await kl(r,t.changes),await Wc(r.remoteStore)}catch(t){const e=nl(t,"Failed to persist write");n.reject(e)}}(await ed(n),r,s)),s.promise}}function Vf(e,t,n){var r=n.docs.get(t._key),s=new Rf(e);return new Cf(e,s,t._key,r,new Df(n.hasPendingWrites,n.fromCache),t.converter)}const Bf={maxAttempts:5};class qf{constructor(e,t){this._firestore=e,this._commitHandler=t,this._mutations=[],this._committed=!1,this._dataReader=qd(e)}set(e,t,n){this._verifyNotCommitted();const r=Uf(e,this._firestore),s=Sf(r.converter,t,n),i=Ud(this._dataReader,"WriteBatch.set",r._key,s,null!==r.converter,n);return this._mutations.push(i.toMutation(r._key,O.none())),this}update(e,t,n,...r){this._verifyNotCommitted();e=Uf(e,this._firestore);let s;return s="string"==typeof(t=v(t))||t instanceof kd?Hd(this._dataReader,"WriteBatch.update",e._key,t,n,r):Wd(this._dataReader,"WriteBatch.update",e._key,t),this._mutations.push(s.toMutation(e._key,O.exists(!0))),this}delete(e){this._verifyNotCommitted();e=Uf(e,this._firestore);return this._mutations=this._mutations.concat(new po(e._key,O.none())),this}commit(){return this._verifyNotCommitted(),this._committed=!0,0<this._mutations.length?this._commitHandler(this._mutations):Promise.resolve()}_verifyNotCommitted(){if(this._committed)throw new _(w.FAILED_PRECONDITION,"A write batch can no longer be used after commit() has been called.")}}function Uf(e,t){if((e=v(e)).firestore!==t)throw new _(w.INVALID_ARGUMENT,"Provided document reference is from a different Firestore instance.");return e}class zf extends class{constructor(e,t){this._firestore=e,this._transaction=t,this._dataReader=qd(e)}get(e){const n=Uf(e,this._firestore),r=new xf(this._firestore);return this._transaction.lookup([n._key]).then(e=>{if(!e||1!==e.length)return E();const t=e[0];if(t.isFoundDocument())return new of(this._firestore,r,t.key,t,n.converter);if(t.isNoDocument())return new of(this._firestore,r,n._key,null,n.converter);throw E()})}set(e,t,n){e=Uf(e,this._firestore),t=Sf(e.converter,t,n),t=Ud(this._dataReader,"Transaction.set",e._key,t,null!==e.converter,n);return this._transaction.set(e._key,t),this}update(e,t,n,...r){e=Uf(e,this._firestore),n="string"==typeof(t=v(t))||t instanceof kd?Hd(this._dataReader,"Transaction.update",e._key,t,n,r):Wd(this._dataReader,"Transaction.update",e._key,t);return this._transaction.update(e._key,n),this}delete(e){e=Uf(e,this._firestore);return this._transaction.delete(e._key),this}}{constructor(e,t){super(e,t),this._firestore=e}get(e){const t=Uf(e,this._firestore),n=new Rf(this._firestore);return super.get(e).then(e=>new Cf(this._firestore,n,t._key,e._document,new Df(!1,!1),t.converter))}}function Gf(e,t){if(void 0===t)return{merge:!1};if(void 0!==t.mergeFields&&void 0!==t.merge)throw new _("invalid-argument",`Invalid options passed to function ${e}(): You cannot `+'specify both "merge" and "mergeFields".');return t}function jf(){if("undefined"==typeof Uint8Array)throw new _("unimplemented","Uint8Arrays are not available in this environment.")}function Kf(){if("undefined"==typeof atob)throw new _("unimplemented","Blobs are unavailable in Firestore in this environment.")}Lr=pg.SDK_VERSION,jr=Lr,pg._registerComponent(new W("firestore",(e,{instanceIdentifier:t,options:n})=>{const r=e.getProvider("app").getImmediate(),s=new B(new Zr(e.getProvider("auth-internal")),new rs(e.getProvider("app-check-internal")),function(e,t){if(Object.prototype.hasOwnProperty.apply(e.options,["projectId"]))return new Di(e.options.projectId,t);throw new _(w.INVALID_ARGUMENT,'"projectId" not provided in firebase.initializeApp.')}(r,t),r);return n=Object.assign({useFetchStreams:!0},n),s._setSettings(n),s},"PUBLIC").setMultipleInstances(!0)),pg.registerVersion(Ee,"4.3.2",void 0),pg.registerVersion(Ee,"4.3.2","esm2017");class Qf{constructor(e){this._delegate=e}static fromBase64String(e){return Kf(),new Qf(Nd.fromBase64String(e))}static fromUint8Array(e){return jf(),new Qf(Nd.fromUint8Array(e))}toBase64(){return Kf(),this._delegate.toBase64()}toUint8Array(){return jf(),this._delegate.toUint8Array()}isEqual(e){return this._delegate.isEqual(e._delegate)}toString(){return"Blob(base64: "+this.toBase64()+")"}}function $f(e){if("object"==typeof e&&null!==e){var t=e;for(const n of["next","error","complete"])if(n in t&&"function"==typeof t[n])return 1}}class Wf{enableIndexedDbPersistence(e,t){var e=e._delegate,t={forceOwnership:t},n=(Ad(e=P(e,B)),Td(e));if(n._uninitializedComponentsProvider)throw new _(w.FAILED_PRECONDITION,"SDK cache is already specified.");$r("enableIndexedDbPersistence() will be deprecated in the future, you can use `FirestoreSettings.cache` instead.");var e=e._freezeSettings(),r=new Bl;return xd(n,r,new Pl(r,e.cacheSizeBytes,null==t?void 0:t.forceOwnership))}enableMultiTabIndexedDbPersistence(e){Ad(e=P(e=e._delegate,B));var t=Td(e);if(t._uninitializedComponentsProvider)throw new _(w.FAILED_PRECONDITION,"SDK cache is already specified.");$r("enableMultiTabIndexedDbPersistence() will be deprecated in the future, you can use `FirestoreSettings.cache` instead.");var e=e._freezeSettings(),n=new Bl;return xd(t,n,new Vl(n,e.cacheSizeBytes))}clearIndexedDbPersistence(e){{var t=e._delegate;if(t._initialized&&!t._terminated)throw new _(w.FAILED_PRECONDITION,"Persistence can only be cleared before a Firestore instance is initialized or after it is terminated.");const n=new Hr;return t._queue.enqueueAndForgetEvenWhileRestricted(async()=>{try{await async function(e){if(!Is.D())return Promise.resolve();e+="main";await Is.delete(e)}($h(t._databaseId,t._persistenceKey)),n.resolve()}catch(e){n.reject(e)}}),n.promise}}}class Hf{constructor(e,t,n){this._delegate=t,this._persistenceProvider=n,this.INTERNAL={delete:()=>this.terminate()},e instanceof Di||(this._appCompat=e)}get _databaseId(){return this._delegate._databaseId}settings(e){var t=this._delegate._getSettings();e.merge||t.host===e.host||$r("You are overriding the original host. If you did not intend to override your settings, use {merge: true}."),e.merge&&delete(e=Object.assign(Object.assign({},t),e)).merge,this._delegate._setSettings(e)}useEmulator(n,r,e={}){{var[n,r,e,s={}]=[this._delegate,n,r,e];const i=(n=P(n,gd))._getSettings(),t=r+":"+e;if("firestore.googleapis.com"!==i.host&&i.host!==t&&$r("Host has been set in both settings() and connectFirestoreEmulator(), emulator host will be used."),n._setSettings(Object.assign(Object.assign({},i),{host:t,ssl:!1})),s.mockUserToken){let e,t;if("string"==typeof s.mockUserToken)e=s.mockUserToken,t=o.MOCK_USER;else{e=function(e,t){if(e.uid)throw new Error('The "uid" field is no longer supported by mockUserToken. Please use "sub" instead for Firebase Auth User ID.');var t=t||"demo-project",n=e.iat||0,r=e.sub||e.user_id;if(r)return r=Object.assign({iss:"https://securetoken.google.com/"+t,aud:t,iat:n,exp:n+3600,auth_time:n,sub:r,user_id:r,firebase:{sign_in_provider:"custom",identities:{}}},e),[q(JSON.stringify({alg:"none",type:"JWT"})),q(JSON.stringify(r)),""].join(".");throw new Error("mockUserToken must contain 'sub' or 'user_id' field!")}(s.mockUserToken,null==(r=n._app)?void 0:r.options.projectId);const i=s.mockUserToken.sub||s.mockUserToken.user_id;if(!i)throw new _(w.INVALID_ARGUMENT,"mockUserToken must contain 'sub' or 'user_id' field!");t=new o(i)}n._authCredentials=new Jr(new Yr(e,t))}return}}enableNetwork(){return Dd(this._delegate)}disableNetwork(){return e=this._delegate,(n=Td(e=P(e,B))).asyncQueue.enqueue(async()=>{const e=await Xl(n),t=await Zl(n);return e.setNetworkEnabled(!1),async function(){const e=t;e.C_.add(0),await Pc(e),e.M_.set("Offline")}()});var e,n}enablePersistence(e){let t=!1,n=!1;return e&&(t=!!e.synchronizeTabs,n=!!e.experimentalForceOwningTab,ud("synchronizeTabs",t,"experimentalForceOwningTab",n)),t?this._persistenceProvider.enableMultiTabIndexedDbPersistence(this):this._persistenceProvider.enableIndexedDbPersistence(this,n)}clearPersistence(){return this._persistenceProvider.clearIndexedDbPersistence(this)}terminate(){return this._appCompat&&(this._appCompat._removeServiceInstance("firestore-compat"),this._appCompat._removeServiceInstance("firestore")),this._delegate._delete()}waitForPendingWrites(){var e=this._delegate;{var t=Td(e=P(e,B));const n=new Hr;return t.asyncQueue.enqueueAndForget(async()=>async function(e,t){const n=e;jc(n.remoteStore)||m("SyncEngine","The network is disabled. The task returned by 'awaitPendingWrites()' will not complete until the network is enabled.");try{const e=await function(){const t=n.localStore;return t.persistence.runTransaction("Get highest unacknowledged batch id","readonly",e=>t.mutationQueue.getHighestUnacknowledgedBatchId(e))}();if(-1===e)return void t.resolve();const r=n.ba.get(e)||[];r.push(t),n.ba.set(e,r)}catch(e){const n=nl(e,"Initialization of waitForPendingWrites() operation failed");t.reject(n)}}(await ed(t),n)),n.promise}}onSnapshotsInSync(e){return Ff(this._delegate,e)}get app(){if(this._appCompat)return this._appCompat;throw new _("failed-precondition","Firestore was not initialized using the Firebase SDK. 'app' is not available")}collection(e){try{return new hg(this,yd(this._delegate,e))}catch(e){throw tg(e,"collection()","Firestore.collection()")}}doc(e){try{return new eg(this,vd(this._delegate,e))}catch(e){throw tg(e,"doc()","Firestore.doc()")}}collectionGroup(e){try{return new ag(this,function(e,t){if(e=P(e,gd),od("collectionGroup","collection id",t),0<=t.indexOf("/"))throw new _(w.INVALID_ARGUMENT,`Invalid collection ID '${t}' passed to function collectionGroup(). Collection IDs must not contain '/'.`);return new md(e,null,new _a(I.emptyPath(),t))}(this._delegate,e))}catch(e){throw tg(e,"collectionGroup()","Firestore.collectionGroup()")}}runTransaction(t){var n=this._delegate,r=e=>t(new Xf(this,e)),e=void 0;if(n=P(n,B),(e=Object.assign(Object.assign({},Bf),e)).maxAttempts<1)throw new _(w.INVALID_ARGUMENT,"Max attempts must be at least 1");{var s=Td(n),i=e=>r(new zf(n,e)),a=e;const o=new Hr;return s.asyncQueue.enqueueAndForget(async()=>{var e=await Yl(s).then(e=>e.datastore);new jl(s.asyncQueue,e,a,i,o).run()}),o.promise}}batch(){return Td(this._delegate),new Jf(new qf(this._delegate,e=>Pf(this._delegate,e)))}loadBundle(e){return n=Td(t=P(this._delegate,B)),r=new Ed,sd(n,t._databaseId,e,r),r;var t,n,r}namedQuery(e){return Cd(this._delegate,e).then(e=>e?new ag(this,e):null)}}class Yf extends Tf{constructor(e){super(),this.firestore=e}convertBytes(e){return new Qf(new Nd(e))}convertReference(e){e=this.convertDocumentKey(e,this.firestore._databaseId);return eg.forKey(e,this.firestore,null)}}class Xf{constructor(e,t){this._firestore=e,this._delegate=t,this._userDataWriter=new Yf(e)}get(e){const t=cg(e);return this._delegate.get(t).then(e=>new sg(this._firestore,new Cf(this._firestore._delegate,this._userDataWriter,e._key,e._document,e.metadata,t.converter)))}set(e,t,n){e=cg(e);return n?(Gf("Transaction.set",n),this._delegate.set(e,t,n)):this._delegate.set(e,t),this}update(e,t,n,...r){e=cg(e);return 2===arguments.length?this._delegate.update(e,t):this._delegate.update(e,t,n,...r),this}delete(e){e=cg(e);return this._delegate.delete(e),this}}class Jf{constructor(e){this._delegate=e}set(e,t,n){e=cg(e);return n?(Gf("WriteBatch.set",n),this._delegate.set(e,t,n)):this._delegate.set(e,t),this}update(e,t,n,...r){e=cg(e);return 2===arguments.length?this._delegate.update(e,t):this._delegate.update(e,t,n,...r),this}delete(e){e=cg(e);return this._delegate.delete(e),this}commit(){return this._delegate.commit()}}class Zf{constructor(e,t,n){this._firestore=e,this._userDataWriter=t,this._delegate=n}fromFirestore(e,t){e=new Af(this._firestore._delegate,this._userDataWriter,e._key,e._document,e.metadata,null);return this._delegate.fromFirestore(new ig(this._firestore,e),null!=t?t:{})}toFirestore(e,t){return t?this._delegate.toFirestore(e,t):this._delegate.toFirestore(e)}static getInstance(e,t){const n=Zf.INSTANCES;let r=n.get(e),s=(r||(r=new WeakMap,n.set(e,r)),r.get(t));return s||(s=new Zf(e,new Yf(e),t),r.set(t,s)),s}}Zf.INSTANCES=new WeakMap;class eg{constructor(e,t){this.firestore=e,this._delegate=t,this._userDataWriter=new Yf(e)}static forPath(e,t,n){if(e.length%2!=0)throw new _("invalid-argument","Invalid document reference. Document references must have an even number of segments, but "+e.canonicalString()+" has "+e.length);return new eg(t,new V(t._delegate,n,new S(e)))}static forKey(e,t,n){return new eg(t,new V(t._delegate,n,e))}get id(){return this._delegate.id}get parent(){return new hg(this.firestore,this._delegate.parent)}get path(){return this._delegate.path}collection(e){try{return new hg(this.firestore,yd(this._delegate,e))}catch(e){throw tg(e,"collection()","DocumentReference.collection()")}}isEqual(e){return(e=v(e))instanceof V&&wd(this._delegate,e)}set(e,t){t=Gf("DocumentReference.set",t);try{return t?Mf(this._delegate,e,t):Mf(this._delegate,e)}catch(e){throw tg(e,"setDoc()","DocumentReference.set()")}}update(e,t,...n){try{return 1===arguments.length?Lf(this._delegate,e):Lf(this._delegate,e,t,...n)}catch(e){throw tg(e,"updateDoc()","DocumentReference.update()")}}delete(){return Pf(P((e=this._delegate).firestore,B),[new po(e._key,O.none())]);var e}onSnapshot(...e){var t=ng(e),e=rg(e,e=>new sg(this.firestore,new Cf(this.firestore._delegate,this._userDataWriter,e._key,e._document,e.metadata,this._delegate.converter)));return Of(this._delegate,t,e)}get(e){let t;return(t=("cache"===(null==e?void 0:e.source)?function(t){t=P(t,V);const n=P(t.firestore,B),e=Td(n),r=new Rf(n);return function(e,t){const n=new Hr;return e.asyncQueue.enqueueAndForget(async()=>async function(e,t,n){try{const r=await function(t){const n=e;return n.persistence.runTransaction("read document","readonly",e=>n.localDocuments.getDocument(e,t))}(t);r.isFoundDocument()?n.resolve(r):r.isNoDocument()?n.resolve(null):n.reject(new _(w.UNAVAILABLE,"Failed to get document from cache. (However, this document may exist on the server. Run again without setting 'source' in the GetOptions to attempt to retrieve the document from the server.)"))}catch(e){t=nl(e,`Failed to get document '${t} from cache`);n.reject(t)}}(await Jl(e),t,n)),n.promise}(e,t._key).then(e=>new Cf(n,r,t._key,e,new Df(null!==e&&e.hasLocalMutations,!0),t.converter))}:"server"===(null==e?void 0:e.source)?function(t){t=P(t,V);const n=P(t.firestore,B);return nd(Td(n),t._key,{source:"server"}).then(e=>Vf(n,t,e))}:function(t){t=P(t,V);const n=P(t.firestore,B);return nd(Td(n),t._key).then(e=>Vf(n,t,e))})(this._delegate)).then(e=>new sg(this.firestore,new Cf(this.firestore._delegate,this._userDataWriter,e._key,e._document,e.metadata,this._delegate.converter)))}withConverter(e){return new eg(this.firestore,e?this._delegate.withConverter(Zf.getInstance(this.firestore,e)):this._delegate.withConverter(null))}}function tg(e,t,n){return e.message=e.message.replace(t,n),e}function ng(e){for(const t of e)if("object"==typeof t&&!$f(t))return t;return{}}function rg(e,t){let n;return{next:e=>{n.next&&n.next(t(e))},error:null==(e=(n=$f(e[0])?e[0]:$f(e[1])?e[1]:"function"==typeof e[0]?{next:e[0],error:e[1],complete:e[2]}:{next:e[1],error:e[2],complete:e[3]}).error)?void 0:e.bind(n),complete:null==(e=n.complete)?void 0:e.bind(n)}}class sg{constructor(e,t){this._firestore=e,this._delegate=t}get ref(){return new eg(this._firestore,this._delegate.ref)}get id(){return this._delegate.id}get metadata(){return this._delegate.metadata}get exists(){return this._delegate.exists()}data(e){return this._delegate.data(e)}get(e,t){return this._delegate.get(e,t)}isEqual(e){return kf(this._delegate,e._delegate)}}class ig extends sg{data(e){e=this._delegate.data(e);return this._delegate._converter||void 0!==e||E(),e}}class ag{constructor(e,t){this.firestore=e,this._delegate=t,this._userDataWriter=new Yf(e)}where(e,t,n){try{return new ag(this.firestore,ff(this._delegate,(r=n,s=t,i=hf("where",e),gf._create(i,s,r))))}catch(e){throw tg(e,/(orderBy|where)\(\)/,"Query.$1()")}var r,s,i}orderBy(e,t){try{return new ag(this.firestore,ff(this._delegate,([n,r="asc"]=[e,t],s=r,i=hf("orderBy",n),pf._create(i,s))))}catch(e){throw tg(e,/(orderBy|where)\(\)/,"Query.$1()")}var n,r,s,i}limit(e){try{return new ag(this.firestore,ff(this._delegate,(dd("limit",t=e),yf._create("limit",t,"F"))))}catch(e){throw tg(e,"limit()","Query.limit()")}var t}limitToLast(e){try{return new ag(this.firestore,ff(this._delegate,(dd("limitToLast",t=e),yf._create("limitToLast",t,"L"))))}catch(e){throw tg(e,"limitToLast()","Query.limitToLast()")}var t}startAt(...e){try{return new ag(this.firestore,ff(this._delegate,([...t]=[...e],vf._create("startAt",t,!0))))}catch(e){throw tg(e,"startAt()","Query.startAt()")}var t}startAfter(...e){try{return new ag(this.firestore,ff(this._delegate,([...t]=[...e],vf._create("startAfter",t,!1))))}catch(e){throw tg(e,"startAfter()","Query.startAfter()")}var t}endBefore(...e){try{return new ag(this.firestore,ff(this._delegate,([...t]=[...e],wf._create("endBefore",t,!1))))}catch(e){throw tg(e,"endBefore()","Query.endBefore()")}var t}endAt(...e){try{return new ag(this.firestore,ff(this._delegate,([...t]=[...e],wf._create("endAt",t,!0))))}catch(e){throw tg(e,"endAt()","Query.endAt()")}var t}isEqual(e){return _d(this._delegate,e._delegate)}get(e){let t;return(t=("cache"===(null==e?void 0:e.source)?function(t){t=P(t,md);const n=P(t.firestore,B),e=Td(n),r=new Rf(n);return function(e,t){const n=new Hr;return e.asyncQueue.enqueueAndForget(async()=>async function(e,t,n){try{const r=await sc(e,t,!0),s=new vl(t,r.ls),i=s.ca(r.documents),a=s.applyChanges(i,!1);n.resolve(a.snapshot)}catch(e){t=nl(e,`Failed to execute query '${t} against cache`);n.reject(t)}}(await Jl(e),t,n)),n.promise}(e,t._query).then(e=>new Nf(n,r,t,e))}:"server"===(null==e?void 0:e.source)?function(t){t=P(t,md);const n=P(t.firestore,B),e=Td(n),r=new Rf(n);return rd(e,t._query,{source:"server"}).then(e=>new Nf(n,r,t,e))}:function(t){t=P(t,md);const n=P(t.firestore,B),e=Td(n),r=new Rf(n);return cf(t._query),rd(e,t._query).then(e=>new Nf(n,r,t,e))})(this._delegate)).then(e=>new ug(this.firestore,new Nf(this.firestore._delegate,this._userDataWriter,this._delegate,e._snapshot)))}onSnapshot(...e){var t=ng(e),e=rg(e,e=>new ug(this.firestore,new Nf(this.firestore._delegate,this._userDataWriter,this._delegate,e._snapshot)));return Of(this._delegate,t,e)}withConverter(e){return new ag(this.firestore,e?this._delegate.withConverter(Zf.getInstance(this.firestore,e)):this._delegate.withConverter(null))}}class og{constructor(e,t){this._firestore=e,this._delegate=t}get type(){return this._delegate.type}get doc(){return new ig(this._firestore,this._delegate.doc)}get oldIndex(){return this._delegate.oldIndex}get newIndex(){return this._delegate.newIndex}}class ug{constructor(e,t){this._firestore=e,this._delegate=t}get query(){return new ag(this._firestore,this._delegate.query)}get metadata(){return this._delegate.metadata}get size(){return this._delegate.size}get empty(){return this._delegate.empty}get docs(){return this._delegate.docs.map(e=>new ig(this._firestore,e))}docChanges(e){return this._delegate.docChanges(e).map(e=>new og(this._firestore,e))}forEach(t,n){this._delegate.forEach(e=>{t.call(n,new ig(this._firestore,e))})}isEqual(e){return kf(this._delegate,e._delegate)}}class hg extends ag{constructor(e,t){super(e,t),this.firestore=e,this._delegate=t}get id(){return this._delegate.id}get path(){return this._delegate.path}get parent(){var e=this._delegate.parent;return e?new eg(this.firestore,e):null}doc(e){try{return void 0===e?new eg(this.firestore,vd(this._delegate)):new eg(this.firestore,vd(this._delegate,e))}catch(e){throw tg(e,"doc()","CollectionReference.doc()")}}add(e){return function(e,t){const n=P(e.firestore,B),r=vd(e),s=Sf(e.converter,t);return Pf(n,[Ud(qd(e.firestore),"addDoc",r._key,s,null!==e.converter,{}).toMutation(r._key,O.exists(!1))]).then(()=>r)}(this._delegate,e).then(e=>new eg(this.firestore,e))}isEqual(e){return wd(this._delegate,e._delegate)}withConverter(e){return new hg(this.firestore,e?this._delegate.withConverter(Zf.getInstance(this.firestore,e)):this._delegate.withConverter(null))}}function cg(e){return P(e,V)}var Ie={Firestore:Hf,GeoPoint:Md,Timestamp:c,Blob:Qf,Transaction:Xf,WriteBatch:Jf,DocumentReference:eg,DocumentSnapshot:sg,Query:ag,QueryDocumentSnapshot:ig,QuerySnapshot:ug,CollectionReference:hg,FieldPath:class fg{constructor(...e){this._delegate=new kd(...e)}static documentId(){return new fg(f.keyField().canonicalString())}isEqual(e){return(e=v(e))instanceof kd&&this._delegate._internalPath.isEqual(e._internalPath)}},FieldValue:class gg{constructor(e){this._delegate=e}static serverTimestamp(){const e=new jd("serverTimestamp");return e._methodName="FieldValue.serverTimestamp",new gg(e)}static delete(){const e=new zd("deleteField");return e._methodName="FieldValue.delete",new gg(e)}static arrayUnion(...e){[...e]=[...e];const t=new Kd("arrayUnion",e);return t._methodName="FieldValue.arrayUnion",new gg(t)}static arrayRemove(...e){[...e]=[...e];const t=new Qd("arrayRemove",e);return t._methodName="FieldValue.arrayRemove",new gg(t)}static increment(e){const t=new $d("increment",e);return t._methodName="FieldValue.increment",new gg(t)}isEqual(e){return this._delegate.isEqual(e._delegate)}},setLogLevel:function(e){Kr.setLogLevel(e)},CACHE_SIZE_UNLIMITED:-1},lg=n.default,dg=(e,t)=>new Hf(e,t,new Wf);lg.INTERNAL.registerComponent(new W("firestore-compat",e=>{var t=e.getProvider("app-compat").getImmediate(),e=e.getProvider("firestore").getImmediate();return dg(t,e)},"PUBLIC").setServiceProps(Object.assign({},Ie))),lg.registerVersion("@firebase/firestore-compat","0.3.22")}.apply(this,arguments)}catch(e){throw console.error(e),new Error("Cannot instantiate firebase-firestore-compat.js - be sure to load firebase-app.js first.")}});